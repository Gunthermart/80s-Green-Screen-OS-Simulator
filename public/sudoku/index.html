<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sudoku Pro</title>
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/394/394127.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#151f2e' } },
                    fontFamily: { mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'] },
                    animation: {
                        'penalty': 'penalty-flash 0.5s ease-in-out',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        'penalty-flash': { '0%, 100%': { color: 'inherit' }, '50%': { color: '#ef4444' } },
                        'shake': { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        'popIn': { '0%': { opacity: '0', transform: 'scale(0.8)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --cell-size: clamp(28px, 11vw, 50px);
            --gap-block: 2px;
            --gap-cell: 1px;
            --bg-body: #f8fafc;
            --color-text-main: #1e293b;
            --grid-border: #334155;
            --bg-block: #334155;
            --cell-bg: #ffffff;
            --cell-text: #1e293b;
            --cell-bg-fixed: #f1f5f9;
            --cell-text-fixed: #0f172a;
            --note-text: #64748b;
            --highlight-selected: #bae6fd;
            --highlight-related: #e0f2fe;
            --highlight-same: #c7d2fe;
            --highlight-conflict-bg: #fee2e2;
            --highlight-conflict-text: #dc2626;
        }

        .dark {
            --bg-body: #0f172a;
            --color-text-main: #f1f5f9;
            --grid-border: #94a3b8;
            --bg-block: #94a3b8;
            --cell-bg: #1e293b;
            --cell-text: #f8fafc;
            --cell-bg-fixed: #020617;
            --cell-text-fixed: #64748b;
            --note-text: #94a3b8;
            --highlight-selected: #0369a1;
            --highlight-related: #1e3a8a;
            --highlight-same: #312e81;
            --highlight-conflict-bg: #450a0a;
            --highlight-conflict-text: #fca5a5;
        }

        @media (min-width: 1024px) { :root { --cell-size: clamp(30px, 6vh, 55px); } }

        body {
            min-height: 100dvh;
            overflow-y: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-body);
            color: var(--color-text-main);
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--gap-block);
            background-color: var(--grid-border);
            border: var(--gap-block) solid var(--grid-border);
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0 auto; 
        }

        .board-block {
            display: grid;
            grid-template-columns: repeat(3, var(--cell-size));
            grid-template-rows: repeat(3, var(--cell-size));
            gap: var(--gap-cell);
            background-color: var(--bg-block);
        }

        .cell {
            background-color: var(--cell-bg);
            color: var(--cell-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--cell-size) * 0.65);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .cell-notes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; padding: 1px; pointer-events: none;
        }
        .note-num { display: flex; justify-content: center; align-items: center; font-size: calc(var(--cell-size) * 0.28); line-height: 1; color: var(--note-text); }

        .cell[data-fixed="true"] { background-color: var(--cell-bg-fixed); color: var(--cell-text-fixed); }
        .cell.is-selected { background-color: var(--highlight-selected) !important; outline: 2px solid #3b82f6; z-index: 10; color: white !important; }
        .cell.is-selected .note-num { color: white; }
        .cell.is-related { background-color: var(--highlight-related); }
        .cell.is-same-value { background-color: var(--highlight-same); }
        .cell.is-error { animation: shake 0.4s ease-in-out; background-color: var(--highlight-conflict-bg) !important; color: var(--highlight-conflict-text) !important; }
        .cell.is-revealed { background-color: #dcfce7 !important; color: #166534 !important; }
        .dark .cell.is-revealed { background-color: #14532d !important; color: #dcfce7 !important; }

        .numpad-grid {
            display: flex;
            justify-content: space-between;
            gap: 0.25rem;
            width: 100%;
            margin-top: 0.5rem;
        }
        .numpad-btn {
            flex: 1;
            aspect-ratio: 0.8; /* Taller buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.1s;
        }
        
        /* Tool buttons row */
        .tools-grid {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        .tool-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            gap: 4px;
        }

        .numpad-btn.active-digit { background-color: #3b82f6 !important; color: white !important; }
        .tool-btn.active { background-color: #3b82f6 !important; color: white !important; }
        .text-penalty { animation: penalty-flash 0.5s; color: #ef4444 !important; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.visible .modal-content { transform: scale(1); animation: pop-in 0.3s forwards; }

        #splash-screen { position: fixed; inset: 0; background: var(--bg-body); z-index: 100; display: flex; flex-col; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #splash-screen.hidden { opacity: 0; pointer-events: none; }

        /* Print/PDF */
        .pdf-clone-root { --cell-size: 40px !important; --gap-block: 2px !important; --bg-block: #000; --cell-bg: #fff; --cell-text: #000; --cell-bg-fixed: #eee; }
        .pdf-temp-wrapper { background: #fff; color: #000; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    </style>
</head>
<body class="font-sans select-none flex flex-col h-[100dvh]">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <h1 class="text-5xl font-extrabold mb-8">SUDOKU<span class="text-blue-500">.JS</span></h1>
        <div class="flex flex-col gap-3 w-64">
            <button data-lang-select="en" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 font-bold">üá∫üá∏ English</button>
            <button data-lang-select="fr" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 font-bold">üá´üá∑ Fran√ßais</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="w-full max-w-md mx-auto px-4 pt-4 pb-2 flex justify-between items-center">
        <div class="flex flex-col">
            <h1 class="text-xl font-black tracking-tight">SUDOKU<span class="text-blue-500">.JS</span></h1>
            <span id="level-display" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Moyen</span>
        </div>
        <div class="flex gap-2">
             <button id="install-app-btn" class="p-2 text-slate-400 hover:text-blue-500 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button>
             <button id="theme-toggle" class="p-2 text-slate-400 hover:text-yellow-500 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg></button>
             <button data-action="solve-click" class="p-2 text-slate-400 hover:text-red-500 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-8a2 2 0 012-2h14a2 2 0 012 2v8M12 3v16m-7-9l7-7 7 7"/></svg></button>
        </div>
    </div>

    <!-- STATS BAR (Above Grid) -->
    <div class="w-full max-w-md mx-auto px-4 py-2 flex justify-between items-center text-sm font-medium text-slate-500 dark:text-slate-400">
        <div class="flex items-center gap-2">
            <span data-i18n="mistakes">Erreurs</span>: <span id="mistakes-count" class="text-slate-800 dark:text-white font-bold">0/3</span>
        </div>
        <div class="flex items-center gap-2">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
             <span id="timer" class="font-mono text-slate-800 dark:text-white font-bold text-lg">00:00</span>
             <span id="penalty-badge" class="hidden text-xs text-red-500 font-bold">+30s</span>
        </div>
        <div class="flex items-center gap-2">
            <span data-i18n="record">Record</span>: <span id="best-time" class="text-blue-500 font-bold">--:--</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="flex-grow flex items-center justify-center p-2 w-full">
        <div id="game-board" class="board-container relative">
            <!-- Toast Victory/Status inside grid container -->
            <div id="status-display" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity z-20 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg font-bold text-sm text-center transform scale-110">
                <span id="status-text"></span><br>
                <span id="status-sub" class="text-xs font-normal opacity-90"></span>
            </div>
        </div>
    </div>

    <!-- CONTROLS CONTAINER (Bottom) -->
    <div class="w-full max-w-md mx-auto px-4 pb-6 flex flex-col gap-2">
        
        <!-- TOOLS ROW -->
        <div class="tools-grid">
            <button id="undo-btn" class="tool-btn bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                <span class="text-[10px] font-bold uppercase" data-i18n="undo">Undo</span>
            </button>
            <button id="eraser-btn" class="tool-btn bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                <span class="text-[10px] font-bold uppercase" data-i18n="erase">Gomme</span>
            </button>
            <button id="note-toggle" class="tool-btn bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                <span class="text-[10px] font-bold uppercase" data-i18n="notes">Notes</span>
            </button>
            <button id="hint-btn" class="tool-btn bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                <span class="text-[10px] font-bold uppercase" data-i18n="hint">Indice</span>
            </button>
        </div>

        <!-- NUMPAD -->
        <div class="numpad-grid" id="numpad">
            <!-- JS will populate 1-9 -->
        </div>

        <!-- NEW GAME ROW -->
        <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-200 dark:border-slate-700">
             <div class="flex gap-1 text-xs font-bold">
                 <button data-action="new-game" data-level="easy" class="px-2 py-1 text-slate-400 hover:text-blue-500">FACILE</button>
                 <button data-action="new-game" data-level="medium" class="px-2 py-1 text-slate-400 hover:text-blue-500">MOYEN</button>
                 <button data-action="new-game" data-level="hard" class="px-2 py-1 text-slate-400 hover:text-blue-500">EXPERT</button>
                 <button data-action="daily-challenge" class="px-2 py-1 text-purple-400 hover:text-purple-600">DAILY</button>
             </div>
             <button id="pdf-btn" class="text-xs font-bold text-slate-300 hover:text-slate-500">PDF</button>
        </div>
    </div>

    <!-- MODALS (Hidden) -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl text-center w-80">
            <h2 class="text-2xl font-black mb-2 dark:text-white" data-i18n="game_over">Game Over</h2>
            <button onclick="app.startNewGame('easy');document.getElementById('game-over-modal').classList.remove('visible')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Nouvelle Partie</button>
        </div>
    </div>
    <div id="victory-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl text-center w-80">
            <div class="text-4xl mb-2">üèÜ</div>
            <h2 class="text-2xl font-black mb-4 dark:text-white" data-i18n="victory">Victoire !</h2>
            <p id="victory-time-display" class="text-xl font-mono font-bold mb-4 text-slate-800 dark:text-white"></p>
            <button onclick="app.startNewGame('easy');document.getElementById('victory-modal').classList.remove('visible')" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">Nouvelle Partie</button>
        </div>
    </div>
    <div id="solve-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl text-center w-80">
            <h2 class="text-xl font-bold mb-4 dark:text-white">Abandonner ?</h2>
            <button id="confirm-solve" class="w-full bg-red-500 text-white py-3 rounded-lg font-bold mb-2">Oui, voir la solution</button>
            <button onclick="document.getElementById('solve-modal').classList.remove('visible')" class="w-full bg-slate-200 text-slate-800 py-3 rounded-lg font-bold">Annuler</button>
        </div>
    </div>

    <script>
        // --- LOGIC ---
        function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }

        const TRANSLATIONS = {
            en: { easy:"Easy", medium:"Medium", hard:"Hard", daily:"Daily", mistakes:"Mistakes", record:"Record", undo:"Undo", erase:"Erase", notes:"Notes", hint:"Hint", game_over:"Game Over", victory:"Victory!", generating_pdf:"PDF..." },
            fr: { easy:"Facile", medium:"Moyen", hard:"Expert", daily:"D√©fi", mistakes:"Erreurs", record:"Record", undo:"Annuler", erase:"Gomme", notes:"Notes", hint:"Indice", game_over:"Perdu", victory:"Victoire !", generating_pdf:"PDF..." },
            de: { easy:"Leicht", medium:"Mittel", hard:"Schwer", daily:"T√§glich", mistakes:"Fehler", record:"Rekord", undo:"Zur√ºck", erase:"L√∂schen", notes:"Notizen", hint:"Hinweis", game_over:"Verloren", victory:"Sieg!", generating_pdf:"PDF..." },
            es: { easy:"F√°cil", medium:"Medio", hard:"Dif√≠cil", daily:"Diario", mistakes:"Errores", record:"R√©cord", undo:"Deshacer", erase:"Borrar", notes:"Notas", hint:"Pista", game_over:"Perdido", victory:"¬°Victoria!", generating_pdf:"PDF..." }
        };

        const SudokuEngine = {
            isValid(grid, idx, val) {
                if(val===0) return true;
                const r=Math.floor(idx/9), c=idx%9, sr=Math.floor(r/3)*3, sc=Math.floor(c/3)*3;
                for(let i=0;i<9;i++) if((i!==c && grid[r*9+i]===val) || (i!==r && grid[i*9+c]===val)) return false;
                for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) { const k=(sr+rr)*9+(sc+cc); if(k!==idx && grid[k]===val) return false; }
                return true;
            },
            generate(lvl, seed) {
                const rng = seed ? mulberry32(seed) : Math.random;
                const grid = new Int8Array(81).fill(0);
                this.fill(grid, rng);
                const sol = [...grid];
                let rem = {easy:30, medium:42, hard:54, daily:45}[lvl] || 30;
                while(rem>0) { const i=Math.floor(rng()*81); if(grid[i]!==0){ grid[i]=0; rem--; } }
                return { puzzle: [...grid], solution: sol };
            },
            fill(grid, rng) {
                for(let i=0;i<81;i++) {
                    if(grid[i]===0) {
                        const nums=[1,2,3,4,5,6,7,8,9].sort(()=>rng()-0.5);
                        for(const n of nums) { if(this.isValid(grid,i,n)) { grid[i]=n; if(this.fill(grid,rng)) return true; grid[i]=0; } }
                        return false;
                    }
                }
                return true;
            },
            getRelated(idx) {
                const s = new Set(); if(idx===null) return s;
                const r=Math.floor(idx/9), c=idx%9, sr=Math.floor(r/3)*3, sc=Math.floor(c/3)*3;
                for(let i=0;i<9;i++) { s.add(r*9+i); s.add(i*9+c); }
                for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) s.add((sr+rr)*9+(sc+cc));
                s.delete(idx); return s;
            }
        };

        class App {
            constructor() {
                this.state = { grid:[], initGrid:[], notes:[], hist:[], sol:[], sel:null, lvl:'easy', noteMode:false, activeDig:null, err:0, lang:'en', won:false };
                this.timer=null; this.sec=0;
                this.els = {
                    board: document.getElementById('game-board'),
                    numpad: document.getElementById('numpad'),
                    timer: document.getElementById('timer'),
                    err: document.getElementById('mistakes-count'),
                    best: document.getElementById('best-time'),
                    level: document.getElementById('level-display'),
                    status: document.getElementById('status-display')
                };
                
                // Init Board
                this.els.board.innerHTML = '';
                for(let b=0;b<9;b++) {
                    const block = document.createElement('div'); block.className='board-block';
                    for(let i=0;i<9;i++) {
                        const idx = (Math.floor(b/3)*3+Math.floor(i/3))*9 + (b%3)*3+(i%3);
                        const cell = document.createElement('div'); cell.className='cell'; cell.dataset.idx=idx;
                        cell.addEventListener('mousedown', ()=>this.onCell(idx));
                        block.appendChild(cell);
                    }
                    this.els.board.appendChild(block);
                }
                
                // Init Numpad
                for(let i=1;i<=9;i++) {
                    const btn = document.createElement('button');
                    btn.className = 'numpad-btn bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 shadow-sm border border-slate-200 dark:border-slate-700';
                    btn.textContent = i;
                    btn.addEventListener('click', ()=>this.onNum(i));
                    this.els.numpad.appendChild(btn);
                }

                // Bindings
                document.getElementById('undo-btn').onclick = ()=>this.undo();
                document.getElementById('eraser-btn').onclick = ()=>this.onNum(0);
                document.getElementById('note-toggle').onclick = ()=>this.toggleNote();
                document.getElementById('hint-btn').onclick = ()=>this.hint();
                document.getElementById('theme-toggle').onclick = ()=>{ document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark')?'dark':'light'; };
                document.querySelectorAll('[data-lang-select]').forEach(b=>b.onclick=()=>this.setLang(b.dataset.langSelect));
                document.querySelectorAll('[data-action="new-game"]').forEach(b=>b.onclick=()=>this.startNewGame(b.dataset.level));
                document.querySelector('[data-action="daily-challenge"]').onclick=()=>this.startNewGame('daily');
                document.querySelector('[data-action="solve-click"]').onclick=()=>document.getElementById('solve-modal').classList.add('visible');
                document.getElementById('confirm-solve').onclick=()=>{
                    document.getElementById('solve-modal').classList.remove('visible');
                    this.state.grid = [...this.state.sol]; this.state.revealed = this.state.grid.map((_,i)=>i);
                    this.render(); this.stopTimer();
                };
                document.getElementById('pdf-btn').onclick = ()=>this.pdf();

                // Load
                if(localStorage.theme==='dark' || (!('theme'in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
                const l = localStorage.getItem('sudoku_lang');
                if(l) this.setLang(l); else this.setLang('en');
                
                // Keyboard
                document.addEventListener('keydown', e=>{
                    if(e.key>='1'&&e.key<='9') this.onNum(parseInt(e.key));
                    if(e.key==='Backspace'||e.key==='0') this.onNum(0);
                    if((e.ctrlKey||e.metaKey)&&e.key==='z') this.undo();
                    if(e.key.toLowerCase()==='n') this.toggleNote();
                });
            }

            setLang(l) { 
                this.state.lang=l; localStorage.setItem('sudoku_lang',l); 
                const t=TRANSLATIONS[l];
                document.querySelectorAll('[data-i18n]').forEach(e=>e.textContent=t[e.dataset.i18n]||e.dataset.i18n);
                document.getElementById('splash-screen').classList.add('hidden');
                if(!this.state.grid.length) this.startNewGame('easy');
                this.render();
            }

            startNewGame(lvl) {
                this.stopTimer(); this.sec=0;
                const seed = lvl==='daily' ? new Date().toISOString().slice(0,10).replace(/-/g,'') : null;
                const data = SudokuEngine.generate(lvl, seed);
                this.state = { 
                    ...this.state, grid:data.puzzle, initGrid:[...data.puzzle], sol:data.solution, 
                    notes:Array(81).fill().map(()=>[]), hist:[], sel:null, lvl:lvl, err:0, 
                    won:false, revealed:[], activeDig:null 
                };
                this.timer = setInterval(()=>{ this.sec++; this.renderInfo(); }, 1000);
                this.render(); this.renderInfo();
            }

            stopTimer() { clearInterval(this.timer); }

            onCell(idx) {
                if(this.state.activeDig) this.fill(idx, this.state.activeDig);
                else { this.state.sel = idx; this.render(); }
            }

            onNum(v) {
                if(this.state.sel !== null) this.fill(this.state.sel, v);
                // Optional: Digit First mode logic could go here
            }

            fill(idx, v) {
                if(this.state.initGrid[idx]!==0 || this.state.won) return;
                
                // Eraser
                if(v===0) {
                    this.pushHist(idx);
                    this.state.grid[idx]=0; this.state.notes[idx]=[];
                    this.render(); return;
                }

                // Note Mode
                if(this.state.noteMode) {
                    this.pushHist(idx);
                    const n = this.state.notes[idx];
                    if(n.includes(v)) this.state.notes[idx] = n.filter(x=>x!==v);
                    else { n.push(v); n.sort(); }
                    this.render(); return;
                }

                // Enter Number
                if(v !== this.state.sol[idx]) {
                    this.state.err++;
                    const el = document.querySelector(`.cell[data-idx="${idx}"]`);
                    el.classList.add('is-error'); setTimeout(()=>el.classList.remove('is-error'),400);
                    if(this.state.err>=3) document.getElementById('game-over-modal').classList.add('visible');
                    this.renderInfo(); return;
                }

                // Correct
                this.pushHist(idx);
                this.state.grid[idx] = v;
                this.state.notes[idx] = [];
                // Clear related notes
                SudokuEngine.getRelated(idx).forEach(r=>{
                    if(this.state.notes[r].includes(v)) this.state.notes[r] = this.state.notes[r].filter(x=>x!==v);
                });
                
                this.render();

                // Win Check
                if(!this.state.grid.includes(0)) {
                    this.state.won = true; this.stopTimer();
                    document.getElementById('victory-time-display').textContent = this.fmtTime(this.sec);
                    document.getElementById('victory-modal').classList.add('visible');
                    // Save Best
                    const k = `best_${this.state.lvl}`;
                    const old = localStorage.getItem(k);
                    if(!old || this.sec < parseInt(old)) localStorage.setItem(k, this.sec);
                }
            }

            toggleNote() { this.state.noteMode = !this.state.noteMode; this.render(); }
            
            hint() {
                if(this.state.won) return;
                const empties = this.state.grid.map((v,i)=>v===0?i:-1).filter(i=>i!==-1);
                if(!empties.length) return;
                const idx = empties[Math.floor(Math.random()*empties.length)];
                this.sec += 30;
                document.getElementById('penalty-badge').classList.remove('hidden');
                setTimeout(()=>document.getElementById('penalty-badge').classList.add('hidden'),1000);
                this.fill(idx, this.state.sol[idx]);
            }

            undo() {
                if(!this.state.hist.length) return;
                const last = this.state.hist.pop();
                this.state.grid[last.i] = last.g;
                this.state.notes[last.i] = last.n;
                this.render();
            }

            pushHist(idx) {
                this.state.hist.push({ i:idx, g:this.state.grid[idx], n:[...this.state.notes[idx]] });
                if(this.state.hist.length>20) this.state.hist.shift();
            }

            render() {
                const { grid, initGrid, sel, notes, revealed } = this.state;
                const rel = SudokuEngine.getRelated(sel);
                const selVal = sel!==null ? grid[sel] : null;

                const cells = this.els.board.getElementsByClassName('cell');
                for(let i=0;i<81;i++) {
                    const c = cells[i];
                    const v = grid[i];
                    
                    // Content
                    if(v!==0) c.textContent = v;
                    else {
                        c.innerHTML = '';
                        if(notes[i].length) {
                            const nDiv = document.createElement('div'); nDiv.className='cell-notes';
                            [1,2,3,4,5,6,7,8,9].forEach(n=>{
                                const s = document.createElement('div'); s.className='note-num';
                                if(notes[i].includes(n)) s.textContent=n;
                                nDiv.appendChild(s);
                            });
                            c.appendChild(nDiv);
                        }
                    }

                    // Classes
                    c.className = 'cell';
                    if(initGrid[i]!==0) c.dataset.fixed="true"; else delete c.dataset.fixed;
                    if(i===sel) c.classList.add('is-selected');
                    else if(rel.has(i)) c.classList.add('is-related');
                    if(selVal && v===selVal && v!==0) c.classList.add('is-same-value');
                    if(revealed && revealed.includes(i)) c.classList.add('is-revealed');
                }

                // Controls State
                document.getElementById('note-toggle').classList.toggle('active', this.state.noteMode);
                document.getElementById('level-display').textContent = TRANSLATIONS[this.state.lang][this.state.lvl].toUpperCase();
            }

            renderInfo() {
                this.els.timer.textContent = this.fmtTime(this.sec);
                this.els.err.textContent = `${this.state.err}/3`;
                const best = localStorage.getItem(`best_${this.state.lvl}`);
                this.els.best.textContent = best ? this.fmtTime(best) : '--:--';
            }

            fmtTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
            
            pdf() {
                const el = document.getElementById('game-board');
                const clone = el.cloneNode(true);
                clone.classList.add('pdf-clone-root');
                // Clean styles
                Array.from(clone.getElementsByClassName('cell')).forEach(c=>{
                    c.className='cell'; 
                    c.style.background = c.dataset.fixed ? '#eee' : '#fff';
                    c.style.color = 'black';
                });
                const wrap = document.createElement('div');
                wrap.className = 'pdf-temp-wrapper';
                wrap.innerHTML = `<h1>SUDOKU PRO</h1><p>Level: ${this.state.lvl}</p>`;
                wrap.appendChild(clone);
                document.body.appendChild(wrap);
                html2pdf().from(wrap).save().then(()=>document.body.removeChild(wrap));
            }
        }

        const app = new App();
    </script>
</body>
</html>

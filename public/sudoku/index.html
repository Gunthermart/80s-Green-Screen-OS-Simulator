<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sudoku Pro">
    
    <title>Sudoku Pro</title>
    
    <!-- Link to external Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#151f2e' } },
                    fontFamily: { mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'] },
                    animation: {
                        'penalty': 'penalty-flash 0.5s ease-in-out',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-out': 'fadeOut 0.5s forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        'penalty-flash': { '0%, 100%': { color: 'inherit' }, '50%': { color: '#ef4444' } },
                        'shake': {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        'fadeOut': { from: { opacity: '1', visibility: 'visible' }, to: { opacity: '0', visibility: 'hidden' } },
                        'popIn': { '0%': { opacity: '0', transform: 'scale(0.8)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* ... existing styles ... */
        :root {
            --cell-size: clamp(28px, 11vw, 55px);
            --gap-block: 4px;
            --gap-cell: 1px;
            --bg-body: #f8fafc;
            --color-text-main: #1e293b;
            --grid-border: #334155;
            --bg-block: #334155;
            --cell-bg: #ffffff;
            --cell-text: #1e293b;
            --cell-bg-fixed: #f1f5f9;
            --cell-text-fixed: #0f172a;
            --note-text: #64748b;
            --highlight-selected: #bae6fd;
            --highlight-related: #e0f2fe;
            --highlight-same: #c7d2fe;
            --highlight-conflict-bg: #fee2e2;
            --highlight-conflict-text: #dc2626;
        }

        .dark {
            --bg-body: #0f172a;
            --color-text-main: #f1f5f9;
            --grid-border: #94a3b8;
            --bg-block: #94a3b8;
            --cell-bg: #1e293b;
            --cell-text: #f8fafc;
            --cell-bg-fixed: #020617;
            --cell-text-fixed: #64748b;
            --note-text: #94a3b8;
            --highlight-selected: #0369a1;
            --highlight-related: #1e3a8a;
            --highlight-same: #312e81;
            --highlight-conflict-bg: #450a0a;
            --highlight-conflict-text: #fca5a5;
        }

        @media (min-width: 1024px) { :root { --cell-size: clamp(30px, 8vh, 60px); } }

        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-body);
            color: var(--color-text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--gap-block);
            background-color: var(--grid-border);
            border: var(--gap-block) solid var(--grid-border);
            width: fit-content;
            margin: 0 auto;
            border-radius: 4px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .board-block {
            display: grid;
            grid-template-columns: repeat(3, var(--cell-size));
            grid-template-rows: repeat(3, var(--cell-size));
            gap: var(--gap-cell);
            background-color: var(--bg-block);
            transition: background-color 0.3s ease;
        }

        .cell {
            background-color: var(--cell-bg);
            color: var(--cell-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--cell-size) * 0.6);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s ease, color 0.1s ease;
            position: relative;
        }

        .cell-notes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 2px;
            pointer-events: none;
        }
        .note-num {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.25);
            line-height: 1;
            color: var(--note-text);
            font-weight: 500;
        }

        .cell[data-fixed="true"] { background-color: var(--cell-bg-fixed); color: var(--cell-text-fixed); cursor: default; }
        .cell.is-selected { background-color: var(--highlight-selected) !important; outline: 3px solid #3b82f6; outline-offset: -3px; z-index: 10; color: white !important; }
        .cell.is-selected .note-num { color: rgba(255,255,255, 0.9); }
        .cell.is-related { background-color: var(--highlight-related); }
        .cell.is-conflict { color: var(--highlight-conflict-text); background-color: var(--highlight-conflict-bg); }
        .cell.is-same-value { background-color: var(--highlight-same); }
        
        .cell.is-revealed {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            transition: all 0.3s ease-out;
        }
        .dark .cell.is-revealed {
            background-color: #14532d !important;
            color: #dcfce7 !important;
        }

        .cell.is-error {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
            background-color: #fee2e2 !important; 
            color: #dc2626 !important;
        }

        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .cell.has-changed { animation: pop 0.2s ease-out; }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 1024px) {
            .numpad-grid { grid-template-columns: repeat(3, 1fr); }
            .numpad-btn:last-child { grid-column: span 3; }
        }
        
        .numpad-btn.is-complete {
            opacity: 0.5;
            pointer-events: none;
            background-color: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
            cursor: not-allowed;
            transform: scale(0.95);
        }
        .dark .numpad-btn.is-complete {
            background-color: #1e293b;
            color: #475569;
            border-color: #334155;
        }
        
        .numpad-btn.active-digit {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #2563eb !important;
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        .note-toggle-active {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }
        .dark .note-toggle-active {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
        }

        .input-mode-active {
            background-color: #f59e0b !important;
            color: white !important;
            border-color: #d97706 !important;
        }

        .text-penalty {
            animation: penalty-flash 0.5s ease-in-out;
            color: #ef4444 !important;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }

        .modal-content { transform: scale(0.9); transition: transform 0.2s ease; }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-body);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        #splash-screen.hidden { pointer-events: none; opacity: 0; }
        
        .pdf-temp-wrapper {
            background-color: white !important;
            color: black !important;
            font-family: sans-serif !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .pdf-clone-root {
            --cell-size: 50px !important;
            --gap-block: 4px !important;
            --gap-cell: 1px !important;
            --bg-block: #000000 !important;
            --cell-bg: #ffffff !important;
            --cell-text: #000000 !important;
            --cell-bg-fixed: #f3f4f6 !important;
            --cell-text-fixed: #000000 !important;
        }
        
        /* Install Button Animation */
        #install-btn.visible {
            display: block;
            animation: pop-in 0.5s ease-out forwards;
        }
        #install-btn {
            display: none;
        }
    </style>
</head>
<body class="h-[100dvh] w-screen flex items-center justify-center font-sans select-none overflow-hidden">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white">
        <div class="mb-10 text-center">
            <h1 class="text-5xl font-extrabold tracking-tight mb-2">SUDOKU<span class="text-blue-500">.JS</span></h1>
            <p class="text-slate-500 dark:text-slate-400">Select your language</p>
        </div>
        <div class="grid grid-cols-1 gap-4 w-64">
            <button data-lang-select="en" class="flex items-center justify-center gap-3 px-6 py-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 transition transform hover:-translate-y-1">
                <span class="text-2xl">üá∫üá∏</span> <span class="font-bold">English</span>
            </button>
            <button data-lang-select="fr" class="flex items-center justify-center gap-3 px-6 py-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 transition transform hover:-translate-y-1">
                <span class="text-2xl">üá´üá∑</span> <span class="font-bold">Fran√ßais</span>
            </button>
            <button data-lang-select="de" class="flex items-center justify-center gap-3 px-6 py-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 transition transform hover:-translate-y-1">
                <span class="text-2xl">üá©üá™</span> <span class="font-bold">Deutsch</span>
            </button>
            <button data-lang-select="es" class="flex items-center justify-center gap-3 px-6 py-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 transition transform hover:-translate-y-1">
                <span class="text-2xl">üá™üá∏</span> <span class="font-bold">Espa√±ol</span>
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="w-full max-w-7xl h-full p-4 flex flex-col lg:flex-row items-center justify-center gap-6 lg:gap-16">
        
        <!-- SECTION GRILLE -->
        <div class="flex-shrink-0 flex items-center justify-center relative">
            <div id="game-board" class="board-container"></div>
            
            <div id="status-display" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity duration-300 z-20">
                <div class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-xl font-bold text-sm whitespace-nowrap transform scale-110 flex flex-col items-center">
                    <span id="status-text">Victoire !</span>
                    <span id="status-sub" class="text-xs font-normal opacity-90 mt-1"></span>
                </div>
            </div>
        </div>

        <!-- SECTION CONTR√îLES -->
        <div class="flex flex-col gap-5 w-full max-w-md lg:w-80 lg:h-auto justify-between lg:justify-center controls-section">
            
            <!-- HEADER -->
            <div class="flex flex-col gap-4 border-b border-slate-200 dark:border-slate-700 pb-4 lg:border-none lg:pb-0">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl lg:text-4xl font-extrabold tracking-tight">SUDOKU<span class="text-blue-500">.JS</span></h1>
                        <span id="save-indicator" data-i18n="saved" class="text-xs text-green-600 dark:text-green-400 font-medium opacity-0 transition-opacity duration-500">Sauvegard√©</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <!-- INSTALL BUTTON (Hidden by default, shown via JS) -->
                        <button id="install-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition text-blue-600 dark:text-blue-400" title="Install App">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                        </button>

                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition text-slate-600 dark:text-yellow-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 hidden dark:block"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 block dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                        </button>
                    </div>
                </div>

                <!-- INFO PANEL -->
                <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-4 py-3">
                    <div class="flex flex-col">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider" data-i18n="time">Temps</span>
                        <div class="flex items-center gap-1">
                            <span id="timer" class="text-xl font-mono font-bold text-slate-800 dark:text-white transition-colors">00:00</span>
                            <span id="penalty-badge" class="hidden text-xs font-bold text-red-500 animate-pulse">+30s</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-center px-4 border-x border-slate-200 dark:border-slate-700">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider" data-i18n="mistakes">Erreurs</span>
                        <div class="flex items-center gap-1">
                            <span id="mistakes-count" class="text-lg font-bold text-slate-700 dark:text-slate-200">0/3</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider" data-i18n="record">Record</span>
                        <span id="best-time" class="text-sm font-mono font-bold text-blue-600 dark:text-blue-400">--:--</span>
                    </div>
                </div>
                
                <!-- Controls Row -->
                <div class="flex gap-2">
                    <div class="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-lg flex-1">
                        <button data-action="new-game" data-level="easy" data-i18n="easy" class="flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all active-level">Facile</button>
                        <button data-action="new-game" data-level="medium" data-i18n="medium" class="flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all">Moyen</button>
                        <button data-action="new-game" data-level="hard" data-i18n="hard" class="flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all">Expert</button>
                        <button data-action="daily-challenge" data-i18n="daily" class="flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20">üìÖ Daily</button>
                    </div>
                </div>
                <div class="flex gap-2 justify-between">
                    <button id="undo-btn" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-400 transition-colors shadow-sm hover:text-blue-600 dark:hover:text-blue-400" aria-label="Annuler">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                    </button>
                    <button id="hint-btn" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-yellow-500 dark:text-yellow-400 transition-colors shadow-sm hover:bg-yellow-50 dark:hover:bg-slate-700" aria-label="Indice">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-1.942a2.408 2.408 0 01.583-1.579L14.7 12.338a4.5 4.5 0 10-5.4 0l2.116 2.14a2.409 2.409 0 01.584 1.58V18m2.4 0a2.4 2.4 0 01-4.8 0m4.8 0V19.875a1.875 1.875 0 11-3.75 0V18m0-6.75l.008-.008m-.008.008l-.008-.008" /></svg>
                    </button>
                    <button id="pdf-btn" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-400 transition-colors shadow-sm hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-red-500 dark:hover:text-red-400" aria-label="PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </button>
                    <button id="input-mode-btn" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-400 transition-colors shadow-sm hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Input Mode">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M6.166 4.666l1.591 1.591" />
                         </svg>
                    </button>
                    <button id="auto-pencil-btn" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-purple-500 dark:text-purple-400 transition-colors shadow-sm hover:bg-purple-50 dark:hover:bg-slate-700" aria-label="Auto Pencil">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l2.846-.813a1.125 1.125 0 00.417-.309l6.86-6.86a2.25 2.25 0 00-3.182-3.182l-6.86 6.86a1.125 1.125 0 00-.309.417zM9 15.281L11.719 18M10.5 2.25L10.5 5.25M13.5 3.75L12 5.25M7.5 3.75L9 5.25" />
                         </svg>
                    </button>
                    <button id="note-toggle" class="w-10 lg:w-12 flex items-center justify-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-400 transition-colors shadow-sm" aria-label="Mode Notes">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                    </button>
                </div>
            </div>

            <!-- Numpad -->
            <div class="numpad-grid" id="numpad"></div>
            
            <!-- Footer -->
            <div class="flex justify-between items-center text-sm pt-2 lg:pt-6 border-t border-slate-200 dark:border-slate-700 mt-auto lg:mt-0">
                <span class="hidden lg:inline text-slate-400 text-xs italic" data-i18n="instructions">N: Notes ‚Ä¢ Ctrl+Z: Annuler</span>
                <div class="flex gap-6 w-full lg:w-auto justify-center lg:justify-end">
                    <button data-action="solve-click" data-i18n="give_up" class="text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 font-semibold text-xs lg:text-sm uppercase tracking-wide transition">Abandon</button>
                    <button data-action="reset" data-i18n="reset" class="text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 font-semibold text-xs lg:text-sm uppercase tracking-wide transition">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Game Over, Victory, Solve) -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2" data-i18n="game_over">Game Over</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6" data-i18n="game_over_desc">Trop d'erreurs ! La grille a eu raison de vous.</p>
            <div class="flex flex-col gap-3">
                <button onclick="document.querySelector('[data-action=new-game][data-level=easy]').click(); document.getElementById('game-over-modal').classList.remove('visible');" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition" data-i18n="new_game">Nouvelle Partie</button>
                <button onclick="document.getElementById('game-over-modal').classList.remove('visible');" class="w-full py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition" data-i18n="close">Fermer</button>
            </div>
        </div>
    </div>

    <div id="victory-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <div class="text-5xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2" data-i18n="victory">Victoire !</h2>
            <div class="grid grid-cols-2 gap-4 my-6">
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold" data-i18n="time">Temps</div>
                    <div id="victory-time" class="text-xl font-mono font-bold text-slate-800 dark:text-white">00:00</div>
                </div>
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold" data-i18n="mistakes">Erreurs</div>
                    <div id="victory-mistakes" class="text-xl font-mono font-bold text-red-500">0/3</div>
                </div>
            </div>
            <div id="victory-comparison" class="mb-6 text-sm font-medium text-slate-600 dark:text-slate-300 bg-blue-50 dark:bg-blue-900/20 py-2 px-3 rounded-lg"></div>
            <div class="flex flex-col gap-3">
                <button onclick="document.querySelector('[data-action=new-game][data-level=easy]').click(); document.getElementById('victory-modal').classList.remove('visible');" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition" data-i18n="new_game">Nouvelle Partie</button>
                <button onclick="document.getElementById('victory-modal').classList.remove('visible');" class="w-full py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition" data-i18n="close">Fermer</button>
            </div>
        </div>
    </div>

    <div id="solve-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <div class="text-5xl mb-4">üè≥Ô∏è</div>
            <h2 class="text-2xl font-black text-slate-800 dark:text-white mb-2" data-i18n="give_up_title">Abandonner ?</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm" data-i18n="give_up_desc">La solution sera r√©v√©l√©e mais la partie ne sera pas comptabilis√©e dans vos statistiques.</p>
            <div class="flex flex-col gap-3">
                <button id="confirm-solve-btn" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition" data-i18n="reveal_solution">R√©v√©ler la Solution</button>
                <button onclick="document.getElementById('solve-modal').classList.remove('visible');" class="w-full py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition" data-i18n="cancel">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // ... (mulberry32, TRANSLATIONS, SudokuEngine remain same) ...
        function mulberry32(a) {
            return function() {
              var t = a += 0x6D2B79F5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        const TRANSLATIONS = {
            en: {
                easy: "Easy", medium: "Medium", hard: "Hard", daily: "Daily",
                time: "Time", mistakes: "Mistakes", record: "Record",
                saved: "Saved", give_up: "Give Up", reset: "Reset",
                instructions: "N: Notes ‚Ä¢ Ctrl+Z: Undo ‚Ä¢ H: Hint",
                victory: "Victory!", new_record: "New Record!",
                game_over: "Game Over", game_over_desc: "Too many mistakes! Try again.",
                new_game: "New Game", close: "Close", erase: "Erase",
                better_than_avg: "üî• {percent}% faster than your average!",
                worse_than_avg: "üê¢ {percent}% slower than your average.",
                first_game: "Great first game on this level!",
                average: "Average",
                give_up_title: "Give Up?",
                give_up_desc: "The solution will be revealed but this game won't count towards your stats.",
                reveal_solution: "Reveal Solution",
                cancel: "Cancel",
                generating_pdf: "Generating PDF..."
            },
            fr: {
                easy: "Facile", medium: "Moyen", hard: "Expert", daily: "D√©fi",
                time: "Temps", mistakes: "Erreurs", record: "Record",
                saved: "Sauvegard√©", give_up: "Abandon", reset: "Reset",
                instructions: "N: Notes ‚Ä¢ Ctrl+Z: Annuler ‚Ä¢ H: Indice",
                victory: "Victoire !", new_record: "Nouveau Record !",
                game_over: "Game Over", game_over_desc: "Trop d'erreurs ! La grille a eu raison de vous.",
                new_game: "Nouvelle Partie", close: "Fermer", erase: "Effacer",
                better_than_avg: "üî• {percent}% plus rapide que votre moyenne !",
                worse_than_avg: "üê¢ {percent}% plus lent que votre moyenne.",
                first_game: "Premi√®re victoire sur ce niveau !",
                average: "Moyenne",
                give_up_title: "Abandonner ?",
                give_up_desc: "La solution sera r√©v√©l√©e mais la partie ne sera pas comptabilis√©e dans vos statistiques.",
                reveal_solution: "R√©v√©ler la Solution",
                cancel: "Annuler",
                generating_pdf: "G√©n√©ration PDF..."
            },
            de: {
                easy: "Leicht", medium: "Mittel", hard: "Schwer", daily: "T√§glich",
                time: "Zeit", mistakes: "Fehler", record: "Rekord",
                saved: "Gespeichert", give_up: "Aufgeben", reset: "Reset",
                instructions: "N: Notizen ‚Ä¢ Ctrl+Z: Zur√ºck",
                victory: "Sieg!", new_record: "Neuer Rekord!",
                game_over: "Spiel Vorbei", game_over_desc: "Zu viele Fehler! Versuchen Sie es erneut.",
                new_game: "Neues Spiel", close: "Schlie√üen", erase: "L√∂schen",
                better_than_avg: "üî• {percent}% schneller als dein Durchschnitt!",
                worse_than_avg: "üê¢ {percent}% langsamer als dein Durchschnitt.",
                first_game: "Gro√üartiges erstes Spiel auf diesem Level!",
                average: "Durchschnitt",
                give_up_title: "Aufgeben?",
                give_up_desc: "Die L√∂sung wird aufgedeckt, aber das Spiel z√§hlt nicht f√ºr deine Statistik.",
                reveal_solution: "L√∂sung anzeigen",
                cancel: "Abbrechen",
                generating_pdf: "PDF wird erstellt..."
            },
            es: {
                easy: "F√°cil", medium: "Medio", hard: "Dif√≠cil", daily: "Diario",
                time: "Tiempo", mistakes: "Errores", record: "R√©cord",
                saved: "Guardado", give_up: "Rendirse", reset: "Reiniciar",
                instructions: "N: Notas ‚Ä¢ Ctrl+Z: Deshacer",
                victory: "¬°Victoria!", new_record: "¬°Nuevo R√©cord!",
                game_over: "Fin del Juego", game_over_desc: "¬°Demasiados errores! Int√©ntalo de nuevo.",
                new_game: "Nuevo Juego", close: "Cerrar", erase: "Borrar",
                better_than_avg: "üî• ¬°{percent}% m√°s r√°pido que tu promedio!",
                worse_than_avg: "üê¢ {percent}% m√°s lento que tu promedio.",
                first_game: "¬°Gran primer juego en este nivel!",
                average: "Promedio",
                give_up_title: "¬øRendirse?",
                give_up_desc: "La soluci√≥n ser√° revelada pero este juego no contar√° en tus estad√≠sticas.",
                reveal_solution: "Revelar Soluci√≥n",
                cancel: "Cancelar",
                generating_pdf: "Generando PDF..."
            }
        };

        /* --- UPDATED PWA MANAGER --- */
        const PWAManager = {
            init() {
                this.installBtn = document.getElementById('install-btn');
                this.deferredPrompt = null;

                // 1. Register Service Worker with Protocol Check
                if ('serviceWorker' in navigator) {
                    // Check if running in a supported environment (HTTP/HTTPS) to avoid 'blob:' errors
                    const isSupportedProtocol = ['http:', 'https:'].includes(window.location.protocol);
                    
                    if (isSupportedProtocol) {
                        window.addEventListener('load', () => {
                            navigator.serviceWorker.register('./service-worker.js')
                                .then(reg => console.log('SW Registered', reg))
                                .catch(err => console.warn('SW Registration failed (expected in preview):', err));
                        });
                    } else {
                        console.log('PWA features disabled in preview environment (protocol: ' + window.location.protocol + ')');
                    }
                }

                // 2. Handle Install Prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    if (this.installBtn) this.installBtn.classList.add('visible');
                });

                window.addEventListener('appinstalled', () => {
                    this.deferredPrompt = null;
                    if (this.installBtn) this.installBtn.classList.remove('visible');
                });

                if (this.installBtn) {
                    this.installBtn.addEventListener('click', async () => {
                        if (!this.deferredPrompt) return;
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        this.deferredPrompt = null;
                        this.installBtn.classList.remove('visible');
                    });
                }
            }
        };

        const ThemeManager = {
            init() {
                const toggleBtn = document.getElementById('theme-toggle');
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else { document.documentElement.classList.remove('dark'); }
                toggleBtn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                });
            }
        };
        
        const SudokuEngine = {
            isValidMove(grid, index, value) {
                if (value === 0) return true;
                const row = Math.floor(index / 9);
                const col = index % 9;
                for (let i = 0; i < 9; i++) {
                    if (i !== col && grid[row * 9 + i] === value) return false;
                    if (i !== row && grid[i * 9 + col] === value) return false;
                }
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 3; c++) {
                        const idx = (startRow + r) * 9 + (startCol + c);
                        if (idx !== index && grid[idx] === value) return false;
                    }
                }
                return true;
            },
            
            generate(level, seed = null) {
                const rng = seed ? mulberry32(seed) : Math.random;
                const grid = new Int8Array(81).fill(0);
                this._fill(grid, rng);
                const solution = Int8Array.from(grid);
                const attempts = { 'easy': 30, 'medium': 45, 'hard': 58, 'daily': 50 }[level] || 30;
                let removed = 0;
                while (removed < attempts) {
                    const idx = Math.floor(rng() * 81);
                    if (grid[idx] !== 0) { grid[idx] = 0; removed++; }
                }
                return { puzzle: Array.from(grid), solution: Array.from(solution) };
            },
            
            _fill(grid, rng) {
                for (let i = 0; i < 81; i++) {
                    if (grid[i] === 0) {
                        const nums = [1,2,3,4,5,6,7,8,9].sort(() => rng() - 0.5);
                        for (const num of nums) {
                            if (this.isValidMove(grid, i, num)) {
                                grid[i] = num;
                                if (this._fill(grid, rng)) return true;
                                grid[i] = 0;
                            }
                        }
                        return false;
                    }
                }
                return true;
            },

            getRelatedIndices(index) {
                const indices = new Set();
                if (index === null) return indices;
                const row = Math.floor(index / 9);
                const col = index % 9;
                const bRow = Math.floor(row / 3) * 3;
                const bCol = Math.floor(col / 3) * 3;
                for (let i = 0; i < 9; i++) {
                    indices.add(row * 9 + i); indices.add(i * 9 + col);
                }
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 3; c++) {
                        indices.add((bRow + r) * 9 + (bCol + c));
                    }
                }
                indices.delete(index);
                return indices;
            },
            getAutoNotes(grid) {
                const notes = Array(81).fill().map(() => []);
                for (let i = 0; i < 81; i++) {
                    if (grid[i] === 0) {
                        for (let num = 1; num <= 9; num++) {
                            if (this.isValidMove(grid, i, num)) {
                                notes[i].push(num);
                            }
                        }
                    }
                }
                return notes;
            }
        };

        class SudokuView {
            constructor(containerId, numpadId) {
                this.container = document.getElementById(containerId);
                this.numpad = document.getElementById(numpadId);
                this.noteToggleBtn = document.getElementById('note-toggle');
                this.inputModeBtn = document.getElementById('input-mode-btn');
                this.undoBtn = document.getElementById('undo-btn');
                this.hintBtn = document.getElementById('hint-btn');
                this.autoPencilBtn = document.getElementById('auto-pencil-btn'); 
                this.pdfBtn = document.getElementById('pdf-btn');
                this.cells = [];
                this.numpadBtns = {}; 
                this.statusEl = document.getElementById('status-display');
                this.timerEl = document.getElementById('timer');
                this.penaltyBadge = document.getElementById('penalty-badge');
                this.bestTimeEl = document.getElementById('best-time');
                this.mistakesEl = document.getElementById('mistakes-count');
                this.saveIndicator = document.getElementById('save-indicator');
                this.levelBtns = document.querySelectorAll('[data-level]');
                this.dailyBtn = document.querySelector('[data-action="daily-challenge"]');
                this.gameOverModal = document.getElementById('game-over-modal');
                this.victoryModal = document.getElementById('victory-modal'); 
                this.solveModal = document.getElementById('solve-modal'); 
                this.splashScreen = document.getElementById('splash-screen');
                this.currentLang = 'en'; 
                this.initDOM();
                this.initNumpad();
            }

            initDOM() {
                this.container.innerHTML = '';
                for (let b = 0; b < 9; b++) {
                    const block = document.createElement('div');
                    block.className = 'board-block';
                    const startRow = Math.floor(b / 3) * 3;
                    const startCol = (b % 3) * 3;
                    for (let i = 0; i < 9; i++) {
                        const r = Math.floor(i / 3);
                        const c = i % 3;
                        const globalIdx = (startRow + r) * 9 + (startCol + c);
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.index = globalIdx;
                        block.appendChild(cell);
                        this.cells[globalIdx] = cell;
                    }
                    this.container.appendChild(block);
                }
            }

            initNumpad() {
                this.numpad.innerHTML = ''; 
                this.numpadBtns = {};
                const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
                numbers.forEach(num => {
                    const btn = document.createElement('button');
                    btn.className = `numpad-btn h-12 lg:h-14 rounded-lg font-bold text-lg lg:text-xl shadow-sm border border-slate-200 dark:border-slate-700 transition active:scale-95 
                        ${num === 0 
                            ? 'bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700' 
                            : 'bg-white text-slate-700 dark:bg-slate-800 dark:text-slate-200 hover:border-blue-500 hover:text-blue-600 dark:hover:border-blue-400 dark:hover:text-blue-400'
                        }`;
                    btn.innerHTML = num === 0 ? 'Eraser' : num; 
                    btn.dataset.value = num;
                    this.numpad.appendChild(btn);
                    if (num !== 0) this.numpadBtns[num] = btn;
                });
            }

            updateLanguage(lang) {
                this.currentLang = lang;
                const t = TRANSLATIONS[lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    if (t[key]) el.textContent = t[key];
                });
                const eraserBtn = document.querySelector('.numpad-btn[data-value="0"]');
                if (eraserBtn) eraserBtn.innerHTML = t.erase;
                document.documentElement.lang = lang;
            }

            hideSplash() { this.splashScreen.classList.add('hidden'); }

            render(state) {
                const { grid, initialGrid, notes, selectedIndex, activeDigit, revealedCells } = state;
                const related = SudokuEngine.getRelatedIndices(selectedIndex);
                const selectedValue = selectedIndex !== null ? grid[selectedIndex] : null;

                for (let i = 0; i < 81; i++) {
                    const cell = this.cells[i];
                    const val = grid[i];
                    const cellNotes = notes[i] || [];
                    const isFixed = initialGrid[i] !== 0;
                    
                    let content = '';
                    if (val !== 0) {
                        content = val;
                    } else if (cellNotes.length > 0) {
                        content = `<div class="cell-notes">
                            ${[1,2,3,4,5,6,7,8,9].map(n => 
                                `<div class="note-num">${cellNotes.includes(n) ? n : ''}</div>`
                            ).join('')}
                        </div>`;
                    }

                    if (cell.innerHTML !== content) {
                        if (val !== 0) {
                             cell.textContent = val;
                             cell.classList.add('has-changed');
                             setTimeout(() => cell.classList.remove('has-changed'), 200);
                        } else {
                            cell.innerHTML = content;
                        }
                    }

                    cell.className = 'cell'; 
                    if (isFixed) cell.dataset.fixed = "true"; else delete cell.dataset.fixed;
                    
                    if (i === selectedIndex) cell.classList.add('is-selected');
                    else if (related.has(i)) cell.classList.add('is-related');
                    
                    if (activeDigit !== null && val === activeDigit && val !== 0) {
                         cell.classList.add('is-same-value'); 
                    } else if (selectedValue && val === selectedValue && val !== 0 && activeDigit === null) {
                         cell.classList.add('is-same-value'); 
                    }

                    if (revealedCells && revealedCells.includes(i)) {
                        cell.classList.add('is-revealed');
                    }
                }
                
                Object.values(this.numpadBtns).forEach(btn => btn.classList.remove('active-digit'));
                if (activeDigit !== null) {
                    if (activeDigit === 0) {
                       const eraser = document.querySelector('.numpad-btn[data-value="0"]');
                       if (eraser) eraser.classList.add('active-digit');
                    } else if (this.numpadBtns[activeDigit]) {
                        this.numpadBtns[activeDigit].classList.add('active-digit');
                    }
                }
            }
            
            triggerErrorAnimation(index) {
                const cell = this.cells[index];
                cell.classList.remove('is-error');
                void cell.offsetWidth; 
                cell.classList.add('is-error');
                setTimeout(() => cell.classList.remove('is-error'), 400);
            }

            updateMistakes(count) {
                this.mistakesEl.textContent = `${count}/3`;
                if (count >= 2) this.mistakesEl.className = "text-lg font-bold text-red-600 dark:text-red-400";
                else this.mistakesEl.className = "text-lg font-bold text-slate-700 dark:text-slate-200";
            }
            
            showGameOver() { this.gameOverModal.classList.add('visible'); }

            showVictory(stats) {
                const { timeFormatted, mistakes, comparison } = stats;
                const t = TRANSLATIONS[this.currentLang];
                
                document.getElementById('victory-time').textContent = timeFormatted;
                document.getElementById('victory-mistakes').textContent = `${mistakes}/3`;
                
                const compEl = document.getElementById('victory-comparison');
                if (comparison.type === 'first') {
                    compEl.textContent = t.first_game;
                    compEl.className = "mb-6 text-sm font-medium text-slate-600 dark:text-slate-300 bg-blue-50 dark:bg-blue-900/20 py-2 px-3 rounded-lg";
                } else if (comparison.type === 'better') {
                    compEl.textContent = t.better_than_avg.replace('{percent}', comparison.val);
                    compEl.className = "mb-6 text-sm font-medium text-green-700 dark:text-green-300 bg-green-50 dark:bg-green-900/20 py-2 px-3 rounded-lg";
                } else {
                    compEl.textContent = t.worse_than_avg.replace('{percent}', comparison.val);
                    compEl.className = "mb-6 text-sm font-medium text-amber-700 dark:text-amber-300 bg-amber-50 dark:bg-amber-900/20 py-2 px-3 rounded-lg";
                }
                
                this.victoryModal.classList.add('visible');
            }

            showSolveModal() { this.solveModal.classList.add('visible'); }
            hideSolveModal() { this.solveModal.classList.remove('visible'); }

            updateNumpadStatus(counts) {
                for (let i = 1; i <= 9; i++) {
                    const btn = this.numpadBtns[i];
                    if (btn) {
                        if (counts[i] >= 9) btn.classList.add('is-complete');
                        else btn.classList.remove('is-complete');
                    }
                }
            }

            toggleNoteButton(isActive) {
                if (isActive) this.noteToggleBtn.classList.add('note-toggle-active');
                else this.noteToggleBtn.classList.remove('note-toggle-active');
            }

            toggleInputModeButton(isActive) {
                if (isActive) this.inputModeBtn.classList.add('input-mode-active');
                else this.inputModeBtn.classList.remove('input-mode-active');
            }

            updateActiveLevel(level) {
                if (this.dailyBtn) this.dailyBtn.classList.remove('ring-2', 'ring-purple-500');

                if (level === 'daily') {
                    this.levelBtns.forEach(btn => btn.className = "flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50");
                    if (this.dailyBtn) this.dailyBtn.classList.add('ring-2', 'ring-purple-500');
                    return;
                }

                this.levelBtns.forEach(btn => {
                    if (btn.dataset.level === level) {
                        btn.className = "flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm ring-1 ring-black/5 dark:ring-white/10";
                    } else {
                        btn.className = "flex-1 px-1 lg:px-2 py-1.5 text-[10px] lg:text-sm font-bold rounded-md transition-all text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50";
                    }
                });
            }

            updateTimer(formattedTime) { this.timerEl.textContent = formattedTime; }
            updateBestTime(time) { this.bestTimeEl.textContent = time ? this.formatTime(time) : '--:--'; }
            
            triggerSaveIndicator() {
                this.saveIndicator.style.opacity = '1';
                setTimeout(() => this.saveIndicator.style.opacity = '0', 1000);
            }

            showTimePenalty() {
                this.timerEl.classList.add('text-penalty');
                this.penaltyBadge.classList.remove('hidden');
                setTimeout(() => {
                    this.timerEl.classList.remove('text-penalty');
                    this.penaltyBadge.classList.add('hidden');
                }, 600);
            }

            formatTime(seconds) {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            }

            showStatus(msgKey, subMsgKey = "") {
                const text = this.statusEl.querySelector('#status-text');
                const sub = this.statusEl.querySelector('#status-sub');
                const t = TRANSLATIONS[this.currentLang];
                text.textContent = t[msgKey] || msgKey; 
                sub.textContent = t[subMsgKey] || subMsgKey;
                this.statusEl.style.opacity = '1';
                setTimeout(() => this.statusEl.style.opacity = '0', 3000);
            }

            bindEvents(handlers) {
                this.container.addEventListener('mousedown', (e) => {
                    const cell = e.target.closest('.cell');
                    if (cell) {
                        handlers.onCellClick(parseInt(cell.dataset.index));
                    }
                });
                this.numpad.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') handlers.onNumpadClick(parseInt(e.target.dataset.value));
                });
                this.noteToggleBtn.addEventListener('click', () => handlers.onToggleNoteMode());
                this.inputModeBtn.addEventListener('click', () => handlers.onToggleInputMode()); 
                this.pdfBtn.addEventListener('click', () => handlers.onDownloadPDF());
                this.undoBtn.addEventListener('click', () => handlers.onUndo());
                this.hintBtn.addEventListener('click', () => handlers.onHint());
                this.autoPencilBtn.addEventListener('click', () => handlers.onAutoPencil());
                
                document.querySelectorAll('[data-lang-select]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.currentTarget.dataset.langSelect;
                        handlers.onLanguageSelect(lang);
                    });
                });
                
                document.getElementById('confirm-solve-btn').addEventListener('click', () => {
                    handlers.onConfirmSolve();
                });

                document.addEventListener('click', (e) => {
                    const action = e.target.closest('[data-action]')?.dataset.action;
                    if (!action) return;
                    if (action === 'new-game') {
                        const lvl = e.target.closest('[data-level]').dataset.level;
                        handlers.onNewGame(lvl);
                    }
                    if (action === 'daily-challenge') {
                        handlers.onNewGame('daily');
                    }
                    if (action === 'solve-click') handlers.onSolveClick();
                    if (action === 'reset') handlers.onReset();
                });
                document.addEventListener('keydown', (e) => {
                    const key = e.key;
                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === 'z') {
                        e.preventDefault();
                        handlers.onUndo();
                        return;
                    }
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                        e.preventDefault();
                        handlers.onNavigate(key);
                    } else if (key >= '1' && key <= '9') {
                        handlers.onNumpadClick(parseInt(key)); 
                    } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
                        handlers.onNumpadClick(0);
                    } else if (key === 'Escape') {
                        handlers.onSelect(null);
                    } else if (key.toLowerCase() === 'n') {
                        handlers.onToggleNoteMode();
                    } else if (key.toLowerCase() === 'h') { 
                        handlers.onHint();
                    }
                });
            }
        }

        class SudokuController {
            constructor() {
                ThemeManager.init();
                PWAManager.init(); // Init PWA logic
                this.view = new SudokuView('game-board', 'numpad');
                this.state = { 
                    grid: [], 
                    initialGrid: [], 
                    notes: Array(81).fill().map(() => []), 
                    history: [], 
                    solution: [], 
                    selectedIndex: null, 
                    level: 'easy',
                    isNoteMode: false,
                    isDigitFirst: false, 
                    activeDigit: null, 
                    mistakes: 0,
                    lang: 'en',
                    revealedCells: []
                };
                this.timerInterval = null;
                this.secondsElapsed = 0;
                this.gameActive = false;

                this.view.bindEvents({
                    onCellClick: (idx) => this.handleCellClick(idx),
                    onNumpadClick: (val) => this.handleNumpadClick(val),
                    onSelect: (idx) => this.selectCell(idx), 
                    onNewGame: (lvl) => this.startNewGame(lvl),
                    onNavigate: (dir) => this.navigate(dir),
                    onSolveClick: () => this.solveClick(),
                    onConfirmSolve: () => this.confirmSolve(),
                    onReset: () => this.resetGame(),
                    onToggleNoteMode: () => this.toggleNoteMode(),
                    onToggleInputMode: () => this.toggleInputMode(),
                    onUndo: () => this.undo(),
                    onHint: () => this.getHint(),
                    onAutoPencil: () => this.autoPencil(),
                    onLanguageSelect: (lang) => this.setLanguage(lang),
                    onDownloadPDF: () => this.downloadPDF()
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && this.gameActive) this.saveGame();
                });

                const savedLang = localStorage.getItem('sudoku_lang');
                if (savedLang) {
                    this.setLanguage(savedLang);
                    if (!this.loadGame()) {
                        this.startNewGame('easy');
                    }
                } else {
                    this.view.updateLanguage('en'); 
                }
            }

            setLanguage(lang) {
                this.state.lang = lang;
                localStorage.setItem('sudoku_lang', lang);
                this.view.updateLanguage(lang);
                this.view.hideSplash();
                
                if (this.state.grid.length === 0) {
                     this.startNewGame('easy');
                }
            }

            setState(updates) {
                this.state = { ...this.state, ...updates };
                
                if (updates.grid) {
                    const counts = Array(10).fill(0);
                    this.state.grid.forEach(n => counts[n]++);
                    this.view.updateNumpadStatus(counts);
                }

                if (updates.hasOwnProperty('mistakes')) {
                    this.view.updateMistakes(updates.mistakes);
                }

                this.view.render(this.state);
                
                if (updates.hasOwnProperty('isNoteMode')) this.view.toggleNoteButton(updates.isNoteMode);
                if (updates.hasOwnProperty('isDigitFirst')) this.view.toggleInputModeButton(updates.isDigitFirst);
                if (updates.level) {
                    this.view.updateActiveLevel(updates.level);
                    this.loadBestTime(updates.level);
                }
                if (this.gameActive) this.checkWinCondition();
            }

            toggleNoteMode() {
                this.setState({ isNoteMode: !this.state.isNoteMode });
            }

            toggleInputMode() {
                const newMode = !this.state.isDigitFirst;
                this.setState({ 
                    isDigitFirst: newMode,
                    activeDigit: null,
                    selectedIndex: null 
                });
            }

            handleCellClick(index) {
                if (!this.gameActive) return;
                if (this.state.isDigitFirst && this.state.activeDigit !== null) {
                    this.inputCell(this.state.activeDigit, index);
                } else {
                    this.selectCell(index);
                }
            }

            handleNumpadClick(value) {
                if (!this.gameActive) return;
                if (this.state.isDigitFirst) {
                    this.setState({ activeDigit: value, selectedIndex: null }); 
                } else {
                    this.inputCell(value);
                }
            }

            createTransaction(indices) {
                const snapshot = indices.map(idx => ({
                    index: idx,
                    value: this.state.grid[idx],
                    notes: [...(this.state.notes[idx] || [])]
                }));
                const newHistory = [...this.state.history, snapshot].slice(-50);
                this.setState({ history: newHistory });
            }

            undo() {
                if (!this.gameActive || this.state.history.length === 0) return;
                
                const newHistory = [...this.state.history];
                const transaction = newHistory.pop();
                
                const newGrid = [...this.state.grid];
                const newNotes = [...this.state.notes];

                let firstIndex = null;
                transaction.forEach(item => {
                    newGrid[item.index] = item.value;
                    newNotes[item.index] = item.notes;
                    if (firstIndex === null) firstIndex = item.index;
                });

                this.setState({ 
                    grid: newGrid, 
                    notes: newNotes, 
                    history: newHistory,
                    selectedIndex: firstIndex 
                });
                this.saveGame();
            }
            
            autoPencil() {
                if (!this.gameActive) return;

                const affectedIndices = [];
                this.state.grid.forEach((val, idx) => {
                    if (val === 0) affectedIndices.push(idx);
                });
                
                if (affectedIndices.length === 0) return;

                this.createTransaction(affectedIndices);
                const newNotes = SudokuEngine.getAutoNotes(this.state.grid);
                this.setState({ notes: newNotes });
                this.saveGame();
            }

            getHint() {
                if (!this.gameActive) return;

                let targetIndex = this.state.selectedIndex;
                if (targetIndex === null || this.state.grid[targetIndex] !== 0) {
                    const emptyIndices = this.state.grid
                        .map((val, idx) => val === 0 ? idx : -1)
                        .filter(idx => idx !== -1);
                    
                    if (emptyIndices.length === 0) return; 
                    targetIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
                    this.selectCell(targetIndex);
                }

                this.secondsElapsed += 30;
                this.view.updateTimer(this.view.formatTime(this.secondsElapsed));
                this.view.showTimePenalty();

                const correctValue = this.state.solution[targetIndex];
                
                const wasNoteMode = this.state.isNoteMode;
                if (wasNoteMode) this.setState({ isNoteMode: false });
                
                this.performValidMove(targetIndex, correctValue);

                if (wasNoteMode) this.setState({ isNoteMode: true });
            }

            performValidMove(index, value) {
                const { grid, notes } = this.state;
                
                const affectedIndices = [index];
                const related = SudokuEngine.getRelatedIndices(index);
                related.forEach(r => affectedIndices.push(r));
                this.createTransaction(affectedIndices);

                const newGrid = [...grid];
                newGrid[index] = value;
                const newNotes = [...notes];
                newNotes[index] = [];
                related.forEach(idx => {
                    if (newNotes[idx] && newNotes[idx].includes(value)) {
                        newNotes[idx] = newNotes[idx].filter(n => n !== value);
                    }
                });

                this.setState({ grid: newGrid, notes: newNotes });
                this.saveGame();
            }

            startTimer() {
                this.stopTimer();
                this.view.updateTimer(this.view.formatTime(this.secondsElapsed));
                this.gameActive = true;
                this.timerInterval = setInterval(() => {
                    this.secondsElapsed++;
                    this.view.updateTimer(this.view.formatTime(this.secondsElapsed));
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            saveGame() {
                if (!this.gameActive) return;
                const saveData = {
                    grid: this.state.grid,
                    initialGrid: this.state.initialGrid,
                    notes: this.state.notes,
                    history: this.state.history, 
                    solution: this.state.solution,
                    level: this.state.level,
                    secondsElapsed: this.secondsElapsed,
                    timestamp: Date.now(),
                    mistakes: this.state.mistakes,
                    isDigitFirst: this.state.isDigitFirst
                };
                localStorage.setItem('sudoku_current_save', JSON.stringify(saveData));
                this.view.triggerSaveIndicator();
            }

            loadGame() {
                try {
                    const saved = localStorage.getItem('sudoku_current_save');
                    if (!saved) return false;
                    const data = JSON.parse(saved);
                    if (!data.grid || !data.initialGrid || data.grid.length !== 81) return false;

                    this.secondsElapsed = data.secondsElapsed || 0;
                    this.setState({
                        grid: data.grid,
                        initialGrid: data.initialGrid,
                        notes: data.notes || Array(81).fill().map(() => []),
                        history: data.history || [],
                        solution: data.solution,
                        level: data.level,
                        selectedIndex: null,
                        isNoteMode: false,
                        mistakes: data.mistakes || 0,
                        isDigitFirst: data.isDigitFirst || false
                    });
                    this.startTimer();
                    return true;
                } catch (e) {
                    return false;
                }
            }

            clearSave() { localStorage.removeItem('sudoku_current_save'); }

            loadBestTime(level) {
                const stored = localStorage.getItem('sudoku_best_times');
                if (stored) {
                    const times = JSON.parse(stored);
                    this.view.updateBestTime(times[level]);
                } else {
                    this.view.updateBestTime(null);
                }
            }

            saveBestTime(level, time) {
                const stored = localStorage.getItem('sudoku_best_times');
                let times = stored ? JSON.parse(stored) : {};
                if (!times[level] || time < times[level]) {
                    times[level] = time;
                    localStorage.setItem('sudoku_best_times', JSON.stringify(times));
                    this.view.updateBestTime(time);
                    return true; 
                }
                return false;
            }

            saveStats(level, time) {
                const stored = localStorage.getItem('sudoku_stats');
                let stats = stored ? JSON.parse(stored) : {};
                if (!stats[level]) { stats[level] = { games: 0, totalTime: 0 }; }
                const oldAverage = stats[level].games > 0 ? stats[level].totalTime / stats[level].games : 0;
                stats[level].games++;
                stats[level].totalTime += time;
                localStorage.setItem('sudoku_stats', JSON.stringify(stats));
                if (oldAverage === 0) return { type: 'first' };
                const diff = time - oldAverage;
                const percent = Math.round(Math.abs(diff / oldAverage) * 100);
                if (diff < 0) return { type: 'better', val: percent };
                return { type: 'worse', val: percent };
            }

            getDailySeed() {
                const today = new Date();
                return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            }

            startNewGame(level) {
                this.stopTimer();
                this.secondsElapsed = 0;
                let seed = null;
                if (level === 'daily') { seed = this.getDailySeed(); }
                const { puzzle, solution } = SudokuEngine.generate(level, seed);
                this.gameActive = true;
                this.setState({ 
                    grid: [...puzzle], 
                    initialGrid: [...puzzle], 
                    notes: Array(81).fill().map(() => []),
                    history: [],
                    solution: solution, 
                    selectedIndex: null, 
                    level: level,
                    mistakes: 0,
                    activeDigit: null,
                    revealedCells: [] 
                });
                this.saveGame();
                this.startTimer();
            }

            selectCell(index) { this.setState({ selectedIndex: index }); }

            inputCell(value, targetIndex = null) {
                const index = targetIndex !== null ? targetIndex : this.state.selectedIndex;
                const { initialGrid, grid, notes, isNoteMode, solution } = this.state;
                if (!this.gameActive || index === null || initialGrid[index] !== 0) return;

                if (value === 0) {
                    const affectedIndices = [index];
                    this.createTransaction(affectedIndices);
                    const newGrid = [...grid];
                    newGrid[index] = 0;
                    const newNotes = [...notes];
                    newNotes[index] = [];
                    this.setState({ grid: newGrid, notes: newNotes });
                    this.saveGame();
                    return;
                }

                if (isNoteMode) {
                    if (grid[index] !== 0) return; 
                    const affectedIndices = [index];
                    this.createTransaction(affectedIndices);
                    const currentNotes = notes[index] || [];
                    let newCellNotes;
                    if (currentNotes.includes(value)) {
                        newCellNotes = currentNotes.filter(n => n !== value);
                    } else {
                        newCellNotes = [...currentNotes, value].sort();
                    }
                    const newNotes = [...notes];
                    newNotes[index] = newCellNotes;
                    this.setState({ notes: newNotes });
                    this.saveGame();
                    return;
                } 
                
                const correctValue = solution[index];
                if (value !== correctValue) {
                    this.view.triggerErrorAnimation(index);
                    const newMistakes = this.state.mistakes + 1;
                    this.setState({ mistakes: newMistakes });
                    this.saveGame();
                    if (newMistakes >= 3) {
                        this.stopTimer();
                        this.gameActive = false;
                        this.clearSave();
                        this.view.showGameOver();
                    }
                    return; 
                }

                const affectedIndices = [index];
                const related = SudokuEngine.getRelatedIndices(index);
                related.forEach(r => affectedIndices.push(r));
                this.createTransaction(affectedIndices);

                const newGrid = [...grid];
                newGrid[index] = value;
                const newNotes = [...notes];
                newNotes[index] = [];
                related.forEach(idx => {
                    if (newNotes[idx] && newNotes[idx].includes(value)) {
                        newNotes[idx] = newNotes[idx].filter(n => n !== value);
                    }
                });

                this.setState({ grid: newGrid, notes: newNotes });
                this.saveGame();
            }

            navigate(direction) {
                let current = this.state.selectedIndex;
                if (current === null) { this.selectCell(40); return; }
                let next = current;
                switch(direction) {
                    case 'ArrowUp': next -= 9; break;
                    case 'ArrowDown': next += 9; break;
                    case 'ArrowLeft': next -= 1; break;
                    case 'ArrowRight': next += 1; break;
                }
                if (direction === 'ArrowLeft' && current % 9 === 0) next = current;
                if (direction === 'ArrowRight' && current % 9 === 8) next = current;
                if (next < 0 || next > 80) next = current;
                this.selectCell(next);
            }

            solveClick() {
                if (!this.gameActive) return;
                this.view.showSolveModal();
            }

            confirmSolve() {
                this.view.hideSolveModal();
                if (!this.gameActive) return;
                this.stopTimer();
                this.gameActive = false;
                this.clearSave();
                const { solution, grid } = this.state;
                const indicesToReveal = [];
                for (let i = 0; i < 81; i++) {
                    if (grid[i] !== solution[i]) {
                        indicesToReveal.push(i);
                    }
                }
                this.setState({ 
                    grid: [...solution], 
                    notes: Array(81).fill().map(() => []),
                    revealedCells: indicesToReveal
                });
            }

            resetGame() {
                this.stopTimer();
                this.secondsElapsed = 0;
                this.setState({ grid: [...this.state.initialGrid], notes: Array(81).fill().map(() => []), history: [], mistakes: 0, revealedCells: [] });
                this.gameActive = true;
                this.saveGame();
                this.startTimer();
            }

            checkWinCondition() {
                const { grid, solution, level } = this.state;
                if (!grid.includes(0)) {
                    const isWin = grid.every((val, i) => val === solution[i]);
                    if (isWin) {
                        this.stopTimer();
                        this.gameActive = false;
                        this.clearSave();
                        this.saveBestTime(level, this.secondsElapsed);
                        const comparison = this.saveStats(level, this.secondsElapsed);
                        this.view.showVictory({
                            timeFormatted: this.view.formatTime(this.secondsElapsed),
                            mistakes: this.state.mistakes,
                            comparison: comparison
                        });
                    }
                }
            }

            downloadPDF() {
                const t = TRANSLATIONS[this.state.lang];
                this.view.showStatus(t.generating_pdf || "Generating PDF...");
                
                const tempContainer = document.createElement('div');
                tempContainer.className = 'pdf-temp-wrapper';
                tempContainer.style.position = 'fixed';
                tempContainer.style.top = '0';
                tempContainer.style.left = '0';
                tempContainer.style.width = '100vw';
                tempContainer.style.height = '100vh';
                tempContainer.style.zIndex = '9999'; 
                tempContainer.style.backgroundColor = 'white';
                
                const loadingText = document.createElement('h2');
                loadingText.innerText = t.generating_pdf || "Generating PDF...";
                loadingText.style.marginBottom = '20px';
                tempContainer.appendChild(loadingText);

                const element = document.getElementById('game-board');
                const clonedBoard = element.cloneNode(true);
                clonedBoard.classList.add('pdf-clone-root');
                
                const cells = clonedBoard.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.classList.remove('is-selected', 'is-related', 'is-same-value', 'is-error', 'has-changed');
                    cell.style.backgroundColor = cell.dataset.fixed === "true" ? '#f3f4f6' : 'white';
                    cell.style.color = 'black';
                });

                const title = document.createElement('h1');
                title.style.fontSize = "30px";
                title.style.marginBottom = "10px";
                title.style.textAlign = "center";
                title.style.color = "black";
                title.style.fontWeight = "bold";
                title.innerText = "SUDOKU PRO";

                const levelText = document.createElement('p');
                levelText.style.marginBottom = "20px";
                levelText.style.textAlign = "center";
                levelText.style.color = "#666";
                const tLevel = TRANSLATIONS[this.state.lang][this.state.level] || this.state.level;
                levelText.innerText = `Niveau: ${tLevel}`;
                
                const contentToCapture = document.createElement('div');
                contentToCapture.style.padding = "40px";
                contentToCapture.style.backgroundColor = "white";
                contentToCapture.style.display = "flex";
                contentToCapture.style.flexDirection = "column";
                contentToCapture.style.alignItems = "center";
                
                contentToCapture.appendChild(title);
                contentToCapture.appendChild(levelText);
                contentToCapture.appendChild(clonedBoard);
                
                tempContainer.appendChild(contentToCapture);
                document.body.appendChild(tempContainer);

                const opt = {
                    margin:       10,
                    filename:     `sudoku_${this.state.level}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true }, 
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                setTimeout(() => {
                    html2pdf().set(opt).from(contentToCapture).save().then(() => {
                        document.body.removeChild(tempContainer);
                    }).catch(err => {
                        console.error(err);
                        document.body.removeChild(tempContainer);
                    });
                }, 100);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new SudokuController());
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    
    <!-- SEO & Viewport Standard -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="NoteLogic V1.25 : Syst√®me de classeur tactique local-first. Storage Manager, Persistance, Nexus Sparklines.">
    <meta name="keywords" content="notelogic, pwa, prise de notes, local-first, productivit√©, ops, tactique, markdown, offline">
    <meta name="author" content="L√©once Equity">
    <meta name="application-name" content="NoteLogic">
    <meta name="theme-color" content="#0f172a">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="NoteLogic V1.25 | Classeur Visual Ops">
    <meta property="og:description" content="Syst√®me de notes d√©centralis√© avec chiffrement local et syntaxe active.">
    <meta property="og:site_name" content="NoteLogic Binder">

    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NoteLogic">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìò</text></svg>">
    <title>NoteLogic V1.25 | Classeur Visual Ops</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root { 
            --bg-dark: #0f172a; 
            --bg-panel: #1e293b; 
            --accent: #3b82f6; 
            --tag-bg: rgba(59, 130, 246, 0.1); 
            --text-muted: #94a3b8; /* Eclairci */
            --border: rgba(255, 255, 255, 0.08); 
            --font-mono: 'JetBrains Mono', monospace; 
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            transition: background-color 0.3s; 
        }

        /* --- SCROLLBARS (Am√©lioration Visuelle & Cliquabilit√©) --- */
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 5px; border: 2px solid var(--bg-dark); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- LAYOUT ANIMATIONS --- */
        aside { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; }
        aside.collapsed { width: 0 !important; opacity: 0; overflow: hidden; border-right: none; }
        
        /* --- EDITOR STYLES --- */
        .editor-layer { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; backdrop-filter: blur(2px); transition: border-color 0.3s, background 0.3s; }
        .editor-layer:focus-within { border-color: var(--accent); }
        #canvas-container { position: absolute; inset: 0; z-index: 0; opacity: 0.5; pointer-events: none; }
        #main-editor { flex: 1; overflow: auto; white-space: pre-wrap; outline: none; position: relative; z-index: 10; padding: 3rem; font-size: 1rem; line-height: 1.7; }
        
        /* --- SYNTAX HIGHLIGHTING (ACTIVE ELEMENTS) --- */
        .chrono-tag { font-family: var(--font-mono); font-size: 0.85em; font-weight: 800; color: #fbbf24; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); padding: 0 4px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; margin: 0 2px; }
        .chrono-tag::before { content: '‚è∞'; margin-right: 4px; font-size: 0.8em; }
        .chrono-tag.overdue { color: #f87171; background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.4); animation: pulse-red 2s infinite; }
        
        .pdf-chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.4); color: #fca5a5; padding: 2px 8px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.8rem; cursor: pointer; user-select: none; margin: 0 4px; transition: all 0.2s; }
        
        .nexus-index { font-family: var(--font-mono); font-size: 0.85em; font-weight: 800; color: #f0abfc; background: rgba(192, 38, 211, 0.2); border: 1px solid #d946ef; padding: 0 4px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; user-select: none; box-shadow: 0 0 10px rgba(217, 70, 239, 0.1); white-space: nowrap; }
        .nexus-index::before { content: '‚ö°'; font-size: 0.7em; margin-right: 4px; color: #e879f9; }

        /* --- UI COMPONENTS (Tailles de polices augment√©es) --- */
        .page-card { border-bottom: 1px solid var(--border); border-left: 3px solid transparent; background: rgba(255,255,255,0.01); transition: background 0.2s; position: relative; cursor: pointer; }
        .page-card.active { background: rgba(59, 130, 246, 0.05); border-left-color: var(--accent); }
        .card-tag-badge { font-size: 11px; font-family: var(--font-mono); font-weight: 700; background: rgba(192, 38, 211, 0.15); color: #e879f9; padding: 2px 5px; border-radius: 3px; border: 1px solid rgba(232, 121, 249, 0.3); margin-right: 4px; display: inline-block; cursor: pointer; margin-top: 4px; }
        .card-actions { opacity: 0; transition: opacity 0.2s; position: absolute; right: 8px; top: 8px; background: #0f172a; padding: 2px; border-radius: 4px; border: 1px solid var(--border); display: flex; gap: 4px; }
        .page-card:hover .card-actions { opacity: 1; }

        .nexus-header { padding: 16px; background: rgba(59, 130, 246, 0.05); border-bottom: 1px solid var(--border); }
        .nexus-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--accent); margin: 16px 16px 8px 16px; letter-spacing: 1px; }
        .network-item { padding: 8px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 0.85rem; cursor: pointer; align-items: center; }
        .network-item:hover { background: rgba(255,255,255,0.05); }

        .ai-insight-panel { margin-bottom: 2rem; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border); border-top: 2px solid var(--accent); border-radius: 4px; animation: slideDown 0.3s ease; font-family: 'JetBrains Mono', monospace; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; border: 1px solid var(--accent); padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100; color: #fff; }
        
        /* --- ANIMATIONS --- */
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 4px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* --- SITREP & REMINDERS --- */
        .sitrep-group { margin-bottom: 16px; border: 1px solid rgba(59, 130, 246, 0.1); border-radius: 6px; overflow: hidden; }
        .sitrep-group-title { font-size: 12px; font-weight: 800; color: #93c5fd; background: rgba(59, 130, 246, 0.1); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
        .sitrep-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.02); cursor: pointer; transition: background 0.2s; }
        .sitrep-item:hover { background: rgba(59, 130, 246, 0.05); }
        .sitrep-page-title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
        .sitrep-source { font-size: 11px; color: #94a3b8; font-family: var(--font-mono); }
        
        .reminder-group { margin-bottom: 12px; }
        .reminder-group-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 4px; padding-left: 8px; letter-spacing: 0.05em; }
        .reminder-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; }
        .reminder-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
        .reminder-item.urgent { border-left: 3px solid #ef4444; }
        .reminder-item.today { border-left: 3px solid #fbbf24; }
        .reminder-date { font-family: var(--font-mono); font-size: 11px; opacity: 0.9; }
        .reminder-title { font-size: 13px; font-weight: 600; color: #f1f5f9; }

        /* --- TABS --- */
        .sitrep-tab-btn, .help-tab-btn { flex: 1; padding: 10px; text-align: center; font-size: 11px; font-weight: 800; text-transform: uppercase; color: #94a3b8; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .sitrep-tab-btn:hover, .help-tab-btn:hover { color: #cbd5e1; background: rgba(255,255,255,0.02); }
        .sitrep-tab-btn.active, .help-tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(59, 130, 246, 0.05); }
        
        /* --- SPARKLINE & STORAGE --- */
        .sparkline-container { display: flex; align-items: flex-end; gap: 2px; height: 16px; width: 36px; margin-right: 8px; opacity: 0.8; }
        .spark-bar { width: 2px; background-color: #3b82f6; border-radius: 1px; transition: height 0.2s; min-height: 2px; }
        .spark-bar.low { background-color: rgba(59, 130, 246, 0.3); }
        .spark-bar.med { background-color: rgba(59, 130, 246, 0.7); }
        .spark-bar.high { background-color: #3b82f6; box-shadow: 0 0 2px #3b82f6; }
        .spark-bar.empty { background-color: rgba(255,255,255,0.05); height: 2px; }

        .storage-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .storage-bar-fill { height: 100%; background: var(--accent); transition: width 0.5s; width: 0%; }
        .storage-bar-fill.warning { background: #fbbf24; }
        .storage-bar-fill.critical { background: #ef4444; }
        .persistence-badge { font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 800; text-transform: uppercase; }
        .persistence-badge.active { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .persistence-badge.inactive { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* --- MENUS & HUD --- */
        .dropdown-menu { transform-origin: top right; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: scale(0.95); pointer-events: none; }
        .dropdown-menu.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .menu-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; font-size: 0.85rem; color: #cbd5e1; font-weight: 600; transition: all 0.1s; border-radius: 4px; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        
        #macro-hud { position: fixed; bottom: 30px; right: 30px; background: #1e293b; border: 1px solid var(--border); padding: 12px; border-radius: 8px; display: none; z-index: 60; box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 200px; }
        #macro-hud.visible { display: block; animation: fadeUp 0.1s; }
        .hud-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 4px 0; }
        
        .view-btn-active { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .bell-icon { position: relative; cursor: pointer; color: #94a3b8; transition: color 0.2s; }
        .bell-icon:hover { color: #fff; }
        .bell-badge { position: absolute; top: 0; right: 0; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: none; box-shadow: 0 0 5px #ef4444; }
        .bell-icon.active .bell-badge { display: block; }
        
        /* --- SEARCH MODAL / COMMAND PALETTE STYLES --- */
        .search-result-item { padding: 10px 14px; border-left: 2px solid transparent; transition: all 0.1s; cursor: pointer; }
        .search-result-item:hover { background: rgba(255,255,255,0.03); }
        .search-result-item.selected { background: rgba(59, 130, 246, 0.1); border-left-color: var(--accent); }
        
        .search-cmd-item { border-left: 2px solid transparent; }
        .search-cmd-item:hover { background: rgba(168, 85, 247, 0.05); }
        .search-cmd-item.selected { background: rgba(168, 85, 247, 0.15); border-left-color: #d946ef; }

        .search-highlight { background: rgba(59, 130, 246, 0.3); color: white; border-radius: 2px; padding: 0 1px; }
        .search-tag { font-size: 11px; background: rgba(255,255,255,0.05); color: #cbd5e1; padding: 1px 4px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.05); margin-right: 4px; }
        
        [contenteditable]:empty:before { content: attr(placeholder); color: #94a3b8; pointer-events: none; display: block; }

        /* --- MOBILE & UX COMPONENTS --- */
        #selection-toolbar { transition: opacity 0.2s, transform 0.2s; transform: translateY(10px); opacity: 0; pointer-events: none; }
        #selection-toolbar.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .fab-menu-open { opacity: 1 !important; pointer-events: auto !important; transform: translateY(0) !important; }
        .fab-main-open { transform: rotate(45deg); background-color: #ef4444 !important; }
        
        /* --- HOVER PEEK (Aper√ßu Tactique) --- */
        #hover-peek {
            position: fixed;
            z-index: 10000;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-top: 3px solid #3b82f6;
            border-radius: 6px;
            padding: 12px;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.15s ease;
            transform: translateY(10px);
            display: none;
            backdrop-filter: blur(8px);
        }
        #hover-peek.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #hover-peek .peek-title { font-size: 11px; font-weight: 800; color: #93c5fd; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        #hover-peek .peek-content { font-size: 11px; color: #cbd5e1; line-height: 1.6; font-family: var(--font-mono); display: -webkit-box; -webkit-line-clamp: 4; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap;}
        
        /* --- ZEN / STEALTH MODE --- */
        body.zen-mode #main-sidebar { width: 0 !important; opacity: 0; overflow: hidden; border: none; }
        body.zen-mode main > header { display: none !important; }
        body.zen-mode #mobile-fab { display: none !important; }
        body.zen-mode .editor-layer { background: transparent !important; border-color: transparent !important; box-shadow: none !important; }
        body.zen-mode .editor-layer > div:last-child { opacity: 0; pointer-events: none; } /* Hide bottom status bar */
        body.zen-mode #canvas-container { opacity: 0.15; }
        body.zen-mode { background-color: #0b1120; } /* Darker background for immersion */
        
        /* --- RICH TEXT FORMATTING IN EDITOR --- */
        #main-editor h1 { font-size: 2em; font-weight: 900; color: #ffffff; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.2em; letter-spacing: -0.5px; }
        #main-editor h2 { font-size: 1.5em; font-weight: 800; color: #f8fafc; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.3; }
        #main-editor h3 { font-size: 1.2em; font-weight: 700; color: #e2e8f0; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.4; color: #93c5fd; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; }
        #main-editor blockquote { border-left: 4px solid var(--accent); padding-left: 1em; color: var(--text-muted); font-style: italic; margin: 1em 0; background: rgba(59, 130, 246, 0.05); padding: 0.5em 1em; border-radius: 0 6px 6px 0; }

        /* --- TASKS (CHECKBOXES) --- */
        .task-box { appearance: none; width: 1.2em; height: 1.2em; border: 2px solid var(--accent); border-radius: 4px; margin-right: 8px; vertical-align: text-bottom; cursor: pointer; position: relative; background: rgba(15, 23, 42, 0.5); transition: all 0.2s; box-shadow: 0 0 5px rgba(59, 130, 246, 0.2); }
        .task-box:checked { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .task-box:checked::after { content: '‚úì'; position: absolute; color: white; font-size: 0.85em; font-weight: 900; left: 50%; top: 50%; transform: translate(-50%, -45%); }

        /* --- SLASH COMMAND MENU --- */
        #slash-menu { position: absolute; z-index: 150; background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(147, 197, 253, 0.3); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(10px); width: 220px; display: none; flex-direction: column; overflow: hidden; }
        .slash-item { padding: 10px 14px; display: flex; align-items: center; gap: 10px; font-size: 13px; cursor: pointer; color: #cbd5e1; border-left: 2px solid transparent; transition: all 0.1s; }
        .slash-item:hover, .slash-item.selected { background: rgba(59, 130, 246, 0.15); border-left-color: #3b82f6; color: #fff; }
    </style>
</head>
<body class="flex-col md:flex-row">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-[#0b1120] transition-opacity duration-700">
        <div class="relative mb-4">
            <div class="absolute -inset-1 bg-blue-500 rounded-lg blur opacity-20"></div>
            <h1 class="relative text-4xl font-black text-white tracking-tighter">NoteLogic V1.25</h1>
        </div>
        <div class="text-[11px] font-mono font-bold text-blue-500 tracking-[0.3em]">CLASSEUR VISUAL OPS</div>
    </div>

    <!-- SIDEBAR -->
    <aside id="main-sidebar" class="w-full md:w-[360px] border-r border-white/5 flex flex-col shrink-0 bg-[#0b1120]">
        <!-- Brand / Identity Header -->
        <div class="p-4 border-b border-white/5 bg-[#0b1120] shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-white font-bold shadow-lg shadow-blue-900/30">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div>
                    <h2 class="text-sm font-bold text-white tracking-tight">NoteLogic <span class="text-blue-500">Binder</span></h2>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span class="text-[11px] font-mono text-slate-400">SYSTEM.ACTIVE</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <header class="h-12 flex items-center justify-between px-3 border-b border-white/5 shrink-0 bg-[#0f172a]">
            <div class="flex items-center gap-2">
                 <span class="text-xs font-black text-white tracking-widest uppercase">Classeur</span>
                 <div class="h-4 w-px bg-white/10 mx-1"></div>
                 <button data-action="newPage" class="flex items-center gap-1 text-xs font-bold bg-blue-500/10 text-blue-400 px-2 py-1 rounded hover:bg-blue-500/20 border border-blue-500/20" title="Nouvelle Note (Alt+N)">
                    <span>+ NOTE</span>
                 </button>
            </div>
            <div class="flex gap-1 items-center">
                <button data-action="triggerSitrep" class="px-2 py-1 rounded text-xs font-bold uppercase text-blue-400 bg-blue-500/5 hover:bg-blue-500/10 transition-all border border-blue-500/20" title="Index Global (Alt+S)">üì° SITREP</button>
                <div class="bg-white/5 rounded p-0.5 flex">
                    <button data-action="toggleView" data-view="pages" id="btn-view-pages" class="px-2 py-0.5 rounded text-[11px] font-bold uppercase text-slate-400 transition-all view-btn-active" title="Vue Liste (Alt+1)">Pages</button>
                    <button data-action="toggleView" data-view="index" id="btn-view-index" class="px-2 py-0.5 rounded text-[11px] font-bold uppercase text-slate-400 transition-all" title="Vue Grappe (Alt+2)">Nexus</button>
                </div>
            </div>
        </header>

        <!-- Dynamic Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="view-pages">
                <div id="ui-filter-banner" class="hidden bg-blue-500/10 border-b border-blue-500 text-blue-300 text-xs font-bold font-mono px-3 py-2 flex justify-between items-center">
                    <span id="ui-filter-text"></span>
                    <button data-action="clearFilter" class="hover:text-white" title="Effacer Filtre">‚úï</button>
                </div>
                <div id="ui-binder-content" class="flex flex-col"></div>
            </div>
            <div id="view-index" class="hidden">
                <div id="ui-nexus-content"></div>
            </div>
        </div>
        
        <!-- PWA Install Prompt (Hidden by default) -->
        <div id="btn-install-pwa" class="hidden p-3 border-t border-white/5 bg-blue-900/10 hover:bg-blue-900/20 cursor-pointer flex items-center justify-between group" data-action="installPWA">
            <div class="flex items-center gap-2">
                <span class="text-xl">‚¨áÔ∏è</span>
                <div class="text-xs font-bold text-blue-300 group-hover:text-white">Installer l'Application</div>
            </div>
            <span class="text-[11px] font-mono text-slate-400">LOCAL.APP</span>
        </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-[#0f172a]">
        <!-- Toolbar -->
        <header class="h-12 border-b border-white/5 flex items-center justify-between px-4 shrink-0 relative z-20 bg-[#0f172a]">
            <div class="flex items-center gap-2">
                <button data-action="toggleSidebar" class="p-2 text-slate-400 hover:text-white" title="Masquer/Afficher Menu (Alt+M)"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-width="2"/></svg></button>
                <button data-action="toggleContrast" class="p-2 text-slate-400 hover:text-white" title="Inverser Couleurs (Alt+C)"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2"/></svg></button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button data-action="editorAction" data-cmd="focusStart" class="p-1.5 text-slate-400 hover:text-emerald-400" title="Aller au d√©but (Alt+Haut)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18" stroke-width="2"/></svg></button>
                <button data-action="editorAction" data-cmd="focusEnd" class="p-1.5 text-slate-400 hover:text-emerald-400" title="Aller √† la fin (Alt+Bas)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="2"/></svg></button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button data-action="insertIndex" class="p-1.5 text-blue-500/80 hover:text-blue-400 font-mono font-bold" title="Ins√©rer Index (Alt+T)">[]</button>
            </div>
            <div class="flex items-center gap-2">
                <button data-action="aiChallenge" id="ai-trigger" class="flex items-center gap-2 px-3 py-1 bg-slate-800/50 border border-slate-700 hover:border-blue-500/50 rounded transition-all group" title="G√©n√©rer Synth√®se Strat√©gique (Alt+G)">
                    <div class="w-1.5 h-1.5 rounded-full bg-slate-400 group-hover:bg-blue-400 transition-colors pointer-events-none" id="ai-pulse"></div>
                    <span class="text-[11px] font-mono font-black text-slate-400 tracking-widest group-hover:text-blue-300 pointer-events-none" id="ai-label">SYSTEM.READY</span>
                </button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button data-action="socialBroadcast" class="p-2 text-indigo-400 hover:bg-indigo-500/10 hover:text-indigo-300 rounded transition-all" title="Transmettre (Alt+B)">
                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button data-action="openReminders" id="btn-reminders" class="bell-icon p-2 hover:bg-white/5 rounded" title="Rappels (Alt+R)">
                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <div class="bell-badge"></div>
                </button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button data-action="triggerAttach" class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded transition-all" title="Joindre PDF (Alt+P)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" stroke-width="2"/></svg></button>
                <button data-action="openSearch" class="p-2 text-slate-400 hover:text-white" title="Recherche Globale (Alt+F ou Ctrl+K)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg></button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button data-action="dispatchToPage" class="p-2 text-slate-400 hover:text-emerald-400 hover:bg-emerald-500/10 rounded transition-all mr-1" title="Enregistrer dans le Classeur (Alt+Entr√©e)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" stroke-width="2"/></svg></button>
                <div class="relative">
                    <button data-action="toggleSettings" class="p-2 text-slate-400 hover:text-white transition-colors" title="Param√®tres (Alt+O)">
                        <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
                    </button>
                    <div id="ui-settings-menu" class="dropdown-menu absolute right-0 top-full mt-2 w-40 bg-[#1e293b] border border-white/10 rounded shadow-2xl z-50 flex flex-col p-1">
                        <button data-action="openHelp" class="menu-item group" title="Aide (F1)"><svg class="w-3 h-3 text-yellow-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Manuel (F1)</button>
                        <button data-action="openShortcuts" class="menu-item group" title="Liste des commandes"><svg class="w-3 h-3 text-indigo-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Raccourcis</button>
                        <div class="h-px bg-white/5 my-1"></div>
                        <button data-action="openMacroManager" class="menu-item group" title="G√©rer Macros"><span class="text-purple-400 group-hover:text-white">‚å®Ô∏è</span> Macros</button>
                        <div class="h-px bg-white/5 my-1"></div>
                        <button data-action="triggerImport" class="menu-item group" title="Importer Backup"><svg class="w-3 h-3 text-blue-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg> Import</button>
                        <button data-action="ioExport" class="menu-item group" title="Exporter Backup"><svg class="w-3 h-3 text-emerald-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2"/></svg> Backup</button>
                        <div class="h-px bg-white/5 my-1"></div>
                        <button data-action="exportToPDF" class="menu-item group" title="Exporter en PDF"><svg class="w-3 h-3 text-red-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke-width="2"/></svg> PDF Export</button>
                    </div>
                </div>
                <button id="btn-crypto" data-action="toggleEncryption" class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded transition-all ml-1" title="Chiffrement Black-Ops (Alt+X)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></button>
                <button data-action="cleanFormat" class="p-2 text-slate-400 hover:text-amber-400 hover:bg-amber-500/10 rounded transition-all ml-1" title="Nettoyer Formatage (Alt+L)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button data-action="clearDraft" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-500/10 rounded transition-all ml-1" title="Vider (Alt+Suppr)"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
            </div>
        </header>

        <!-- Editor Surface -->
        <div class="flex-1 overflow-hidden p-6 md:p-12 flex flex-col relative z-10">
            <div class="max-w-4xl mx-auto w-full editor-layer rounded-lg flex-1 overflow-hidden flex flex-col">
                <div id="canvas-container"></div>
                <div id="main-editor" contenteditable="true" class="custom-scrollbar flex-1" placeholder="Saisir donn√©es..."></div>
                <div class="h-6 bg-[#0b1120]/80 border-t border-white/5 flex items-center justify-between px-3 shrink-0 select-none z-20 backdrop-blur-sm transition-colors hover:bg-[#0b1120]">
                    <div class="flex items-center gap-4 text-[11px] font-mono font-bold tracking-wider text-slate-400">
                         <span class="flex items-center gap-1.5 text-emerald-500/60"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>LIVE</span>
                         <span class="text-slate-600">|</span>
                         <span class="text-blue-400/80 hover:text-blue-400 transition-colors cursor-help" title="Astuce : S√©lectionnez un mot et double-cliquez pour cr√©er un Tag automatiquement">MOUSE 2x: [INDEXER]</span>
                    </div>
                    <div class="flex gap-3 text-[11px] font-mono text-slate-400">
                        <span class="hover:text-slate-300 cursor-pointer transition-colors" onclick="document.execCommand('selectAll',false,null)" title="Tout s√©lectionner">SELECT.ALL</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden Inputs -->
        <input type="file" id="import-input" class="hidden" accept=".json">
        <input type="file" id="pdf-input" class="hidden" accept="application/pdf">
    </main>

    <!-- UI OVERLAYS -->
    <div id="toast" class="toast">Notif</div>

    <div id="macro-hud">
        <div class="text-[11px] font-bold text-slate-400 uppercase mb-2 border-b border-white/10 pb-1 flex justify-between">
            <span>DIRECT MACRO</span><span class="text-blue-500">READY</span>
        </div>
        <div id="ui-macro-list-hud" class="flex flex-col gap-0.5"></div>
    </div>

    <!-- SOCIAL SHARE MODAL -->
    <div id="modal-social" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#1e293b] border-2 border-indigo-500/30 w-full max-w-sm" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-indigo-900/20">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-black text-indigo-400 uppercase tracking-widest">TRANSMISSION OPS</span>
                </div>
                <button data-action="closeModals" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-4 space-y-3">
                <p class="text-xs text-slate-300 mb-4">S√©lectionnez le canal de diffusion pour le contenu actif.</p>
                <button data-action="shareTwitter" class="w-full flex items-center justify-between p-3 bg-black/30 border border-white/10 rounded hover:bg-black/50 hover:border-indigo-500 transition-all group">
                    <div class="flex items-center gap-3"><span class="text-lg">ùïè</span><div class="text-left"><div class="text-xs font-bold text-white group-hover:text-indigo-400">Twitter / X</div><div class="text-[11px] text-slate-400">Post rapide</div></div></div><span class="text-slate-400 group-hover:text-white">‚Üí</span>
                </button>
                <button data-action="shareLinkedIn" class="w-full flex items-center justify-between p-3 bg-black/30 border border-white/10 rounded hover:bg-black/50 hover:border-blue-500 transition-all group">
                    <div class="flex items-center gap-3"><span class="text-lg text-blue-500">in</span><div class="text-left"><div class="text-xs font-bold text-white group-hover:text-blue-400">LinkedIn</div><div class="text-[11px] text-slate-400">R√©seau Pro</div></div></div><span class="text-slate-400 group-hover:text-white">‚Üí</span>
                </button>
                <button data-action="copyToClipboard" class="w-full flex items-center justify-between p-3 bg-indigo-500/10 border border-indigo-500/30 rounded hover:bg-indigo-500/20 transition-all group">
                    <div class="flex items-center gap-3"><span class="text-lg">üìã</span><div class="text-left"><div class="text-xs font-bold text-indigo-300">Presse-Papier</div><div class="text-[11px] text-indigo-400/80">Copie brute</div></div></div><span class="text-indigo-500">OK</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SITREP MODAL -->
    <div id="modal-sitrep" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#0f172a] border border-blue-900/50 w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-[#0b1120]">
                <div class="flex items-center gap-2"><div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div><span class="text-xs font-black text-white uppercase tracking-widest">SITUATION REPORT</span></div>
                <button data-action="closeModals" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div class="flex border-b border-white/5">
                <button class="sitrep-tab-btn active" data-action="switchSitrepTab" data-tab="tags">Index Tactique</button>
                <button class="sitrep-tab-btn" data-action="switchSitrepTab" data-tab="time">TimeKeeper</button>
                <button class="sitrep-tab-btn" data-action="switchSitrepTab" data-tab="missions">Missions</button>
            </div>
            <div id="sitrep-content" class="p-4 overflow-y-auto custom-scrollbar h-[50vh] space-y-4"></div>
            <div id="sitrep-footer" class="hidden p-3 bg-[#0b1120] border-t border-white/5 text-[11px] text-slate-400 font-mono">Syntaxe: <span class="text-amber-400">!demain</span>, <span class="text-amber-400">!lundi</span>, <span class="text-amber-400">!25-12</span></div>
        </div>
    </div>

    <!-- ENHANCED HELP MODAL (TABBED) -->
    <div id="modal-help" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#0f172a] border border-blue-900/50 max-w-[900px] shadow-2xl flex flex-col h-[85vh] md:h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
            <!-- HEADER -->
            <div class="p-5 border-b border-white/10 bg-[#0b1120] flex justify-between items-center shrink-0">
                <div><h2 class="text-xl font-black text-white tracking-tight flex items-center gap-3"><span class="text-blue-500">///</span> MANUEL OP√âRATIONNEL <span class="text-slate-400 text-xs font-mono border border-slate-600 px-1 rounded">V2.0</span></h2></div>
                <button data-action="closeModals" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
            </div>

            <!-- TABS NAVIGATION -->
            <div class="flex border-b border-white/5 bg-[#0b1120] shrink-0">
                <button class="help-tab-btn active" data-action="switchHelpTab" data-tab="doctrine">DOCTRINE</button>
                <button class="help-tab-btn" data-action="switchHelpTab" data-tab="operations">OP√âRATIONS</button>
                <button class="help-tab-btn" data-action="switchHelpTab" data-tab="tactics">TACTIQUES</button>
                <button class="help-tab-btn" data-action="switchHelpTab" data-tab="controls">SYST√àME</button>
            </div>

            <!-- TABS CONTENT -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-[#0f172a]">
                
                <!-- TAB 1: DOCTRINE (PHILOSOPHIE) -->
                <div id="help-tab-doctrine" class="help-section space-y-8">
                     <div class="mb-4">
                         <h3 class="text-lg font-black text-white uppercase tracking-wider mb-2 border-b border-white/10 pb-2">Changement de Paradigme</h3>
                         <p class="text-sm text-slate-300 leading-relaxed">NoteLogic n'est pas un √©diteur de texte classique. C'est un **Syst√®me de Visual Ops**. Il a √©t√© con√ßu pour √©liminer la "friction organisationnelle" (le temps perdu √† chercher dans quel dossier ranger une note). Ici, vous √©crivez d'abord, le syst√®me s'organise ensuite.</p>
                     </div>

                     <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-[#1e293b] p-5 rounded border-l-2 border-blue-400 relative overflow-hidden group hover:bg-[#253248] transition-colors">
                            <h4 class="text-blue-400 font-bold text-xs uppercase mb-2 tracking-widest flex items-center gap-2"><span>1.</span> LE FLUX TENDU</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">Ouvrez l'app, tapez. Pas de titres obligatoires, pas de dossiers rigides. L'Omnibar (√©diteur unique) est un sas d'entr√©e constant. Vous saisissez "au kilom√®tre".</p>
                        </div>
                        <div class="bg-[#1e293b] p-5 rounded border-l-2 border-purple-400 relative overflow-hidden group hover:bg-[#253248] transition-colors">
                            <h4 class="text-purple-400 font-bold text-xs uppercase mb-2 tracking-widest flex items-center gap-2"><span>2.</span> L'√âMERGENCE (NEXUS)</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">Au lieu de ranger des notes dans des bo√Ætes, vous cr√©ez des **connexions**. En taguant des mots `[PROJET_X]`, l'intelligence du syst√®me cr√©e dynamiquement des grappes d'informations (Le Nexus).</p>
                        </div>
                        <div class="bg-[#1e293b] p-5 rounded border-l-2 border-emerald-400 relative overflow-hidden group hover:bg-[#253248] transition-colors">
                            <h4 class="text-emerald-400 font-bold text-xs uppercase mb-2 tracking-widest flex items-center gap-2"><span>3.</span> LOCAL-FIRST & R√âSILIENCE</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">Vos donn√©es ne quittent **jamais** votre machine (IndexedDB). Z√©ro cloud, z√©ro compte. Pour les donn√©es ultra-sensibles, le mode Black-Ops chiffre localement (AES-256).</p>
                        </div>
                        <div class="bg-[#1e293b] p-5 rounded border-l-2 border-amber-400 relative overflow-hidden group hover:bg-[#253248] transition-colors">
                            <h4 class="text-amber-400 font-bold text-xs uppercase mb-2 tracking-widest flex items-center gap-2"><span>4.</span> ACTIONNABILIT√â (SITREP)</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">Une note n'est pas une archive morte. Avec les rappels `!date` et les checklists `- [ ]`, vos notes remontent automatiquement √† la surface quand vous en avez besoin via le SITREP.</p>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: OP√âRATIONS (FEATURES & EXEMPLE) -->
                <div id="help-tab-operations" class="help-section hidden space-y-8">
                    
                    <div class="bg-blue-900/10 border border-blue-500/20 p-5 rounded-lg">
                        <h3 class="text-blue-400 font-bold text-xs uppercase tracking-widest mb-3">EXEMPLE PERTINENT : LE RAPPORT D'INTERVENTION</h3>
                        <p class="text-sm text-slate-300 mb-4">Voici comment r√©diger une note parfaite combinant toutes les syntaxes actives en une seule fois :</p>
                        <div class="bg-black/40 font-mono text-sm p-4 rounded text-slate-300 border border-white/5 whitespace-pre-wrap">Crash du serveur de production identifi√© √† 14h00.
Le client <span class="text-purple-400 font-bold bg-purple-500/10 px-1 rounded">[CORP_ALPHA]</span> a √©t√© pr√©venu. 

Le probl√®me venait de la base de donn√©es. Il faut absolument que l'√©quipe <span class="text-purple-400 font-bold bg-purple-500/10 px-1 rounded">[DEV_BACKEND]</span> revoie l'architecture <span class="text-amber-400 font-bold bg-amber-500/10 px-1 rounded">!lundi</span>.

T√¢ches post-mortem :
<span class="text-emerald-400 font-bold">‚òë</span> Restaurer le backup de la nuit.
<span class="text-slate-500">‚òê</span> Mettre √† jour la documentation d'urgence.
<span class="text-slate-500">‚òê</span> Demander un audit de s√©curit√©.</div>
                        <p class="text-xs text-slate-400 mt-3 italic">R√©sultat : Cette note liera automatiquement le client √† l'√©quipe dev dans le Nexus, cr√©era un rappel pour Lundi, et ajoutera 2 t√¢ches dans votre centre de commandement.</p>
                    </div>

                    <div class="space-y-6">
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center font-bold text-slate-300 text-lg shrink-0">/</div>
                            <div>
                                <h4 class="text-white font-bold mb-1">Le Protocole Slash (Commandes Rapides)</h4>
                                <p class="text-sm text-slate-400">Tapez `/` suivi d'un mot pour formater instantan√©ment. Ex: `/h1` (Grand titre), `/todo` (Case √† cocher), `/date` (Date du jour), `/quote` (Citation).</p>
                            </div>
                        </div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center font-bold text-slate-300 text-lg shrink-0">[]</div>
                            <div>
                                <h4 class="text-white font-bold mb-1">Indexation Neuronal (Tags)</h4>
                                <p class="text-sm text-slate-400">Entourez un mot de crochets `[tag]`. La note rejoindra ce groupe. Utilisez `Alt+S` pour voir l'activit√© globale de vos tags (Heatmap des 12 derniers mois).</p>
                            </div>
                        </div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center font-bold text-slate-300 text-lg shrink-0">!</div>
                            <div>
                                <h4 class="text-white font-bold mb-1">Le TimeKeeper (Rappels)</h4>
                                <p class="text-sm text-slate-400">Utilisez `!demain`, `!lundi`, ou `!15/12`. Le syst√®me surveille l'horloge syst√®me et allume l'ic√¥ne Cloche üîî quand une √©ch√©ance est atteinte ou d√©pass√©e.</p>
                            </div>
                        </div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center font-bold text-slate-300 text-lg shrink-0">‚òë</div>
                            <div>
                                <h4 class="text-white font-bold mb-1">Task-Ops (Checklists Interactives)</h4>
                                <p class="text-sm text-slate-400">Tapez un tiret, un espace, et des crochets vides `- [ ] ` (suivi d'un espace) : cela se transforme en case √† cocher. Retrouvez toutes vos cases vides dans le SITREP > Missions.</p>
                            </div>
                        </div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded bg-red-900/30 border border-red-500/30 flex items-center justify-center font-bold text-red-400 text-lg shrink-0">üîí</div>
                            <div>
                                <h4 class="text-white font-bold mb-1">Mode Black-Ops (Chiffrement AES-256)</h4>
                                <p class="text-sm text-slate-400">Cliquez sur l'ic√¥ne cadenas ou utilisez <code class="bg-black/40 px-1 rounded text-red-300">Alt+X</code> pour s√©curiser la note active. Elle devient totalement illisible et ind√©tectable par la recherche sans votre mot de passe ma√Ætre.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: TACTIQUES (ASTUCES) -->
                <div id="help-tab-tactics" class="help-section hidden space-y-6">
                    <h3 class="text-lg font-black text-white uppercase tracking-wider mb-2 border-b border-white/10 pb-2">Astuces de Power-User</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 border border-white/5 p-4 rounded-lg">
                            <h4 class="text-blue-400 font-bold text-xs uppercase mb-2">üëÅÔ∏è Hover Peek (Aper√ßu Tactique)</h4>
                            <p class="text-sm text-slate-300 mb-2">Laissez votre souris immobile (800ms) sur une note dans le classeur de gauche, ou sur un tag `[INDEX]` dans le texte : une bulle volante appara√Ætra pour lire le contenu sans quitter votre page !</p>
                        </div>
                        <div class="bg-black/30 border border-white/5 p-4 rounded-lg">
                            <h4 class="text-emerald-400 font-bold text-xs uppercase mb-2">üñ±Ô∏è Tagging par Double-Clic</h4>
                            <p class="text-sm text-slate-300 mb-2">Pendant la r√©daction, s√©lectionnez n'importe quel mot (double-clic) puis appuyez sur **`Alt+T`** (ou double-cliquez √† nouveau sur la s√©lection). Le mot sera instantan√©ment encapsul√© en Tag `[mot]`.</p>
                        </div>
                        <div class="bg-black/30 border border-white/5 p-4 rounded-lg">
                            <h4 class="text-amber-400 font-bold text-xs uppercase mb-2">‚å®Ô∏è Les Macros Clavier</h4>
                            <p class="text-sm text-slate-300 mb-2">Appuyez sur `Alt` pour afficher le HUD des Macros. Appuyez sur `Alt + V` pour ins√©rer le mot "[VENTE]". Vous pouvez configurer des paragraphes entiers (templates) via le menu Param√®tres > Macros.</p>
                        </div>
                        <div class="bg-black/30 border border-white/5 p-4 rounded-lg">
                            <h4 class="text-purple-400 font-bold text-xs uppercase mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è Le Mode Stealth (Focus)</h4>
                            <p class="text-sm text-slate-300 mb-2">Besoin de vous concentrer ? Appuyez sur **`Alt+Z`**. Toute l'interface dispara√Æt. Il ne reste que vous et votre texte au centre d'un √©cran sombre. R√©appuyez pour revenir au mode standard.</p>
                        </div>
                        <div class="bg-black/30 border border-white/5 p-4 rounded-lg md:col-span-2 flex items-center gap-4">
                            <div class="text-4xl">üìå</div>
                            <div>
                                <h4 class="text-indigo-400 font-bold text-xs uppercase mb-1">√âpinglage Strat√©gique</h4>
                                <p class="text-sm text-slate-300">Survolez une note dans le classeur √† gauche et cliquez sur la petite ic√¥ne de signet. La note restera fix√©e d√©finitivement tout en haut de la liste, prot√©g√©e de l'enfouissement chronologique. Parfait pour vos mots de passe ou tableaux de bord.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: SYST√àME & CONTROLES -->
                <div id="help-tab-controls" class="help-section hidden space-y-8">
                      <!-- STORAGE DIAGNOSTICS -->
                      <div class="bg-white/5 p-4 rounded border border-white/5 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-[11px] font-bold text-blue-300 uppercase tracking-widest">Moniteur de Stockage Local</h4>
                            <span id="storage-persist-badge" class="persistence-badge inactive">Non Persistant</span>
                        </div>
                        <div class="text-[11px] text-slate-300 flex justify-between font-mono mb-1">
                            <span id="storage-used">Calcul...</span>
                            <span id="storage-quota">Calcul...</span>
                        </div>
                        <div class="storage-bar-bg">
                            <div id="storage-bar" class="storage-bar-fill"></div>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                             <p class="text-[11px] text-slate-400 italic max-w-[70%]">Les navigateurs peuvent effacer les donn√©es si l'espace manque. Exportez des Backups r√©guliers (.json) depuis le menu.</p>
                             <button data-action="pruneAttachments" class="px-3 py-1 bg-red-900/30 text-red-400 border border-red-500/30 text-[11px] font-bold rounded hover:bg-red-900/50 transition-all uppercase">Purger Attachments</button>
                        </div>
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest border-b border-white/5 pb-1 mb-4">Commandes Op√©rationnelles</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Nouvelle Note</span><span class="font-mono text-xs text-blue-400 bg-blue-500/10 px-1.5 py-0.5 rounded border border-blue-500/20">Alt + N</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Enregistrer (Dispatch)</span><span class="font-mono text-xs text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">Alt + Entr√©e</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Palette / Recherche</span><span class="font-mono text-xs text-slate-400 bg-white/5 px-1.5 py-0.5 rounded">Alt + F ou Ctrl+K</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">SITREP (Tableau de bord)</span><span class="font-mono text-xs text-slate-400 bg-white/5 px-1.5 py-0.5 rounded">Alt + S</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Chiffrement Black-Ops</span><span class="font-mono text-xs text-red-400 bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20">Alt + X</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Vider le brouillon</span><span class="font-mono text-xs text-red-400 bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20">Alt + Suppr</span></div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest border-b border-white/5 pb-1 mb-4">Mise en Forme & Vues</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Ins√©rer Index []</span><span class="font-mono text-xs text-purple-400 bg-white/5 px-1.5 py-0.5 rounded">Alt + T</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Menu Slash</span><span class="font-mono text-xs text-slate-400 bg-white/5 px-1.5 py-0.5 rounded">Touche " / "</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Mode Focus (Stealth)</span><span class="font-mono text-xs text-slate-400 bg-white/5 px-1.5 py-0.5 rounded">Alt + Z</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Analyse S√©mantique IA</span><span class="font-mono text-xs text-amber-400 bg-amber-500/10 px-1.5 py-0.5 rounded">Alt + G</span></div>
                                <div class="flex justify-between items-center group"><span class="text-slate-300">Basculer Vue Pages/Nexus</span><span class="font-mono text-xs text-slate-400 bg-white/5 px-1.5 py-0.5 rounded">Alt + 1 / Alt + 2</span></div>
                            </div>
                        </div>
                      </div>
                      
                      <!-- DANGER ZONE -->
                      <div class="border border-red-900/50 rounded p-4 mt-6 bg-red-900/10">
                          <h4 class="text-[11px] font-bold text-red-400 uppercase tracking-widest mb-3">Zone de Danger</h4>
                          <div class="flex gap-4">
                              <button data-action="ioExport" class="flex-1 text-center bg-white/5 hover:bg-white/10 text-xs font-bold py-2 rounded border border-white/10 transition-all">Export Backup (JSON)</button>
                              <button data-action="hardReset" class="flex-1 text-center bg-red-500/20 hover:bg-red-500/40 text-red-300 text-xs font-bold py-2 rounded border border-red-500/30 transition-all">Hard Reset (Nuke DB)</button>
                          </div>
                      </div>
                </div>

            </div>
        </div>
    </div>

    <!-- COMMAND PALETTE / SEARCH MODAL -->
    <div id="modal-search" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#1e293b] border border-white/10 shadow-2xl rounded-lg overflow-hidden max-w-[600px] flex flex-col" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/5 flex items-center gap-3 bg-[#0b1120]">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg>
                <input type="text" id="search-input" class="w-full bg-transparent text-white text-lg outline-none font-medium placeholder-slate-400" placeholder="Rechercher ou taper '>' pour les commandes..." autocomplete="off">
                <span class="text-[11px] font-mono text-slate-400 border border-slate-500 px-1.5 rounded">ESC</span>
            </div>
            <div id="search-results" class="overflow-y-auto custom-scrollbar h-[50vh] bg-[#1e293b]">
                <!-- Results dynamically loaded -->
            </div>
            <div class="px-3 py-2 bg-[#0b1120] border-t border-white/5 flex justify-between items-center text-[11px] text-slate-400 font-mono">
                <div class="flex gap-3"><span class="flex items-center gap-1"><span class="bg-white/10 px-1 rounded">‚Üë</span><span class="bg-white/10 px-1 rounded">‚Üì</span> Naviguer</span><span class="flex items-center gap-1"><span class="bg-white/10 px-1 rounded">‚Üµ</span> Ex√©cuter / Ouvrir</span></div><span id="search-count">0 r√©sultats</span>
            </div>
        </div>
    </div>
    
    <!-- MACRO MODAL -->
    <div id="modal-macros" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#1e293b] max-w-lg" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-black/20"><span class="text-xs font-bold text-white uppercase">Gestionnaire de Macros</span><button data-action="closeModals" class="text-slate-400 hover:text-white">‚úï</button></div>
            <div id="ui-macro-manager-list" class="p-4 overflow-y-auto custom-scrollbar h-[35vh] space-y-1 bg-[#0b1120]"></div>
            <div class="p-4 border-t border-white/5 bg-[#1e293b] flex flex-col gap-3">
                <div class="flex justify-between items-center"><span class="text-xs font-bold text-blue-400 uppercase tracking-wider">Nouvelle Macro</span></div>
                <div class="flex gap-2"><div class="w-24 flex flex-col gap-1"><label class="text-[11px] text-slate-400 font-mono uppercase font-bold">Touche</label><input id="new-macro-key" type="text" class="w-full bg-black/30 border border-white/10 rounded px-2 py-2 text-center font-mono text-blue-400 font-bold outline-none uppercase text-lg" placeholder="Ex: G,H"></div><div class="flex-1 flex flex-col gap-1"><label class="text-[11px] text-slate-400 font-mono uppercase font-bold">Contenu (Rich Text/HTML)</label><div id="new-macro-val" contenteditable="true" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-xs text-slate-300 outline-none font-mono custom-scrollbar focus:border-blue-500/50 transition-colors h-24 overflow-y-auto" placeholder="Collez contenu riche..."></div></div></div>
                <button data-action="addMacro" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded uppercase tracking-widest transition-colors shadow-lg shadow-blue-900/20">Enregistrer Macro</button>
            </div>
        </div>
    </div>

    <!-- CRYPTO MODAL (BLACK-OPS) -->
    <div id="modal-crypto" class="modal-overlay" data-action="closeModals">
        <div class="modal-box bg-[#0f172a] border border-red-900/50 max-w-sm" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-red-900/20">
                <span class="text-xs font-black text-red-400 uppercase tracking-widest flex items-center gap-2">üîí PROTOCOLE BLACK-OPS</span>
                <button data-action="closeModals" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-5 flex flex-col gap-4">
                <p id="crypto-msg" class="text-xs text-slate-300">Saisissez le mot de passe cryptographique.</p>
                <input type="password" id="crypto-input" class="w-full bg-black/50 border border-red-500/30 rounded px-3 py-2 text-white outline-none focus:border-red-500 font-mono text-center tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
                <button data-action="submitCrypto" class="w-full py-2 bg-red-600/80 hover:bg-red-500 text-white text-xs font-bold rounded uppercase tracking-widest transition-colors shadow-lg shadow-red-900/20">Autoriser</button>
            </div>
        </div>
    </div>

    <!-- CONTEXTUAL FORMATTING BAR -->
    <div id="selection-toolbar" class="fixed z-[100] bg-[#1e293b] border border-white/10 shadow-2xl rounded-lg px-1 py-1 flex gap-1 items-center backdrop-blur-md">
        <button data-action="formatBold" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-slate-300 font-bold" title="Gras">B</button>
        <button data-action="formatItalic" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-slate-300 italic font-serif" title="Italique">I</button>
        <div class="w-px h-5 bg-white/10 mx-1"></div>
        <button data-action="formatTag" class="w-8 h-8 flex items-center justify-center hover:bg-purple-500/20 rounded text-purple-400 font-mono font-bold text-xs" title="Taguer []">[]</button>
        <button data-action="formatTime" class="w-8 h-8 flex items-center justify-center hover:bg-amber-500/20 rounded text-amber-400 font-mono font-bold" title="Rappel !">!</button>
    </div>

    <!-- MOBILE FAB (FLOATING ACTION BUTTON) -->
    <div id="mobile-fab" class="fixed bottom-6 right-6 z-50 md:hidden flex flex-col-reverse items-end gap-3">
        <button data-action="toggleFab" id="fab-main" class="w-14 h-14 bg-blue-600 rounded-full shadow-lg shadow-blue-900/50 flex items-center justify-center text-white text-3xl transition-all duration-300">
            +
        </button>
        <div id="fab-menu" class="flex flex-col gap-3 opacity-0 pointer-events-none transition-all duration-300 translate-y-4 origin-bottom">
            <button data-action="newPage" class="w-12 h-12 bg-[#1e293b] border border-blue-500/30 rounded-full shadow-lg flex items-center justify-center text-blue-400 hover:bg-white/5" title="Nouvelle Note">
                <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
            <button data-action="triggerSitrep" class="w-12 h-12 bg-[#1e293b] border border-emerald-500/30 rounded-full shadow-lg flex items-center justify-center text-emerald-400 hover:bg-white/5" title="SITREP">
                <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            </button>
            <button data-action="aiChallenge" class="w-12 h-12 bg-[#1e293b] border border-amber-500/30 rounded-full shadow-lg flex items-center justify-center text-amber-400 hover:bg-white/5" title="Analyse IA">
                <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- HOVER PEEK TOOLTIP -->
    <div id="hover-peek">
        <div class="peek-title"></div>
        <div class="peek-content"></div>
    </div>

    <!-- SLASH MENU -->
    <div id="slash-menu"></div>

    <script>
        const System = (() => {
            const CONFIG = { 
                DB_NAME: "AgenData_V9", 
                DB_VERSION: 4, 
                ANIMATION: { particles: 600, range: 400 }, 
                MACROS_DEFAULT: { 'a': '[ACHAT]', 'v': '[VENTE]', 'w': '‚ö†Ô∏è [WARNING]', 'i': '[INFO]', 'u': '[URGENT]' }
            };
            
            // --- CORE DECLARATION ---
            let Bus; 

            const State = new Proxy({ currentPageId: null, isReadMode: false, activeTagFilter: null, macros: { ...CONFIG.MACROS_DEFAULT }, recognition: null, isRecording: false, deferredPrompt: null, searchIndex: -1, searchResults: [], chordBuffer: [], chordTimer: null, slash: { active: false, query: '', index: 0, results: [] }, unlockedNotes: {}, cryptoContext: null }, {
                set(target, prop, value) {
                    target[prop] = value;
                    if (prop === 'isReadMode' && Bus) Bus.emit('mode:changed', value);
                    if (prop === 'macros' && Renderer) Renderer.renderHUD(value);
                    return true;
                }
            });

            const TimeEngine = {
                parse(text) {
                    const clean = text.toLowerCase().trim(); const now = new Date(); const oneDay = 86400000;
                    if(clean === 'aujourdhui' || clean === 'ajd') return now; if(clean === 'demain') return new Date(now.getTime() + oneDay); if(clean === 'apres-demain') return new Date(now.getTime() + (oneDay*2));
                    const days = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi']; const targetDayIndex = days.indexOf(clean);
                    if(targetDayIndex !== -1) { const currentDayIndex = now.getDay(); let diff = targetDayIndex - currentDayIndex; if(diff <= 0) diff += 7; return new Date(now.getTime() + (diff * oneDay)); }
                    const relMatch = clean.match(/^\+(\d+)j$/); if(relMatch) return new Date(now.getTime() + (parseInt(relMatch[1]) * oneDay));
                    const dateMatch = clean.match(/^(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?$/);
                    if(dateMatch) { const d = parseInt(dateMatch[1]); const m = parseInt(dateMatch[2]) - 1; const y = dateMatch[3] ? (dateMatch[3].length === 2 ? 2000 + parseInt(dateMatch[3]) : parseInt(dateMatch[3])) : now.getFullYear(); const target = new Date(y, m, d); if(!dateMatch[3] && target < now && target.toDateString() !== now.toDateString()) target.setFullYear(y + 1); return target; }
                    return null;
                },
                format(date) { return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }); },
                isToday(date) { const now = new Date(); return date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear(); },
                isOverdue(date) { const now = new Date(); now.setHours(0,0,0,0); const d = new Date(date); d.setHours(0,0,0,0); return d < now; }
            };
            
            const CryptoEngine = {
                _buf2b64(buffer) { let binary = ''; const bytes = new Uint8Array(buffer); for (let i = 0; i < bytes.byteLength; i++) { binary += String.fromCharCode(bytes[i]); } return window.btoa(binary); },
                _b642buf(base64) { const binary_string = window.atob(base64); const bytes = new Uint8Array(binary_string.length); for (let i = 0; i < binary_string.length; i++) { bytes[i] = binary_string.charCodeAt(i); } return bytes.buffer; },
                async deriveKey(password, salt) {
                    const enc = new TextEncoder();
                    const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
                    return crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
                },
                async encrypt(text, password) {
                    const enc = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const key = await this.deriveKey(password, salt);
                    const cipherBuffer = await crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, key, enc.encode(text));
                    return JSON.stringify({ c: this._buf2b64(cipherBuffer), s: this._buf2b64(salt), i: this._buf2b64(iv), enc: true });
                },
                async decrypt(jsonStr, password) {
                    const data = JSON.parse(jsonStr);
                    if (!data.enc) return jsonStr;
                    const salt = this._b642buf(data.s);
                    const iv = this._b642buf(data.i);
                    const cipher = this._b642buf(data.c);
                    const key = await this.deriveKey(password, salt);
                    const plainBuffer = await crypto.subtle.decrypt({name: "AES-GCM", iv: new Uint8Array(iv)}, key, cipher);
                    return new TextDecoder().decode(plainBuffer);
                }
            };

            const Social = {
                getContentToShare() { const editor = document.getElementById('main-editor'); if (!editor.innerText.trim()) return null; const rawText = editor.innerText; const lines = rawText.split('\n').filter(l => l.trim()); const title = lines[0] || "Note"; return { title, text: rawText, url: window.location.href }; },
                async broadcast() { const data = this.getContentToShare(); if (!data) { Renderer.toast("NOTE VIDE"); return; } if (navigator.share) { try { await navigator.share(data); Renderer.toast("TRANSMISSION OK"); } catch (err) { console.log("Share skipped/error", err); } } else { document.getElementById('modal-social').style.display = 'flex'; } },
                twitter() { const data = this.getContentToShare(); if(!data) return; window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(data.text.substring(0, 280))}`, '_blank'); Bus.dispatchAction('closeModals'); },
                linkedin() { window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`, '_blank'); Bus.dispatchAction('closeModals'); },
                clipboard() { const data = this.getContentToShare(); if(!data) return; navigator.clipboard.writeText(data.text).then(() => { Renderer.toast("COPI√â DANS LE PRESSE-PAPIER"); Bus.dispatchAction('closeModals'); }); }
            };

            const Storage = {
                db: null,
                manager: {
                    async init() {
                        if (navigator.storage && navigator.storage.persist) {
                            const isPersisted = await navigator.storage.persist();
                            this.updateBadge(isPersisted);
                        }
                        this.updateUsage();
                        setInterval(() => this.updateUsage(), 30000); // Check every 30s
                    },
                    updateBadge(isPersisted) {
                        const el = document.getElementById('storage-persist-badge');
                        if(isPersisted) { el.classList.remove('inactive'); el.classList.add('active'); el.textContent = "PERSISTANT (S√âCURIS√â)"; }
                        else { el.classList.remove('active'); el.classList.add('inactive'); el.textContent = "NON PERSISTANT"; }
                    },
                    async updateUsage() {
                        if (navigator.storage && navigator.storage.estimate) {
                            const {usage, quota} = await navigator.storage.estimate();
                            const usedMB = (usage / (1024 * 1024)).toFixed(1);
                            const quotaMB = (quota / (1024 * 1024)).toFixed(0);
                            const percent = (usage / quota) * 100;
                            
                            document.getElementById('storage-used').textContent = `${usedMB} MB utilis√©s`;
                            document.getElementById('storage-quota').textContent = `${quotaMB} MB disponibles`;
                            
                            const bar = document.getElementById('storage-bar');
                            bar.style.width = `${Math.max(percent, 1)}%`;
                            
                            bar.classList.remove('warning', 'critical');
                            if(percent > 80 || usage > 500 * 1024 * 1024) bar.classList.add('critical');
                            else if(percent > 50) bar.classList.add('warning');

                            if (usage > 500 * 1024 * 1024) Renderer.toast("‚ö†Ô∏è STOCKAGE √âLEV√â (>500MB)");
                        }
                    },
                    async pruneAttachments() {
                        if(confirm("Supprimer toutes les pi√®ces jointes (PDF/Images) pour lib√©rer de l'espace ? Les notes textuelles seront conserv√©es.")) {
                            await Storage.db.attachments.clear();
                            this.updateUsage();
                            Renderer.toast("INCIN√âRATION TERMIN√âE");
                        }
                    }
                },
                async init() { 
                    this.db = new Dexie(CONFIG.DB_NAME); 
                    this.db.version(4).stores({ pages: "++id, title, updated", meta: "id", macros: "trigger", attachments: "++id, name, type" }); 
                    await this.loadMacros(); 
                    await this.loadDraft(); 
                    this.manager.init();
                },
                async loadDraft() { const d = await this.db.meta.get('draft'); if(d) document.getElementById('main-editor').innerHTML = Renderer.processContent(d.content); },
                async saveDraft(c, force = false) { 
                    if(!force && State.currentPageId) {
                        const p = await this.getPage(State.currentPageId);
                        if(p && p.encrypted) return; 
                    }
                    await this.db.meta.put({id: 'draft', content: c}); 
                },
                async getPages() { 
                    const all = await this.db.pages.toArray();
                    return all.sort((a,b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        return b.updated - a.updated;
                    });
                },
                async togglePinPage(id) {
                    const page = await this.getPage(id);
                    if (page) await this.db.pages.update(parseInt(id), { pinned: !page.pinned });
                },
                async getPage(id) { return await this.db.pages.get(parseInt(id)); },
                async findPageByTitle(t) { return await this.db.pages.where('title').equals(t).first(); },
                async createPage(title, content) { await this.db.pages.add({ title, content, updated: Date.now() }); },
                async updatePage(id, content) { await this.db.pages.update(parseInt(id), { content, updated: Date.now() }); },
                async deletePage(id) { await this.db.pages.delete(parseInt(id)); },
                async saveAttachment(file) { const id = await this.db.attachments.add({ name: file.name, type: file.type, data: file, created: Date.now() }); this.manager.updateUsage(); return id; },
                async getAttachment(id) { return await this.db.attachments.get(parseInt(id)); },
                async nuke() { await this.db.delete(); location.reload(); },
                async loadMacros() { const s = await this.db.macros.toArray(); if(s.length===0) await this.db.macros.bulkPut(Object.entries(CONFIG.MACROS_DEFAULT).map(([k,v])=>({trigger:k,content:v}))); else { const m={}; s.forEach(x=>m[x.trigger]=x.content); State.macros=m; } },
                async addMacro(t,c) { await this.db.macros.put({trigger:t,content:c}); await this.loadMacros(); },
                async removeMacro(t) { await this.db.macros.delete(t); await this.loadMacros(); }
            };

            const Renderer = {
                processContent(html) { 
                    const div = document.createElement('div'); div.innerHTML = html;
                    div.querySelectorAll('.nexus-index, .chrono-tag').forEach(el => { const text = document.createTextNode(el.innerText); el.parentNode.replaceChild(text, el); });
                    const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false); const nodesToReplace = [];
                    while(walker.nextNode()) { const node = walker.currentNode; const hasTag = node.nodeValue && node.nodeValue.match(/\[[a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+\]/); const hasTime = node.nodeValue && node.nodeValue.match(/!([a-zA-Z0-9\+\-\/]+)/); const hasTask = node.nodeValue && node.nodeValue.match(/-\s*\[[ xX]*\]/); if(hasTag || hasTime || hasTask) { if(node.parentElement.tagName !== 'SCRIPT' && node.parentElement.tagName !== 'STYLE') nodesToReplace.push(node); } }
                    nodesToReplace.forEach(node => { const fragment = document.createDocumentFragment(); const parts = node.nodeValue.split(/(\[[a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+\]|![a-zA-Z0-9\+\-\/]+|-\s*\[[ xX]*\])/g); parts.forEach(part => { if(part.match(/^\[[a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+\]$/)) { if(part.match(/^\[(\d+(?:px|%|rem|em|vw|vh)|#[0-9a-fA-F]{3,6})\]$/)) { fragment.appendChild(document.createTextNode(part)); } else { const span = document.createElement('span'); span.className = 'nexus-index'; span.dataset.action = 'openNexus'; span.dataset.tag = part.replace(/[\[\]]/g, ''); span.textContent = part; fragment.appendChild(span); } } else if (part.match(/^![a-zA-Z0-9\+\-\/]+$/)) { const span = document.createElement('span'); span.className = 'chrono-tag'; const parsedDate = TimeEngine.parse(part.substring(1)); if(parsedDate && TimeEngine.isOverdue(parsedDate) && !TimeEngine.isToday(parsedDate)) span.classList.add('overdue'); span.textContent = part; fragment.appendChild(span); } else if (part.match(/^-\s*\[[ xX]*\]$/)) { const isChecked = part.toLowerCase().includes('x'); const input = document.createElement('input'); input.type = 'checkbox'; input.className = 'task-box'; input.contentEditable = 'false'; if(isChecked) input.setAttribute('checked', 'checked'); fragment.appendChild(input); fragment.appendChild(document.createTextNode(' ')); } else { fragment.appendChild(document.createTextNode(part)); } }); node.parentNode.replaceChild(fragment, node); });
                    return div.innerHTML;
                },
                toast(msg) { const el=document.getElementById('toast'); el.textContent=msg; el.style.opacity="1"; setTimeout(()=>el.style.opacity="0",2000); },
                renderHUD(macros) { const strip = (html) => { const tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }; document.getElementById('ui-macro-list-hud').innerHTML = Object.entries(macros).map(([k,v]) => { const plain = strip(v); const display = plain.length > 20 ? plain.substring(0,20) + '...' : plain; return `<div class="hud-row"><span class="font-mono text-blue-400 font-bold text-xs mr-4">Alt+${k.toUpperCase()}</span><span class="font-mono text-slate-400 text-xs">${display}</span></div>`; }).join(''); },
                renderMacroManager() { const strip = (html) => { const tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }; document.getElementById('ui-macro-manager-list').innerHTML = Object.entries(State.macros).map(([k,v]) => { const plain = strip(v); const display = plain.replace(/\n/g, ' ‚Üµ ').substring(0, 50) + (plain.length > 50 ? '...' : ''); return `<div class="flex justify-between items-center bg-white/5 p-2 rounded mb-1 border border-white/5 hover:border-blue-500/30 transition-colors"><div class="flex items-center overflow-hidden"><span class="font-mono text-xs text-blue-300 font-black bg-blue-900/30 px-1.5 py-0.5 rounded mr-3 w-6 text-center block">${k.toUpperCase()}</span><span class="font-mono text-xs text-slate-300 truncate opacity-80" title="Contenu Riche">${display}</span></div><button data-action="removeMacro" data-trigger="${k}" class="text-slate-400 hover:text-red-400 px-2 transition-colors">√ó</button></div>`; }).join(''); },
                toggleViewBtn(view) { document.getElementById('btn-view-pages').classList.toggle('view-btn-active', view === 'pages'); document.getElementById('btn-view-pages').classList.toggle('text-slate-400', view !== 'pages'); document.getElementById('btn-view-index').classList.toggle('view-btn-active', view === 'index'); document.getElementById('btn-view-index').classList.toggle('text-slate-400', view !== 'index'); },
                renderSearchResults(results, selectedIndex) {
                    const container = document.getElementById('search-results'); document.getElementById('search-count').textContent = `${results.length} r√©sultats`;
                    if(results.length === 0) { container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-400 space-y-2 opacity-60 p-6"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg><p class="text-sm">Aucune correspondance</p></div>'; return; }
                    
                    container.innerHTML = results.map((r, i) => { 
                        const isSelected = i === selectedIndex ? 'selected' : ''; 
                        
                        if (r.type === 'command') {
                            return `<div class="search-result-item search-cmd-item ${isSelected}" data-index="${i}" data-action="executeCommand" data-cmd="${r.action}">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">${r.icon}</span>
                                    <div>
                                        <div class="text-sm font-bold ${isSelected ? 'text-white' : 'text-purple-300'} pointer-events-none">${r.title}</div>
                                        <div class="text-[11px] text-slate-400 font-mono pointer-events-none">${r.snippet}</div>
                                    </div>
                                </div>
                            </div>`;
                        } else {
                            const tagMatch = r.rawContent.match(/\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/g) || []; 
                            const tags = tagMatch.slice(0, 3).map(t => `<span class="search-tag">${t}</span>`).join(''); 
                            return `<div class="search-result-item ${isSelected}" data-index="${i}" data-action="openPage" data-id="${r.id}">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-sm font-bold ${isSelected ? 'text-white' : 'text-slate-200'} pointer-events-none">${r.title}</span>
                                    <span class="text-[11px] text-slate-400 font-mono pointer-events-none">${Engine.utils.formatDate(r.updated)}</span>
                                </div>
                                <div class="text-xs text-slate-400 font-mono leading-relaxed line-clamp-2 pointer-events-none">${r.snippet}</div>
                                ${tags ? `<div class="mt-2 flex pointer-events-none">${tags}</div>` : ''}
                            </div>`; 
                        }
                    }).join('');
                    
                    const selectedEl = container.querySelector('.selected'); if(selectedEl) selectedEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            };

            const Engine = {
                utils: { formatDate: d => { const date = new Date(d); const now = new Date(); const diff = (now - date) / 1000; if(diff < 60) return "√Ä l'instant"; if(diff < 3600) return `Il y a ${Math.floor(diff/60)} min`; if(diff < 86400) return `Il y a ${Math.floor(diff/3600)} h`; return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); }, debounce: (fn,ms) => { let t; return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);} }, escapeRegExp: (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') },
                gfx: { init() { const c = document.getElementById('canvas-container'); if(!c) return; const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x0f172a, 0.002); const camera = new THREE.PerspectiveCamera(75, c.clientWidth/c.clientHeight, 0.1, 1000); camera.position.z=100; const renderer = new THREE.WebGLRenderer({alpha:true}); renderer.setSize(c.clientWidth,c.clientHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)); c.appendChild(renderer.domElement); const geo = new THREE.BufferGeometry(); const pos = new Float32Array(CONFIG.ANIMATION.particles*3); for(let i=0;i<CONFIG.ANIMATION.particles*3;i++) pos[i]=(Math.random()-0.5)*CONFIG.ANIMATION.range; geo.setAttribute('position',new THREE.BufferAttribute(pos,3)); const parts = new THREE.Points(geo, new THREE.PointsMaterial({size:1.5,color:0x3b82f6,transparent:true,opacity:0.6})); scene.add(parts); const anim = () => { if(!document.hidden) { parts.rotation.y+=0.0005; parts.rotation.x+=0.0002; renderer.render(scene,camera); } requestAnimationFrame(anim); }; anim(); } }
            };

            const Intelligence = {
                // COMMAND PALETTE DEFINITIONS
                COMMANDS: [
                    { id: 'cmd_new', title: 'Nouvelle Note', desc: 'Cr√©er une note vierge', icon: 'üìù', action: 'newPage', keys: 'nouveau,new,creer,note,>nouvelle' },
                    { id: 'cmd_zen', title: 'Mode Focus / Stealth', desc: 'Masquer toute l\'interface (Alt+Z)', icon: 'üëÅÔ∏è', action: 'toggleZenMode', keys: 'zen,focus,stealth,immersion,>zen' },
                    { id: 'cmd_sitrep', title: 'Rapport Strat√©gique (SITREP)', desc: 'Ouvrir le tableau de bord global', icon: 'üì°', action: 'triggerSitrep', keys: 'sitrep,dashboard,rapport,index,>sitrep' },
                    { id: 'cmd_ai', title: 'Analyse IA', desc: 'G√©n√©rer une synth√®se strat√©gique', icon: 'ü§ñ', action: 'aiChallenge', keys: 'ia,ai,analyse,synthese,>analyse' },
                    { id: 'cmd_pdf', title: 'Exporter PDF', desc: 'G√©n√©rer un PDF de la note active', icon: 'üìÑ', action: 'exportToPDF', keys: 'pdf,export,imprimer,>export' },
                    { id: 'cmd_backup', title: 'Backup Complet', desc: 'Sauvegarder les donn√©es (JSON)', icon: '‚¨áÔ∏è', action: 'ioExport', keys: 'backup,sauvegarde,export,json,>backup' },
                    { id: 'cmd_import', title: 'Importer Backup', desc: 'Restaurer depuis un fichier JSON', icon: '‚¨ÜÔ∏è', action: 'triggerImport', keys: 'import,restaurer,>import' },
                    { id: 'cmd_macros', title: 'Gestionnaire de Macros', desc: 'Configurer les raccourcis texte', icon: '‚å®Ô∏è', action: 'openMacroManager', keys: 'macro,raccourcis,automatisation,>macros' },
                    { id: 'cmd_clean', title: 'Nettoyer Formatage', desc: 'Purger les styles complexes', icon: 'üßπ', action: 'cleanFormat', keys: 'clean,nettoyer,format,purger,>nettoyer' },
                    { id: 'cmd_help', title: 'Manuel Op√©rationnel', desc: 'Ouvrir l\'aide', icon: '‚ùì', action: 'openHelp', keys: 'aide,help,manuel,tuto,>aide' },
                    { id: 'cmd_attach', title: 'Joindre PDF', desc: 'Attacher un document √† la note', icon: 'üìé', action: 'triggerAttach', keys: 'joindre,attach,pdf,fichier,>joindre' },
                ],
                async sitrep(tab = 'tags') {
                    const contentDiv = document.getElementById('sitrep-content'); const footerDiv = document.getElementById('sitrep-footer'); const tabs = document.querySelectorAll('.sitrep-tab-btn');
                    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab)); contentDiv.innerHTML = '';
                    const pages = await Storage.getPages();
                    if(tab === 'tags') {
                        footerDiv.classList.add('hidden'); 
                        const tagMap = {}; 
                        const orphans = []; // Array for dead drops
                        const tagRegex = /\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/g;
                        const dateRegex = /!([a-zA-Z0-9\+\-\/]+)/g;

                        pages.forEach(page => { 
                            const div = document.createElement('div'); div.innerHTML = page.content; div.querySelectorAll('.ai-insight-panel').forEach(el => el.remove()); const text = div.innerText; 
                            
                            let hasTags = false;
                            let match; 
                            
                            // Check for tags
                            while ((match = tagRegex.exec(text)) !== null) { 
                                const tag = match[1]; 
                                if (tag.match(/^(\d+(?:px|%|rem|em)|#[0-9a-f]+)$/)) continue; 
                                
                                hasTags = true;
                                if (!tagMap[tag]) tagMap[tag] = []; 
                                if (!tagMap[tag].find(p => p.pageId === page.id)) tagMap[tag].push({ pageId: page.id, title: page.title, updated: page.updated }); 
                            }
                            
                            // Check for dates (simple regex check is enough for boolean)
                            const hasDates = /!([a-zA-Z0-9\+\-\/]+)/.test(text);

                            if (!hasTags && !hasDates) {
                                orphans.push(page);
                            }
                        });

                        // Rendering
                        let html = '';
                        
                        // 1. Render Orphans First
                        if (orphans.length > 0) {
                            const orphanHtml = orphans.map(i => `<div class="sitrep-item" style="border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.05);" data-action="openPage" data-id="${i.id}"><span class="sitrep-page-title pointer-events-none text-red-300">${i.title}</span><span class="sitrep-source pointer-events-none text-red-400">ORPHELIN</span></div>`).join('');
                            html += `<div class="sitrep-group" style="border-color: rgba(239, 68, 68, 0.3);"><div class="sitrep-group-title" style="background: rgba(239, 68, 68, 0.1); color: #fca5a5;"><span>‚ö†Ô∏è NON-CLASS√â</span><span class="text-red-500">${orphans.length}</span></div><div>${orphanHtml}</div></div>`;
                        }

                        // --- HEATMAP LOGIC START ---
                        const now = Date.now();
                        const hotThreshold = 48 * 60 * 60 * 1000; // 48h in ms

                        // Helper to get most recent updated time for a tag
                        const getFreshness = (tag) => {
                            return Math.max(...tagMap[tag].map(p => p.updated));
                        };

                        // Sort tags by freshness (descending) instead of alphabetical
                        const sortedTags = Object.keys(tagMap).sort((a, b) => getFreshness(b) - getFreshness(a));

                        if (sortedTags.length === 0 && orphans.length === 0) { 
                            contentDiv.innerHTML = '<div class="p-8 text-center text-slate-400 text-sm italic">Aucun index d√©tect√©.</div>'; 
                        } else { 
                            sortedTags.forEach(tag => { 
                                const items = tagMap[tag]; 
                                // Sort items within tag by update time as well
                                items.sort((a,b) => b.updated - a.updated);

                                const lastActive = getFreshness(tag);
                                const isHot = (now - lastActive) < hotThreshold;

                                let groupStyle = '';
                                let titleStyle = '';
                                let countClass = 'text-blue-500/50';
                                let hotIcon = '';

                                if (isHot) {
                                    groupStyle = 'border-color: rgba(251, 191, 36, 0.3);'; // Amber border
                                    titleStyle = 'background: rgba(251, 191, 36, 0.1); color: #fbbf24;'; // Amber bg/text
                                    countClass = 'text-amber-500';
                                    hotIcon = ' <span class="animate-pulse ml-1 text-amber-500">üî•</span>';
                                } else {
                                     // Default blue style handled by CSS, but we can be explicit if needed
                                }

                                const itemsHtml = items.map(i => `<div class="sitrep-item" data-action="openPage" data-id="${i.pageId}"><span class="sitrep-page-title pointer-events-none">${i.title}</span><span class="sitrep-source pointer-events-none">${Engine.utils.formatDate(i.updated)}</span></div>`).join(''); 
                                
                                html += `<div class="sitrep-group" style="${groupStyle}"><div class="sitrep-group-title" style="${titleStyle}"><span>[${tag}]${hotIcon}</span><span class="${countClass}">${items.length}</span></div><div>${itemsHtml}</div></div>`; 
                            }); 
                            contentDiv.innerHTML = html; 
                        }
                        // --- HEATMAP LOGIC END ---
                    } else if (tab === 'time') {
                        footerDiv.classList.remove('hidden'); const reminders = []; const today = new Date(); today.setHours(0,0,0,0);
                        pages.forEach(page => { const div = document.createElement('div'); div.innerHTML = page.content; const text = div.innerText; const regex = /!([a-zA-Z0-9\+\-\/]+)/g; let match; while ((match = regex.exec(text)) !== null) { const date = TimeEngine.parse(match[1]); if(date) { const checkDate = new Date(date); checkDate.setHours(0,0,0,0); reminders.push({ id: page.id, title: page.title, date: date, tag: match[0], isOverdue: checkDate < today }); } } });
                        reminders.sort((a,b) => a.date - b.date); const overdue = reminders.filter(r => { const d = new Date(r.date); d.setHours(0,0,0,0); return d < today; }); const todays = reminders.filter(r => { const d = new Date(r.date); d.setHours(0,0,0,0); return d.getTime() === today.getTime(); }); const upcoming = reminders.filter(r => { const d = new Date(r.date); d.setHours(0,0,0,0); return d > today; }).slice(0, 10);
                        let html = ''; const renderGroup = (title, list, cls) => { if(list.length === 0) return ''; return `<div class="reminder-group"><div class="reminder-group-label">${title} (${list.length})</div>` + list.map(r => `<div class="reminder-item ${cls}" data-action="openPage" data-id="${r.id}"><div><div class="reminder-title pointer-events-none">${r.title}</div><div class="reminder-date text-amber-500/80 pointer-events-none">${r.tag} ‚Ä¢ ${TimeEngine.format(r.date)}</div></div><svg class="w-4 h-4 text-slate-600 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg></div>`).join('') + `</div>`; };
                        html += renderGroup('EN RETARD', overdue, 'urgent'); html += renderGroup('AUJOURD\'HUI', todays, 'today'); html += renderGroup('√Ä VENIR', upcoming, 'normal'); if(html === '') html = '<div class="p-8 text-center text-slate-400 text-sm italic">Aucun rappel actif d√©tect√©.<br>Utilisez !demain ou !date dans vos notes.</div>'; contentDiv.innerHTML = html;
                    } else if (tab === 'missions') {
                        footerDiv.classList.add('hidden'); let html = ''; let totalTasks = 0;
                        pages.forEach(page => {
                            const div = document.createElement('div'); div.innerHTML = page.content; div.querySelectorAll('.ai-insight-panel').forEach(el => el.remove());
                            const tasks = div.querySelectorAll('.task-box:not([checked])');
                            if (tasks.length > 0) {
                                totalTasks += tasks.length;
                                const taskListHtml = Array.from(tasks).map(t => {
                                    let taskText = ""; let curr = t.nextSibling;
                                    while(curr && curr.tagName !== 'BR' && curr.tagName !== 'DIV') { taskText += curr.textContent; curr = curr.nextSibling; }
                                    taskText = taskText.trim() || "T√¢che sans nom...";
                                    return `<div class="sitrep-item hover:bg-emerald-500/10" data-action="openPage" data-id="${page.id}"><div class="flex items-center gap-2"><span class="w-3 h-3 border border-emerald-500/50 rounded-sm"></span><span class="text-sm text-slate-300 truncate max-w-[250px]">${taskText}</span></div></div>`;
                                }).join('');
                                html += `<div class="sitrep-group" style="border-color: rgba(16, 185, 129, 0.2);"><div class="sitrep-group-title" style="background: rgba(16, 185, 129, 0.1); color: #34d399;"><span>${page.title}</span><span class="text-emerald-500">${tasks.length} pending</span></div><div>${taskListHtml}</div></div>`;
                            }
                        });
                        if (html === '') html = '<div class="p-8 text-center text-slate-400 text-sm italic">Aucune mission en cours.<br>Tapez "- [ ] " pour cr√©er une t√¢che.</div>';
                        else html = `<div class="mb-4 text-xs font-mono text-emerald-400 text-center border-b border-emerald-500/20 pb-2">${totalTasks} OBJECTIF(S) EN ATTENTE</div>` + html;
                        contentDiv.innerHTML = html;
                    }
                    document.getElementById('modal-sitrep').style.display = 'flex';
                },
                extract() {
                     const btn = document.getElementById('ai-trigger'); const label = document.getElementById('ai-label'); const pulse = document.getElementById('ai-pulse'); pulse.classList.add('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]'); label.textContent = "ANALYSE STRAT√âGIQUE..."; label.classList.add('text-blue-300');
                     setTimeout(() => {
                         const editor = document.getElementById('main-editor'); const existing = editor.querySelector('.ai-insight-panel'); if(existing) existing.remove();
                         const text = editor.innerText.trim(); if(!text || text.length < 10) { pulse.classList.remove('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]'); label.textContent = "SYSTEM.READY"; label.classList.remove('text-blue-300'); Renderer.toast("DONN√âES INSUFFISANTES"); return; }
                         const lines = text.split('\n').filter(l => l.trim().length > 0); const tagRegex = /\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/g; const timeRegex = /!([a-zA-Z0-9\+\-\/]+)/g;
                         const synthesis = lines.slice(0, 2).join(' ').substring(0, 150) + (lines[0].length > 150 ? '...' : '.');
                         let architecture = []; lines.forEach(l => { if(l.trim().startsWith('-') || l.trim().startsWith('‚Ä¢') || l.match(/^\d+\./)) architecture.push(l.trim()); }); if(architecture.length === 0) architecture = lines.slice(2, 5); if(architecture.length === 0) architecture = ["Structure narrative lin√©aire non-identifi√©e."];
                         let keyPoints = []; const tags = [...text.matchAll(tagRegex)].map(m => m[0]); const times = [...text.matchAll(timeRegex)].map(m => m[0]); const money = text.match(/\d+[\s]?(‚Ç¨|\$|eur|usd)/gi) || []; if(tags.length) keyPoints.push(`Indexation: ${tags.join(' ')}`); if(times.length) keyPoints.push(`√âch√©ances: ${times.join(' ')}`); if(money.length) keyPoints.push(`Impact Financier: ${money.join(', ')}`); lines.forEach(l => { if(l.match(/important|urgent|critique|cible|strat√©gie/i)) keyPoints.push(l.trim()); }); if(keyPoints.length === 0) keyPoints.push("Aucun marqueur tactique explicite d√©tect√©.");
                         let weaknesses = []; if(text.length < 200) weaknesses.push("Volume de donn√©es faible pour une analyse robuste."); if(!tags.length) weaknesses.push("Absence totale d'indexation [TAGS]."); if(!times.length) weaknesses.push("Aucune temporalit√© d√©finie (!date)."); if(weaknesses.length === 0) weaknesses.push("Aucune incoh√©rence majeure d√©tect√©e.");
                         const panelHtml = `<div class="ai-insight-panel select-none mb-6 border-l-2 border-blue-500 rounded bg-[#0f172a] font-mono text-xs" contenteditable="false"><div class="flex justify-between items-center p-2 border-b border-white/5 bg-white/5"><div class="flex items-center gap-2"><div class="w-2 h-2 bg-blue-500 rounded-sm"></div><span class="font-black text-blue-400 tracking-widest uppercase">Analyse Strat√©gique</span></div><button onclick="this.closest('.ai-insight-panel').remove();" class="text-slate-400 hover:text-red-400">‚úï</button></div><div class="p-4 space-y-4 text-slate-300"><div><h4 class="text-blue-500 font-bold uppercase mb-1">1. Synth√®se Conceptuelle</h4><p class="leading-relaxed opacity-80">${synthesis}</p></div><div><h4 class="text-purple-400 font-bold uppercase mb-1">2. Architecture des Ideas</h4><ul class="list-none space-y-1 opacity-80 pl-2 border-l border-white/10">${architecture.slice(0,3).map(i => `<li>${i}</li>`).join('')}</ul></div><div><h4 class="text-emerald-400 font-bold uppercase mb-1">3. Points Cl√©s Strat√©giques</h4><ul class="list-disc list-inside space-y-1 opacity-80">${keyPoints.slice(0,4).map(k => `<li>${k}</li>`).join('')}</ul></div><div><h4 class="text-red-400 font-bold uppercase mb-1">4. Angles Morts / Faiblesses</h4><ul class="list-none space-y-1 text-red-300/70 italic">${weaknesses.map(w => `<li>‚ö† ${w}</li>`).join('')}</ul></div></div></div>`;
                         editor.insertAdjacentHTML('afterbegin', panelHtml); Storage.saveDraft(editor.innerHTML); pulse.classList.remove('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]'); label.textContent = "ANALYSE TERMIN√âE"; label.classList.remove('text-blue-300'); Renderer.toast("RAPPORT G√âN√âR√â");
                     }, 800);
                },
                initVoice() { const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(SR) { State.recognition = new SR(); State.recognition.lang = 'fr-FR'; State.recognition.onstart = () => { State.isRecording = true; }; State.recognition.onresult = (e) => { if(!State.isReadMode && Bus) Bus.insertText(e.results[0][0].transcript); }; State.recognition.onend = () => { State.isRecording = false; }; } },
                toggleVoice() { if(State.recognition) State.isRecording ? State.recognition.stop() : State.recognition.start(); },
                async performSearch(query) {
                    // OMNIBAR LOGIC
                    const qLower = query.toLowerCase();
                    const isCmdMode = qLower.startsWith('>');
                    const searchStr = isCmdMode ? qLower.substring(1).trim() : qLower;
                    
                    let results = [];
                    
                    // 1. Show commands
                    if (searchStr.length > 0 || isCmdMode || query.length === 0) {
                        this.COMMANDS.forEach(cmd => {
                            if(query.length === 0 || cmd.title.toLowerCase().includes(searchStr) || cmd.keys.includes(searchStr)) {
                                results.push({ type: 'command', id: cmd.id, title: cmd.title, snippet: cmd.desc, icon: cmd.icon, action: cmd.action, score: 100 });
                            }
                        });
                    }

                    // 2. Show Pages (only if not strictly in command mode, and user typed something)
                    if (!isCmdMode && searchStr.length >= 1) {
                        const allPages = await Storage.getPages();
                        const escapeQuery = Engine.utils.escapeRegExp(searchStr); 
                        const regex = new RegExp(`(${escapeQuery})`, 'gi');
                        
                        allPages.forEach(page => { 
                            if (page.encrypted) {
                                if(page.title.toLowerCase().includes(searchStr)) {
                                    results.push({ type: 'page', id: page.id, title: page.title, updated: page.updated, snippet: '<span class="text-red-400 font-mono text-xs">üîí [DONN√âES CHIFFR√âES]</span>', score: 10, rawContent: '' }); 
                                }
                                return; // Black-Ops: on ne parse pas le contenu car il est chiffr√© !
                            }

                            const tempDiv = document.createElement('div'); tempDiv.innerHTML = page.content; tempDiv.querySelectorAll('.ai-insight-panel').forEach(e => e.remove()); 
                            const textContent = tempDiv.innerText; let score = 0; 
                            if(page.title.toLowerCase().includes(searchStr)) score += 10; 
                            if(textContent.toLowerCase().includes(searchStr)) score += 1; 
                            if(score > 0) { 
                                let snippet = ""; const index = textContent.toLowerCase().indexOf(searchStr); 
                                if (index > -1) { 
                                    const start = Math.max(0, index - 40); const end = Math.min(textContent.length, index + searchStr.length + 60); 
                                    snippet = (start > 0 ? "..." : "") + textContent.substring(start, end) + (end < textContent.length ? "..." : ""); 
                                } else { 
                                    snippet = textContent.substring(0, 100) + "..."; 
                                } 
                                snippet = snippet.replace(regex, '<span class="search-highlight">$1</span>'); 
                                results.push({ type: 'page', id: page.id, title: page.title, updated: page.updated, snippet: snippet, score: score, rawContent: page.content }); 
                            }
                        });
                    }

                    results.sort((a,b) => b.score - a.score);
                    State.searchResults = results; 
                    State.searchIndex = results.length > 0 ? 0 : -1; 
                    Renderer.renderSearchResults(results, State.searchIndex);
                },
                async checkReminders() {
                    const pages = await Storage.getPages(); const reminders = []; const today = new Date(); today.setHours(0,0,0,0);
                    pages.forEach(page => { const div = document.createElement('div'); div.innerHTML = page.content; const text = div.innerText; const regex = /!([a-zA-Z0-9\+\-\/]+)/g; let match; while ((match = regex.exec(text)) !== null) { const date = TimeEngine.parse(match[1]); if(date) { const checkDate = new Date(date); checkDate.setHours(0,0,0,0); if (checkDate.getTime() === today.getTime() || checkDate < today) reminders.push({ id: page.id, title: page.title, date: date, tag: match[0], isOverdue: checkDate < today }); } } });
                    const bell = document.getElementById('btn-reminders'); if(reminders.length > 0) { bell.classList.add('active'); bell.querySelector('.bell-badge').innerText = ""; } else { bell.classList.remove('active'); } return reminders;
                }
            };

            const Slash = {
                COMMANDS: [
                    { id: 'h1', icon: 'H1', label: 'Titre Principal', keys: ['h1', 'titre1', 'titre'] },
                    { id: 'h2', icon: 'H2', label: 'Titre Secondaire', keys: ['h2', 'titre2'] },
                    { id: 'h3', icon: 'H3', label: 'Sous-titre', keys: ['h3', 'titre3', 'sous'] },
                    { id: 'quote', icon: '‚ùù', label: 'Citation', keys: ['quote', 'citation', 'q'] },
                    { id: 'todo', icon: '‚òê', label: 'T√¢che (Todo)', keys: ['todo', 'tache', 'check'] },
                    { id: 'date', icon: 'üìÖ', label: 'Date du jour', keys: ['date', 'jour', 'today'] },
                    { id: 'tag', icon: '‚ö°', label: 'Nouveau Tag', keys: ['tag', 'index'] }
                ],
                check() {
                    const sel = window.getSelection();
                    if(!sel.isCollapsed) return this.close();
                    const range = sel.getRangeAt(0);
                    if(range.startContainer.nodeType !== Node.TEXT_NODE) return this.close();
                    
                    // On r√©cup√®re le texte avant le curseur
                    const text = range.startContainer.textContent.substring(0, range.startOffset);
                    const match = text.match(/(?:^|\s)\/([a-zA-Z0-9]*)$/);
                    
                    if (match) {
                        State.slash.active = true;
                        State.slash.query = match[1].toLowerCase();
                        this.render();
                        
                        // Calcul dynamique de la position du curseur
                        const rect = range.getBoundingClientRect();
                        const menu = document.getElementById('slash-menu');
                        menu.style.display = 'flex';
                        
                        let top = rect.bottom + window.scrollY + 5;
                        let left = rect.left + window.scrollX;
                        // Afficher au-dessus si pas assez de place en bas
                        if(top + 250 > window.innerHeight) top = rect.top + window.scrollY - 260;
                        
                        menu.style.top = `${top}px`;
                        menu.style.left = `${left}px`;
                    } else {
                        this.close();
                    }
                },
                render() {
                    const menu = document.getElementById('slash-menu');
                    const filtered = this.COMMANDS.filter(c => c.id.includes(State.slash.query) || c.keys.some(k => k.includes(State.slash.query)));
                    if(filtered.length === 0) return this.close();
                    
                    State.slash.results = filtered;
                    State.slash.index = Math.min(State.slash.index, filtered.length - 1);
                    
                    // Note: L'utilisation de mousedown pr√©vient la perte de focus de l'√©diteur lors du clic !
                    menu.innerHTML = filtered.map((c, i) => `
                        <div class="slash-item ${i === State.slash.index ? 'selected' : ''}" data-action="execSlash" data-id="${c.id}" onmousedown="event.preventDefault();">
                            <span class="w-6 font-bold text-slate-400 font-mono text-center">${c.icon}</span>
                            <span>${c.label}</span>
                        </div>
                    `).join('');
                },
                handleKey(e) {
                    if(!State.slash.active) return false;
                    if(e.key === 'ArrowDown') { e.preventDefault(); State.slash.index = Math.min(State.slash.index + 1, State.slash.results.length - 1); this.render(); return true; }
                    if(e.key === 'ArrowUp') { e.preventDefault(); State.slash.index = Math.max(State.slash.index - 1, 0); this.render(); return true; }
                    if(e.key === 'Enter') { e.preventDefault(); if(State.slash.results[State.slash.index]) this.execute(State.slash.results[State.slash.index].id); return true; }
                    if(e.key === 'Escape') { e.preventDefault(); this.close(); return true; }
                    return false;
                },
                execute(id) {
                    // 1. Suppression de la cha√Æne "/commande" qui vient d'√™tre tap√©e
                    const sel = window.getSelection();
                    if (sel.rangeCount > 0) {
                        const r = sel.getRangeAt(0);
                        const startOffset = r.startOffset - State.slash.query.length - 1;
                        if (startOffset >= 0 && r.startContainer.nodeType === Node.TEXT_NODE) {
                            r.setStart(r.startContainer, startOffset);
                            r.deleteContents();
                        }
                    }
                    this.close();
                    
                    // 2. Ex√©cution du formatage ou de l'insertion
                    const editor = document.getElementById('main-editor');
                    if(id === 'h1') document.execCommand('formatBlock', false, 'H1');
                    if(id === 'h2') document.execCommand('formatBlock', false, 'H2');
                    if(id === 'h3') document.execCommand('formatBlock', false, 'H3');
                    if(id === 'quote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
                    if(id === 'todo') document.execCommand('insertHTML', false, '<input type="checkbox" class="task-box" contenteditable="false">&nbsp;');
                    if(id === 'date') document.execCommand('insertText', false, new Date().toLocaleDateString('fr-FR'));
                    if(id === 'tag') {
                        document.execCommand('insertText', false, '[]');
                        // Replace the cursor right between the brackets
                        const newRange = document.createRange();
                        const sel2 = window.getSelection();
                        newRange.setStart(sel2.anchorNode, sel2.anchorOffset - 1);
                        newRange.collapse(true);
                        sel2.removeAllRanges();
                        sel2.addRange(newRange);
                    }
                    Storage.saveDraft(editor.innerHTML);
                },
                close() {
                    State.slash.active = false;
                    State.slash.query = '';
                    State.slash.index = 0;
                    const menu = document.getElementById('slash-menu');
                    if(menu) menu.style.display = 'none';
                }
            };
            
            const IO = {
                exportData: async () => { const pages = await Storage.getPages(); const draft = await Storage.db.meta.get('draft'); const blob = new Blob([JSON.stringify({version: "v9.80", date: new Date(), pages, draft}, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); const now = new Date(); const d = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0'); const t = String(now.getHours()).padStart(2, '0') + "-" + String(now.getMinutes()).padStart(2, '0'); a.download = `NoteLogic_Backup_${d}_${t}.json`; a.click(); Renderer.toast("BACKUP G√âN√âR√â"); },
                importData: (file) => { const r = new FileReader(); r.onload = async (e) => { try { const d = JSON.parse(e.target.result); if(d.pages) for(let x of d.pages) await Storage.createPage(x.title, x.content); if(d.draft) await Storage.saveDraft(d.draft.content); Renderer.toast("IMPORT OK"); setTimeout(()=>location.reload(),1000); } catch(err) { Renderer.toast("ERREUR FICHIER"); } }; r.readAsText(file); },
                attachPDF: async (file) => { if (file.size > 5000000) { Renderer.toast("FICHIER TROP GROS (>5Mo)"); return; } const id = await Storage.saveAttachment(file); const span = `<span class="pdf-chip" contenteditable="false" data-id="${id}" data-action="openPdf">üìÑ ${file.name.substring(0,25)}...</span>&nbsp;`; document.execCommand('insertHTML', false, span); Storage.saveDraft(document.getElementById('main-editor').innerHTML); Renderer.toast("PDF ATTACH√â"); },
                generatePDF: () => { const element = document.getElementById('main-editor'); if(!element.innerText.trim()) { Renderer.toast("NOTE VIDE"); return; } const now = new Date(); const d = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0'); const cleanText = element.innerText.trim(); const tagMatch = cleanText.match(/\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/); let rawTitle = tagMatch ? tagMatch[1] : cleanText.split('\n')[0].substring(0, 30); const safeTitle = rawTitle.replace(/[^a-zA-Z0-9\u00C0-\u00FF\-_]/g, '_'); const fname = `NoteLogic_${safeTitle}_${d}.pdf`; const opt = { margin: 10, filename: fname, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; const clone = element.cloneNode(true); clone.style.color = '#000000'; clone.style.background = '#ffffff'; clone.style.padding = '20px'; clone.style.width = '100%'; clone.style.fontFamily = 'Inter, sans-serif'; const container = document.createElement('div'); container.appendChild(clone); container.style.position = 'absolute'; container.style.left = '-9999px'; container.style.top = '0'; document.body.appendChild(container); html2pdf().set(opt).from(clone).save().then(() => { document.body.removeChild(container); Renderer.toast("PDF G√âN√âR√â"); }).catch(err => { console.error(err); Renderer.toast("ERREUR PDF"); }); }
            };

            const Nexus = {
                async render(tag) { const container = document.getElementById('ui-nexus-content'); container.innerHTML = `<div class="p-8 text-center text-sm text-slate-400">Scan Neural: [${tag}]...</div>`; const all = await Storage.getPages(); const hits = all.filter(e => e.content.includes(tag)).sort((a,b)=>b.updated - a.updated); const relations = {}; hits.forEach(h => { const tags = (h.content.match(/\[([a-zA-Z0-9_\-]+)\]/g)||[]).map(t=>t.replace(/[\[\]]/g,'')); tags.forEach(t => { if(t!==tag) relations[t]=(relations[t]||0)+1; }); }); const topRel = Object.entries(relations).sort((a,b)=>b[1]-a[1]).slice(0,8); const netHTML = topRel.length ? topRel.map(([t,c]) => `<div class="network-item" data-action="openNexus" data-tag="${t}"><span class="text-blue-300 font-bold pointer-events-none">${t}</span><span class="text-xs text-slate-400 pointer-events-none">${c}</span></div>`).join('') : '<div class="p-4 text-sm text-slate-400">Aucune corr√©lation.</div>'; container.innerHTML = `<div class="nexus-header"><div class="nexus-title">${tag}</div><div class="nexus-meta">Vol: ${hits.length}</div></div><div class="nexus-section-title">R√©seau Neuronal</div><div class="flex flex-col">${netHTML}</div><div class="nexus-section-title">Pages Li√©es</div><div class="flex flex-col">${hits.slice(0,5).map(h => `<div class="network-item" data-action="openPage" data-id="${h.id}"><span class="text-xs text-slate-300 font-mono pointer-events-none">${h.title}</span></div>`).join('')}</div>`; },
                async renderGlobal() { 
                    const container = document.getElementById('ui-nexus-content'); 
                    const all = await Storage.getPages(); 
                    const tagCounts = {};
                    const tagActivity = {}; // { tagName: [0,0...12] }
                    const now = new Date();

                    all.forEach(e => { 
                        const matches = e.content.match(/\[([a-zA-Z0-9_\-]+)\]/g) || []; 
                        matches.forEach(t => { 
                            const tag = t.replace(/[\[\]]/g,''); 
                            if (tag.match(/^(\d+(?:px|%|rem)|#[0-9a-f]+)$/)) return; 
                            
                            // Count volume
                            tagCounts[tag] = (tagCounts[tag]||0)+1; 
                            
                            // Activity Heatmap
                            if(!tagActivity[tag]) tagActivity[tag] = new Array(12).fill(0);
                            const pageDate = new Date(e.updated);
                            // Calc months diff (0 = this month)
                            const diffMonths = (now.getFullYear() - pageDate.getFullYear()) * 12 + (now.getMonth() - pageDate.getMonth());
                            if(diffMonths >= 0 && diffMonths < 12) {
                                // We store from Left (Oldest) to Right (Newest)
                                // Index 11 is Current Month, Index 0 is 11 months ago
                                const idx = 11 - diffMonths;
                                tagActivity[tag][idx] = (tagActivity[tag][idx] || 0) + 1;
                            }
                        }); 
                    }); 
                    
                    const sorted = Object.entries(tagCounts).sort((a,b) => b[1] - a[1]); 
                    
                    if(sorted.length === 0) { 
                        container.innerHTML = '<div class="p-8 text-center text-sm text-slate-400">Aucun tag d√©tect√©.</div>'; 
                        return; 
                    } 
                    
                    const listHTML = sorted.map(([t, c]) => {
                        // Generate Sparkline HTML
                        const activity = tagActivity[t] || new Array(12).fill(0);
                        const sparkBars = activity.map(val => {
                            let heightClass = 'h-0.5'; // default min height
                            let colorClass = 'empty';
                            let styleHeight = '2px';
                            
                            if (val > 0) {
                                // Normalize height roughly: 1 update = low, 2-3 = med, 4+ = high
                                if (val >= 4) { colorClass = 'high'; styleHeight = '14px'; }
                                else if (val >= 2) { colorClass = 'med'; styleHeight = '8px'; }
                                else { colorClass = 'low'; styleHeight = '4px'; }
                            }
                            
                            return `<div class="spark-bar ${colorClass}" style="height: ${styleHeight}"></div>`;
                        }).join('');

                        return `<div class="network-item" data-action="openNexus" data-tag="${t}"><div class="flex items-center"><span class="text-blue-300 font-bold font-mono tracking-wide pointer-events-none mr-2">${t}</span></div><div class="flex items-center"><div class="sparkline-container" title="Activit√© (12 derniers mois)">${sparkBars}</div><span class="text-xs text-slate-400 w-4 text-right pointer-events-none font-bold">${c}</span></div></div>`;
                    }).join(''); 
                    
                    container.innerHTML = `<div class="nexus-header"><div class="nexus-title">INDEX GLOBAL</div><div class="nexus-meta">Tags: ${sorted.length}</div></div><div class="nexus-section-title">Fr√©quence & Activit√©</div><div class="flex flex-col">${listHTML}</div>`; 
                }
            };

            // Initialize Bus here with the full object
            Bus = {
                listeners: {},
                peekTimer: null,
                currentPeekTarget: null,
                lastMouseX: 0,
                lastMouseY: 0,
                on(e,f) { (this.listeners[e]=this.listeners[e]||[]).push(f); },
                emit(e,d) { (this.listeners[e]||[]).forEach(f=>f(d)); },
                handle(e) {
                    const t = e.target.closest('[data-action]');
                    const settingsBtn = e.target.closest('[data-action="toggleSettings"]');
                    const settingsMenu = document.getElementById('ui-settings-menu');
                    
                    // Fermer le menu Slash si on clique ailleurs
                    if(State.slash.active && !e.target.closest('#slash-menu')) Slash.close();

                    if(settingsBtn) { settingsMenu.classList.toggle('active'); e.stopPropagation(); return; }
                    if(!e.target.closest('#ui-settings-menu') && settingsMenu) settingsMenu.classList.remove('active');

                    if(t) { this.hidePeek(); e.preventDefault(); this.dispatchAction(t.dataset.action, {...t.dataset, el:t, type: e.type}); return; }
                    if(e.target.closest('.modal-overlay')) { if(e.target.id === 'modal-search') document.getElementById('search-input').value = ''; document.querySelectorAll('.modal-overlay').forEach(el=>el.style.display='none'); }
                },
                handleSearchKeydown(e) {
                    if(document.getElementById('modal-search').style.display !== 'flex') return;
                    if(e.key === 'ArrowDown') { e.preventDefault(); State.searchIndex = Math.min(State.searchIndex + 1, State.searchResults.length - 1); Renderer.renderSearchResults(State.searchResults, State.searchIndex); } 
                    else if (e.key === 'ArrowUp') { e.preventDefault(); State.searchIndex = Math.max(State.searchIndex - 1, 0); Renderer.renderSearchResults(State.searchResults, State.searchIndex); } 
                    else if (e.key === 'Enter') { 
                        e.preventDefault(); 
                        if(State.searchIndex >= 0 && State.searchResults[State.searchIndex]) { 
                            const res = State.searchResults[State.searchIndex];
                            if (res.type === 'command') {
                                this.dispatchAction('executeCommand', { cmd: res.action });
                            } else {
                                this.dispatchAction('openPage', {id: res.id}); 
                            }
                        } 
                    } 
                    else if (e.key === 'Escape') { this.dispatchAction('closeModals'); }
                },
                toggleIndexWrapper(strictMode = false) {
                    const editor = document.getElementById('main-editor'); const selection = window.getSelection();
                    if (!editor.contains(selection.anchorNode)) return;
                    if (selection.isCollapsed) { if (strictMode) return; if (selection.modify) { selection.modify('move', 'backward', 'word'); selection.modify('extend', 'forward', 'word'); } }
                    const text = selection.toString(); if (text.trim().length > 0) document.execCommand('insertText', false, `[${text.trim()}]`); else if (!strictMode) document.execCommand('insertText', false, '[]'); Storage.saveDraft(editor.innerHTML);
                },
                toggleTimeWrapper() {
                    const editor = document.getElementById('main-editor'); const selection = window.getSelection();
                    if (!editor.contains(selection.anchorNode) || selection.isCollapsed) return;
                    const text = selection.toString(); if (text.trim().length > 0) document.execCommand('insertText', false, `!${text.trim()}`); Storage.saveDraft(editor.innerHTML);
                },
                checkSelection() {
                    const editor = document.getElementById('main-editor'); const toolbar = document.getElementById('selection-toolbar'); const selection = window.getSelection();
                    if (!selection.isCollapsed && editor.contains(selection.anchorNode)) {
                        const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect();
                        toolbar.style.top = `${Math.max(10, rect.top - 50)}px`;
                        toolbar.style.left = `${Math.max(10, rect.left + (rect.width / 2) - (toolbar.offsetWidth / 2))}px`;
                        toolbar.classList.add('active');
                    } else {
                        toolbar.classList.remove('active');
                    }
                },
                async showPeek(idOrTag, type) {
                    const peekEl = document.getElementById('hover-peek');
                    const titleEl = peekEl.querySelector('.peek-title');
                    const contentEl = peekEl.querySelector('.peek-content');
                    
                    if (type === 'page') {
                        const page = await Storage.getPage(idOrTag);
                        if (!page) return;
                        titleEl.innerHTML = `<span class="text-white mr-2">üìÑ</span>${page.title}`;
                        const temp = document.createElement('div');
                        temp.innerHTML = page.content;
                        temp.querySelectorAll('.ai-insight-panel, .pdf-chip').forEach(el => el.remove());
                        contentEl.innerHTML = temp.innerText.trim().substring(0, 300) || "<span class='italic opacity-50'>Note vide...</span>";
                    } else if (type === 'tag') {
                        const pages = await Storage.getPages();
                        const hits = pages.filter(p => p.content.includes(`[${idOrTag}]`));
                        let latest = null;
                        if (hits.length === 0) {
                             const hitsText = pages.filter(p => p.content.includes(idOrTag));
                             if (hitsText.length === 0) return;
                             latest = hitsText.sort((a,b) => b.updated - a.updated)[0];
                        } else {
                             latest = hits.sort((a,b) => b.updated - a.updated)[0];
                        }
                        
                        titleEl.innerHTML = `<span class="text-purple-400 mr-2">‚ö°</span>[${idOrTag}]`;
                        const temp = document.createElement('div');
                        temp.innerHTML = latest.content;
                        temp.querySelectorAll('.ai-insight-panel, .pdf-chip').forEach(el => el.remove());
                        contentEl.innerHTML = `<div class="text-blue-400 opacity-90 mb-1 border-b border-blue-500/20 pb-1 text-[10px] uppercase tracking-widest font-bold">R√©f: ${latest.title}</div>${temp.innerText.trim().substring(0, 200)}`;
                    }
                    
                    peekEl.style.display = 'block';
                    
                    let x = this.lastMouseX + 15;
                    let y = this.lastMouseY + 15;
                    
                    requestAnimationFrame(() => {
                        if (x + peekEl.offsetWidth > window.innerWidth) x = window.innerWidth - peekEl.offsetWidth - 15;
                        if (y + peekEl.offsetHeight > window.innerHeight) y = window.innerHeight - peekEl.offsetHeight - 15;
                        peekEl.style.left = `${x}px`;
                        peekEl.style.top = `${y}px`;
                        peekEl.classList.add('visible');
                    });
                },
                hidePeek() {
                    const peekEl = document.getElementById('hover-peek');
                    if(peekEl) {
                        peekEl.classList.remove('visible');
                        peekEl.style.display = 'none';
                    }
                },
                async dispatchAction(act, d) {
                    if(act==='executeCommand') { this.dispatchAction('closeModals'); setTimeout(() => this.dispatchAction(d.cmd), 50); }
                    if(act==='execSlash') Slash.execute(d.id);
                    if(act==='toggleZenMode') { document.body.classList.toggle('zen-mode'); Renderer.toast(document.body.classList.contains('zen-mode') ? "MODE STEALTH ACTIV√â (Alt+Z)" : "MODE STANDARD"); }
                    if(act==='toggleEncryption') {
                        if (!State.currentPageId) { Renderer.toast("SAUVEGARDER OU OUVRIR UNE NOTE D'ABORD"); return; }
                        Storage.getPage(State.currentPageId).then(page => {
                            if (!page) return;
                            State.cryptoContext = { id: page.id, action: page.encrypted ? 'remove' : 'add' };
                            document.getElementById('crypto-msg').textContent = page.encrypted ? "Mot de passe pour D√âCHIFFRER d√©finitivement cette note :" : "Cr√©er un mot de passe de CHIFFREMENT (AES-256) pour cette note :";
                            document.getElementById('crypto-input').value = '';
                            document.getElementById('modal-crypto').style.display = 'flex';
                            document.getElementById('crypto-input').focus();
                        });
                    }
                    if(act==='submitCrypto') {
                        const pwd = document.getElementById('crypto-input').value;
                        if (!pwd) return;
                        const ctx = State.cryptoContext;
                        if (!ctx) return;
                        
                        Storage.getPage(ctx.id).then(async page => {
                            if (ctx.action === 'add') {
                                const plain = document.getElementById('main-editor').innerHTML;
                                const cipher = await CryptoEngine.encrypt(plain, pwd);
                                await Storage.db.pages.update(ctx.id, { content: cipher, encrypted: true });
                                State.unlockedNotes[ctx.id] = pwd;
                                Renderer.toast("NOTE S√âCURIS√âE üîí");
                                document.getElementById('btn-crypto').classList.add('text-red-500');
                                this.dispatchAction('closeModals');
                                this.renderBinder();
                            } else if (ctx.action === 'remove') {
                                try {
                                    const plain = await CryptoEngine.decrypt(page.content, pwd);
                                    await Storage.db.pages.update(ctx.id, { content: plain, encrypted: false });
                                    delete State.unlockedNotes[ctx.id];
                                    Renderer.toast("CHIFFREMENT RETIR√â üîì");
                                    document.getElementById('btn-crypto').classList.remove('text-red-500');
                                    this.dispatchAction('closeModals');
                                    this.renderBinder();
                                } catch(e) { Renderer.toast("MOT DE PASSE INCORRECT"); }
                            } else if (ctx.action === 'unlock') {
                                try {
                                    const plain = await CryptoEngine.decrypt(page.content, pwd);
                                    State.unlockedNotes[ctx.id] = pwd;
                                    State.currentPageId = page.id;
                                    document.getElementById('main-editor').innerHTML = Renderer.processContent(plain);
                                    document.getElementById('btn-crypto').classList.add('text-red-500');
                                    Renderer.toast("ACC√àS AUTORIS√â");
                                    this.dispatchAction('closeModals');
                                } catch(e) { Renderer.toast("ACC√àS REFUS√â"); }
                            }
                        });
                    }
                    if(act==='toggleSidebar') document.getElementById('main-sidebar').classList.toggle('collapsed');
                    if(act==='toggleView') { document.getElementById('view-pages').classList.toggle('hidden',d.view!=='pages'); document.getElementById('view-index').classList.toggle('hidden',d.view!=='index'); Renderer.toggleViewBtn(d.view); if(d.view === 'pages') this.renderBinder(); if(d.view === 'index') Nexus.renderGlobal(); }
                    if(act==='triggerSitrep') Intelligence.sitrep('tags');
                    if(act==='aiChallenge') Intelligence.extract();
                    if(act==='openNexus') { this.dispatchAction('toggleView',{view:'index'}); Nexus.render(d.tag); }
                    if(act==='clearDraft') { if(d.type === 'dblclick' || !d.type) { document.getElementById('main-editor').innerHTML=''; Storage.saveDraft(''); Renderer.toast("VID√â"); } else { Renderer.toast("Double-clic pour vider"); } }
                    if(act==='dispatchToPage') this.dispatchDraftToPage();
                    if(act==='newPage') { State.currentPageId = null; document.getElementById('main-editor').innerHTML=''; Storage.saveDraft(''); document.getElementById('main-editor').focus(); Renderer.toast("NOUVELLE NOTE PR√äTE"); }
                    if(act==='insertIndex') this.toggleIndexWrapper();
                    if(act==='openSearch') { document.getElementById('modal-search').style.display='flex'; const inp = document.getElementById('search-input'); inp.value = ''; inp.focus(); Intelligence.performSearch(''); }
                    if(act==='openHelp') document.getElementById('modal-help').style.display='flex';
                    if(act==='switchHelpTab') { document.querySelectorAll('.help-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === d.tab)); document.querySelectorAll('.help-section').forEach(s => s.classList.toggle('hidden', s.id !== 'help-tab-' + d.tab)); }
                    if(act==='openShortcuts') { document.getElementById('modal-help').style.display='flex'; this.dispatchAction('switchHelpTab', {tab: 'controls'}); }
                    if(act==='openReminders') Intelligence.sitrep('time');
                    if(act==='openMacroManager') { Renderer.renderMacroManager(); document.getElementById('modal-macros').style.display='flex'; }
                    if(act==='switchSitrepTab') Intelligence.sitrep(d.tab);
                    if(act==='socialBroadcast') Social.broadcast();
                    if(act==='toggleFab') { const menu = document.getElementById('fab-menu'); const main = document.getElementById('fab-main'); menu.classList.toggle('fab-menu-open'); main.classList.toggle('fab-main-open'); }
                    if(act==='formatBold') { document.execCommand('bold', false, null); this.checkSelection(); Storage.saveDraft(document.getElementById('main-editor').innerHTML); }
                    if(act==='formatItalic') { document.execCommand('italic', false, null); this.checkSelection(); Storage.saveDraft(document.getElementById('main-editor').innerHTML); }
                    if(act==='formatTag') { this.toggleIndexWrapper(true); this.checkSelection(); }
                    if(act==='formatTime') { this.toggleTimeWrapper(); this.checkSelection(); }
                    if(act==='shareTwitter') Social.twitter();
                    if(act==='shareLinkedIn') Social.linkedin();
                    if(act==='copyToClipboard') Social.clipboard();
                    if(act==='addMacro') { const k = document.getElementById('new-macro-key').value.toLowerCase(); const v = document.getElementById('new-macro-val').innerHTML; if(k && v && v !== '<br>'){ Storage.addMacro(k,v).then(() => { Renderer.renderMacroManager(); document.getElementById('new-macro-key').value = ''; document.getElementById('new-macro-val').innerHTML = ''; Renderer.toast(`MACRO [${k.toUpperCase()}] CR√â√âE`); }); } else { Renderer.toast("CHAMPS VIDES"); } }
                    if(act==='removeMacro') { Storage.removeMacro(d.trigger).then(() => { Renderer.renderMacroManager(); }); }
                    if(act==='hardReset') this.confirmAction(d.el, () => Storage.nuke());
                    if(act==='closeModals') { document.querySelectorAll('.modal-overlay').forEach(el=>el.style.display='none'); document.getElementById('search-input').value = ''; }
                    if(act==='pageDelete') this.confirmAction(d.el, async()=>{ await Storage.deletePage(d.id); this.renderBinder(); });
                    if(act==='togglePin') { await Storage.togglePinPage(d.id); this.renderBinder(); }
                    if(act==='openPage') { this.openPage(d.id); document.querySelectorAll('.modal-overlay').forEach(el=>el.style.display='none'); }
                    if(act==='ioExport') IO.exportData();
                    if(act==='exportToPDF') IO.generatePDF();
                    if(act==='triggerImport') document.getElementById('import-input').click();
                    if(act==='cleanFormat') { const editor = document.getElementById('main-editor'); editor.querySelectorAll('*').forEach(el => el.removeAttribute('style')); editor.querySelectorAll('*').forEach(el => { if(!el.classList.contains('pdf-chip') && !el.classList.contains('chrono-tag')) { el.removeAttribute('class'); } }); const stripTags = ['b', 'strong', 'i', 'em', 'u', 'font', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tbody', 'tr', 'td', 'a', 'strike', 'blockquote', 'code', 'pre']; stripTags.forEach(tag => { const elements = editor.querySelectorAll(tag); elements.forEach(el => { const parent = el.parentNode; while(el.firstChild) parent.insertBefore(el.firstChild, el); parent.removeChild(el); }); }); editor.querySelectorAll('span').forEach(el => { if(!el.classList.contains('pdf-chip') && !el.classList.contains('chrono-tag')) { const parent = el.parentNode; while(el.firstChild) parent.insertBefore(el.firstChild, el); parent.removeChild(el); } }); const finalHTML = Renderer.processContent(editor.innerHTML); editor.innerHTML = finalHTML; Storage.saveDraft(editor.innerHTML); Renderer.toast("FORMAT NETTOY√â"); }
                    if(act==='clearFilter') { State.activeTagFilter=null; document.getElementById('ui-filter-banner').classList.add('hidden'); this.renderBinder(); }
                    if(act==='pruneAttachments') Storage.manager.pruneAttachments();
                    if(act==='editorAction') { 
                        if(d.cmd==='focusStart') { 
                            const ed=document.getElementById('main-editor'); 
                            ed.insertAdjacentHTML('afterbegin', '<div><br></div>'); 
                            Storage.saveDraft(ed.innerHTML); 
                            
                            // Focus inside that new line
                            const newLine = ed.firstElementChild;
                            const r = document.createRange(); 
                            r.selectNodeContents(newLine); 
                            r.collapse(true); 
                            
                            const s = window.getSelection(); 
                            s.removeAllRanges(); 
                            s.addRange(r); 
                            ed.scrollTop = 0;
                        } 
                        if(d.cmd==='focusEnd') { 
                            const ed=document.getElementById('main-editor'); 
                            ed.insertAdjacentHTML('beforeend', '<div><br></div>'); 
                            Storage.saveDraft(ed.innerHTML); 
                            const r=document.createRange(); 
                            r.selectNodeContents(ed); 
                            r.collapse(false); 
                            const s=window.getSelection(); 
                            s.removeAllRanges(); 
                            s.addRange(r); 
                            ed.scrollTop = ed.scrollHeight;
                        } 
                    }
                    if(act==='installPWA') { if (State.deferredPrompt) { State.deferredPrompt.prompt(); State.deferredPrompt.userChoice.then((result) => { State.deferredPrompt = null; document.getElementById('btn-install-pwa').classList.add('hidden'); }); } }
                    if(act==='toggleContrast') { const selection = window.getSelection(); if (!selection.isCollapsed) { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, '#000000'); document.execCommand('hiliteColor', false, '#ffffff'); } else { Renderer.toast("S√âLECTIONNER TEXTE"); } }
                    if(act==='triggerAttach') document.getElementById('pdf-input').click();
                    if(act==='openPdf') this.openPdf(d.id);
                },
                async openPdf(id) { const file = await Storage.getAttachment(id); if(file && file.data) { const url = URL.createObjectURL(file.data); window.open(url, '_blank'); } else { Renderer.toast("PDF INTROUVABLE"); } },
                confirmAction(btn, cb) { if(!btn) return; if(btn.dataset.confirm==="true") { cb(); btn.dataset.confirm="false"; btn.classList.remove('text-red-500', 'border-red-500', 'bg-red-500/20'); } else { btn.dataset.confirm="true"; btn.classList.add('text-red-500', 'border-red-500', 'bg-red-500/20'); Renderer.toast("S√õR ?"); setTimeout(()=>{btn.dataset.confirm="false";btn.classList.remove('text-red-500', 'border-red-500', 'bg-red-500/20');},2000); } },
                insertHTML(html) { const editor = document.getElementById('main-editor'); editor.focus(); document.execCommand('insertHTML', false, html); setTimeout(() => { document.execCommand('insertHTML', false, '<div><br></div>'); Storage.saveDraft(editor.innerHTML); }, 10); },
                insertText(t) { document.execCommand('insertText', false, t); Storage.saveDraft(document.getElementById('main-editor').innerHTML); },
                async dispatchDraftToPage() {
                    const editor = document.getElementById('main-editor'); if(!editor.innerText.trim()) { Renderer.toast("VIDE"); return; }
                    const clone = editor.cloneNode(true); const panels = clone.querySelectorAll('.ai-insight-panel'); panels.forEach(p => p.remove());
                    const cleanText = clone.innerText.trim(); const fullContent = editor.innerHTML;
                    if(!cleanText && panels.length > 0) { Renderer.toast("AJOUTER CONTENU MANUEL"); return; }
                    const tagMatch = cleanText.match(/\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/);
                    let title = tagMatch ? tagMatch[1] : null; if (!title) { title = cleanText.split('\n')[0].substring(0, 40) || "Sans Titre"; }
                    const existingPage = await Storage.findPageByTitle(title);
                    if (existingPage) { 
                        const tempDiv = document.createElement('div'); tempDiv.innerHTML = existingPage.content; tempDiv.querySelectorAll('.ai-insight-panel').forEach(el => el.remove()); const cleanOldContent = tempDiv.innerHTML; let newContent; if (State.currentPageId === existingPage.id) { newContent = fullContent; Renderer.toast(`MISE √Ä JOUR: [${title}]`); } else { newContent = cleanOldContent + "<br><hr style='border-color: rgba(255,255,255,0.1); margin: 20px 0;'><br>" + fullContent; Renderer.toast(`FUSION: [${title}]`); } 
                        if (existingPage.encrypted) {
                            if(!State.unlockedNotes[existingPage.id]) { Renderer.toast("ERREUR DE CL√â"); return; }
                            newContent = await CryptoEngine.encrypt(newContent, State.unlockedNotes[existingPage.id]);
                        }
                        await Storage.updatePage(existingPage.id, newContent); 
                    } 
                    else { await Storage.createPage(title, fullContent); Renderer.toast(`NOUVELLE PAGE: [${title}]`); }
                    State.currentPageId = null; editor.innerHTML = ''; document.getElementById('btn-crypto').classList.remove('text-red-500'); await Storage.saveDraft('', true); this.renderBinder();
                },
                promptUnlock(id) {
                    State.cryptoContext = { id: id, action: 'unlock' };
                    document.getElementById('crypto-msg').textContent = "Note prot√©g√©e. Acc√®s requis :";
                    document.getElementById('crypto-input').value = '';
                    document.getElementById('modal-crypto').style.display = 'flex';
                    document.getElementById('crypto-input').focus();
                },
                async openPage(id) { 
                    const page = await Storage.getPage(id); 
                    if(page) { 
                        if(page.encrypted) {
                            if(State.unlockedNotes[id]) {
                                try {
                                    const plain = await CryptoEngine.decrypt(page.content, State.unlockedNotes[id]);
                                    State.currentPageId = page.id;
                                    document.getElementById('main-editor').innerHTML = Renderer.processContent(plain);
                                    document.getElementById('btn-crypto').classList.add('text-red-500');
                                    await Storage.saveDraft('', true); // Efface le draft si on lit une note s√©curis√©e
                                } catch(e) {
                                    delete State.unlockedNotes[id];
                                    this.promptUnlock(page.id);
                                }
                            } else {
                                this.promptUnlock(page.id);
                            }
                        } else {
                            State.currentPageId = page.id; 
                            document.getElementById('main-editor').innerHTML = Renderer.processContent(page.content); 
                            Storage.saveDraft(page.content, true); 
                            document.getElementById('btn-crypto').classList.remove('text-red-500');
                        }
                    } 
                },
                async renderBinder() {
                    const container = document.getElementById('ui-binder-content'); container.innerHTML='';
                    const pages = await Storage.getPages();
                    let displayPages = pages;
                    if(State.activeTagFilter) { displayPages = pages.filter(e => e.content.includes(State.activeTagFilter)); document.getElementById('ui-filter-banner').classList.remove('hidden'); document.getElementById('ui-filter-text').textContent = `Filtre: [${State.activeTagFilter}]`; }
                    if(displayPages.length === 0) container.innerHTML = '<div class="p-8 text-center text-slate-400 text-sm italic">Classeur Vide</div>';
                    displayPages.forEach(page => {
                        const card = document.createElement('div'); card.className = `page-card px-4 py-3`; if(State.currentPageId === page.id) card.classList.add('active');
                        const isPinned = !!page.pinned;
                        if (isPinned) { card.style.borderLeftColor = '#3b82f6'; card.style.background = 'rgba(59, 130, 246, 0.03)'; }
                        
                        const lockIcon = page.encrypted ? `<svg class="w-3 h-3 text-red-500 shrink-0 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>` : '';
                        const pinIcon = `<svg class="w-3 h-3 pointer-events-none" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>`;
                        
                        if(page.encrypted) {
                            card.innerHTML = `<div class="flex justify-between items-start mb-1"><div class="flex flex-col w-full" data-action="openPage" data-id="${page.id}"><span class="text-sm font-bold text-slate-200 truncate pr-8 pointer-events-none flex items-center gap-1.5">${isPinned ? '<svg class="w-3 h-3 text-blue-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>' : ''}<span class="truncate">${page.title}</span>${lockIcon}</span><span class="text-[11px] text-slate-400 font-mono mt-0.5 pointer-events-none">${Engine.utils.formatDate(page.updated)}</span><div class="mt-1 pointer-events-none"><span class="card-tag-badge !text-red-400 !border-red-500/30 !bg-red-500/10">BLACK-OPS</span></div></div><div class="card-actions"><button data-action="togglePin" data-id="${page.id}" class="p-1 ${isPinned ? 'text-blue-400' : 'text-slate-400'} hover:text-blue-400 rounded transition-colors" title="${isPinned ? 'D√©s√©pingler' : '√âpingler'}">${pinIcon}</button><button data-action="pageDelete" data-id="${page.id}" class="p-1 text-slate-400 hover:text-red-400 rounded transition-colors" title="Supprimer d√©finitivement"><svg class="w-3 h-3 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button></div></div>`;
                        } else {
                            const matches = page.content.match(/\[([a-zA-Z0-9\u00C0-\u00FF\s_\-'‚Äô]+)\]/g) || [];
                            const cleanTags = matches.map(t => t.replace(/[\[\]]/g,'')).filter(t => !t.match(/^(\d+(?:px|%|rem|em)|#[0-9a-f]+)$/));
                            const uniqueTags = [...new Set(cleanTags)];
                            const tagsHTML = uniqueTags.slice(0,3).map(t=>`<span class="card-tag-badge" data-action="openNexus" data-tag="${t}">${t}</span>`).join('');
                            card.innerHTML = `<div class="flex justify-between items-start mb-1"><div class="flex flex-col w-full" data-action="openPage" data-id="${page.id}"><span class="text-sm font-bold text-slate-200 truncate pr-8 pointer-events-none flex items-center gap-1.5">${isPinned ? '<svg class="w-3 h-3 text-blue-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>' : ''}<span class="truncate">${page.title}</span></span><span class="text-[11px] text-slate-400 font-mono mt-0.5 pointer-events-none">${Engine.utils.formatDate(page.updated)}</span><div class="mt-1 pointer-events-none">${tagsHTML}</div></div><div class="card-actions"><button data-action="togglePin" data-id="${page.id}" class="p-1 ${isPinned ? 'text-blue-400' : 'text-slate-400'} hover:text-blue-400 rounded transition-colors" title="${isPinned ? 'D√©s√©pingler' : '√âpingler'}">${pinIcon}</button><button data-action="pageDelete" data-id="${page.id}" class="p-1 text-slate-400 hover:text-red-400 rounded transition-colors" title="Supprimer d√©finitivement"><svg class="w-3 h-3 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button></div></div>`;
                        }
                        container.appendChild(card);
                    });
                }
            };

            const init = async () => {
                try {
                    window.Bus = Bus; // Exposer Bus globalement pour r√©soudre les ReferenceErrors d'UI inline.
                    await Storage.init(); Engine.gfx.init(); Intelligence.initVoice(); await Intelligence.checkReminders();
                    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); State.deferredPrompt = e; document.getElementById('btn-install-pwa').classList.remove('hidden'); document.getElementById('btn-install-pwa').classList.add('flex'); });
                    
                    // --- HOVER PEEK MOUSE TRACKER ---
                    document.addEventListener('mousemove', (e) => {
                        Bus.lastMouseX = e.clientX;
                        Bus.lastMouseY = e.clientY;
                        const targetPage = e.target.closest('[data-action="openPage"]');
                        const targetTag = e.target.closest('[data-action="openNexus"]');
                        const target = targetPage || targetTag;

                        if (target !== Bus.currentPeekTarget) {
                            clearTimeout(Bus.peekTimer);
                            Bus.hidePeek();
                            if (target) {
                                Bus.currentPeekTarget = target;
                                Bus.peekTimer = setTimeout(() => {
                                    if (targetPage) Bus.showPeek(target.dataset.id, 'page');
                                    else if (targetTag) Bus.showPeek(target.dataset.tag, 'tag');
                                }, 800);
                            } else {
                                Bus.currentPeekTarget = null;
                            }
                        }
                    });

                    document.body.addEventListener('click', (e) => Bus.handle(e)); document.body.addEventListener('dblclick', (e) => Bus.handle(e));
                    document.getElementById('main-editor').addEventListener('dblclick', (e) => { Bus.toggleIndexWrapper(true); });
                    document.addEventListener('selectionchange', Engine.utils.debounce(() => Bus.checkSelection(), 100));
                    document.getElementById('import-input').addEventListener('change', (e) => IO.importData(e.target.files[0]));
                    document.getElementById('pdf-input').addEventListener('change', (e) => IO.attachPDF(e.target.files[0]));
                    
                    document.getElementById('crypto-input').addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') { e.preventDefault(); Bus.dispatchAction('submitCrypto'); }
                    });

                    // Interception √† la frappe pour le menu slash
                    document.getElementById('main-editor').addEventListener('input', (e) => { Slash.check(); });
                    document.getElementById('main-editor').addEventListener('input', Engine.utils.debounce(() => Storage.saveDraft(document.getElementById('main-editor').innerHTML), 1000));
                    
                    // Gestion de l'√©tat des cases √† cocher dans l'√©diteur
                    document.getElementById('main-editor').addEventListener('change', (e) => {
                        if (e.target.classList.contains('task-box')) {
                            if (e.target.checked) e.target.setAttribute('checked', 'checked');
                            else e.target.removeAttribute('checked');
                            Storage.saveDraft(document.getElementById('main-editor').innerHTML);
                        }
                    });

                    document.getElementById('main-editor').addEventListener('paste', (e) => { setTimeout(() => { document.execCommand('insertHTML', false, '<div><br></div>'); Storage.saveDraft(document.getElementById('main-editor').innerHTML); }, 10); });
                    document.addEventListener('keydown', (e) => {
                        // Capture des fl√®ches/entrer si le menu slash est ouvert
                        if (e.target.id === 'main-editor' && Slash.handleKey(e)) return;

                        // Conversion magique des Checklists √† la frappe
                        if (e.target.id === 'main-editor' && e.code === 'Space') {
                            const sel = window.getSelection();
                            if (sel.isCollapsed && sel.anchorNode.nodeType === 3) {
                                const text = sel.anchorNode.textContent.substring(0, sel.anchorOffset);
                                if (text.endsWith('- [ ]')) {
                                    e.preventDefault();
                                    for(let i=0; i<5; i++) document.execCommand('delete', false, null);
                                    document.execCommand('insertHTML', false, '<input type="checkbox" class="task-box" contenteditable="false">&nbsp;');
                                } else if (text.match(/- \[[xX]\]$/)) {
                                    e.preventDefault();
                                    for(let i=0; i<5; i++) document.execCommand('delete', false, null);
                                    document.execCommand('insertHTML', false, '<input type="checkbox" class="task-box" contenteditable="false" checked="checked">&nbsp;');
                                }
                            }
                        }

                        if(e.key === 'Alt') document.getElementById('macro-hud').classList.add('visible');
                        if(e.altKey && e.code === 'KeyZ') { e.preventDefault(); Bus.dispatchAction('toggleZenMode'); }
                        if(e.altKey && e.code === 'KeyX') { e.preventDefault(); Bus.dispatchAction('toggleEncryption'); }
                        if(e.altKey && e.code === 'KeyT') { e.preventDefault(); Bus.dispatchAction('insertIndex'); }
                        if(e.key === 'F1') { e.preventDefault(); Bus.dispatchAction('openHelp'); }
                        if(e.altKey && e.code === 'KeyN') { e.preventDefault(); Bus.dispatchAction('newPage'); }
                        if(e.altKey && e.code === 'KeyS') { e.preventDefault(); Bus.dispatchAction('triggerSitrep'); }
                        if(e.altKey && e.code === 'Digit1') { e.preventDefault(); Bus.dispatchAction('toggleView', {view: 'pages'}); }
                        if(e.altKey && e.code === 'Digit2') { e.preventDefault(); Bus.dispatchAction('toggleView', {view: 'index'}); }
                        if(e.altKey && e.code === 'KeyM') { e.preventDefault(); Bus.dispatchAction('toggleSidebar'); }
                        if(e.altKey && e.code === 'KeyC') { e.preventDefault(); Bus.dispatchAction('toggleContrast'); }
                        if(e.altKey && e.code === 'ArrowUp') { e.preventDefault(); Bus.dispatchAction('editorAction', {cmd: 'focusStart'}); }
                        if(e.altKey && e.code === 'ArrowDown') { e.preventDefault(); Bus.dispatchAction('editorAction', {cmd: 'focusEnd'}); }
                        if(e.altKey && e.code === 'KeyG') { e.preventDefault(); Bus.dispatchAction('aiChallenge'); }
                        if(e.altKey && e.code === 'KeyP') { e.preventDefault(); Bus.dispatchAction('triggerAttach'); }
                        if(e.altKey && e.code === 'KeyR') { e.preventDefault(); Bus.dispatchAction('openReminders'); } 
                        if(e.altKey && e.code === 'KeyB') { e.preventDefault(); Bus.dispatchAction('socialBroadcast'); }
                        if((e.altKey && e.code === 'KeyF') || (e.ctrlKey && e.code === 'KeyK')) { e.preventDefault(); Bus.dispatchAction('openSearch'); }
                        if(e.altKey && e.code === 'Enter') { e.preventDefault(); Bus.dispatchAction('dispatchToPage'); }
                        if(e.altKey && e.code === 'KeyO') { e.preventDefault(); Bus.dispatchAction('toggleSettings'); }
                        if(e.altKey && e.code === 'KeyL') { e.preventDefault(); Bus.dispatchAction('cleanFormat'); }
                        if(e.altKey && e.code === 'Delete') { e.preventDefault(); Bus.dispatchAction('clearDraft', {type: 'dblclick'}); }
                        Bus.handleSearchKeydown(e);
                        if (!e.altKey && State.chordBuffer.length === 0) return;
                        if (['Alt', 'Control', 'Shift', 'Meta'].includes(e.key)) return;
                        const key = e.key.toLowerCase();
                        if (State.chordBuffer.length === 0) {
                            if (e.altKey) {
                                const potentialMatches = Object.keys(State.macros).filter(k => k.startsWith(key + ',') || k === key);
                                if (potentialMatches.length > 0) {
                                    const exactMatch = State.macros[key]; const isPrefixForOthers = potentialMatches.some(k => k.startsWith(key + ','));
                                    if (exactMatch && !isPrefixForOthers) { e.preventDefault(); Bus.insertHTML(exactMatch); Renderer.toast(`MACRO [${key.toUpperCase()}]`); } 
                                    else if (potentialMatches.length > 0) { e.preventDefault(); State.chordBuffer.push(key); Renderer.toast(`S√âQUENCE: ${key.toUpperCase()}...`); document.getElementById('macro-hud').classList.add('visible'); clearTimeout(State.chordTimer); State.chordTimer = setTimeout(() => { State.chordBuffer = []; Renderer.toast("TIMEOUT MACRO"); document.getElementById('macro-hud').classList.remove('visible'); }, 2000); }
                                }
                            }
                            return;
                        }
                        e.preventDefault(); State.chordBuffer.push(key); const sequence = State.chordBuffer.join(',');
                        if (State.macros[sequence]) { Bus.insertHTML(State.macros[sequence]); Renderer.toast(`MACRO [${sequence.toUpperCase()}]`); State.chordBuffer = []; clearTimeout(State.chordTimer); document.getElementById('macro-hud').classList.remove('visible'); } 
                        else { const isPrefix = Object.keys(State.macros).some(k => k.startsWith(sequence + ',')); if (isPrefix) { Renderer.toast(`S√âQUENCE: ${sequence.toUpperCase()}...`); clearTimeout(State.chordTimer); State.chordTimer = setTimeout(() => { State.chordBuffer = []; Renderer.toast("TIMEOUT MACRO"); }, 2000); } else { Renderer.toast(`S√âQUENCE INCONNUE: ${sequence.toUpperCase()}`); State.chordBuffer = []; clearTimeout(State.chordTimer); } }
                    });
                    document.addEventListener('keyup', (e) => { if(e.key === 'Alt') { if(State.chordBuffer.length === 0) document.getElementById('macro-hud').classList.remove('visible'); } });
                    document.getElementById('search-input').addEventListener('input', Engine.utils.debounce((e) => { Intelligence.performSearch(e.target.value); }, 150));
                    Bus.renderBinder(); Renderer.renderHUD(State.macros);
                    setTimeout(() => { document.getElementById('splash-screen').style.opacity=0; setTimeout(()=>document.getElementById('splash-screen').remove(),700); }, 1000);
                } catch(e) { console.error(e); Renderer.toast("ERR KERNEL"); }
            };

            return { init };
        })();
        window.onload = System.init;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgenData v10.0 - OS Tactique Titan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0a0f1d;
            --bg-panel: #111827;
            --accent: #3b82f6;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .editor-layer {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .editor-layer:focus-within { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        [contenteditable]:focus { outline: none; }
        
        .high-contrast { background: #ffffff !important; color: #000000 !important; }
        .high-contrast [contenteditable] { color: #000000 !important; }

        .agenda-card {
            border-bottom: 1px solid var(--border);
            border-left: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .agenda-card.today { background: rgba(59, 130, 246, 0.05); border-left-color: var(--accent); }
        .card-actions { opacity: 0; transform: translateY(5px); transition: all 0.2s; }
        .agenda-card:hover .card-actions { opacity: 1; transform: translateY(0); }
        
        .action-icon { padding: 5px; border-radius: 4px; color: #64748b; cursor: pointer; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .action-icon:hover { background: #334155; color: white; transform: scale(1.1); }

        .smart-link { font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .smart-link:hover { opacity: 0.8; }
        .backlink { color: #8b5cf6; background: rgba(139, 92, 246, 0.1); padding: 0 4px; border-radius: 4px; }
        .hashtag { color: #10b981; background: rgba(16, 185, 129, 0.1); padding: 0 4px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.85em; }
        mark { background: rgba(59, 130, 246, 0.4); color: white; border-radius: 2px; padding: 0 2px; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 20px; width: 95%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        #macro-hud {
            position: fixed; bottom: 30px; right: 30px;
            background: rgba(10, 15, 29, 0.9); border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 0; border-radius: 16px; display: none; z-index: 80; width: 280px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(12px);
            overflow: hidden;
            font-family: var(--font-mono);
        }
        .hud-header {
            background: rgba(59, 130, 246, 0.1); padding: 12px 16px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .hud-buffer { color: var(--accent); font-weight: 700; letter-spacing: 0.2em; }
        .hud-content { padding: 8px 0; max-height: 300px; overflow-y: auto; }
        .macro-item { padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.03); transition: all 0.2s; }
        .macro-item.active { background: rgba(59, 130, 246, 0.15); border-left: 3px solid var(--accent); }

        .ai-pulse { width: 8px; height: 8px; border-radius: 50%; position: relative; }
        .ai-pulse.active { background: #10b981; box-shadow: 0 0 12px #10b981; }
        .ai-pulse.idle { background: #475569; }
        .ai-pulse.warning { background: #f59e0b; box-shadow: 0 0 12px #f59e0b; }

        .search-group-title { font-size: 10px; font-weight: 900; color: var(--accent); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 12px; margin-top: 24px; padding-left: 4px; display: flex; align-items: center; gap: 10px; }
        .search-group-title::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.05); }
        .search-result-card { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .search-result-card:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255,255,255,0.15); transform: translateX(4px); }
        
        .help-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .help-section { border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2.5rem; margin-bottom: 2.5rem; }
        .help-title { font-family: var(--font-mono); font-weight: 900; letter-spacing: 0.1em; color: var(--accent); font-size: 13px; margin-bottom: 1.5rem; border-left: 4px solid var(--accent); padding-left: 14px; text-transform: uppercase; }
        .help-content { color: var(--text-muted); font-size: 14px; line-height: 1.8; }
        .help-content b { color: var(--text-main); font-weight: 700; }
        .help-content i { color: #8b5cf6; }
        
        #smart-toolbar { position: absolute; display: none; background: #0f172a; border: 1px solid var(--border); border-radius: 8px; padding: 6px; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        
        .ai-response-block { margin-top: 1rem; padding: 1.5rem; background: rgba(139, 92, 246, 0.05); border-left: 3px solid #8b5cf6; font-size: 0.95em; color: #a78bfa; border-radius: 0 12px 12px 0; }
        .ai-response-header { display: block; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #8b5cf6; margin-bottom: 0.75rem; letter-spacing: 0.15em; }
    </style>
</head>
<body class="flex-col md:flex-row">

    <aside class="w-full md:w-[380px] border-r border-white/5 flex flex-col shrink-0 bg-black/20 z-10">
        <header class="h-14 flex items-center justify-between px-4 border-b border-white/5 bg-white/[0.02]">
            <div class="flex items-center gap-2">
                <button onclick="Core.Agenda.shiftWeek(-1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5"/></svg>
                </button>
                <span id="ui-week-range" class="text-[10px] font-mono font-black uppercase text-slate-400"></span>
                <button onclick="Core.Agenda.shiftWeek(1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5"/></svg>
                </button>
            </div>
            <button onclick="Core.Agenda.jumpToToday()" class="text-[9px] font-black bg-blue-500/10 text-blue-400 px-3 py-1.5 rounded border border-blue-500/20">AUJOURD'HUI</button>
        </header>
        <div id="ui-agenda-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        <div id="ui-flashback-zone" class="mt-auto border-t border-white/5"></div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-white/[0.01]">
        <header class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/20 shrink-0">
            <div class="flex items-center gap-1">
                <button onclick="Core.Editor.toggleMode()" id="ui-mode-btn" class="p-2 text-slate-400 hover:text-white" title="Mode Lecture (Alt+V)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.Editor.toggleContrast()" class="p-2 text-slate-400 hover:text-white" title="Contraste Relecture">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 4v16c4.41 0 8-3.59 8-8s-3.59-8-8-8z"/></svg>
                </button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.Editor.addLine('start')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Ins√©rer haut">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19V5m-7 7l7-7 7 7" stroke-width="2.5"/></svg>
                </button>
                <button onclick="Core.Editor.addLine('end')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Ins√©rer bas">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 5v14m-7-7l7 7 7-7" stroke-width="2.5"/></svg>
                </button>
            </div>

            <div class="flex items-center gap-3">
                <div id="ui-ai-status-container" title="Densit√© cognitive">
                    <div id="ui-ai-status-dot" class="ai-pulse idle"></div>
                    <span id="ui-ai-status-text" class="text-[9px] font-mono font-bold text-slate-500 uppercase">Passif</span>
                </div>
                
                <button onclick="Core.AI.challenge()" class="p-2 text-violet-400 hover:text-violet-300" title="IA Challenge (Alt+C)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.UI.openMacros()" class="p-2 text-slate-500 hover:text-purple-400" title="Macros">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.UI.openSearch()" class="p-2 text-slate-500 hover:text-blue-400" title="Recherche (Ctrl+F)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"/></svg>
                </button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.IO.triggerImport()" class="p-2 text-slate-500 hover:text-emerald-400" title="Import">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.IO.exportMD()" class="p-2 text-slate-500 hover:text-blue-400" title="Export">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.UI.openHelp()" class="p-2 text-slate-600 hover:text-yellow-500" title="Aide (F1)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 custom-scrollbar">
            <div id="editor-canvas" class="max-w-3xl mx-auto editor-layer rounded-2xl shadow-2xl transition-all duration-300">
                <div id="main-editor" contenteditable="true" class="p-12 md:p-16 min-h-[60vh] text-[1.05rem] text-slate-300 leading-relaxed outline-none" placeholder="Capture ta pens√©e ici..."></div>
            </div>
        </div>

        <div id="smart-toolbar" class="flex items-center">
            <div class="px-2 text-[8px] text-slate-500 font-black border-r border-white/10 mr-1 flex items-center gap-1">
                <svg class="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/></svg>TRANSFERT
            </div>
            <div id="ui-toolbar-days" class="flex gap-1 px-1"></div>
        </div>
        
        <input type="file" id="import-input" class="hidden" accept=".json,.md" onchange="Core.IO.importData(event)">
    </main>

    <!-- MODAL: RECHERCHE -->
    <div id="modal-search" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-4xl !rounded-3xl shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-8 bg-black/40 border-b border-white/5">
                <div class="flex items-center gap-6 mb-4">
                    <div class="p-3 bg-blue-500/10 rounded-2xl border border-blue-500/20">
                        <svg class="w-7 h-7 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"/></svg>
                    </div>
                    <input type="text" id="search-input" class="w-full bg-transparent text-white text-3xl outline-none font-mono placeholder:text-slate-800" placeholder="Terme tactique..." oninput="Core.Search.exec(this.value)">
                </div>
                <div class="flex gap-4">
                    <button onclick="Core.Search.quickFilter('#')" class="text-[9px] font-bold text-blue-400 border border-blue-400/20 px-3 py-1 rounded"># HASHTAGS</button>
                    <button onclick="Core.Search.quickFilter('[[')" class="text-[9px] font-bold text-violet-400 border border-violet-400/20 px-3 py-1 rounded">[[ CONCEPTS</button>
                </div>
            </div>
            <div id="search-results" class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-[#0a0f1d]/50 min-h-[500px]"></div>
            <div class="p-4 border-t border-white/5 bg-black/20 px-8 flex justify-between items-center text-[9px] font-mono text-slate-500">
                <span id="ui-search-count">INDEXATION PR√äTE</span>
                <span>ESC POUR FERMER</span>
            </div>
        </div>
    </div>

    <!-- MODAL: AIDE TACTIQUE EXHAUSTIVE -->
    <div id="modal-help" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-5xl !rounded-3xl shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-8 bg-black/40 border-b border-white/5 flex flex-col gap-6">
                <div class="flex justify-between items-start">
                    <h2 class="text-xl font-black uppercase tracking-widest text-white">Manifeste Op√©rationnel AgenData v10.0</h2>
                    <button onclick="Core.UI.closeModals()" class="p-2 text-slate-500 hover:text-white bg-white/5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>
                <div class="flex gap-8 border-b border-white/5 overflow-x-auto no-scrollbar custom-scrollbar">
                    <button onclick="Core.UI.switchHelp('philosophie')" class="help-tab active pb-3 text-[11px] font-black uppercase tracking-wider">Philosophie</button>
                    <button onclick="Core.UI.switchHelp('protocole')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Protocole</button>
                    <button onclick="Core.UI.switchHelp('cas')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Cas Pratique</button>
                    <button onclick="Core.UI.switchHelp('lexique')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Lexique</button>
                </div>
            </div>
            <div id="ui-help-content" class="p-12 overflow-y-auto custom-scrollbar min-h-[600px] bg-black/10"></div>
        </div>
    </div>

    <!-- MACROS -->
    <div id="modal-macros" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box max-w-xl !p-8" onclick="event.stopPropagation()">
            <h2 class="text-xl font-black uppercase tracking-widest text-white mb-6">Protocoles</h2>
            <div id="ui-macro-manager-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 mb-6"></div>
            <div class="border-t border-white/5 pt-6">
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <input type="text" id="ui-new-macro-trigger" placeholder="d,o" class="col-span-1 bg-black/40 border border-white/10 p-3 text-xs text-blue-400 font-mono rounded-xl outline-none">
                    <input type="text" id="ui-new-macro-text" placeholder="Expansion..." class="col-span-3 bg-black/40 border border-white/10 p-3 text-xs text-white rounded-xl outline-none">
                </div>
                <button onclick="Core.Macros.add()" class="w-full py-3 bg-blue-500/10 text-blue-400 text-[10px] font-black uppercase rounded-xl border border-blue-500/20">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- CONCEPT VIEWER -->
    <div id="modal-concept" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-5xl" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
                <h2 id="ui-concept-title" class="text-2xl font-black text-white uppercase tracking-tighter"></h2>
                <div class="flex gap-3">
                    <button onclick="Core.AI.synthesize()" class="bg-violet-500/20 text-violet-300 border border-violet-500/30 px-4 py-2 rounded-lg text-[10px] font-black uppercase">Cristalliser</button>
                    <button onclick="Core.UI.closeModals()" class="p-2 text-slate-500 hover:text-white bg-white/5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>
            </div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-px bg-white/5">
                <div id="ui-concept-snippets" class="bg-[#111827] p-6 overflow-y-auto custom-scrollbar space-y-4"></div>
                <div id="ui-concept-synthesis" contenteditable="true" class="bg-[#0a0f1d] p-8 text-slate-300 leading-relaxed outline-none overflow-y-auto custom-scrollbar text-sm"></div>
            </div>
        </div>
    </div>

    <div id="macro-hud">
        <div class="hud-header">
            <span class="text-[9px] font-black text-slate-500 uppercase">Input</span>
            <span id="ui-hud-buffer" class="hud-buffer">_</span>
        </div>
        <div id="ui-macro-list-hud" class="hud-content custom-scrollbar"></div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-white/10 px-6 py-3 rounded-xl text-xs font-bold transition-all opacity-0 pointer-events-none z-[200]"></div>

    <script>
        const Core = {
            State: { currentMonday: null, isReadMode: false, isContrast: false, macroBuffer: [], macroTimeout: null, macros: {}, activeConcept: null },
            DB: null,
            Init: async function() {
                this.DB = new Dexie("AgenDataDB_v9");
                this.DB.version(1).stores({ meta: "id", agenda: "date", macros: "trigger", concepts: "title" });
                this.State.currentMonday = this.Utils.getMonday(new Date());
                await this.Storage.loadAll();
                this.Agenda.render();
                this.Listeners.setup();
                this.Utils.toast("SYST√àME V10.0 ACTIF");
                this.AI.updateStatus();
            },
            Utils: {
                getMonday: d => { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)).setHours(0,0,0,0); },
                formatDate: d => d.toISOString().split('T')[0],
                toast: msg => { 
                    const el = document.getElementById('toast'); if (!el) return;
                    el.textContent = msg; el.style.opacity = "1"; el.style.transform = "translateX(-50%) translateY(0)"; 
                    setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateX(-50%) translateY(10px)"; }, 2500); 
                },
                debounce: (fn, ms) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn.apply(this, args), ms); }; },
                highlight: (text, query) => { if(!query) return text; const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'); return text.replace(re, '<mark>$1</mark>'); }
            },
            Storage: {
                saveEditor: async () => { if(Core.State.isReadMode) return; const html = document.getElementById('main-editor').innerHTML; await Core.DB.meta.put({id: 'editor', content: html, ts: Date.now()}); Core.AI.updateStatus(); },
                saveConcept: async (title, synthesis) => { await Core.DB.concepts.put({title, synthesis, ts: Date.now()}); },
                loadAll: async () => { 
                    const ed = await Core.DB.meta.get('editor'); if(ed) document.getElementById('main-editor').innerHTML = ed.content; 
                    const m = await Core.DB.macros.toArray(); Core.State.macros = {}; m.forEach(x => Core.State.macros[x.trigger] = x.text);
                    if(!m.length) {
                        const d = {'s,d': 'üå± ', 'g,r': 'üåø ', 'p,e': 'üå≥ ', 'c,o': '[[]]', 't,o': '‚úÖ ', 'n,o': '‚ùå '};
                        for(let k in d) { await Core.DB.macros.put({trigger: k, text: d[k]}); Core.State.macros[k] = d[k]; }
                    }
                }
            },
            Agenda: {
                render: async function() {
                    const container = document.getElementById('ui-agenda-list'); if(!container) return;
                    container.innerHTML = ''; const start = new Date(Core.State.currentMonday);
                    const rangeEl = document.getElementById('ui-week-range'); if(rangeEl) rangeEl.textContent = `${start.getDate()}/${start.getMonth()+1} - ${new Date(start.getTime() + 6*86400000).getDate()}/${start.getMonth()+1}`;
                    for(let i=0; i<7; i++) {
                        const current = new Date(start.getTime() + i*86400000);
                        const key = Core.Utils.formatDate(current);
                        const isToday = key === Core.Utils.formatDate(new Date());
                        const data = await Core.DB.agenda.get(key);
                        const card = document.createElement('div');
                        card.className = `agenda-card px-5 py-4 ${isToday ? 'today' : ''}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-black ${isToday ? 'text-blue-400' : 'text-slate-600'} uppercase">${current.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'})}</span>
                                <div class="card-actions flex gap-1">
                                    <button onclick="Core.Agenda.importFromDraft('${key}')" class="action-icon" title="Archiver (Purge)"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="2.5"/></svg></button>
                                    <button onclick="Core.Agenda.copyToClipboard('${key}')" class="action-icon" title="Copier"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2.5"/></svg></button>
                                    <button onclick="Core.Agenda.pushToDraft('${key}')" class="action-icon" title="Restaurer"><svg class="w-3 h-3 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7M5 5l7 7-7 7" stroke-width="2.5"/></svg></button>
                                    <button onclick="Core.Agenda.clear('${key}')" class="action-icon text-red-500/50" title="Vider"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5"/></svg></button>
                                </div>
                            </div>
                            <div contenteditable="true" oninput="Core.Agenda.save('${key}', this.innerHTML)" class="text-[0.85rem] text-slate-400 outline-none min-h-[4rem] custom-scrollbar leading-relaxed">${data ? data.content : ''}</div>`;
                        container.appendChild(card);
                    }
                    this.renderFlashback();
                },
                renderFlashback: async function() {
                    const zone = document.getElementById('ui-flashback-zone'); if (!zone) return;
                    zone.innerHTML = ''; const intervals = [30, 90, 365]; const now = new Date(); let match = null;
                    for(let days of intervals) {
                        const target = new Date(now.getTime() - days*86400000);
                        const data = await Core.DB.agenda.get(Core.Utils.formatDate(target));
                        if(data && data.content.trim()) { match = {d: target, c: data.content, interval: days}; break; }
                    }
                    if(match) {
                        const card = document.createElement('div'); card.className = 'agenda-card flashback p-5';
                        card.innerHTML = `<div class="text-[9px] font-black text-purple-400 uppercase mb-2">FLASHBACK J-${match.interval}</div><div class="text-[0.8rem] text-slate-500 italic line-clamp-4 leading-relaxed">${match.c}</div>`;
                        zone.appendChild(card);
                    }
                },
                save: async (date, content) => { await Core.DB.agenda.put({date, content, ts: Date.now()}); },
                shiftWeek: (dir) => { Core.State.currentMonday = new Date(Core.State.currentMonday.getTime() + (dir * 7 * 86400000)); Core.Agenda.render(); },
                jumpToToday: () => { Core.State.currentMonday = Core.Utils.getMonday(new Date()); Core.Agenda.render(); },
                importFromDraft: async (key) => {
                    const draft = document.getElementById('main-editor').innerHTML; if(!draft.trim()) return;
                    const entry = await Core.DB.agenda.get(key);
                    const newContent = (entry ? entry.content : '') + '<br>' + draft;
                    await Core.Agenda.save(key, newContent); Core.Agenda.render(); 
                    document.getElementById('main-editor').innerHTML = ''; Core.Storage.saveEditor();
                },
                copyToClipboard: async (key) => {
                    const entry = await Core.DB.agenda.get(key); if(!entry) return;
                    const text = entry.content.replace(/<[^>]*>/g, '');
                    const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
                    Core.Utils.toast("COPI√â");
                },
                pushToDraft: async (key) => {
                    const entry = await Core.DB.agenda.get(key);
                    if(entry) { document.getElementById('main-editor').innerHTML += `<br><br>${entry.content}`; Core.Storage.saveEditor(); }
                },
                clear: async (key) => { if(confirm("Supprimer la trace ?")) { await Core.DB.agenda.delete(key); Core.Agenda.render(); } }
            },
            Editor: {
                toggleMode: function() {
                    const el = document.getElementById('main-editor'); Core.State.isReadMode = !Core.State.isReadMode; el.contentEditable = !Core.State.isReadMode;
                    if(Core.State.isReadMode) { Core.State.rawCache = el.innerHTML; this.processLinks(el); document.getElementById('ui-mode-btn').classList.add('text-blue-400'); } 
                    else { el.innerHTML = Core.State.rawCache || el.innerHTML; document.getElementById('ui-mode-btn').classList.remove('text-blue-400'); }
                },
                toggleContrast: function() {
                    const canvas = document.getElementById('editor-canvas');
                    Core.State.isContrast = !Core.State.isContrast;
                    canvas.classList.toggle('high-contrast', Core.State.isContrast);
                    Core.Utils.toast(Core.State.isContrast ? "RELECTURE" : "STANDARD");
                },
                addLine: (pos) => {
                    const div = document.createElement('div'); div.innerHTML = '<br>'; const ed = document.getElementById('main-editor');
                    pos === 'start' ? ed.prepend(div) : ed.append(div);
                    const range = document.createRange(), sel = window.getSelection(); range.setStart(div, 0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); div.focus();
                },
                processLinks: (el) => {
                    let html = el.innerHTML;
                    html = html.replace(/\[\[(.*?)\]\]/g, '<span class="smart-link backlink" onclick="Core.UI.openConcept(\'$1\')">$1</span>');
                    html = html.replace(/#(\w+)/g, '<span class="smart-link hashtag" onclick="Core.Search.quickFilter(\'#$1\')">#$1</span>');
                    el.innerHTML = html;
                }
            },
            AI: {
                call: async function(prompt, systemInstruction) {
                    const apiKey = "";
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    try {
                        const resp = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                        const data = await resp.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch(e) { return null; }
                },
                updateStatus: function() {
                    const text = document.getElementById('main-editor').innerText.trim();
                    const dot = document.getElementById('ui-ai-status-dot');
                    const label = document.getElementById('ui-ai-status-text');
                    if (!dot || !label) return;
                    if (text.length < 50) { dot.className = "ai-pulse idle"; label.textContent = "Passif"; }
                    else if (text.length < 300) { dot.className = "ai-pulse warning"; label.textContent = "Faible"; }
                    else { dot.className = "ai-pulse active"; label.textContent = "Dense"; }
                },
                challenge: async function() {
                    const text = document.getElementById('main-editor').innerText;
                    if (text.length < 50) return Core.Utils.toast("Masse critique insuffisante.");
                    Core.Utils.toast("AUDIT TITAN...");
                    const system = `Tu es Titan, conseiller strat√©gique brutal. Analyse le texte pour y trouver les excuses, les biais et les failles logiques. Sois sec et direct. Pas d'emojis.`;
                    const result = await this.call(text, system);
                    if (result) {
                        const div = document.createElement('div'); div.className = "ai-response-block";
                        div.innerHTML = `<span class="ai-response-header">AUDIT TACTIQUE TITAN</span>${result.replace(/\n/g, '<br>')}`;
                        document.getElementById('main-editor').append(div); Core.Storage.saveEditor();
                    }
                },
                synthesize: async function() {
                    if(!Core.State.activeConcept) return;
                    Core.Utils.toast("CRISTALLISATION...");
                    const snippets = Array.from(document.querySelectorAll('#ui-concept-snippets div')).map(s => s.innerText).join('\n---\n');
                    const system = `Synth√®se chirurgicale pour [[${Core.State.activeConcept}]]. Dense. Actionnable.`;
                    const result = await this.call(snippets, system);
                    if (result) {
                        const target = document.getElementById('ui-concept-synthesis');
                        if (target) { target.innerHTML = result.replace(/\n/g, '<br>'); Core.Storage.saveConcept(Core.State.activeConcept, result); }
                    }
                }
            },
            Search: {
                exec: async (q) => {
                    const resContainer = document.getElementById('search-results'); if(!resContainer) return;
                    if(!q || q.length < 2) { resContainer.innerHTML = ''; return; }
                    const query = q.toLowerCase(); resContainer.innerHTML = ''; let count = 0;

                    const render = (meta, text, action) => {
                        const card = document.createElement('div'); card.className = "search-result-card";
                        card.innerHTML = `<div class="search-result-meta">${meta}</div><div class="search-result-text">${Core.Utils.highlight(text, query)}</div>`;
                        card.onclick = action; resContainer.appendChild(card); count++;
                    };

                    const draft = await Core.DB.meta.get('editor');
                    if(draft && draft.content.toLowerCase().includes(query)) {
                        resContainer.innerHTML += '<div class="search-group-title">Br√ªlant (Brouillon)</div>';
                        render("Pr√©sent", draft.content.replace(/<[^>]*>/g, ''), () => Core.UI.closeModals());
                    }

                    const concepts = await Core.DB.concepts.toArray();
                    const conceptsRes = concepts.filter(x => x.title.toLowerCase().includes(query) || (x.synthesis && x.synthesis.toLowerCase().includes(query)));
                    if(conceptsRes.length > 0) {
                        resContainer.innerHTML += '<div class="search-group-title">Concepts (S√©mantique)</div>';
                        conceptsRes.forEach(x => render(`Cristallisation : ${x.title}`, x.synthesis || 'Vide', () => Core.UI.openConcept(x.title)));
                    }

                    const agenda = await Core.DB.agenda.toArray();
                    const results = agenda.filter(x => x.content.toLowerCase().includes(query)).sort((a,b) => b.date.localeCompare(a.date));
                    if(results.length > 0) {
                        resContainer.innerHTML += '<div class="search-group-title">Froid (Agenda)</div>';
                        results.forEach(x => render(x.date, x.content.replace(/<[^>]*>/g, ''), () => { 
                            Core.State.currentMonday = Core.Utils.getMonday(new Date(x.date)); 
                            Core.Agenda.render().then(() => Core.UI.closeModals()); 
                        }));
                    }
                    const countEl = document.getElementById('ui-search-count');
                    if(countEl) countEl.textContent = `${count} EXTRACTION(S) TROUV√âE(S)`;
                },
                quickFilter: (prefix) => {
                    const input = document.getElementById('search-input');
                    if (input) { input.value = prefix; input.focus(); Core.Search.exec(prefix); }
                }
            },
            UI: {
                openSearch: () => { const m = document.getElementById('modal-search'); if(m) { m.style.display = 'flex'; document.getElementById('search-input').focus(); } },
                openMacros: () => { const m = document.getElementById('modal-macros'); if(m) { m.style.display = 'flex'; Core.Macros.renderManager(); } },
                openConcept: async (kw) => {
                    Core.State.activeConcept = kw; 
                    const title = document.getElementById('ui-concept-title'); if (title) title.textContent = kw;
                    const snippets = document.getElementById('ui-concept-snippets'); 
                    if (snippets) {
                        snippets.innerHTML = '';
                        const all = await Core.DB.agenda.toArray();
                        all.forEach(entry => {
                            if(entry.content.toLowerCase().includes(kw.toLowerCase())) {
                                const d = document.createElement('div'); d.className = "p-3 bg-white/[0.03] rounded-lg border border-white/5 text-[11px] text-slate-400 mb-2";
                                d.innerHTML = `<span class="text-blue-500 font-bold block mb-1 uppercase text-[8px] tracking-widest">${entry.date}</span>${entry.content}`; snippets.appendChild(d);
                            }
                        });
                    }
                    const cache = await Core.DB.concepts.get(kw);
                    const synthesis = document.getElementById('ui-concept-synthesis');
                    if (synthesis) synthesis.innerHTML = cache ? cache.synthesis : "<div class='text-slate-600 italic'>Pr√™t pour cristallisation.</div>";
                    const m = document.getElementById('modal-concept'); if(m) m.style.display = 'flex';
                },
                openHelp: () => { Core.UI.switchHelp('philosophie'); const m = document.getElementById('modal-help'); if(m) m.style.display = 'flex'; },
                switchHelp: (tab) => {
                    document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
                    const btn = document.querySelector(`[onclick="Core.UI.switchHelp('${tab}')"]`);
                    if(btn) btn.classList.add('active');
                    const content = document.getElementById('ui-help-content'); if (!content) return;
                    
                    if(tab === 'philosophie') {
                        content.innerHTML = `
                        <div class="help-section">
                            <div class="help-title">La Connaissance est une Dette</div>
                            <div class="help-content space-y-6">
                                <p>AgenData n'est pas un entrep√¥t de souvenirs, c'est une <b>infrastructure de transformation</b>. Chaque note que tu captures est une dette cognitive : elle consomme ton attention jusqu'√† ce qu'elle soit convertie en <b>action</b> ou en <b>d√©cision</b>.</p>
                                <p><b>L'illusion du stockage :</b> Accumuler des informations sans les transformer cr√©e un sentiment de progr√®s artificiel. C'est du productivisme de fa√ßade. L'OS est con√ßu pour te mettre mal √† l'aise face √† l'accumulation inutile.</p>
                                <p><b>La Destruction par l'Action :</b> Le but ultime d'une note est sa propre destruction. Une fois l'action effectu√©e, la trace devient "Froid" (Agenda) et ne doit plus encombrer ton "Pr√©sent" (Brouillon).</p>
                            </div>
                        </div>`;
                    } else if(tab === 'protocole') {
                        content.innerHTML = `
                        <div class="help-section">
                            <div class="help-title">Le Flux des 72 Heures</div>
                            <div class="help-content space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div class="p-6 bg-white/5 rounded-2xl border border-white/5">
                                        <b>1. Capture Radicale (Le Brouillon)</b>
                                        <p class="mt-2 opacity-60">Note tout sans filtrer dans le champ central. Ne cherche pas la structure ici, cherche la capture. C'est ton Inbox universel.</p>
                                    </div>
                                    <div class="p-6 bg-white/5 rounded-2xl border border-white/5">
                                        <b>2. Audit & Transfert</b>
                                        <p class="mt-2 opacity-60">Surligne le texte. Utilise la barre flottante pour l'injecter dans un jour pr√©cis de l'Agenda. Si une id√©e üå± stagne 72h, supprime-la.</p>
                                    </div>
                                    <div class="p-6 bg-white/5 rounded-2xl border border-white/5">
                                        <b>3. Purge (Bouton ‚Üì)</b>
                                        <p class="mt-2 opacity-60">Chaque soir, vide le Brouillon. Clique sur ‚Üì d'un jour d'Agenda pour y "dumper" tout le reste. Ton cockpit doit √™tre vide au r√©veil.</p>
                                    </div>
                                    <div class="p-6 bg-white/5 rounded-2xl border border-white/5">
                                        <b>4. Cristallisation</b>
                                        <p class="mt-2 opacity-60">Utilise [[Concept]] pour lier les th√®mes r√©currents. Quand un concept a assez de snippets, Titan g√©n√®re une synth√®se finale (Cristallisation).</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    } else if(tab === 'cas') {
                        content.innerHTML = `
                        <div class="help-section">
                            <div class="help-title">√âtude de Cas : Le Lancement de Projet</div>
                            <div class="help-content space-y-6">
                                <p><i>Sc√©nario : Tu as une id√©e de nouvelle offre de service.</i></p>
                                <ol class="list-decimal ml-6 space-y-4">
                                    <li><b>√âtape 1 :</b> Tu tapes "Id√©e offre X" dans le Brouillon. Tu ajoutes le tag <i>[[OffreX]]</i>.</li>
                                    <li><b>√âtape 2 :</b> Tu surlignes "Appeler client Y pour tester" et tu cliques sur "J" (Jeudi) dans la barre de transfert.</li>
                                    <li><b>√âtape 3 :</b> Tu ouvres le concept <i>[[OffreX]]</i>. Tu vois tous tes snippets pr√©c√©dents sur ce th√®me. Tu cliques sur "Cristalliser".</li>
                                    <li><b>√âtape 4 :</b> Titan g√©n√®re une synth√®se strat√©gique. Tu copies cette synth√®se et tu la transformes en document de vente.</li>
                                    <li><b>√âtape 5 :</b> Tu purges ton brouillon. L'id√©e est devenue une action (appel) et un pilier (document). La dette est pay√©e.</li>
                                </ol>
                            </div>
                        </div>`;
                    } else if(tab === 'lexique') {
                        content.innerHTML = `
                        <div class="help-section">
                            <div class="help-title">Commandes & Statuts</div>
                            <div class="help-content grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <b>Raccourcis Clavier</b>
                                    <ul class="mt-4 space-y-2 opacity-70">
                                        <li><i>Alt + V :</i> Mode Lecture (Wiki)</li>
                                        <li><i>Alt + C :</i> Engagement Titan (Audit)</li>
                                        <li><i>Ctrl + F :</i> Recherche</li>
                                        <li><i>F1 :</i> Ce Manuel</li>
                                    </ul>
                                </div>
                                <div>
                                    <b>Tags de Maturit√©</b>
                                    <ul class="mt-4 space-y-2 opacity-70">
                                        <li><i>üå± Graine (s,d) :</i> Information brute.</li>
                                        <li><i>üåø Pousse (g,r) :</i> En cours de maillage.</li>
                                        <li><i>üå≥ Pilier (p,e) :</i> Connaissance immuable.</li>
                                    </ul>
                                </div>
                                <div>
                                    <b>Indicateur de Densit√©</b>
                                    <p class="mt-2 opacity-70">La LED en haut √† droite analyse ton brouillon. <b>Vert</b> = Masse critique atteinte, Titan peut auditer. <b>Orange/Gris</b> = Pens√©e trop pauvre.</p>
                                </div>
                            </div>
                        </div>`;
                    }
                },
                closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); },
                showToolbar: (rect) => {
                    const bar = document.getElementById('smart-toolbar'); const container = document.getElementById('ui-toolbar-days'); if (!bar || !container) return;
                    container.innerHTML = '';
                    ['L','M','M','J','V','S','D'].forEach((d, i) => {
                        const target = new Date(Core.State.currentMonday); target.setDate(target.getDate() + i); const k = Core.Utils.formatDate(target);
                        const btn = document.createElement('button'); btn.className = "px-2 py-1 text-[9px] hover:bg-blue-500 hover:text-white rounded text-slate-500 font-bold transition-colors";
                        btn.textContent = d; btn.onmousedown = (e) => { e.preventDefault(); Core.Agenda.importFromDraft(k); }; container.appendChild(btn);
                    });
                    bar.style.top = `${rect.bottom + window.scrollY + 8}px`; bar.style.left = `${rect.left + window.scrollX}px`; bar.style.display = 'flex';
                }
            },
            Listeners: {
                setup: function() {
                    const editor = document.getElementById('main-editor'); if (!editor) return;
                    editor.addEventListener('input', Core.Utils.debounce(() => Core.Storage.saveEditor(), 1000));
                    document.addEventListener('keydown', e => {
                        const hud = document.getElementById('macro-hud');
                        if(e.key === 'Alt') { if(hud) hud.style.display = 'block'; Core.Macros.renderHUD(); }
                        if(e.key === 'Escape') Core.UI.closeModals();
                        if(e.altKey) {
                            if(e.key === 'v') { e.preventDefault(); Core.Editor.toggleMode(); }
                            if(e.key === 'c') { e.preventDefault(); Core.AI.challenge(); }
                            else if(e.key.length === 1) Core.Macros.handle(e.key);
                        }
                        if((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); Core.UI.openSearch(); }
                        if(e.key === 'F1') { e.preventDefault(); Core.UI.openHelp(); }
                    });
                    document.addEventListener('keyup', e => { 
                        if(e.key === 'Alt') { 
                            const hud = document.getElementById('macro-hud'); if(hud) hud.style.display = 'none'; 
                            Core.State.macroBuffer = []; const buffer = document.getElementById('ui-hud-buffer'); if(buffer) buffer.textContent = '_'; 
                        } 
                    });
                    document.addEventListener('selectionchange', () => {
                        const sel = window.getSelection();
                        if(sel.rangeCount && !sel.isCollapsed && editor.contains(sel.anchorNode)) Core.UI.showToolbar(sel.getRangeAt(0).getBoundingClientRect());
                        else { const bar = document.getElementById('smart-toolbar'); if(bar) bar.style.display = 'none'; }
                    });
                }
            },
            Macros: {
                handle: function(key) {
                    clearTimeout(Core.State.macroTimeout); Core.State.macroBuffer.push(key.toLowerCase());
                    const seq = Core.State.macroBuffer.join(',');
                    const buffer = document.getElementById('ui-hud-buffer');
                    if (buffer) buffer.textContent = Core.State.macroBuffer.join('').toUpperCase();
                    if(Core.State.macros[seq]) { 
                        document.execCommand('insertHTML', false, Core.State.macros[seq]); 
                        Core.State.macroBuffer = []; if(buffer) buffer.textContent = 'OK'; 
                    }
                    this.renderHUD();
                    Core.State.macroTimeout = setTimeout(() => { 
                        Core.State.macroBuffer = []; if(buffer) buffer.textContent = '_'; this.renderHUD(); 
                    }, 1200);
                },
                renderHUD: function() {
                    const hud = document.getElementById('ui-macro-list-hud'); if (!hud) return;
                    hud.innerHTML = ''; const buffer = Core.State.macroBuffer.join(',');
                    for(let k in Core.State.macros) {
                        const isActive = k.startsWith(buffer) && buffer.length > 0;
                        const item = document.createElement('div');
                        item.className = `macro-item ${isActive ? 'active' : ''}`;
                        item.innerHTML = `<span class="macro-trigger">${k.replace(',','+').toUpperCase()}</span><span class="macro-preview text-[9px] text-slate-500">${Core.State.macros[k].replace(/<[^>]*>/g, '')}</span>`;
                        hud.appendChild(item);
                    }
                },
                renderManager: async function() {
                    const list = document.getElementById('ui-macro-manager-list'); if (!list) return;
                    list.innerHTML = ''; const all = await Core.DB.macros.toArray();
                    all.forEach(m => {
                        const row = document.createElement('div'); row.className = "flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5 group";
                        row.innerHTML = `<div class="flex items-center gap-4"><span class="text-[10px] font-black text-blue-400 font-mono">${m.trigger.toUpperCase()}</span><span class="text-xs text-slate-400 truncate max-w-[200px]">${m.text.replace(/<[^>]*>/g, '')}</span></div><button onclick="Core.Macros.delete('${m.trigger}')" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5"/></svg></button>`;
                        list.appendChild(row);
                    });
                },
                add: async function() {
                    const trigger = document.getElementById('ui-new-macro-trigger').value.toLowerCase().trim();
                    const text = document.getElementById('ui-new-macro-text').value.trim();
                    if(!trigger || !text) return;
                    await Core.DB.macros.put({trigger, text});
                    document.getElementById('ui-new-macro-trigger').value = '';
                    document.getElementById('ui-new-macro-text').value = '';
                    await Core.Storage.loadAll(); this.renderManager();
                },
                delete: async function(trigger) { await Core.DB.macros.delete(trigger); await Core.Storage.loadAll(); this.renderManager(); }
            },
            IO: {
                triggerImport: () => document.getElementById('import-input').click(),
                exportMD: async () => {
                    const agenda = await Core.DB.agenda.toArray(); const meta = await Core.DB.meta.get('editor');
                    const blob = new Blob([JSON.stringify({agenda, editor: meta?.content})], {type: 'application/json'});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AgenData_v10.0.json`; a.click();
                },
                importData: (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if(data.agenda) for(let entry of data.agenda) await Core.DB.agenda.put(entry);
                            if(data.editor) await Core.DB.meta.put({id: 'editor', content: data.editor, ts: Date.now()});
                            location.reload();
                        } catch(err) { Core.Utils.toast("FORMAT ERRON√â"); }
                    };
                    reader.readAsText(file);
                }
            }
        };
        window.onload = () => Core.Init();
    </script>
</body>
</html>

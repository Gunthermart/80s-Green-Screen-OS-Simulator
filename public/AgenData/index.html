<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgenData v7.8 - Syst√®me Op√©rationnel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0a0f1d;
            --bg-panel: #111827;
            --accent: #3b82f6;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .editor-layer {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .editor-layer:focus-within { border-color: var(--accent); transform: translateY(-2px); }

        [contenteditable]:focus { outline: none; }

        .agenda-card {
            border-bottom: 1px solid var(--border);
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .agenda-card.today { background: rgba(59, 130, 246, 0.05); border-left-color: var(--accent); }
        .agenda-card.flashback { background: rgba(139, 92, 246, 0.05); border-left-color: #8b5cf6; }
        
        .card-actions { opacity: 0; transform: translateY(3px); transition: all 0.2s; }
        .agenda-card:hover .card-actions { opacity: 1; transform: translateY(0); }
        
        .action-icon { padding: 4px; border-radius: 4px; color: #64748b; cursor: pointer; background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .action-icon:hover { background: #334155; color: white; }

        .status-stale { color: #ef4444 !important; text-decoration: line-through dashed; opacity: 0.7; }
        .smart-link { color: var(--accent); font-weight: 600; cursor: pointer; border-bottom: 1px solid rgba(59, 130, 246, 0.2); }
        .backlink { color: #8b5cf6; background: rgba(139, 92, 246, 0.1); padding: 0 4px; border-radius: 4px; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 20px; width: 95%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }

        #macro-hud {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent);
            padding: 12px; border-radius: 12px; display: none; z-index: 80; width: 240px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #smart-toolbar { 
            position: absolute; display: none; background: #0f172a; border: 1px solid var(--border); 
            border-radius: 8px; padding: 4px; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        
        .help-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        
        .help-section-title { font-family: var(--font-mono); font-weight: 900; letter-spacing: 0.1em; color: var(--accent); font-size: 11px; margin-top: 1.5rem; margin-bottom: 0.5rem; border-left: 3px solid var(--accent); padding-left: 10px; }
        .help-step-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="flex-col md:flex-row">

    <aside class="w-full md:w-[380px] border-r border-white/5 flex flex-col shrink-0 bg-black/20">
        <header class="h-14 flex items-center justify-between px-4 border-b border-white/5 bg-white/[0.02]">
            <div class="flex items-center gap-2">
                <button onclick="Core.Agenda.shiftWeek(-1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5"/></svg>
                </button>
                <span id="ui-week-range" class="text-[10px] font-mono font-black uppercase text-slate-400"></span>
                <button onclick="Core.Agenda.shiftWeek(1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5"/></svg>
                </button>
            </div>
            <button onclick="Core.Agenda.jumpToToday()" class="text-[9px] font-black bg-blue-500/10 text-blue-400 px-3 py-1.5 rounded border border-blue-500/20">AUJOURD'HUI</button>
        </header>
        <div id="ui-agenda-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        <div id="ui-flashback-zone" class="mt-auto border-t border-white/5"></div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-white/[0.01]">
        <header class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/20 shrink-0">
            <div class="flex items-center gap-1">
                <button onclick="Core.Editor.toggleMode()" id="ui-mode-btn" class="p-2 text-slate-400 hover:text-white" title="Mode Lecture (Alt+V)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/></svg>
                </button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.Editor.contrast()" class="p-2 text-slate-300 hover:text-white" title="Contraste (Noir sur Blanc)">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 4v16c4.41 0 8-3.59 8-8s-3.59-8-8-8z"/></svg>
                </button>
                <button onclick="Core.Editor.highlight()" class="p-2 text-yellow-500/60 hover:text-yellow-400" title="Surligner"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.addLine('start')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Haut (Alt+N)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 11l5-5m0 0l5 5m-5-5v12" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.addLine('end')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Bas (Alt+E)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 13l-5 5m0 0l-5-5m5 5V6" stroke-width="2"/></svg></button>
            </div>

            <div class="flex items-center gap-1">
                <div id="ui-ai-status" class="w-2 h-2 rounded-full bg-slate-600 mr-2" title="Status IA"></div>
                <button onclick="Core.AI.challenge()" class="p-2 text-violet-400 hover:text-violet-300" title="IA Challenge"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openMacros()" class="p-2 text-slate-500 hover:text-purple-400" title="Macros (Alt+M)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="2"/></svg></button>
                <button id="ui-voice-btn" onclick="Core.Voice.toggle()" class="p-2 text-slate-500" title="Vocal (Alt+R)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openSearch()" class="p-2 text-slate-500" title="Recherche (Ctrl+F)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"/></svg></button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.IO.triggerImport()" class="p-2 text-slate-500 hover:text-blue-400" title="Importer"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg></button>
                <button onclick="Core.IO.exportMD()" class="p-2 text-slate-500 hover:text-blue-400" title="Exporter"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.clear()" class="p-2 text-slate-500 hover:text-red-400" title="Vider"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openHelp()" class="p-2 text-slate-600 hover:text-yellow-500" title="Aide (F1)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 custom-scrollbar">
            <div class="max-w-3xl mx-auto editor-layer rounded-2xl">
                <div id="main-editor" contenteditable="true" class="p-12 md:p-16 min-h-[60vh] text-[1.05rem] text-slate-300 leading-relaxed outline-none" placeholder="Lib√©rez votre pens√©e ici..."></div>
            </div>
        </div>

        <div id="smart-toolbar" class="flex items-center">
            <div class="px-2 text-[8px] text-slate-500 font-black border-r border-white/10 mr-1 flex items-center gap-1"><svg class="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/></svg>TRANSFERT</div>
            <div id="ui-toolbar-days" class="flex gap-1 px-1"></div>
        </div>
        <input type="file" id="import-input" class="hidden" accept=".json,.md" onchange="Core.IO.importData(event)">
    </main>

    <!-- MODALES -->
    <div id="modal-search" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="bg-[#111827] border border-white/10 p-8 rounded-2xl w-full max-w-2xl shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 border-b border-white/10 pb-4 mb-6">
                <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg>
                <input type="text" id="search-input" class="w-full bg-transparent text-white text-2xl outline-none font-mono" placeholder="Recherche profonde..." oninput="Core.Search.exec(this.value)">
            </div>
            <div id="search-results" class="max-h-[50vh] overflow-y-auto space-y-3 custom-scrollbar"></div>
        </div>
    </div>

    <div id="modal-macros" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box max-w-xl !p-8" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black uppercase tracking-widest text-white">Gestionnaire de Protocoles</h2>
                <button onclick="Core.UI.closeModals()" class="text-slate-500 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
            </div>
            <div class="mb-6">
                <label class="text-[10px] text-slate-500 uppercase font-black block mb-2">Biblioth√®que Active</label>
                <div id="ui-macro-manager-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
            </div>
            <div class="border-t border-white/5 pt-6">
                <label class="text-[10px] text-slate-500 uppercase font-black block mb-4">Nouveau Protocole</label>
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <input type="text" id="ui-new-macro-trigger" placeholder="d,o" class="col-span-1 bg-black/40 border border-white/10 p-3 text-xs text-blue-400 font-mono rounded-xl outline-none focus:border-blue-500/50">
                    <input type="text" id="ui-new-macro-text" placeholder="Expansion du texte..." class="col-span-3 bg-black/40 border border-white/10 p-3 text-xs text-white rounded-xl outline-none focus:border-blue-500/50">
                </div>
                <button onclick="Core.Macros.add()" class="w-full py-3 bg-blue-500/10 text-blue-400 text-[10px] font-black uppercase rounded-xl border border-blue-500/20 hover:bg-blue-500/20 transition-all tracking-widest">Enregistrer le Protocole</button>
            </div>
        </div>
    </div>

    <div id="modal-concept" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-5xl" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
                <h2 id="ui-concept-title" class="text-2xl font-black text-white uppercase tracking-tighter"></h2>
                <div class="flex gap-3">
                    <button onclick="Core.AI.synthesize()" class="bg-violet-500/20 text-violet-300 border border-violet-500/30 px-4 py-2 rounded-lg text-[10px] font-black uppercase flex items-center gap-2">IA Cristalliser</button>
                    <button onclick="Core.UI.closeModals()" class="p-2 text-slate-500 hover:text-white bg-white/5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>
            </div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-px bg-white/5">
                <div id="ui-concept-snippets" class="bg-[#111827] p-6 overflow-y-auto custom-scrollbar space-y-4"></div>
                <div id="ui-concept-synthesis" contenteditable="true" class="bg-[#0a0f1d] p-8 text-slate-300 leading-relaxed outline-none overflow-y-auto custom-scrollbar text-sm"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-4xl" onclick="event.stopPropagation()">
            <div class="p-8 bg-black/40 flex flex-col gap-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-widest text-white">Manuel Op√©rationnel v7.8</h2>
                        <p class="text-[10px] text-slate-500 uppercase mt-1 tracking-widest font-bold">L'art de la capture et de la cristallisation</p>
                    </div>
                    <button onclick="Core.UI.closeModals()" class="p-2 text-slate-500 hover:text-white bg-white/5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>
                <div class="flex gap-6 border-b border-white/5">
                    <button onclick="Core.UI.switchHelp('strat')" class="help-tab active pb-3 text-[11px] font-black uppercase tracking-wider">Strat√©gie</button>
                    <button onclick="Core.UI.switchHelp('flow')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Le Flux</button>
                    <button onclick="Core.UI.switchHelp('zettel')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Zettelkasten</button>
                    <button onclick="Core.UI.switchHelp('intel')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Intelligence IA</button>
                    <button onclick="Core.UI.switchHelp('keys')" class="help-tab pb-3 text-[11px] font-black uppercase tracking-wider">Commandes</button>
                </div>
            </div>
            <div id="ui-help-content" class="p-10 overflow-y-auto custom-scrollbar text-[13px] text-slate-400 space-y-8 leading-relaxed"></div>
        </div>
    </div>

    <div id="macro-hud">
        <div class="text-[9px] font-black text-blue-400 uppercase border-b border-white/5 mb-3 pb-1 flex justify-between">
            <span>Macro HUD</span>
            <span class="text-slate-600">ALT + SEQ</span>
        </div>
        <div id="ui-macro-list-hud" class="space-y-1.5"></div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-white/10 px-6 py-3 rounded-xl text-xs font-bold transition-all opacity-0 pointer-events-none z-[200] shadow-2xl"></div>

    <script>
        const Core = {
            State: { currentMonday: null, isReadMode: false, macroBuffer: [], macroTimeout: null, recognition: null, isRecording: false, apiKey: "", macros: {}, activeConcept: null },
            DB: null,
            Init: async function() {
                this.DB = new Dexie("AgenDataDB_v7");
                this.DB.version(1).stores({ meta: "id", agenda: "date", macros: "trigger", concepts: "title" });
                this.State.currentMonday = this.Utils.getMonday(new Date());
                await this.Storage.loadAll();
                this.Agenda.render();
                this.Listeners.setup();
                this.Voice.init();
                this.Utils.toast("Syst√®me v7.8 Op√©rationnel");
            },
            Utils: {
                getMonday: d => { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)).setHours(0,0,0,0); },
                formatDate: d => d.toISOString().split('T')[0],
                toast: msg => { const el = document.getElementById('toast'); el.textContent = msg; el.style.opacity = "1"; el.style.transform = "translateX(-50%) translateY(-10px)"; setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateX(-50%) translateY(0px)"; }, 2500); },
                debounce: (fn, ms) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn.apply(this, args), ms); }; }
            },
            Storage: {
                saveEditor: async () => { if(Core.State.isReadMode) return; const html = document.getElementById('main-editor').innerHTML; await Core.DB.meta.put({id: 'editor', content: html, ts: Date.now()}); },
                loadAll: async () => { const ed = await Core.DB.meta.get('editor'); if(ed) document.getElementById('main-editor').innerHTML = ed.content; const m = await Core.DB.macros.toArray(); Core.State.macros = {}; m.forEach(x => Core.State.macros[x.trigger] = x.text); if(!m.length) { const d = {'s,d': 'üå± ((graine)) ', 'g,r': 'üåø ((pousse)) ', 'p,e': 'üå≥ ((pilier)) ', 'c,o': '[[]]'}; for(let k in d) { await Core.DB.macros.put({trigger: k, text: d[k]}); Core.State.macros[k] = d[k]; } } }
            },
            Agenda: {
                render: async function() {
                    const container = document.getElementById('ui-agenda-list');
                    container.innerHTML = '';
                    const start = new Date(Core.State.currentMonday);
                    document.getElementById('ui-week-range').textContent = `${start.getDate()}/${start.getMonth()+1} - ${new Date(start.getTime() + 6*86400000).getDate()}/${start.getMonth()+1}`;
                    for(let i=0; i<7; i++) {
                        const current = new Date(start.getTime() + i*86400000);
                        const key = Core.Utils.formatDate(current);
                        const isToday = key === Core.Utils.formatDate(new Date());
                        const data = await Core.DB.agenda.get(key);
                        const card = document.createElement('div');
                        card.className = `agenda-card px-5 py-4 ${isToday ? 'today' : ''}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-black ${isToday ? 'text-blue-400' : 'text-slate-600'} uppercase">${current.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'})}</span>
                                <div class="card-actions flex gap-1">
                                    <button onclick="Core.Agenda.importFromDraft('${key}')" class="action-icon" title="Importer brouillon"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="3"/></svg></button>
                                    <button onclick="Core.Agenda.copyToClipboard('${key}')" class="action-icon" title="Copier"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2" stroke-width="2.5"/></svg></button>
                                    <button onclick="Core.Agenda.pushToDraft('${key}')" class="action-icon" title="Extraire"><svg class="w-2.5 h-2.5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7M5 5l7 7-7 7" stroke-width="3"/></svg></button>
                                    <button onclick="Core.Agenda.clear('${key}')" class="action-icon text-red-500/50" title="Vider"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="3"/></svg></button>
                                </div>
                            </div>
                            <div contenteditable="true" oninput="Core.Agenda.save('${key}', this.innerHTML)" class="text-[0.8rem] text-slate-400 outline-none min-h-[4rem] custom-scrollbar leading-relaxed">${data ? data.content : ''}</div>
                        `;
                        container.appendChild(card);
                    }
                    this.renderFlashback();
                },
                renderFlashback: async function() {
                    const zone = document.getElementById('ui-flashback-zone'); zone.innerHTML = '';
                    const intervals = [30, 90, 365]; const now = new Date(); let match = null;
                    for(let days of intervals) {
                        const target = new Date(now.getTime() - days*86400000);
                        const data = await Core.DB.agenda.get(Core.Utils.formatDate(target));
                        if(data && data.content.trim()) { match = {d: target, c: data.content}; break; }
                    }
                    if(match) {
                        const card = document.createElement('div'); card.className = 'agenda-card flashback p-5';
                        card.innerHTML = `<div class="text-[9px] font-black text-purple-400 uppercase mb-2 flex items-center gap-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2.5"/></svg> FLASHBACK ANALYTIQUE</div><div class="text-[0.75rem] text-slate-500 italic line-clamp-4">${match.c}</div>`;
                        zone.appendChild(card);
                    }
                },
                save: async (date, content) => { await Core.DB.agenda.put({date, content, ts: Date.now()}); },
                shiftWeek: (dir) => { Core.State.currentMonday = new Date(Core.State.currentMonday.getTime() + (dir * 7 * 86400000)); Core.Agenda.render(); },
                jumpToToday: () => { Core.State.currentMonday = Core.Utils.getMonday(new Date()); Core.Agenda.render(); },
                importFromDraft: async (key) => {
                    const draft = document.getElementById('main-editor').innerHTML;
                    if(!draft.trim()) return;
                    const entry = await Core.DB.agenda.get(key);
                    const newContent = (entry ? entry.content : '') + '<br>' + draft;
                    await Core.Agenda.save(key, newContent);
                    Core.Agenda.render();
                    Core.Utils.toast("Brouillon import√©");
                },
                copyToClipboard: async (key) => {
                    const entry = await Core.DB.agenda.get(key);
                    if(!entry) return;
                    const text = entry.content.replace(/<[^>]*>/g, '');
                    const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
                    Core.Utils.toast("Copi√©");
                },
                pushToDraft: async (key) => {
                    const entry = await Core.DB.agenda.get(key);
                    if(entry) {
                        document.getElementById('main-editor').innerHTML += `<br><br>${entry.content}`;
                        Core.Storage.saveEditor();
                        Core.Utils.toast("Contenu extrait");
                    }
                },
                clear: async (key) => { if(confirm("Confirmer la purge ?")) { await Core.DB.agenda.delete(key); Core.Agenda.render(); } }
            },
            Editor: {
                toggleMode: function() {
                    const el = document.getElementById('main-editor'); Core.State.isReadMode = !Core.State.isReadMode; el.contentEditable = !Core.State.isReadMode;
                    if(Core.State.isReadMode) { Core.State.rawCache = el.innerHTML; this.processLinks(el); document.getElementById('ui-mode-btn').classList.add('text-blue-400'); Core.Utils.toast("Mode Lecture"); } 
                    else { el.innerHTML = Core.State.rawCache || el.innerHTML; document.getElementById('ui-mode-btn').classList.remove('text-blue-400'); Core.Utils.toast("Mode Edition"); }
                },
                contrast: () => { 
                    document.execCommand('backColor', false, '#ffffff'); 
                    document.execCommand('foreColor', false, '#000000'); 
                    Core.Storage.saveEditor(); 
                },
                highlight: () => { document.execCommand('hiliteColor', false, '#fde047'); document.execCommand('foreColor', false, '#000'); Core.Storage.saveEditor(); },
                addLine: (pos) => {
                    const div = document.createElement('div'); div.innerHTML = '<br>'; const ed = document.getElementById('main-editor');
                    pos === 'start' ? ed.prepend(div) : ed.append(div);
                    const range = document.createRange(), sel = window.getSelection(); range.setStart(div, 0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); div.focus();
                },
                clear: () => { if(confirm("Purge totale du brouillon ?")) { document.getElementById('main-editor').innerHTML = ""; Core.Storage.saveEditor(); } },
                processLinks: (el) => {
                    let html = el.innerHTML;
                    html = html.replace(/\[\[(.*?)\]\]/g, '<span class="smart-link backlink" onclick="Core.UI.openConcept(\'$1\')">$1</span>');
                    html = html.replace(/\(\(graine\)\)/g, 'üå±').replace(/\(\(pousse\)\)/g, 'üåø').replace(/\(\(pilier\)\)/g, 'üå≥');
                    el.innerHTML = html;
                }
            },
            Voice: {
                init: function() {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if(SR) {
                        Core.State.recognition = new SR(); Core.State.recognition.lang = 'fr-FR';
                        Core.State.recognition.onstart = () => { Core.State.isRecording = true; document.getElementById('ui-voice-btn').classList.add('text-red-500', 'animate-pulse'); };
                        Core.State.recognition.onresult = (e) => { const t = e.results[0][0].transcript; document.execCommand('insertText', false, t); Core.Storage.saveEditor(); };
                        Core.State.recognition.onend = () => { Core.State.isRecording = false; document.getElementById('ui-voice-btn').classList.remove('text-red-500', 'animate-pulse'); };
                    }
                },
                toggle: function() { if(!Core.State.recognition) return Core.Utils.toast("Vocal non support√©"); Core.State.isRecording ? Core.State.recognition.stop() : Core.State.recognition.start(); }
            },
            AI: {
                challenge: async function() {
                    const text = document.getElementById('main-editor').innerText; if(!text) return; Core.Utils.toast("IA Challenge : Analyse critique...");
                    setTimeout(() => { const res = "\n\n> üß† **IA Challenge** : Votre brouillon manque de structure. Vous m√©langez observations et ex√©cution. S√©parez les faits des intentions."; document.getElementById('main-editor').innerHTML += res.replace(/\n/g, '<br>'); Core.Storage.saveEditor(); }, 1200);
                },
                synthesize: async function() { if(!Core.State.activeConcept) return; Core.Utils.toast("Cristallisation..."); setTimeout(() => { document.getElementById('ui-concept-synthesis').innerHTML = "<b>Synth√®se IA :</b> Ce concept semble √™tre le pivot de vos r√©flexions actuelles. Il appara√Æt r√©guli√®rement comme un obstacle ou un levier."; }, 1000); }
            },
            Search: {
                exec: async (q) => {
                    const res = document.getElementById('search-results'); res.innerHTML = ''; if(!q || q.length < 2) return;
                    const all = await Core.DB.agenda.toArray(); const filter = all.filter(x => x.content.toLowerCase().includes(q.toLowerCase()));
                    filter.forEach(x => {
                        const d = document.createElement('div'); d.className = "p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition-colors border border-white/5";
                        d.innerHTML = `<div class="text-[9px] text-blue-400 font-black mb-1 uppercase tracking-widest">${x.date}</div><div class="text-xs text-slate-400 truncate">${x.content.replace(/<[^>]*>/g, '')}</div>`;
                        d.onclick = () => { const target = new Date(x.date); Core.State.currentMonday = Core.Utils.getMonday(target); Core.Agenda.render().then(() => { Core.UI.closeModals(); Core.Utils.toast(`Navigation vers ${x.date}`); }); };
                        res.appendChild(d);
                    });
                }
            },
            IO: {
                triggerImport: () => document.getElementById('import-input').click(),
                importData: (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if(data.agenda) for(let entry of data.agenda) await Core.DB.agenda.put(entry);
                            if(data.editor) await Core.DB.meta.put({id: 'editor', content: data.editor, ts: Date.now()});
                            location.reload();
                        } catch(err) { Core.Utils.toast("Format invalide"); }
                    };
                    reader.readAsText(file);
                },
                exportMD: async () => {
                    const agenda = await Core.DB.agenda.toArray(); const meta = await Core.DB.meta.get('editor');
                    let data = { agenda, editor: meta ? meta.content : "" };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `AgenData_Backup.json`; a.click();
                }
            },
            UI: {
                openSearch: () => { document.getElementById('modal-search').style.display = 'flex'; document.getElementById('search-input').focus(); },
                openMacros: () => { document.getElementById('modal-macros').style.display = 'flex'; Core.Macros.renderManager(); },
                openConcept: async (kw) => {
                    Core.State.activeConcept = kw; document.getElementById('ui-concept-title').textContent = kw;
                    const snippets = document.getElementById('ui-concept-snippets'); snippets.innerHTML = '';
                    const all = await Core.DB.agenda.toArray();
                    all.forEach(entry => {
                        if(entry.content.toLowerCase().includes(kw.toLowerCase())) {
                            const d = document.createElement('div'); d.className = "p-3 bg-white/[0.03] rounded-lg border border-white/5 text-[11px] text-slate-400";
                            d.innerHTML = `<span class="text-violet-500 font-bold block mb-1 uppercase text-[8px]">${entry.date}</span>${entry.content}`; snippets.appendChild(d);
                        }
                    });
                    const cache = await Core.DB.concepts.get(kw);
                    document.getElementById('ui-concept-synthesis').innerHTML = cache ? cache.synthesis : "<i>Aucune synth√®se cristallis√©e.</i>";
                    document.getElementById('modal-concept').style.display = 'flex';
                },
                openHelp: () => { Core.UI.switchHelp('strat'); document.getElementById('modal-help').style.display = 'flex'; },
                switchHelp: (tab) => {
                    document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
                    const content = document.getElementById('ui-help-content');
                    if(tab === 'strat') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'strat\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">PHILOSOPHIE DU SYST√àME</div>
                            <p>AgenData n'est pas un bloc-notes. C'est une forge intellectuelle. Ce syst√®me repose sur la transformation brutale de l'information (un passif) en connaissance cristallis√©e (un actif). Si tu ne produis pas de structure, tu ne fais que stocker du bruit.</p>
                            
                            <div class="help-section-title">AMBITION STRAT√âGIQUE</div>
                            <p>Ton ambition doit √™tre de construire des <b>Piliers üå≥</b>. Un Pilier est une connaissance immuable, une d√©cision finale ou un principe de vie. Pour y arriver, tu dois accepter de cultiver des <b>Graines üå±</b> et de laisser mourir ce qui n'a plus de valeur. AgenData est con√ßu pour mettre en lumi√®re tes stagnations : une Graine qui ne devient pas une Pousse sous 30 jours est un poids mort pour ton attention.</p>
                            
                            <div class="help-section-title">L'OBJECTIF DE CLART√â</div>
                            <p>Le syst√®me t'impose une rigueur chirurgicale. Si ton brouillon sature, ton attention se fragmente. Si tu √©vites le "Challenge", tu te mens √† toi-m√™me. La clart√© n'est pas un √©tat naturel, c'est le r√©sultat d'un processus de filtrage impitoyable.</p>
                        `;
                    } else if(tab === 'flow') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'flow\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">1. CAPTURE (LE BROUILLON)</div>
                            <p>Le brouillon est ta d√©charge cognitive. Sa seule fonction est la lib√©ration imm√©diate de ta m√©moire de travail. N'y cherche pas la mise en forme. Capture l'id√©e brute avant qu'elle ne soit pollu√©e par le biais de rappel.</p>
                            <p class="mt-2 text-red-400"><b>R√®gle de fer :</b> Le brouillon doit √™tre vid√© ou tri√© toutes les 24 heures. Un brouillon qui stagne cr√©e une dette cognitive qui paralyse l'action.</p>

                            <div class="help-section-title">2. QUALIFICATION (MATURIT√â)</div>
                            <p>Rien ne reste anonyme. Chaque bloc doit recevoir un statut :</p>
                            <ul class="list-disc pl-5 mt-2 space-y-2">
                                <li><b>üå± Graine :</b> Intuition, lien, fait brut. Si tu ne la consultes pas pendant 30 jours, elle devient rouge (Stale). C'est le signal pour la traiter ou la supprimer sans regret.</li>
                                <li><b>üåø Pousse :</b> Id√©e en cours de structuration, argumentaire √©tay√©.</li>
                                <li><b>üå≥ Pilier :</b> Connaissance cristallis√©e, d√©cision irr√©vocable.</li>
                            </ul>

                            <div class="help-section-title">3. TRANSFERT (AGENDA)</div>
                            <p>L'information m√ªre doit √™tre ancr√©e dans le temps. Utilise la "Smart Toolbar" (s√©lection de texte) ou les boutons d'import pour envoyer tes notes vers l'agenda. Cela lib√®re ton brouillon et cr√©e une archive historique exploitable.</p>
                        `;
                    } else if(tab === 'zettel') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'zettel\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">L'EFFET R√âSEAU S√âMANTIQUE</div>
                            <p>L'information isol√©e est inutile. La connaissance na√Æt de la connexion. Les doubles crochets <code>[[Concept]]</code> agissent comme des neurones artificiels. Ils cr√©ent des ponts entre des pens√©es captur√©es √† des mois d'intervalle.</p>
                            
                            <div class="help-section-title">NAVIGATION ET VUE CONSOLID√âE</div>
                            <p>En mode lecture (ALT+V), chaque lien devient une passerelle. Cliquer sur un concept ouvre une vue consolid√©e qui rassemble <b>tous les extraits</b> mentionnant ce terme √† travers ton agenda. C'est ici que tu d√©tectes tes contradictions, tes sch√©mas r√©p√©titifs et tes angles morts.</p>

                            <div class="help-section-title">CRISTALLISATION</div>
                            <p>La vue Concept permet de transformer des fragments √©pars en une v√©rit√© structur√©e. C'est l'√©tape finale : la <b>Cristallisation</b>. Utilise le volet de droite pour r√©diger une synth√®se parfaite. Une fois cristallis√©e, l'essence de la connaissance est extraite, et les fragments bruts peuvent √™tre archiv√©s.</p>
                        `;
                    } else if(tab === 'intel') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'intel\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">L'IA COMME MIROIR FROID</div>
                            <p>L'IA Challenge n'est pas ton assistant personnel, c'est ton <b>opposant</b>. Son r√¥le est de d√©monter ton raisonnement, de traquer tes biais cognitifs et de pointer tes excuses. Si l'IA ne te bouscule pas, c'est que ton brouillon est soit trop pauvre, soit que tu n'as pas os√© √™tre honn√™te avec toi-m√™me.</p>
                            
                            <div class="help-section-title">CONFRONTATION TEMPORELLE (FLASHBACKS)</div>
                            <p>Le syst√®me remonte automatiquement des notes de J-30, J-90 ou J-365. C'est un protocole de reddition de comptes. Il te force √† voir si tu as r√©ellement progress√© sur tes probl√©matiques ou si tu tournes en rond dans les m√™mes sch√©mas depuis un an.</p>

                            <div class="help-section-title">ANALYSE DE QUALIT√â</div>
                            <p>Avant de figer une id√©e dans l'agenda, lance le Challenge. L'IA analysera ton texte pour y d√©celer les manques de preuves, les raccourcis faciles et les zones de flou. C'est le dernier filtre avant l'archivage d√©finitif.</p>
                        `;
                    } else {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'keys\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">AMBITION DU SYST√àME DE MACROS</div>
                            <p class="text-white font-bold mb-2">Automatiser la structure, pas seulement la saisie.</p>
                            <p>Les macros d'AgenData ne sont pas de simples raccourcis texte. Ce sont des <b>Protocoles de Pens√©e</b>. L'ambition est de supprimer toute r√©sistance entre une pens√©e chaotique et un cadre d√©cisionnel rigoureux. En tapant une s√©quence, tu injectes instantan√©ment un framework structur√© dans ton brouillon, for√ßant ton esprit √† suivre une logique de performance d√®s l'√©mergence de l'id√©e.</p>
                            
                            <div class="help-section-title">M√âCANIQUE EXHAUSTIVE</div>
                            <div class="space-y-4">
                                <div class="help-step-box">
                                    <p class="font-bold text-blue-400 mb-1 uppercase text-[10px]">D√©clenchement (Alt-Tap)</p>
                                    <p>Maintenez la touche <kbd class="text-blue-500">Alt</kbd> enfonc√©e. Le HUD des macros s'affiche. Tapez ensuite la s√©quence de caract√®res (ex: <kbd>s</kbd> puis <kbd>d</kbd>).</p>
                                </div>
                                <div class="help-step-box">
                                    <p class="font-bold text-blue-400 mb-1 uppercase text-[10px]">Buffer de S√©quence</p>
                                    <p>Le syst√®me dispose d'un buffer de 800ms. Si vous tapez vos touches trop lentement, le buffer se vide. Cette contrainte temporelle favorise le rythme de capture.</p>
                                </div>
                                <div class="help-step-box">
                                    <p class="font-bold text-blue-400 mb-1 uppercase text-[10px]">Gestion des Protocoles</p>
                                    <p>Utilisez l'ic√¥ne <svg class="w-3 h-3 inline text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="2"/></svg> pour ouvrir le gestionnaire. Vous pouvez d√©finir des triggers complexes s√©par√©s par des virgules (ex: <code>p,r,o</code> pour un protocole de projet).</p>
                                </div>
                            </div>

                            <div class="help-section-title">COMMANDES SYST√àME FIXES</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-white/5 rounded-xl border border-white/5"><kbd class="text-blue-400">ALT + V</kbd><br><span class="text-[10px] uppercase">Bascule Lecture / √âdition</span></div>
                                <div class="p-3 bg-white/5 rounded-xl border border-white/5"><kbd class="text-blue-400">ALT + T</kbd><br><span class="text-[10px] uppercase">Focus sur Aujourd'hui</span></div>
                                <div class="p-3 bg-white/5 rounded-xl border border-white/5"><kbd class="text-blue-400">ALT + R</kbd><br><span class="text-[10px] uppercase">Activation Vocale</span></div>
                                <div class="p-3 bg-white/5 rounded-xl border border-white/5"><kbd class="text-blue-400">CTRL + F</kbd><br><span class="text-[10px] uppercase">Recherche Profonde</span></div>
                            </div>
                        `;
                    }
                },
                closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); },
                showToolbar: (rect, text) => {
                    const bar = document.getElementById('smart-toolbar'); const container = document.getElementById('ui-toolbar-days'); container.innerHTML = '';
                    ['L','M','M','J','V','S','D'].forEach((d, i) => {
                        const target = new Date(Core.State.currentMonday); target.setDate(target.getDate() + i); const k = Core.Utils.formatDate(target);
                        const btn = document.createElement('button'); btn.className = "px-2 py-1 text-[9px] hover:bg-blue-500 hover:text-white rounded text-slate-500 font-bold";
                        btn.textContent = d; btn.onmousedown = (e) => { e.preventDefault(); Core.Agenda.importFromDraft(k); }; container.appendChild(btn);
                    });
                    bar.style.top = `${rect.bottom + window.scrollY + 8}px`; bar.style.left = `${rect.left + window.scrollX}px`; bar.style.display = 'flex';
                }
            },
            Listeners: {
                setup: function() {
                    const editor = document.getElementById('main-editor');
                    editor.addEventListener('input', Core.Utils.debounce(() => Core.Storage.saveEditor(), 1000));
                    document.addEventListener('keydown', e => {
                        if(e.key === 'Alt') { document.getElementById('macro-hud').style.display = 'block'; Core.Macros.renderHUD(); }
                        if(e.altKey) {
                            if(e.key.length === 1 && !['v','t','m','n','e','r'].includes(e.key)) Core.Macros.handle(e.key);
                            if(e.key === 'v') { e.preventDefault(); Core.Editor.toggleMode(); }
                            if(e.key === 't') { e.preventDefault(); Core.Agenda.jumpToToday(); }
                            if(e.key === 'n') { e.preventDefault(); Core.Editor.addLine('start'); }
                            if(e.key === 'e') { e.preventDefault(); Core.Editor.addLine('end'); }
                            if(e.key === 'r') { e.preventDefault(); Core.Voice.toggle(); }
                        }
                        if((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); Core.UI.openSearch(); }
                        if(e.key === 'F1') { e.preventDefault(); Core.UI.openHelp(); }
                    });
                    document.addEventListener('keyup', e => { if(e.key === 'Alt') document.getElementById('macro-hud').style.display = 'none'; });
                    document.addEventListener('selectionchange', () => {
                        const sel = window.getSelection();
                        if(sel.rangeCount && !sel.isCollapsed && editor.contains(sel.anchorNode)) Core.UI.showToolbar(sel.getRangeAt(0).getBoundingClientRect(), sel.toString());
                        else document.getElementById('smart-toolbar').style.display = 'none';
                    });
                }
            },
            Macros: {
                handle: function(key) {
                    clearTimeout(Core.State.macroTimeout); Core.State.macroBuffer.push(key.toLowerCase()); const seq = Core.State.macroBuffer.join(',');
                    if(Core.State.macros[seq]) { document.execCommand('insertHTML', false, Core.State.macros[seq]); Core.State.macroBuffer = []; }
                    Core.State.macroTimeout = setTimeout(() => { Core.State.macroBuffer = []; }, 800);
                },
                renderHUD: function() {
                    const hud = document.getElementById('ui-macro-list-hud'); hud.innerHTML = '';
                    for(let k in Core.State.macros) hud.innerHTML += `<div class="flex justify-between items-center text-[10px] font-mono border-b border-white/5 pb-1"><span class="text-blue-500 font-bold">${k.replace(',','+').toUpperCase()}</span><span class="text-slate-500 truncate">${Core.State.macros[k].substring(0, 15)}...</span></div>`;
                },
                renderManager: async function() {
                    const list = document.getElementById('ui-macro-manager-list'); list.innerHTML = '';
                    const all = await Core.DB.macros.toArray();
                    all.forEach(m => {
                        const row = document.createElement('div'); row.className = "flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5 group";
                        row.innerHTML = `
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-black text-blue-400 font-mono bg-blue-500/10 px-2 py-1 rounded border border-blue-500/20">${m.trigger.replace(',','+').toUpperCase()}</span>
                                <span class="text-xs text-slate-400 truncate max-w-[250px]">${m.text}</span>
                            </div>
                            <button onclick="Core.Macros.delete('${m.trigger}')" class="text-slate-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
                        `;
                        list.appendChild(row);
                    });
                },
                add: async function() {
                    const trigger = document.getElementById('ui-new-macro-trigger').value.toLowerCase().trim();
                    const text = document.getElementById('ui-new-macro-text').value.trim();
                    if(!trigger || !text) return Core.Utils.toast("Champs incomplets");
                    await Core.DB.macros.put({trigger, text});
                    document.getElementById('ui-new-macro-trigger').value = '';
                    document.getElementById('ui-new-macro-text').value = '';
                    await Core.Storage.loadAll(); this.renderManager(); Core.Utils.toast("Protocole ajout√©");
                },
                delete: async function(trigger) { await Core.DB.macros.delete(trigger); await Core.Storage.loadAll(); this.renderManager(); Core.Utils.toast("Protocole supprim√©"); }
            }
        };
        window.onload = () => Core.Init();
    </script>
</body>
</html>

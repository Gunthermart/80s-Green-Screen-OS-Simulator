<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>AgenData v9.23 | Système d'Extraction Financière</title>
    
    <meta name="description" content="Ne laissez plus rien au hasard. Transformez le chaos en ordre avec ce système opérationnel de prise de note tactique. Pas de bruit, juste du signal.">
    <meta name="author" content="LEONCE-EQUITY">
    <meta name="keywords" content="productivité, pkm, finance, analyse, marché, tactique, minimalisme">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://agendata.io/">
    <meta property="og:title" content="AgenData | Extraction du Signal">
    <meta property="og:description" content="Système de cristallisation temporelle pour l'analyse financière. Capturez, structurez, agissez.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1555421689-491a97ff2040?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&h=630&q=80">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://agendata.io/">
    <meta property="twitter:title" content="AgenData | Système d'Extraction Financière">
    <meta property="twitter:description" content="Détruisez le narratif. Extrayez les métriques.">
    <meta property="twitter:image" content="https://images.unsplash.com/photo-1555421689-491a97ff2040?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&h=630&q=80">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AgenData">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --accent: #3b82f6;
            --tag-bg: rgba(59, 130, 246, 0.1);
            --tag-border: rgba(59, 130, 246, 0.3);
            --tag-text: #93c5fd;
            --text-main: #f8fafc;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 5px; border: 2px solid var(--bg-dark); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
        .custom-scrollbar::-webkit-scrollbar-corner { background: transparent; }

        aside { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; }
        aside.collapsed { width: 0 !important; opacity: 0; overflow: hidden; border-right: none; }

        .editor-layer {
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid var(--border);
            transition: border-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        .editor-layer:focus-within { border-color: var(--accent); }
        
        #main-editor {
            flex: 1;
            overflow: auto;
            white-space: pre-wrap;
            outline: none;
            word-wrap: break-word;
        }
        
        #main-editor.read-mode { cursor: default; color: #94a3b8; }
        #main-editor.read-mode ::selection { background: rgba(217, 70, 239, 0.2); color: #fff; }
        #main-editor pre { white-space: pre; overflow-x: auto; }

        .nexus-index {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 800;
            color: #f0abfc;
            background: rgba(192, 38, 211, 0.25);
            border: 1px solid #d946ef;
            padding: 1px 6px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin: 0 3px;
            vertical-align: middle;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            letter-spacing: -0.02em;
            box-shadow: 0 0 12px rgba(217, 70, 239, 0.2);
            text-transform: uppercase;
        }
        
        .nexus-index:hover {
            background: rgba(217, 70, 239, 0.5);
            border-color: #f5d0fe;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(217, 70, 239, 0.5);
            z-index: 10;
        }

        .nexus-index::before {
            content: '⚡'; 
            font-size: 0.7em;
            margin-right: 4px;
            color: #e879f9;
        }

        .ai-insight-panel .nexus-index {
            display: inline !important;
            padding: 0 2px !important;
            margin: 0 1px !important;
            font-size: inherit !important;
            background: rgba(192, 38, 211, 0.15);
            border: none !important;
            box-shadow: none !important;
            vertical-align: baseline !important;
            transform: none !important;
            letter-spacing: normal !important;
            white-space: normal !important;
            line-height: inherit !important;
        }
        .ai-insight-panel .nexus-index:hover {
            background: rgba(192, 38, 211, 0.3);
            color: #fff;
            text-decoration: underline;
        }
        .ai-insight-panel .nexus-index::before { display: none !important; }

        .agenda-card {
            border-bottom: 1px solid var(--border); border-left: 3px solid transparent;
            transition: all 0.2s; position: relative; background: rgba(255,255,255,0.01);
        }
        .agenda-card:hover { background: rgba(255,255,255,0.03); }
        .agenda-card.today { background: rgba(59, 130, 246, 0.05); border-left-color: var(--accent); }
        .agenda-card.flash-success { animation: flashHighlight 0.6s ease-out; }
        
        @keyframes flashHighlight { 0% { background-color: rgba(59, 130, 246, 0.4); } 100% { background-color: transparent; } }

        .agenda-editable { font-size: 0.8rem; line-height: 1.6; max-height: 8rem; overflow-y: auto; display: block; }
        .agenda-separator { display: block; margin: 8px 0 4px 0; padding-top: 4px; border-top: 1px dashed var(--border); font-size: 0.6em; color: var(--text-muted); font-family: var(--font-mono); }
        
        .card-tag-badge { 
            font-size: 9px; 
            font-family: var(--font-mono); 
            font-weight: 700; 
            background: rgba(192, 38, 211, 0.15);
            color: #e879f9; 
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid rgba(232, 121, 249, 0.3); 
            margin-left: 4px; 
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .card-tag-badge:hover {
            background: #d946ef; color: #fff; border-color: #f0abfc;
            transform: translateY(-1px); box-shadow: 0 2px 8px rgba(217, 70, 239, 0.4);
        }

        .ai-insight-panel {
            margin-bottom: 3rem; 
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            user-select: none;
        }
        .ai-insight-panel * { user-select: text; } 

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .ai-insight-header {
            background: rgba(255, 255, 255, 0.03);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .ai-title-group { display: flex; align-items: center; gap: 10px; }
        .ai-icon-box { color: var(--accent); font-size: 14px; }
        .ai-panel-title { font-family: var(--font-mono); font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .ai-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); }

        .nexus-header { padding: 16px; border-bottom: 1px solid var(--border); background: rgba(59, 130, 246, 0.05); }
        .nexus-title { font-size: 1.2rem; font-weight: 800; color: white; margin-bottom: 4px; }
        .nexus-meta { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); display: flex; gap: 12px; }
        .nexus-section-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--accent); margin: 16px 16px 8px 16px; letter-spacing: 1px; }
        .heatmap-container { display: flex; gap: 2px; height: 40px; align-items: flex-end; padding: 0 16px; }
        .heatmap-bar { flex: 1; background: var(--tag-bg); border-radius: 2px; min-height: 2px; transition: height 0.3s; }
        .heatmap-bar.active { background: var(--accent); }
        .network-item { padding: 8px 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .network-item:hover { background: rgba(255,255,255,0.05); }
        .context-item { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
        .context-date { font-size: 0.7rem; color: var(--accent); font-weight: 700; margin-bottom: 4px; font-family: var(--font-mono); }
        .context-snippet em { color: #fff; font-style: normal; font-weight: 600; background: rgba(255,255,255,0.1); }

        .card-actions { opacity: 0; transform: translateY(2px); transition: all 0.2s; background: var(--bg-dark); border-radius: 4px; padding: 2px; position: absolute; right: 8px; top: 8px; border: 1px solid var(--border); }
        .agenda-card:hover .card-actions, .agenda-card:focus-within .card-actions { opacity: 1; transform: translateY(0); }
        
        .action-icon { padding: 4px; border-radius: 3px; color: #64748b; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; }
        .action-icon:hover { color: var(--text-main); background: rgba(255,255,255,0.1); }
        .action-icon.danger:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .action-icon.armed { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .filter-banner { background: var(--tag-bg); border-bottom: 1px solid var(--accent); color: var(--tag-text); font-size: 0.75rem; font-weight: 700; font-family: var(--font-mono); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
        
        #macro-hud { 
            position: fixed; bottom: 30px; right: 30px; background: #1e293b; 
            border: 1px solid var(--border); padding: 16px; border-radius: 12px; 
            display: none; z-index: 60; box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 200px;
        }
        #macro-hud.visible { display: block; animation: slideUp 0.1s ease-out; }
        #macro-hud.active { border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        
        .hud-row { display: flex; justify-content: space-between; padding: 6px 8px; border-radius: 4px; margin-bottom: 2px; }
        .hud-row.triggered { background: var(--accent); }
        .hud-row.triggered .hud-key, .hud-row.triggered .hud-val { color: white; }
        
        .hud-key { font-family: var(--font-mono); color: var(--accent); font-weight: 700; font-size: 0.8rem; min-width: 20px; }
        .hud-val { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; border: 1px solid var(--accent); padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100; }
        
        .help-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; font-size: 0.8rem; }
        .help-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .help-content h3 { color: var(--accent); font-weight: 800; margin-top: 2rem; margin-bottom: 0.75rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; border-left: 2px solid var(--accent); padding-left: 10px; }
        .help-content h4 { color: #fff; font-weight: 700; margin-bottom: 0.5rem; font-size: 0.85rem; margin-top: 1rem; }
        .help-content p { color: #cbd5e1; margin-bottom: 0.8rem; font-size: 0.85rem; line-height: 1.6; }
        .help-content ul { list-style: none; padding-left: 0; margin-bottom: 1rem; }
        .help-content li { position: relative; padding-left: 1.2rem; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.85rem; }
        .help-content li::before { content: "›"; position: absolute; left: 0; color: var(--accent); font-weight: bold; }
        .help-content code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.8em; color: #93c5fd; border: 1px solid rgba(255,255,255,0.1); }
        .help-step { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .help-step-num { color: var(--accent); font-family: var(--font-mono); font-weight: bold; font-size: 0.75rem; margin-bottom: 4px; display: block; }

        .macro-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid transparent; border-radius: 6px; margin-bottom: 6px; }
        .macro-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
        .macro-trigger { font-family: var(--font-mono); color: var(--accent); font-weight: 800; background: rgba(59, 130, 246, 0.1); padding: 4px 8px; border-radius: 4px; min-width: 40px; text-align: center; }
        .macro-content { color: #e2e8f0; font-family: var(--font-mono); font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; }

        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }

        #splash-screen {
            background: #0b1120;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0b1120 100%);
        }

        #btn-install-pwa {
            position: absolute; top: 32px; left: 32px; display: none; align-items: center; gap: 12px; padding: 8px 16px;
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.08); border-left: 2px solid var(--accent);
            backdrop-filter: blur(12px); color: #94a3b8; font-family: var(--font-mono); font-size: 10px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1.5px; border-radius: 2px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #btn-install-pwa:hover {
            border-color: rgba(59, 130, 246, 0.5); border-left-color: var(--accent); color: #fff;
            background: rgba(15, 23, 42, 0.9); box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); transform: translateX(2px);
        }

        .pwa-status-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 8px var(--accent); animation: pwaPulse 2s infinite; }
        @keyframes pwaPulse { 0% { opacity: 0.4; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.4; transform: scale(0.9); } }
        @keyframes fadeIn { to { opacity: 1; } }

    </style>
</head>
<body class="flex-col md:flex-row">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center transition-opacity duration-1000">
        <button id="btn-install-pwa" onclick="Core.System.installPWA()"><div class="pwa-status-dot"></div><span>INITIALISER LE SYSTÈME</span></button>
        <div class="relative mb-4">
            <div class="absolute -inset-1 bg-blue-500 rounded-lg blur opacity-20"></div>
            <h1 class="relative text-4xl md:text-5xl font-black text-white tracking-tight">AgenData v9.23</h1>
        </div>
        <div class="text-xs md:text-sm font-mono font-bold text-blue-400 tracking-[0.3em] uppercase opacity-80">LEONCE-EQUITY</div>
        <div class="mt-8 flex gap-1">
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <aside id="main-sidebar" class="w-full md:w-[360px] border-r border-white/5 flex flex-col shrink-0 bg-[#0b1120]">
        <header class="h-14 flex items-center justify-between px-4 border-b border-white/5">
            <div id="date-controls" class="flex items-center gap-2">
                <button onclick="Core.Binder.shiftWeek(-1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg></button>
                <span id="ui-week-range" class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-wide"></span>
                <button onclick="Core.Binder.shiftWeek(1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg></button>
                <button onclick="Core.Binder.jumpToToday()" class="ml-2 text-[9px] font-bold bg-blue-500/10 text-blue-400 px-2 py-1 rounded hover:bg-blue-500/20">AUJ.</button>
            </div>
            <div class="flex bg-white/5 rounded p-0.5">
                <button onclick="Core.UI.toggleSidebarView('pages')" id="btn-view-pages" class="px-2 py-1 rounded text-[10px] font-bold uppercase text-blue-400 bg-slate-800 shadow-sm transition-all">Pages</button>
                <button onclick="Core.UI.toggleSidebarView('index')" id="btn-view-index" class="px-2 py-1 rounded text-[10px] font-bold uppercase text-slate-500 hover:text-slate-300 transition-all">Nexus</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="view-pages">
                <div id="ui-filter-banner" class="hidden filter-banner">
                    <span id="ui-filter-text">[FILTRE]</span>
                    <button onclick="Core.Binder.clearFilter()" class="hover:text-white font-bold">✕</button>
                </div>
                <div id="ui-binder-content"></div>
            </div>
            <div id="view-index" class="hidden">
                <div id="ui-nexus-content"></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-[#0f172a]">
        <header class="h-14 border-b border-white/5 flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-2">
                <button onclick="Core.UI.toggleSidebar()" class="p-2 text-slate-500 hover:text-white" title="Basculer Sidebar (Alt+B)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-width="2"/></svg>
                </button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button onclick="Core.Editor.toggleMode()" id="ui-mode-btn" class="p-2 text-emerald-400 hover:text-emerald-300 transition-colors" title="Lecture/Édition (Alt+V)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-width="2"/></svg>
                </button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                
                <button onclick="Core.Editor.addLine('start')" class="p-1.5 text-slate-500 hover:text-emerald-400" title="Focus Haut (Alt+Haut)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18" stroke-width="2"/></svg>
                </button>
                <button onclick="Core.Editor.addLine('end')" class="p-1.5 text-slate-500 hover:text-emerald-400" title="Focus Bas (Alt+Bas)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="2"/></svg>
                </button>

                <div class="h-4 w-px bg-white/10 mx-1"></div>

                <button onclick="Core.Editor.highlight()" class="p-1.5 text-yellow-500/60 hover:text-yellow-400" title="Surligner"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg></button>
                
                <button onclick="Core.Editor.contrast()" class="p-1.5 text-white/70 hover:text-white border border-white/10 rounded ml-1" title="Contraste Fort (Fond Blanc)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z M12 4v16c4.41 0 8-3.59 8-8s-3.59-8-8-8z" stroke-width="2" fill="currentColor"/></svg>
                </button>

                <button onclick="Core.Editor.insertIndexManual()" class="p-1.5 text-blue-500/80 hover:text-blue-400 font-mono font-bold" title="Insérer Index (Alt+T)">[]</button>
            </div>

            <div class="flex items-center gap-2">
                <!-- AI CHALLENGE BUTTON (NOUVELLE DOCTRINE) -->
                <button id="ai-trigger" onclick="Core.AI.challenge()" class="flex items-center gap-2 px-3 py-1.5 rounded bg-slate-800/50 border border-slate-700 hover:border-blue-500/50 transition-all group mr-2">
                    <div class="relative flex items-center justify-center">
                        <div id="ai-pulse" class="w-1.5 h-1.5 rounded-full bg-slate-500 transition-colors duration-300 group-hover:bg-blue-400"></div>
                    </div>
                    <span id="ai-label" class="text-[9px] font-mono font-black text-slate-500 tracking-widest group-hover:text-blue-300">SYSTEM.READY</span>
                </button>

                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button id="ui-voice-btn" onclick="Core.Voice.toggle()" class="p-2 text-slate-500 hover:text-white" title="Dictée"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openSearch()" class="p-2 text-slate-500 hover:text-white" title="Rechercher (Ctrl+F)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openMacroManager()" class="p-2 text-slate-500 hover:text-white" title="Configurer Macros"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openHelp()" class="p-2 text-slate-500 hover:text-yellow-400" title="Manuel Opérationnel (F1)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg></button>
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button onclick="Core.IO.triggerImport()" class="p-2 text-slate-500 hover:text-blue-400" title="Restaurer Backup (Upload)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg></button>
                <button onclick="Core.IO.export()" class="p-2 text-slate-500 hover:text-blue-400" title="Sauvegarder JSON (Download)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2"/></svg></button>
                
                <div class="h-4 w-px bg-white/10 mx-1"></div>
                <button onclick="Core.Editor.clear(this)" class="p-2 text-slate-500 hover:text-red-500 hover:bg-red-500/10 rounded transition-all" title="Vider le brouillon (Double Clic)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden p-6 md:p-12 flex flex-col">
            <div class="max-w-4xl mx-auto w-full editor-layer rounded-lg flex-1 overflow-hidden relative">
                <div id="main-editor" contenteditable="true" class="p-12 md:p-16 text-slate-300 outline-none text-base leading-7 custom-scrollbar" placeholder="Copier-coller rapports financiers ici..."></div>
            </div>
        </div>
        
        <input type="file" id="import-input" class="hidden" accept=".json" onchange="Core.IO.importData(event)">
    </main>

    <div id="toast" class="toast">Action effectuée</div>

    <div id="macro-hud">
        <div class="text-[10px] font-bold text-slate-500 uppercase mb-3 border-b border-white/10 pb-2 flex justify-between">
            <span>DIRECT MACRO (ALT+)</span>
            <span class="text-blue-500 animate-pulse">READY</span>
        </div>
        <div id="ui-macro-list-hud" class="flex flex-col gap-1"></div>
    </div>

    <!-- MODALS -->
    <div id="modal-search" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box bg-[#1e293b]" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/5">
                <input type="text" id="search-input" class="w-full bg-transparent text-white text-lg outline-none font-medium" placeholder="Rechercher dans le classeur..." oninput="Core.Binder.search(this.value)">
            </div>
            <div id="search-results" class="p-4 overflow-y-auto custom-scrollbar h-[50vh] space-y-2"></div>
        </div>
    </div>

    <div id="modal-macros" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box bg-[#1e293b] max-w-lg" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-black/20">
                <span class="text-xs font-bold text-white uppercase tracking-widest">Configuration Macros</span>
                <button onclick="Core.UI.closeModals()" class="text-slate-500 hover:text-white">✕</button>
            </div>
            <div id="ui-macro-manager-list" class="p-4 overflow-y-auto custom-scrollbar h-[40vh] space-y-2 bg-[#0b1120]"></div>
            <div class="p-4 border-t border-white/5 bg-[#1e293b]">
                <div class="flex gap-2">
                    <input id="new-macro-key" type="text" maxlength="1" class="w-12 bg-black/30 border border-white/10 rounded px-2 text-center font-mono text-blue-400 font-bold outline-none focus:border-blue-500 uppercase" placeholder="K">
                    <input id="new-macro-val" type="text" class="flex-1 bg-black/30 border border-white/10 rounded px-3 text-sm text-white outline-none focus:border-blue-500" placeholder="Contenu (ex: [ACHAT_FORT])">
                    <button onclick="Core.Macros.add()" class="px-4 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded uppercase">Ajouter</button>
                </div>
                <div class="text-[10px] text-slate-500 mt-2">Astuce : Une seule lettre (A-Z) pour déclencher avec Alt.</div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box bg-[#1e293b] max-w-[800px]" onclick="event.stopPropagation()">
            <div class="flex border-b border-white/5 overflow-x-auto">
                <div class="help-tab active" onclick="Core.UI.switchHelp('manifesto', this)">DOCTRINE</div>
                <div class="help-tab" onclick="Core.UI.switchHelp('workflow', this)">PROTOCOLE</div>
                <div class="help-tab" onclick="Core.UI.switchHelp('nexus', this)">NEXUS</div>
                <div class="help-tab" onclick="Core.UI.switchHelp('ai', this)">EXTRACTION IA</div>
                <div class="help-tab" onclick="Core.UI.switchHelp('controls', this)">ARMEMENT</div>
            </div>
            <div id="ui-help-content" class="p-8 overflow-y-auto custom-scrollbar h-[60vh] help-content"></div>
        </div>
    </div>

    <div id="modal-pwa" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box bg-[#1e293b] max-w-sm" onclick="event.stopPropagation()">
            <div class="p-6 text-center">
                <h3 class="text-white font-bold mb-4">INSTALLATION MANUELLE</h3>
                <p class="text-sm text-slate-300 mb-4">L'installation automatique est bloquée par votre navigateur ou l'environnement sécurisé.</p>
                <div class="text-xs text-slate-400 bg-black/20 p-4 rounded text-left">
                    <strong>1.</strong> Ouvrez le menu du navigateur (3 points ou icône Partager).<br><br>
                    <strong>2.</strong> Sélectionnez <strong>"Ajouter à l'écran d'accueil"</strong> ou <strong>"Installer l'application"</strong>.
                </div>
                <button onclick="Core.UI.closeModals()" class="mt-6 w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded">COMPRIS</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('Échec SW:', err));
            });
        }

        const Core = {
            DB: null,
            State: { 
                currentMonday: null, isReadMode: false, activeTagFilter: null,
                installPrompt: null,
                macros: {},
                lastSelection: { text: null, ts: 0 } 
            },

            Init: async function() {
                this.DB = new Dexie("AgenData_V8");
                this.DB.version(2).stores({ entries: "date", meta: "id", macros: "trigger" });
                this.State.currentMonday = this.Utils.getMonday(new Date());
                await this.IO.loadDraft();
                await this.Macros.init();
                this.Binder.render();
                this.Listeners.setup();
                this.Voice.init();
                this.Utils.toast("V9.23 : FINANCIAL EXTRACTOR ACTIVE");
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault(); Core.State.installPrompt = e;
                    const btn = document.getElementById('btn-install-pwa');
                    if(btn) { btn.style.display = 'flex'; btn.style.animation = 'fadeIn 0.5s ease-out forwards'; }
                });
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if(isIOS) {
                    const btn = document.getElementById('btn-install-pwa');
                    if(btn) { btn.style.display = 'flex'; btn.querySelector('span').textContent = "INSTALLER SUR IPHONE"; }
                }
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    if(splash) { splash.style.opacity = '0'; setTimeout(() => splash.remove(), 1000); }
                }, 3500); 
            },

            System: {
                installPWA: async () => {
                    const promptEvent = Core.State.installPrompt;
                    if (promptEvent) {
                        promptEvent.prompt();
                        const { outcome } = await promptEvent.userChoice;
                        if (outcome === 'accepted') Core.Utils.toast("INSTALLATION EN COURS...");
                        Core.State.installPrompt = null;
                        document.getElementById('btn-install-pwa').style.display = 'none';
                    } else {
                        document.getElementById('modal-pwa').style.display = 'flex';
                    }
                }
            },

            Utils: {
                getMonday: d => { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)).setHours(0,0,0,0); },
                formatDate: d => d.toISOString().split('T')[0],
                toast: msg => { const el = document.getElementById('toast'); el.textContent = msg; el.style.opacity = "1"; setTimeout(() => el.style.opacity = "0", 2000); },
                debounce: (fn, ms) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn.apply(this, args), ms); }; },
                stripHTML: (html) => { const tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; },
                tagRegex: /\[([a-zA-Z0-9\u00C0-\u00FF\s_\-]+)\]/g,
                extractIndexes: (html) => {
                    const text = Core.Utils.stripHTML(html);
                    const tags = [];
                    let match;
                    const regex = /\[([a-zA-Z0-9\u00C0-\u00FF\s_\-]+)\]/g;
                    while ((match = regex.exec(text)) !== null) { tags.push(match[1]); }
                    return tags;
                }
            },

            Macros: {
                init: async function() {
                    const count = await Core.DB.macros.count();
                    if (count === 0) {
                        const defaults = [
                            {trigger: 'a', content: '[ACHAT_FORT]'},
                            {trigger: 'v', content: '[VENTE_RAPIDE]'},
                            {trigger: 'r', content: '⚠️ [RISQUE]'},
                            {trigger: 'c', content: '[CATALYSEUR]'},
                            {trigger: 'e', content: '[EARNINGS]'},
                            {trigger: 'm', content: '[MACRO]'}
                        ];
                        await Core.DB.macros.bulkPut(defaults);
                    }
                    await this.load();
                },
                load: async function() {
                    const all = await Core.DB.macros.toArray();
                    Core.State.macros = {};
                    all.forEach(m => Core.State.macros[m.trigger] = m.content);
                    this.renderHUD();
                },
                handle: function(keyEvent) {
                    if(Core.State.isReadMode) return;
                    const key = keyEvent.key.toLowerCase();
                    if(Core.State.macros[key]) {
                        keyEvent.preventDefault(); 
                        document.execCommand('insertText', false, Core.State.macros[key]);
                        Core.IO.saveDraft();
                        const hudRow = document.getElementById(`macro-row-${key}`);
                        if(hudRow) { hudRow.classList.add('triggered'); setTimeout(() => hudRow.classList.remove('triggered'), 200); }
                    }
                },
                renderHUD: function() {
                    const hudList = document.getElementById('ui-macro-list-hud');
                    hudList.innerHTML = '';
                    Object.entries(Core.State.macros).forEach(([k, v]) => {
                        const row = document.createElement('div'); row.className = "hud-row"; row.id = `macro-row-${k}`;
                        row.innerHTML = `<span class="hud-key">Alt + ${k.toUpperCase()}</span><span class="hud-val">${v}</span>`;
                        hudList.appendChild(row);
                    });
                },
                manager: async function() {
                    const container = document.getElementById('ui-macro-manager-list');
                    container.innerHTML = '';
                    const all = await Core.DB.macros.toArray();
                    all.sort((a,b) => a.trigger.localeCompare(b.trigger));
                    all.forEach(m => {
                        const div = document.createElement('div'); div.className = "macro-item";
                        div.innerHTML = `<div class="flex items-center gap-3"><div class="macro-trigger">${m.trigger.toUpperCase()}</div><div class="macro-content">${m.content}</div></div><button onclick="Core.Macros.remove('${m.trigger}')" class="text-red-500 hover:bg-red-500/10 p-1 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>`;
                        container.appendChild(div);
                    });
                },
                add: async function() {
                    const k = document.getElementById('new-macro-key').value.toLowerCase();
                    const v = document.getElementById('new-macro-val').value;
                    if(!k || !v || k.length !== 1 || !/[a-z0-9]/.test(k)) { Core.Utils.toast("ERREUR: TOUCHE INVALIDE"); return; }
                    await Core.DB.macros.put({trigger: k, content: v});
                    await this.load(); this.manager();
                    document.getElementById('new-macro-key').value = ''; document.getElementById('new-macro-val').value = '';
                    Core.Utils.toast("MACRO ENREGISTRÉE");
                },
                remove: async function(key) {
                    await Core.DB.macros.delete(key); await this.load(); this.manager();
                    Core.Utils.toast("MACRO SUPPRIMÉE");
                }
            },

            AI: {
                analyzeTag: async function(tag) {
                    const data = await Core.Nexus.analyzeIndex(tag);
                    const editor = document.getElementById('main-editor');
                    
                    let status = "ACTIF";
                    let urgency = "NEUTRE";
                    let advice = "Maintenir la surveillance.";
                    
                    if(data.count > 15 && data.relations.length < 2) {
                        status = "BIAIS D'ANCRAGE";
                        urgency = "CRITIQUE";
                        advice = "Tu accumules sur ce titre sans le corréler au marché. C'est du biais de confirmation. Arrête ou structure.";
                    } else if (data.count < 3 && data.timeline.filter(t => t.count > 0).length === 0) {
                        status = "ANGLE MORT";
                        urgency = "BASSE";
                        advice = "Donnée inactive. Si ce n'est plus pertinent, purge-le pour nettoyer ton système.";
                    } else if (data.relations.length > 5) {
                        status = "NOEUD SYSTÉMIQUE";
                        urgency = "HAUTE";
                        advice = "Ce concept impacte le reste de ton portefeuille. Surveillance renforcée requise.";
                    }

                    const topRel = data.relations.slice(0,3).map(r => r[0]).join(', ') || "Aucun";
                    const lastActive = data.mentions[0]?.date || "Inconnu";

                    const reportHTML = `
                        <div class="ai-insight-panel" style="border-color: #3b82f6;">
                            <div class="ai-insight-header">
                                <div class="ai-title-group">
                                    <div class="ai-icon-box" style="background: #2563eb;">⚡</div>
                                    <div class="ai-panel-title" style="color: #60a5fa;">RAPPORT TACTIQUE : [${tag}]</div>
                                </div>
                                <div class="ai-meta">AUTO-GENERATED</div>
                            </div>
                            <div class="p-4 space-y-2 text-sm text-slate-300 font-mono">
                                <div class="flex justify-between border-b border-white/5 pb-2">
                                    <span>STATUT : <strong class="${urgency === 'CRITIQUE' ? 'text-red-500' : 'text-blue-400'}">${status}</strong></span>
                                    <span>VOL : ${data.count}</span>
                                </div>
                                <div>> DERNIÈRE ACTIVITÉ : <span class="text-white">${lastActive}</span></div>
                                <div>> CORRÉLATIONS : <span class="text-slate-400">${topRel}</span></div>
                                <div class="mt-4 pt-2 border-t border-white/10 text-blue-300 font-bold">
                                    > AUDIT : ${advice}
                                </div>
                            </div>
                        </div>
                        <br>
                    `;
                    
                    editor.insertAdjacentHTML('afterbegin', reportHTML);
                    Core.IO.saveDraft();
                    Core.Utils.toast("RAPPORT GÉNÉRÉ");
                    if(window.innerWidth < 768) Core.UI.toggleSidebar();
                },

                challenge: async function() {
                    const btn = document.getElementById('ai-trigger');
                    const label = document.getElementById('ai-label');
                    const pulse = document.getElementById('ai-pulse');
                    const editor = document.getElementById('main-editor');

                    btn.classList.add('border-blue-500', 'bg-blue-500/10');
                    pulse.classList.add('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]');
                    label.classList.add('text-blue-300');
                    label.textContent = "EXTRACTION...";

                    const htmlContent = editor.innerHTML;
                    const textContent = Core.Utils.stripHTML(htmlContent);
                    const lines = textContent.split(/\n|(?<=[.?!])\s+/).filter(s => s.trim().length > 10);

                    // NOUVELLE DOCTRINE FINANCIÈRE : Mots-clés quantitatifs et de risques purs
                    const metricKeywords = ['%', '€', '$', 'marge', 'ca', 'revenu', 'capex', 'dividende', 'ebitda', 'bpa', 'guidance', 'trimestre', 'croissance', 'baisse', 'hausse', 'points de base', 'bps', 'trésorerie', 'fcf'];
                    const riskKeywords = ['supply chain', 'litige', 'retard', 'inflation', 'pénurie', 'dette', 'avertissement', 'warning', 'dépréciation', 'restructuration', 'enquête', 'démission', 'risque', 'incertitude', 'pression', 'défaut'];
                    
                    const extractedMetrics = [];
                    const extractedRisks = [];
                    
                    lines.forEach(line => {
                        const lower = line.toLowerCase();
                        if (metricKeywords.some(k => lower.includes(k))) { extractedMetrics.push(line.trim()); } 
                        if (riskKeywords.some(k => lower.includes(k))) { extractedRisks.push(line.trim()); }
                    });

                    const uniqueMetrics = [...new Set(extractedMetrics)].slice(0, 5);
                    const uniqueRisks = [...new Set(extractedRisks)].slice(0, 4);

                    setTimeout(() => {
                        const old = document.querySelector('.ai-insight-panel'); if(old) old.remove();

                        if (lines.length === 0) {
                             label.textContent = "NO DATA";
                             setTimeout(() => { btn.classList.remove('border-blue-500', 'bg-blue-500/10'); pulse.classList.remove('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]'); label.classList.remove('text-blue-300'); label.textContent = "SYSTEM.READY"; }, 1500);
                             return;
                        }

                        const now = new Date();
                        const timeID = `${now.getHours()}${now.getMinutes()}`;

                        let synthesisHTML = `
                            <div class="ai-insight-panel">
                                <div class="ai-insight-header" contenteditable="false">
                                    <div class="ai-title-group">
                                        <div class="ai-icon-box" style="background: #2563eb;">⚡</div>
                                        <div class="ai-panel-title" style="color: #60a5fa;">EXTRACTION TACTIQUE FINANCIÈRE</div>
                                    </div>
                                    <div class="ai-meta">ID-${timeID}</div>
                                </div>
                                <div class="p-4 space-y-4">
                        `;

                        if (uniqueMetrics.length === 0 && uniqueRisks.length === 0) {
                             // AUDIT BRUTAL (Miroir)
                             synthesisHTML += `
                                <div class="p-4 bg-red-500/10 border border-red-500/30 rounded">
                                    <div class="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1" contenteditable="false">REJET SYSTÈME : BRUIT DÉTECTÉ</div>
                                    <div class="text-xs text-slate-300">Aucune métrique financière ni marqueur de risque factuel identifié. Ce texte est du narratif pur ou de l'opinion. Ne polluez pas la base de données avec du sentiment.</div>
                                </div>`;
                        } else {
                            if (uniqueMetrics.length > 0) {
                                synthesisHTML += `<div><div class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2" contenteditable="false">Faits & Métriques</div><ul class="space-y-2">${uniqueMetrics.map(p => `<li class="flex items-start gap-2 text-sm text-slate-300"><span class="text-cyan-500 mt-1" contenteditable="false">►</span><div class="flex-1">${p}</div></li>`).join('')}</ul></div>`;
                            }

                            if (uniqueRisks.length > 0) {
                                 synthesisHTML += `<div><div class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-2" contenteditable="false">Signaux Faibles & Risques</div><ul class="space-y-2">${uniqueRisks.map(p => `<li class="flex items-start gap-2 text-sm text-slate-300"><span class="text-orange-500 mt-1" contenteditable="false">⚠️</span><div class="flex-1">${p}</div></li>`).join('')}</ul></div>`;
                            }
                        }

                        synthesisHTML += `</div></div>`;
                        editor.insertAdjacentHTML('afterbegin', synthesisHTML);
                        Core.IO.saveDraft();

                        label.textContent = "DONE";
                        setTimeout(() => { btn.classList.remove('border-blue-500', 'bg-blue-500/10'); pulse.classList.remove('bg-blue-400', 'shadow-[0_0_10px_#60a5fa]'); label.classList.remove('text-blue-300'); label.textContent = "SYSTEM.READY"; }, 1500);
                    }, 800);
                },
                insertTag: (tag) => { document.execCommand('insertText', false, ` ${tag} `); Core.IO.saveDraft(); }
            },

            Listeners: {
                setup: function() {
                    const editor = document.getElementById('main-editor');
                    editor.addEventListener('input', Core.Utils.debounce(() => Core.IO.saveDraft(), 1000));
                    document.addEventListener('keydown', e => {
                        if(e.key === 'Alt') document.getElementById('macro-hud').classList.add('visible');
                        
                        if(e.altKey && !e.ctrlKey && !e.metaKey) {
                            const k = e.key.toLowerCase();
                            const code = e.code; 

                            if(k === 'v' || code === 'KeyV') { e.preventDefault(); Core.Editor.toggleMode(); return; }
                            
                            if(k === 't' || code === 'KeyT') { 
                                e.preventDefault(); 
                                Core.Editor.insertIndexManual(); 
                                return; 
                            }
                            
                            if(e.key === 'ArrowUp') { e.preventDefault(); Core.Editor.addLine('start'); return; }
                            if(e.key === 'ArrowDown') { e.preventDefault(); Core.Editor.addLine('end'); return; }

                            if(k === 'b' || code === 'KeyB') { e.preventDefault(); Core.UI.toggleSidebar(); return; }
                            
                            if(e.key.length === 1) Core.Macros.handle(e);
                        }
                        
                        if((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); Core.UI.openSearch(); }
                        if(e.key === 'F1') { e.preventDefault(); Core.UI.openHelp(); }
                    });
                    document.addEventListener('keyup', e => { if(e.key === 'Alt') document.getElementById('macro-hud').classList.remove('visible'); });
                    
                    editor.addEventListener('mouseup', () => {
                        const sel = window.getSelection();
                        const text = sel.toString().trim();
                        if (text.length > 0) {
                            Core.State.lastSelection = { text: text, ts: Date.now() };
                        }
                    });

                    editor.addEventListener('dblclick', (e) => {
                        if(Core.State.isReadMode) return;
                        
                        setTimeout(() => {
                            let textToIndex = "";
                            const sel = window.getSelection();
                            const currentText = sel.toString().trim();

                            const now = Date.now();
                            if (Core.State.lastSelection.text && (now - Core.State.lastSelection.ts < 1000)) {
                                if (Core.State.lastSelection.text.includes(currentText)) {
                                    textToIndex = Core.State.lastSelection.text;
                                } else {
                                    textToIndex = currentText;
                                }
                            } else {
                                textToIndex = currentText;
                            }
                            
                            if(!textToIndex || textToIndex.length === 0) return;
                            if(textToIndex.includes('[') || textToIndex.includes(']')) return; 
                            if(sel.anchorNode.parentElement.classList.contains('nexus-index')) return;

                            document.execCommand('insertText', false, `[${textToIndex}]`);
                            Core.IO.saveDraft();
                            Core.Nexus.open(textToIndex);
                            Core.Utils.toast(`INDEX CRÉÉ : [${textToIndex.toUpperCase().substring(0, 15)}...]`);
                            
                            Core.State.lastSelection = { text: null, ts: 0 };
                        }, 50); 
                    });
                }
            },
            Nexus: {
                analyzeIndex: async function(tag) {
                    const cleanTag = tag.replace(/[\[\]]/g, '');
                    const allEntries = await Core.DB.entries.toArray();
                    const relevant = allEntries.filter(e => e.content.includes(cleanTag)).sort((a,b) => b.date.localeCompare(a.date));
                    if(relevant.length === 0) return { tag: cleanTag, count: 0, relations: [], timeline: [], mentions: [] };
                    const relationsMap = {};
                    relevant.forEach(entry => {
                        const tagsInEntry = Core.Utils.extractIndexes(entry.content);
                        tagsInEntry.forEach(t => { if(t !== cleanTag) relationsMap[t] = (relationsMap[t] || 0) + 1; });
                    });
                    const relations = Object.entries(relationsMap).sort((a,b) => b[1] - a[1]).slice(0, 10); 
                    const mentions = relevant.slice(0, 5).map(e => {
                        const raw = Core.Utils.stripHTML(e.content);
                        const idx = raw.indexOf(cleanTag);
                        const start = Math.max(0, idx - 40);
                        const end = Math.min(raw.length, idx + 40 + cleanTag.length);
                        let snippet = raw.substring(start, end);
                        if(start > 0) snippet = "..." + snippet; if(end < raw.length) snippet = snippet + "...";
                        snippet = snippet.replace(cleanTag, `<em>${cleanTag}</em>`);
                        return { date: e.date, text: snippet };
                    });
                    const timeline = []; const today = new Date();
                    for(let i=29; i>=0; i--) {
                        const d = new Date(); d.setDate(today.getDate() - i); const key = Core.Utils.formatDate(d);
                        const hit = relevant.find(e => e.date === key); timeline.push({ date: key, count: hit ? 1 : 0 });
                    }
                    return { tag: cleanTag, count: relevant.length, relations, timeline, mentions };
                },
                render: async function(tagName) {
                    const container = document.getElementById('ui-nexus-content');
                    container.innerHTML = '<div class="p-8 text-center text-xs text-slate-500">Analyse Neurale...</div>';
                    const data = await this.analyzeIndex(tagName);
                    if(data.count === 0) { container.innerHTML = `<div class="nexus-header"><div class="nexus-title">${data.tag}</div><div class="nexus-meta">Nouvel Index</div></div>`; return; }
                    let relationsHTML = ''; data.relations.forEach(([relTag, count]) => { relationsHTML += `<div class="network-item" onclick="Core.Nexus.open('${relTag}')"><span class="network-name">${relTag}</span><span class="network-score">${count}</span></div>`; });
                    let mentionsHTML = ''; data.mentions.forEach(m => { mentionsHTML += `<div class="context-item" onclick="Core.Binder.goToDate('${m.date}')"><div class="context-date">${m.date}</div><div class="context-snippet">${m.text}</div></div>`; });
                    let heatHTML = ''; data.timeline.forEach(t => { heatHTML += `<div class="heatmap-bar ${t.count > 0 ? 'active' : ''}" style="height:${t.count > 0 ? '100%' : '10%'}"></div>`; });
                    
                    const html = `
                        <div class="nexus-header">
                            <div class="flex justify-between items-start mb-2">
                                <div class="nexus-title">${data.tag}</div>
                                <button onclick="Core.AI.analyzeTag('${data.tag}')" class="text-[9px] font-bold bg-blue-500/10 text-blue-400 px-2 py-1 rounded border border-blue-500/20 hover:bg-blue-500 hover:text-white transition-colors">⚡ AUDIT</button>
                            </div>
                            <div class="nexus-meta"><span>${data.count} occurrences</span><span>Dernière: ${data.mentions[0]?.date || 'N/A'}</span></div>
                        </div>
                        <div class="nexus-section-title">Activité (30j)</div><div class="heatmap-container">${heatHTML}</div>
                        <div class="nexus-section-title">Réseau de Corrélation</div><div class="flex flex-col">${relationsHTML || '<div class="p-4 text-xs text-slate-600">Aucune corrélation trouvée.</div>'}</div>
                        <div class="nexus-section-title">Contexte Récent</div><div class="flex flex-col">${mentionsHTML}</div>
                    `;
                    container.innerHTML = html;
                },
                open: function(tag) { Core.UI.toggleSidebarView('index'); this.render(tag); }
            },
            Binder: { 
                render: async function() {
                    const container = document.getElementById('ui-binder-content');
                    container.innerHTML = '';
                    if (Core.State.activeTagFilter) {
                        const all = await Core.DB.entries.toArray();
                        const relevant = all.filter(e => e.content.includes(Core.State.activeTagFilter));
                        relevant.sort((a,b) => b.date.localeCompare(a.date));
                        if(relevant.length === 0) container.innerHTML = `<div class="p-8 text-center text-xs text-slate-600">Aucun Index trouvé.</div>`;
                        relevant.forEach(entry => this.createCard(container, new Date(entry.date), entry));
                        return;
                    }
                    const start = new Date(Core.State.currentMonday);
                    const end = new Date(start.getTime() + 6*86400000);
                    document.getElementById('ui-week-range').textContent = `${start.getDate()}/${start.getMonth()+1} - ${end.getDate()}/${end.getMonth()+1}`;
                    for(let i=0; i<7; i++) {
                        const current = new Date(start.getTime() + i*86400000);
                        const key = Core.Utils.formatDate(current);
                        const data = await Core.DB.entries.get(key);
                        this.createCard(container, current, data, true);
                    }
                },
                createCard: function(container, dateObj, data, showControls = false) {
                    const key = Core.Utils.formatDate(dateObj);
                    const isToday = key === Core.Utils.formatDate(new Date());
                    const card = document.createElement('div'); card.className = `agenda-card px-4 py-3 ${isToday ? 'today' : ''}`; card.id = `card-${key}`;
                    const tags = data ? Core.Utils.extractIndexes(data.content) : [];
                    
                    const tagsHTML = tags.map(t => `<span class="card-tag-badge" onclick="event.stopPropagation(); Core.Nexus.open('${t}')">${t}</span>`).join('');
                    
                    const header = document.createElement('div'); header.className = "flex justify-between items-start mb-1";
                    header.innerHTML = `<div class="flex flex-col"><span class="text-[10px] font-bold text-slate-500 uppercase font-mono">${dateObj.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'numeric'})}</span><div class="mt-1">${tagsHTML}</div></div>`;
                    if (showControls) {
                        const actions = document.createElement('div'); actions.className = "card-actions flex gap-1";
                        actions.innerHTML = `
                            <button onclick="Core.Binder.importDraft('${key}')" class="action-icon" title="Archiver ici"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="2"/></svg></button>
                            <button onclick="Core.Binder.returnToDraft('${key}')" class="action-icon" title="Renvoyer au brouillon"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18" stroke-width="2"/></svg></button>
                            <button onclick="Core.Binder.clearCard(this, '${key}')" class="action-icon danger" title="Effacer"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
                        `;
                        header.appendChild(actions);
                    }
                    card.appendChild(header);
                    const contentDiv = document.createElement('div'); contentDiv.className = "agenda-editable text-slate-300 outline-none custom-scrollbar"; contentDiv.contentEditable = showControls; 
                    contentDiv.innerHTML = data ? Core.Editor.processContent(data.content) : '';
                    if(showControls) {
                        contentDiv.oninput = Core.Utils.debounce(() => {
                            Core.DB.entries.put({date: key, content: contentDiv.innerHTML});
                            const newTags = Core.Utils.extractIndexes(contentDiv.innerHTML);
                            const tagContainer = header.querySelector('.mt-1');
                            if(tagContainer) tagContainer.innerHTML = newTags.map(t => `<span class="card-tag-badge" onclick="event.stopPropagation(); Core.Nexus.open('${t}')">${t}</span>`).join('');
                        }, 1000);
                    }
                    card.appendChild(contentDiv); container.appendChild(card);
                },
                importDraft: async function(key) {
                    const editor = document.getElementById('main-editor');
                    const raw = editor.innerText.trim();
                    if(!raw) return;
                    const currentEntry = await Core.DB.entries.get(key);
                    const time = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                    const sep = currentEntry && currentEntry.content ? `<div class="agenda-separator">${time}</div>` : '';
                    const newContent = (currentEntry ? currentEntry.content : '') + sep + editor.innerHTML;
                    await Core.DB.entries.put({date: key, content: newContent});
                    editor.innerHTML = '';
                    Core.IO.saveDraft();
                    this.render(); 
                    const card = document.getElementById(`card-${key}`);
                    if(card) card.classList.add('flash-success');
                    Core.Utils.toast("ARCHIVÉ DANS LE CLASSEUR");
                },
                returnToDraft: async function(key) {
                    const entry = await Core.DB.entries.get(key);
                    if(!entry || !entry.content) return;
                    const editor = document.getElementById('main-editor');
                    const spacing = editor.innerHTML.trim() ? '<br><br>' : '';
                    editor.innerHTML = editor.innerHTML + spacing + entry.content;
                    Core.IO.saveDraft();
                    await Core.DB.entries.delete(key);
                    this.render();
                    Core.Utils.toast("CARTE DÉPLACÉE VERS BROUILLON");
                },
                copyCard: async function(key) {
                    const entry = await Core.DB.entries.get(key); if(!entry) return;
                    const t = document.createElement('textarea'); t.value = Core.Utils.stripHTML(entry.content); document.body.appendChild(t); t.select();
                    document.execCommand('copy'); document.body.removeChild(t); Core.Utils.toast("COPIÉ");
                },
                clearCard: function(btn, key) {
                    if (btn.dataset.confirm === "true") {
                        Core.DB.entries.delete(key).then(() => { Core.Binder.render(); Core.Utils.toast("FICHE SUPPRIMÉE"); });
                    } else {
                        btn.dataset.confirm = "true"; btn.classList.add('armed'); Core.Utils.toast("RE-CLIQUER POUR TUER");
                        setTimeout(() => { if(btn) { btn.dataset.confirm = "false"; btn.classList.remove('armed'); } }, 2500);
                    }
                },
                filterByTag: function(tag) {
                    Core.State.activeTagFilter = tag; 
                    document.getElementById('ui-filter-banner').classList.remove('hidden');
                    document.getElementById('ui-filter-text').textContent = `${tag}`;
                    Core.UI.toggleSidebarView('pages');
                    this.render();
                },
                clearFilter: function() {
                    Core.State.activeTagFilter = null;
                    document.getElementById('ui-filter-banner').classList.add('hidden');
                    this.render();
                },
                shiftWeek: (dir) => { 
                    const d = new Date(Core.State.currentMonday); d.setDate(d.getDate() + (dir * 7));
                    Core.State.currentMonday = d.getTime(); 
                    Core.State.activeTagFilter = null; 
                    document.getElementById('ui-filter-banner').classList.add('hidden');
                    Core.Binder.render(); 
                },
                jumpToToday: () => {
                     Core.State.currentMonday = Core.Utils.getMonday(new Date());
                     Core.State.activeTagFilter = null;
                     document.getElementById('ui-filter-banner').classList.add('hidden');
                     Core.Binder.render();
                     Core.Utils.toast("RETOUR AUJOURD'HUI");
                },
                goToDate: (dateStr) => {
                     Core.State.currentMonday = Core.Utils.getMonday(new Date(dateStr));
                     Core.UI.toggleSidebarView('pages');
                     setTimeout(() => { const card = document.getElementById(`card-${dateStr}`); if(card) card.classList.add('flash-success'); }, 300);
                },
                search: async function(query) {
                    const container = document.getElementById('search-results'); 
                    container.innerHTML = ''; 
                    if(!query || query.trim().length < 2) return;

                    const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const terms = normalize(query).split(' ').filter(t => t);
                    
                    const draftHtml = document.getElementById('main-editor').innerHTML;
                    const draftText = Core.Utils.stripHTML(draftHtml);
                    const draftNorm = normalize(draftText);
                    
                    if (draftText.trim().length > 0 && terms.every(t => draftNorm.includes(t))) {
                        const div = document.createElement('div');
                        div.className = "bg-blue-500/10 border border-blue-500/30 p-3 rounded cursor-pointer hover:bg-blue-500/20 mb-3";
                        div.onclick = () => { Core.UI.closeModals(); };
                        
                        let snippet = draftText;
                        query.split(' ').filter(t=>t).forEach(t => {
                            const regex = new RegExp(`(${t})`, 'gi');
                            snippet = snippet.replace(regex, `<span class="bg-yellow-500/40 text-white rounded px-0.5">$1</span>`);
                        });

                        div.innerHTML = `<div class="text-[10px] font-mono text-blue-400 mb-1">BROUILLON ACTIF</div><div class="text-xs text-slate-300 line-clamp-3">${snippet}</div>`;
                        container.appendChild(div);
                    }

                    const all = await Core.DB.entries.toArray();
                    const results = all.filter(e => {
                        const contentNorm = normalize(Core.Utils.stripHTML(e.content));
                        return terms.every(t => contentNorm.includes(t));
                    }).sort((a,b) => b.date.localeCompare(a.date));

                    if (results.length > 0) {
                        results.forEach(res => {
                            const div = document.createElement('div');
                            div.className = "bg-white/5 p-3 rounded cursor-pointer hover:bg-white/10 mb-2";
                            div.onclick = () => { Core.State.currentMonday = Core.Utils.getMonday(new Date(res.date)); Core.Binder.render(); Core.UI.closeModals(); };
                            
                            let snippet = Core.Utils.stripHTML(res.content);
                            const firstTermIdx = normalize(snippet).indexOf(terms[0]);
                            if (firstTermIdx > 40) snippet = "..." + snippet.substring(firstTermIdx - 30);
                            
                            query.split(' ').filter(t=>t).forEach(t => {
                                const regex = new RegExp(`(${t})`, 'gi');
                                snippet = snippet.replace(regex, `<span class="bg-yellow-500/40 text-white rounded px-0.5">$1</span>`);
                            });

                            div.innerHTML = `<div class="text-[10px] font-mono text-slate-500 mb-1">${res.date}</div><div class="text-xs text-slate-300 line-clamp-3">${snippet}</div>`;
                            container.appendChild(div);
                        });
                    } else if (container.innerHTML === '') {
                        container.innerHTML = '<div class="p-4 text-center text-xs text-slate-500">Aucun signal trouvé.</div>';
                    }
                }
            },
            Editor: {
                stripIndexes: (html) => {
                    let cleaned = html;
                    const regex = /<span class="nexus-index"[^>]*>(.*?)<\/span>/g;
                    while (regex.test(cleaned)) {
                        cleaned = cleaned.replace(regex, '$1');
                    }
                    return cleaned;
                },

                toggleMode: () => {
                    const el = document.getElementById('main-editor');
                    Core.State.isReadMode = !Core.State.isReadMode;
                    el.contentEditable = !Core.State.isReadMode;
                    el.classList.toggle('read-mode', Core.State.isReadMode);
                    
                    const btn = document.getElementById('ui-mode-btn');

                    if(Core.State.isReadMode) {
                        const clean = Core.Editor.stripIndexes(el.innerHTML);
                        el.innerHTML = Core.Editor.processContent(clean);
                        
                        btn.classList.remove('text-emerald-400', 'hover:text-emerald-300'); 
                        btn.classList.add('text-red-500', 'hover:text-red-400');
                        
                        Core.Utils.toast("MODE LECTURE");
                    } else {
                        const clean = Core.Editor.stripIndexes(el.innerHTML);
                        el.innerHTML = Core.Editor.processContent(clean);
                        
                        btn.classList.remove('text-red-500', 'hover:text-red-400');
                        btn.classList.add('text-emerald-400', 'hover:text-emerald-300');
                        
                        Core.Utils.toast("MODE ÉDITION");
                    }
                },
                processContent: (html) => {
                    const tags = [];
                    const textOnly = html.replace(/<[^>]*>/g, (match) => {
                        tags.push(match);
                        return `###HTML_TAG_${tags.length - 1}###`;
                    });

                    let processed = textOnly.replace(Core.Utils.tagRegex, (match) => {
                        if (match.includes('###HTML_TAG_')) return match;
                        const safeMatch = match.replace(/'/g, "\\'");
                        return `<span class="nexus-index" onclick="Core.Nexus.open('${safeMatch.replace(/[\[\]]/g, '')}')">${match}</span>`;
                    });

                    return processed.replace(/###HTML_TAG_(\d+)###/g, (match, index) => tags[index]);
                },
                insertIndexManual: () => {
                    const sel = window.getSelection();
                    if (sel.getRangeAt && sel.rangeCount) {
                        const text = sel.toString();
                        if (text.length > 0) {
                            document.execCommand('insertText', false, `[${text}]`);
                        } else {
                            const range = sel.getRangeAt(0); const node = document.createTextNode("[]");
                            range.insertNode(node); range.setStart(node, 1); range.setEnd(node, 1);
                            sel.removeAllRanges(); sel.addRange(range);
                        }
                    }
                    document.getElementById('main-editor').focus();
                    Core.Utils.toast("INDEX [] INSÉRÉ");
                },
                format: (cmd) => { document.execCommand(cmd, false, null); Core.IO.saveDraft(); },
                highlight: () => { document.execCommand('hiliteColor', false, '#fde047'); document.execCommand('foreColor', false, '#000'); Core.IO.saveDraft(); },
                contrast: () => { document.execCommand('backColor', false, '#ffffff'); document.execCommand('foreColor', false, '#000000'); Core.IO.saveDraft(); },
                addLine: (pos) => {
                     const div = document.createElement('div'); div.innerHTML = '<br>';
                     const ed = document.getElementById('main-editor');
                     pos === 'start' ? ed.prepend(div) : ed.append(div);
                     div.scrollIntoView({behavior: "smooth", block: "nearest"});
                     
                     const range = document.createRange();
                     const sel = window.getSelection();
                     range.selectNodeContents(div);
                     range.collapse(false);
                     sel.removeAllRanges();
                     sel.addRange(range);
                     ed.focus();

                     Core.IO.saveDraft();
                },
                clear: (btn) => {
                    if(btn.dataset.confirm === "true") {
                        document.getElementById('main-editor').innerHTML = ''; Core.IO.saveDraft(); Core.Utils.toast("BROUILLON RAZ");
                        btn.dataset.confirm = "false"; btn.classList.remove('text-red-500', 'bg-red-500/10');
                    } else {
                        btn.dataset.confirm = "true"; btn.classList.add('text-red-500', 'bg-red-500/10'); Core.Utils.toast("CONFIRMER LE VIDE ?");
                        setTimeout(() => { btn.dataset.confirm = "false"; btn.classList.remove('text-red-500', 'bg-red-500/10'); }, 3000);
                    }
                }
            },
            IO: {
                saveDraft: async () => { await Core.DB.meta.put({id: 'draft', content: document.getElementById('main-editor').innerHTML}); },
                loadDraft: async () => { const draft = await Core.DB.meta.get('draft'); if(draft) { document.getElementById('main-editor').innerHTML = Core.Editor.processContent(draft.content); } },
                export: async () => {
                    const entries = await Core.DB.entries.toArray(); const draft = await Core.DB.meta.get('draft');
                    const blob = new Blob([JSON.stringify({version: "v9.23", exportedAt: new Date().toISOString(), agenda: entries, draft: draft ? draft.content : ""}, null, 2)], {type : 'application/json'});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AgenData_Backup_${Core.Utils.formatDate(new Date())}.json`; a.click(); Core.Utils.toast("BACKUP COMPLET GÉNÉRÉ");
                },
                triggerImport: () => document.getElementById('import-input').click(),
                importData: (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader(); reader.onload = async (ev) => {
                        try { 
                            const data = JSON.parse(ev.target.result);
                            if(data.agenda) { for(let entry of data.agenda) await Core.DB.entries.put(entry); }
                            if(data.draft) { await Core.DB.meta.put({id: 'draft', content: data.draft}); }
                            Core.Utils.toast("RESTAURATION TERMINÉE"); setTimeout(() => location.reload(), 1500);
                        } catch(err) { Core.Utils.toast("ERREUR FICHIER"); }
                    }; reader.readAsText(file);
                }
            },
            Voice: {
                init: function() {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if(SR) {
                        Core.State.recognition = new SR(); Core.State.recognition.lang = 'fr-FR';
                        Core.State.recognition.onstart = () => { Core.State.isRecording = true; document.getElementById('ui-voice-btn').classList.add('recording-pulse'); };
                        Core.State.recognition.onresult = (e) => { if(!Core.State.isReadMode) { document.execCommand('insertText', false, e.results[0][0].transcript); Core.IO.saveDraft(); } };
                        Core.State.recognition.onend = () => { Core.State.isRecording = false; document.getElementById('ui-voice-btn').classList.remove('recording-pulse'); };
                    }
                },
                toggle: function() { if(!Core.State.recognition || Core.State.isReadMode) return; Core.State.isRecording ? Core.State.recognition.stop() : Core.State.recognition.start(); }
            },
            UI: {
                toggleSidebarView: (view) => {
                    const pages = document.getElementById('view-pages'); const index = document.getElementById('view-index');
                    if (view === 'pages') {
                        pages.classList.remove('hidden'); index.classList.add('hidden');
                        document.getElementById('btn-view-pages').classList.replace('text-slate-500', 'text-blue-400');
                        document.getElementById('btn-view-index').classList.replace('text-blue-400', 'text-slate-500');
                        Core.Binder.render();
                    } else {
                        pages.classList.add('hidden'); index.classList.remove('hidden');
                        document.getElementById('btn-view-index').classList.replace('text-slate-500', 'text-blue-400');
                        document.getElementById('btn-view-pages').classList.replace('text-blue-400', 'text-slate-500');
                        if(!document.getElementById('ui-nexus-content').innerHTML.trim()) Core.Binder.render();
                    }
                },
                toggleSidebar: () => document.getElementById('main-sidebar').classList.toggle('collapsed'),
                openSearch: () => { document.getElementById('modal-search').style.display = 'flex'; document.getElementById('search-input').focus(); },
                openMacroManager: () => { document.getElementById('modal-macros').style.display = 'flex'; Core.Macros.manager(); },
                openHelp: () => { Core.UI.switchHelp('manifesto'); document.getElementById('modal-help').style.display = 'flex'; },
                switchHelp: (section, tabEl) => {
                    const content = document.getElementById('ui-help-content');
                    if(tabEl) { document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active')); tabEl.classList.add('active'); }
                    
                    if (section === 'manifesto') {
                        content.innerHTML = `
                            <h3>DOCTRINE : LE SIGNAL CONTRE LE BRUIT</h3>
                            <p>Le marché se nourrit du bruit. Ton avantage concurrentiel réside dans l'extraction du signal. Accumuler des articles boursiers sans les structurer est une illusion de productivité. Ton cerveau n'est pas conçu pour mémoriser des bilans comptables.</p>
                            
                            <div class="help-step">
                                <span class="help-step-num">PRINCIPE 01 : LE SAS D'ÉPURATION</span>
                                <p>Le Brouillon central est une zone de traitement. C'est ici que tu décharges tes copier-coller bruts de Reuters, Bloomberg ou des rapports annuels. La mise en forme n'a aucune importance. C'est un espace temporaire pour disséquer l'information.</p>
                            </div>

                            <div class="help-step">
                                <span class="help-step-num">PRINCIPE 02 : LA CRISTALLISATION</span>
                                <p>Une donnée financière n'a de valeur que si elle est indexée et horodatée. Déplacer une note épurée vers l'Agenda, c'est figer une donnée stratégique. C'est transformer un narratif journalistique en un actif informationnel.</p>
                            </div>

                            <div class="help-step">
                                <span class="help-step-num">PRINCIPE 03 : LA PURGE</span>
                                <p>Garder un brouillon plein est une dette cognitive. Une fois les faits (marges, CAPEX, guidances) transférés dans l'Agenda, détruis le reste. Reviens à zéro pour analyser la prochaine société avec lucidité.</p>
                            </div>
                        `;
                    } else if (section === 'workflow') {
                        content.innerHTML = `
                            <h3>PROTOCOLE : L'ANALYSE FINANCIÈRE BRUTE</h3>
                            <p>Scénario : Suivi de résultats trimestriels et annonces macro-économiques.</p>
                            
                            <div class="help-step">
                                <span class="help-step-num">PHASE 1 : INJECTION (COPIER-COLLER)</span>
                                <p>Tu trouves un article de 3 pages sur une société cotée. Ne le lis pas passivement. Copie le texte brut et jette-le dans le Brouillon.</p>
                                <div class="p-2 bg-black/30 rounded font-mono text-xs text-slate-400 mb-2">
                                    La société XYZ a annoncé une baisse de ses marges opérationnelles de 12% suite à des problèmes de supply chain en Asie...
                                </div>
                            </div>

                            <div class="help-step">
                                <span class="help-step-num">PHASE 2 : DISSECTION ET INDEXATION</span>
                                <p>Supprime le blabla journalistique. Ne garde que les faits concrets et les chiffres. Utilise les crochets pour créer tes nœuds de données.</p>
                                <div class="p-2 bg-black/30 rounded font-mono text-xs text-slate-400 mb-2">
                                    [XYZ] Baisse marge opé -12%. Cause: [SUPPLY_CHAIN] Asie.<br>
                                    [ACTION] Vérifier exposition de [ABC] aux mêmes fournisseurs.
                                </div>
                            </div>

                            <div class="help-step">
                                <span class="help-step-num">PHASE 3 : CRISTALLISATION TEMPORELLE</span>
                                <p>Cette annonce a lieu aujourd'hui. Clique sur la flèche d'import de la carte "AUJOURD'HUI". Les faits sont maintenant verrouillés dans ta base de données historique.</p>
                            </div>

                            <div class="help-step">
                                <span class="help-step-num">PHASE 4 : PURGE</span>
                                <p>Clique sur la corbeille pour vider le Brouillon. Ton espace est net pour l'analyse du prochain titre boursier.</p>
                            </div>
                        `;
                    } else if (section === 'nexus') {
                        content.innerHTML = `
                            <h3>LE NEXUS : LA MATRICE DE CORRÉLATION</h3>
                            <p>Lire l'actualité du jour te donne un avantage nul. Tout le monde a la même information. Ton avantage réside dans la corrélation historique.</p>
                            <ul>
                                <li>En encapsulant des mots-clés entre crochets comme <code>[NVDA]</code> ou <code>[INFLATION]</code>, tu crées des nœuds de données.</li>
                                <li>Le Nexus cartographie ces nœuds. Il te montre mathématiquement à quelle fréquence <code>[NVDA]</code> apparaît à côté de <code>[TSMC]</code> dans tes propres analyses sur les 6 derniers mois.</li>
                                <li>C'est ici que tu repères les signaux faibles et les dépendances avant que le marché ne les intègre.</li>
                            </ul>
                        `;
                    } else if (section === 'ai') {
                         content.innerHTML = `
                            <h3>EXTRACTION IA (SYSTEM.READY)</h3>
                            <p>Les rapports financiers sont conçus pour noyer l'information critique sous une abondance de termes rassurants. L'IA est ton extracteur à froid.</p>
                            
                            <div class="help-step">
                                <span class="help-step-num">FONCTION : SCAN OBJECTIF</span>
                                <p>Tu as collé le communiqué de presse d'une entreprise. Clique sur SYSTEM.READY. L'algorithme ignore le narratif. Il extrait les points de tension (mots-clés liés au risque, aux retards, aux baisses de guidance) et les métriques.</p>
                                <p>C'est une synthèse brutale qui te force à voir les failles que le management essaie de cacher, t'évitant de tomber dans le biais d'ancrage.</p>
                            </div>
                        `;
                    } else if (section === 'controls') {
                        content.innerHTML = `
                            <h3>ARMEMENT (RACCOURCIS ET MACROS)</h3>
                            <p>Chaque seconde passée à formater est une seconde de concentration perdue sur l'analyse.</p>
                            <ul>
                                <li><code>Alt + V</code> : Basculer entre l'édition brute et la lecture (activation des liens indexés).</li>
                                <li><code>Alt + T</code> : Insérer une balise d'index <code>[]</code>.</li>
                                <li><code>Double-Clic</code> : Transformer le ticker ou le mot sélectionné en <strong>INDEX</strong>.</li>
                                <li><code>Ctrl + F</code> : Interroger la base de données intégrale.</li>
                            </ul>
                            <h4>DIRECT MACROS (ALT + LETTRE)</h4>
                            <p>Configure tes macros pour gagner du temps. Exemple : Alt+A pour insérer [ACHAT_FORT], Alt+R pour [RISQUE_MAJEUR].</p>
                        `;
                    }
                },
                closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); document.getElementById('macro-hud').classList.remove('visible'); }
            }
        };

        window.onload = () => Core.Init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgenData v7.7 - Syst√®me Op√©rationnel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #070a13;
            --bg-panel: #0f172a;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --text-main: #f1f5f9;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.06);
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .editor-layer {
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .editor-layer:focus-within { border-color: var(--accent); transform: translateY(-2px); }

        [contenteditable]:focus { outline: none; }

        .agenda-card {
            border-bottom: 1px solid var(--border);
            border-left: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .agenda-card.today { background: rgba(59, 130, 246, 0.03); border-left-color: var(--accent); }
        
        .agenda-editable {
            font-size: 0.8rem;
            line-height: 1.5;
            max-height: 7.2rem;
            overflow-y: auto;
            overflow-x: auto;
            white-space: nowrap;
            display: block;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }
        .agenda-editable::-webkit-scrollbar { width: 3px; height: 3px; }
        .agenda-editable::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .card-actions { opacity: 0; transform: translateY(3px); transition: all 0.2s; }
        .agenda-card:hover .card-actions { opacity: 1; transform: translateY(0); }
        
        .action-icon { padding: 4px; border-radius: 4px; color: #475569; cursor: pointer; background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .action-icon:hover { background: #1e293b; color: white; }
        .action-icon.active { background: var(--accent); color: white; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(12px); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 24px; width: 95%; max-width: 900px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }

        #macro-hud {
            position: fixed; bottom: 40px; right: 40px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            padding: 24px; border-radius: 20px;
            display: none; z-index: 150; width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform: translateY(10px);
            transition: transform 0.2s ease-out;
        }
        #macro-hud.visible { transform: translateY(0); display: block; }
        
        .hud-header { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .hud-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .hud-title { font-size: 10px; font-weight: 900; letter-spacing: 0.15em; color: var(--text-main); text-transform: uppercase; }

        .hud-grid { display: grid; gap: 4px; }
        .hud-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.02); border: 1px solid transparent; transition: all 0.2s; }
        .hud-row:hover { background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.2); }
        
        .hud-key { font-family: var(--font-mono); font-size: 11px; font-weight: 700; color: var(--accent); }
        .hud-val { font-size: 11px; color: var(--text-muted); font-weight: 500; }

        #smart-toolbar, .day-transfer-bar { 
            position: absolute; display: none; background: #0f172a; border: 1px solid var(--border); 
            border-radius: 8px; padding: 4px; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .search-category-title { font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2em; color: var(--accent); margin: 20px 0 10px 0; display: flex; align-items: center; gap: 8px; }
        .search-category-title::after { content: ''; flex: 1; height: 1px; background: rgba(59, 130, 246, 0.2); }
        .search-item { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; transition: all 0.2s; cursor: pointer; }
        .search-item:hover { background: rgba(255,255,255,0.04); border-color: var(--accent); transform: scale(1.01); }
        .search-meta { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .search-date { font-size: 10px; font-weight: 900; color: var(--accent); font-family: var(--font-mono); }
        .search-body { font-size: 12px; color: var(--text-main); line-height: 1.5; opacity: 0.8; }

        /* Styles Manuel Aide */
        .help-tab { color: var(--text-muted); transition: all 0.2s; cursor: pointer; padding-bottom: 12px; border-bottom: 2px solid transparent; }
        .help-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .help-section-title { font-family: var(--font-mono); font-weight: 900; letter-spacing: 0.1em; color: var(--accent); font-size: 11px; margin-top: 2rem; margin-bottom: 0.75rem; border-left: 3px solid var(--accent); padding-left: 10px; text-transform: uppercase; }
        .help-step-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="flex-col md:flex-row">

    <aside class="w-full md:w-[380px] border-r border-white/5 flex flex-col shrink-0 bg-black/20">
        <header class="h-14 flex items-center justify-between px-4 border-b border-white/5 bg-white/[0.02]">
            <div class="flex items-center gap-2">
                <button onclick="Core.Agenda.shiftWeek(-1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5"/></svg>
                </button>
                <span id="ui-week-range" class="text-[10px] font-mono font-black uppercase text-slate-400"></span>
                <button onclick="Core.Agenda.shiftWeek(1)" class="p-1.5 hover:bg-white/5 rounded text-slate-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5"/></svg>
                </button>
            </div>
            <button onclick="Core.Agenda.jumpToToday()" class="text-[9px] font-black bg-blue-500/10 text-blue-400 px-3 py-1.5 rounded border border-blue-500/20">AUJOURD'HUI</button>
        </header>
        <div id="ui-agenda-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-white/[0.01]">
        <header class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/20 shrink-0">
            <div class="flex items-center gap-1">
                <button onclick="Core.Editor.toggleMode()" id="ui-mode-btn" class="p-2 text-slate-400 hover:text-white" title="Mode Lecture (Alt+V)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/></svg>
                </button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.Editor.contrast()" class="p-2 text-slate-300 hover:text-white" title="Contraste"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 4v16c4.41 0 8-3.59 8-8s-3.59-8-8-8z"/></svg></button>
                <button onclick="Core.Editor.highlight()" class="p-2 text-yellow-500/60 hover:text-yellow-400" title="Surligner"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.addLine('start')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Haut (Alt+N)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 11l5-5m0 0l5 5m-5-5v12" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.insertLine()" class="p-2 text-blue-500/60 hover:text-blue-400" title="Ins√©rer ligne"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2.5"/></svg></button>
                <button onclick="Core.Editor.addLine('end')" class="p-2 text-emerald-500/60 hover:text-emerald-400" title="Bas (Alt+E)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 13l-5 5m0 0l-5-5m5 5V6" stroke-width="2"/></svg></button>
            </div>

            <div class="flex items-center gap-1">
                <div id="ui-ai-status" class="w-2 h-2 rounded-full bg-slate-600 mr-2"></div>
                <button onclick="Core.AI.challenge()" class="p-2 text-violet-400 hover:text-violet-300" title="AI Challenge"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openMacros()" class="p-2 text-slate-500 hover:text-purple-400" title="Macros"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="2"/></svg></button>
                <button id="ui-voice-btn" onclick="Core.Voice.toggle()" class="p-2 text-slate-500" title="Vocal"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openSearch()" class="p-2 text-slate-500" title="Recherche"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"/></svg></button>
                <div class="h-5 w-px bg-white/10 mx-2"></div>
                <button onclick="Core.IO.triggerImport()" class="p-2 text-slate-500 hover:text-blue-400" title="Importer"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg></button>
                <button onclick="Core.IO.exportMD()" class="p-2 text-slate-500 hover:text-blue-400" title="Exporter"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2"/></svg></button>
                <button onclick="Core.Editor.clear()" class="p-2 text-slate-500 hover:text-red-400" title="Vider brouillon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
                <button onclick="Core.UI.openHelp()" class="p-2 text-slate-500 hover:text-yellow-500" title="Aide (F1)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 custom-scrollbar">
            <div class="max-w-3xl mx-auto editor-layer rounded-2xl">
                <div id="main-editor" contenteditable="true" class="p-12 md:p-16 min-h-[60vh] text-slate-300 outline-none" placeholder="Capture brute..."></div>
            </div>
        </div>

        <div id="smart-toolbar" class="flex items-center">
            <div id="ui-toolbar-days" class="flex gap-1 px-1"></div>
        </div>
        <div id="day-transfer-bar" class="day-transfer-bar flex items-center">
            <div id="ui-day-transfer-container" class="flex gap-1 px-1"></div>
        </div>
        <!-- Input masqu√© pour l'importation -->
        <input type="file" id="import-input" class="hidden" accept=".json" onchange="Core.IO.importData(event)">
    </main>

    <!-- MODALES -->
    <div id="modal-search" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !bg-[#0b0f19]" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-white/5">
                <div class="flex items-center gap-4 bg-white/5 p-4 rounded-xl">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3"/></svg>
                    <input type="text" id="search-input" class="w-full bg-transparent text-white text-xl outline-none font-medium" placeholder="Recherche profonde..." oninput="Core.Search.exec(this.value)">
                </div>
            </div>
            <div id="search-results" class="p-6 overflow-y-auto custom-scrollbar h-[50vh] space-y-3"></div>
        </div>
    </div>

    <div id="modal-macros" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box max-w-2xl !p-0" onclick="event.stopPropagation()">
            <div class="p-6 bg-white/[0.02] border-b border-white/10 flex justify-between items-center">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">Gestionnaire Macros</h2>
                <button onclick="Core.UI.closeModals()" class="p-2 hover:bg-white/5 rounded-full text-slate-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
            </div>
            <div id="ui-macro-manager-list" class="flex-1 overflow-y-auto p-6 space-y-3 custom-scrollbar max-h-[40vh]"></div>
            <div class="p-6 border-t border-white/10 bg-white/[0.02]">
                <div class="grid grid-cols-5 gap-3">
                    <input type="text" id="ui-new-macro-trigger" placeholder="Seq (ex: s,d)" class="col-span-2 bg-black/40 border border-white/10 p-3 text-xs text-blue-400 font-mono rounded-xl outline-none">
                    <input type="text" id="ui-new-macro-text" placeholder="Expansion..." class="col-span-3 bg-black/40 border border-white/10 p-3 text-xs text-white rounded-xl outline-none">
                    <button onclick="Core.Macros.add()" class="col-span-5 py-3 bg-blue-500 text-white text-[10px] font-black uppercase rounded-xl">Enregistrer Protocole</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay" onclick="Core.UI.closeModals()">
        <div class="modal-box !max-w-4xl" onclick="event.stopPropagation()">
            <div class="p-8 bg-black/40 flex flex-col gap-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-widest text-white">Manuel Op√©rationnel v7.7</h2>
                    </div>
                    <button onclick="Core.UI.closeModals()" class="p-2 text-slate-500 bg-white/5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>
                <div class="flex gap-6 border-b border-white/5">
                    <button onclick="Core.UI.switchHelp('strat')" class="help-tab active pb-3 text-[11px] font-black uppercase">Philosophie</button>
                    <button onclick="Core.UI.switchHelp('comp')" class="help-tab pb-3 text-[11px] font-black uppercase">Composants</button>
                    <button onclick="Core.UI.switchHelp('syntax')" class="help-tab pb-3 text-[11px] font-black uppercase">Syntaxe</button>
                    <button onclick="Core.UI.switchHelp('workflow')" class="help-tab pb-3 text-[11px] font-black uppercase">Exemple</button>
                </div>
            </div>
            <div id="ui-help-content" class="p-10 overflow-y-auto custom-scrollbar text-[13px] text-slate-400 space-y-8 leading-relaxed"></div>
        </div>
    </div>

    <!-- HUD TACTIQUE -->
    <div id="macro-hud">
        <div class="hud-header">
            <div class="hud-dot"></div>
            <div class="hud-title">Expansion S√©quences (Alt)</div>
        </div>
        <div id="ui-macro-list-hud" class="hud-grid"></div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-white/10 px-6 py-3 rounded-xl text-xs font-bold transition-all opacity-0 pointer-events-none z-[200]"></div>

    <script>
        const Core = {
            State: { currentMonday: null, isReadMode: false, macroBuffer: [], macroTimeout: null, recognition: null, isRecording: false, macros: {}, activeConcept: null },
            DB: null,
            Init: async function() {
                this.DB = new Dexie("AgenDataDB_v7");
                this.DB.version(1).stores({ meta: "id", agenda: "date", macros: "trigger" });
                this.State.currentMonday = this.Utils.getMonday(new Date());
                await this.Storage.loadAll();
                this.Agenda.render();
                this.Listeners.setup();
                this.Voice.init();
                this.Utils.toast("NOYAU V7.7 ACTIF");
            },
            Utils: {
                getMonday: d => { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)).setHours(0,0,0,0); },
                formatDate: d => d.toISOString().split('T')[0],
                toast: msg => { const el = document.getElementById('toast'); if(el) { el.textContent = msg; el.style.opacity = "1"; el.style.transform = "translateX(-50%) translateY(-10px)"; setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateX(-50%) translateY(0px)"; }, 2000); } },
                debounce: (fn, ms) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn.apply(this, args), ms); }; },
                stripHTML: (html) => { const tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
            },
            Storage: {
                saveEditor: async () => { if(Core.State.isReadMode) return; const html = document.getElementById('main-editor').innerHTML; await Core.DB.meta.put({id: 'editor', content: html, ts: Date.now()}); },
                loadAll: async () => { 
                    const ed = await Core.DB.meta.get('editor'); 
                    if(ed) document.getElementById('main-editor').innerHTML = ed.content; 
                    const m = await Core.DB.macros.toArray(); 
                    Core.State.macros = {}; m.forEach(x => Core.State.macros[x.trigger] = x.text);
                    if(!m.length) { 
                        const d = {'s,d': 'üå±', 'g,r': 'üåø', 'p,e': 'üå≥', 'c,o': '[[]]'};
                        for(let k in d) { await Core.DB.macros.put({trigger: k, text: d[k]}); Core.State.macros[k] = d[k]; }
                    }
                }
            },
            Search: {
                exec: async (query) => {
                    const res = document.getElementById('search-results'); if (!res) return;
                    res.innerHTML = ''; if (!query || query.length < 2) return;
                    const term = query.toLowerCase();
                    const allData = await Core.DB.agenda.toArray();
                    const draftContent = Core.Utils.stripHTML(document.getElementById('main-editor').innerHTML);
                    
                    if (draftContent.toLowerCase().includes(term)) {
                        res.innerHTML += `<div class="search-category-title">Brouillon</div><div class="search-item" onclick="Core.UI.closeModals()"><div class="search-body">${draftContent.substring(0, 150)}...</div></div>`;
                    }
                    
                    const archiveResults = allData.filter(x => x.content.toLowerCase().includes(term));
                    if (archiveResults.length > 0) {
                        res.innerHTML += `<div class="search-category-title">Archives</div>`;
                        archiveResults.forEach(x => {
                            const item = document.createElement('div'); item.className = 'search-item mb-2';
                            item.innerHTML = `<div class="search-meta"><span class="search-date">${x.date}</span></div><div class="search-body">${Core.Utils.stripHTML(x.content).substring(0, 150)}...</div>`;
                            item.onclick = () => { Core.State.currentMonday = Core.Utils.getMonday(new Date(x.date)); Core.Agenda.render().then(() => Core.UI.closeModals()); };
                            res.appendChild(item);
                        });
                    }
                }
            },
            Agenda: {
                render: async function() {
                    const container = document.getElementById('ui-agenda-list'); if (!container) return;
                    container.innerHTML = '';
                    const start = new Date(Core.State.currentMonday);
                    document.getElementById('ui-week-range').textContent = `${start.getDate()}/${start.getMonth()+1} - ${new Date(start.getTime() + 6*86400000).getDate()}/${start.getMonth()+1}`;
                    for(let i=0; i<7; i++) {
                        const current = new Date(start.getTime() + i*86400000);
                        const key = Core.Utils.formatDate(current);
                        const isToday = key === Core.Utils.formatDate(new Date());
                        const data = await Core.DB.agenda.get(key);
                        const card = document.createElement('div'); card.className = `agenda-card px-5 py-4 ${isToday ? 'today' : ''}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-black text-slate-600 uppercase">${current.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'})}</span>
                                <div class="card-actions flex gap-1">
                                    <button onclick="Core.Agenda.importFromDraft('${key}')" class="action-icon" title="Importer"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" stroke-width="3"/></svg></button>
                                    <button onclick="Core.Agenda.cutToClipboard('${key}')" class="action-icon" title="Couper"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14.121 14.121L19 19m-4.879-4.879l4.879-4.879M12 12l4.879 4.879M12 12L7.121 7.121m4.879 4.879L7.121 16.879M12 12l4.879-4.879" stroke-width="2"/></svg></button>
                                    <button onclick="Core.Agenda.copyToClipboard('${key}')" class="action-icon" title="Copier"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2" stroke-width="2.5"/></svg></button>
                                    <button onclick="Core.Agenda.openTransferMenu(event, '${key}')" class="action-icon" title="D√©placer"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7" stroke-width="3"/></svg></button>
                                    <button onclick="Core.Agenda.clear('${key}')" class="action-icon text-red-500/50" title="Effacer"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="3"/></svg></button>
                                </div>
                            </div>
                            <div contenteditable="true" oninput="Core.Agenda.save('${key}', this.innerHTML)" class="agenda-editable text-slate-400 outline-none custom-scrollbar leading-relaxed"> ${data ? data.content : ''}</div>
                        `;
                        container.appendChild(card);
                    }
                },
                save: async (date, content) => { await Core.DB.agenda.put({date, content, ts: Date.now()}); },
                shiftWeek: (dir) => { Core.State.currentMonday = new Date(Core.State.currentMonday.getTime() + (dir * 7 * 86400000)); Core.Agenda.render(); },
                jumpToToday: () => { Core.State.currentMonday = Core.Utils.getMonday(new Date()); Core.Agenda.render(); },
                importFromDraft: async (key) => {
                    const draft = document.getElementById('main-editor').innerHTML; if(!draft.trim()) return;
                    const entry = await Core.DB.agenda.get(key);
                    const newContent = (entry ? entry.content : '') + '<br>' + draft;
                    await Core.DB.agenda.put({date: key, content: newContent}); Core.Agenda.render(); Core.Utils.toast("TRANSF√âR√â");
                },
                cutToClipboard: async (key) => {
                    const entry = await Core.DB.agenda.get(key); if(!entry) return;
                    const t = document.createElement('textarea'); t.value = Core.Utils.stripHTML(entry.content); document.body.appendChild(t); t.select();
                    document.execCommand('copy'); await Core.DB.agenda.delete(key); document.body.removeChild(t); Core.Agenda.render(); Core.Utils.toast("COUP√â");
                },
                copyToClipboard: async (key) => {
                    const entry = await Core.DB.agenda.get(key); if(!entry) return;
                    const t = document.createElement('textarea'); t.value = Core.Utils.stripHTML(entry.content); document.body.appendChild(t); t.select();
                    document.execCommand('copy'); document.body.removeChild(t); Core.Utils.toast("COPI√â");
                },
                openTransferMenu: (e, sourceKey) => {
                    e.stopPropagation(); const bar = document.getElementById('day-transfer-bar'); const container = document.getElementById('ui-day-transfer-container');
                    container.innerHTML = ''; const rect = e.currentTarget.getBoundingClientRect();
                    ['L','M','M','J','V','S','D'].forEach((d, i) => {
                        const targetDate = new Date(Core.State.currentMonday); targetDate.setDate(targetDate.getDate() + i); const k = Core.Utils.formatDate(targetDate);
                        const btn = document.createElement('button'); btn.className = `px-2 py-1 text-[9px] hover:bg-blue-500 rounded text-slate-500 font-bold ${k === sourceKey ? 'opacity-30' : ''}`;
                        btn.textContent = d; if(k !== sourceKey) btn.onmousedown = (ev) => { ev.preventDefault(); Core.Agenda.moveDayToDay(sourceKey, k); };
                        container.appendChild(btn);
                    });
                    bar.style.top = `${rect.bottom + window.scrollY + 8}px`; bar.style.left = `${rect.left + window.scrollX - 100}px`; bar.style.display = 'flex';
                },
                moveDayToDay: async (sourceKey, targetKey) => {
                    const sourceData = await Core.DB.agenda.get(sourceKey); if(!sourceData) return;
                    const targetData = await Core.DB.agenda.get(targetKey);
                    const newContent = (targetData ? targetData.content : '') + (targetData ? '<br>' : '') + sourceData.content;
                    await Core.DB.agenda.put({date: targetKey, content: newContent}); await Core.DB.agenda.delete(sourceKey);
                    document.getElementById('day-transfer-bar').style.display = 'none'; Core.Agenda.render(); Core.Utils.toast("D√âPLAC√â");
                },
                clear: (key) => { Core.DB.agenda.delete(key); Core.Agenda.render(); }
            },
            Editor: {
                contrast: () => { document.execCommand('backColor', false, '#ffffff'); document.execCommand('foreColor', false, '#000000'); Core.Storage.saveEditor(); },
                highlight: () => { document.execCommand('hiliteColor', false, '#fde047'); document.execCommand('foreColor', false, '#000'); Core.Storage.saveEditor(); },
                addLine: (pos) => {
                    const div = document.createElement('div'); div.innerHTML = '<br>'; const ed = document.getElementById('main-editor');
                    pos === 'start' ? ed.prepend(div) : ed.append(div); div.focus();
                },
                insertLine: () => { document.execCommand('insertHTML', false, '<div><br></div>'); Core.Storage.saveEditor(); },
                clear: () => { document.getElementById('main-editor').innerHTML = ""; Core.Storage.saveEditor(); },
                toggleMode: () => { const el = document.getElementById('main-editor'); el.contentEditable = el.contentEditable === "true" ? "false" : "true"; Core.Utils.toast(el.contentEditable === "true" ? "MODE √âDITION" : "MODE LECTURE"); }
            },
            IO: {
                triggerImport: () => document.getElementById('import-input').click(),
                importData: (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader(); reader.onload = async (ev) => {
                        try { 
                            const data = JSON.parse(ev.target.result); 
                            if(data.agenda) for(let entry of data.agenda) await Core.DB.agenda.put(entry); 
                            if(data.editor) {
                                await Core.DB.meta.put({id: 'editor', content: data.editor, ts: Date.now()});
                            }
                            Core.Utils.toast("RESTAURATION TERMIN√âE");
                            setTimeout(() => location.reload(), 1000);
                        } catch(err) { Core.Utils.toast("ERREUR STRUCTURE JSON"); }
                    }; reader.readAsText(file);
                },
                exportMD: async () => {
                    const agenda = await Core.DB.agenda.toArray(); 
                    const meta = await Core.DB.meta.get('editor');
                    const blob = new Blob([JSON.stringify({ agenda, editor: meta ? meta.content : "" })], {type: 'application/json'});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AgenData_Backup.json`; a.click();
                    Core.Utils.toast("DONN√âES EXPORT√âES");
                }
            },
            AI: {
                challenge: async function() { Core.Utils.toast("ANALYSE EN COURS..."); setTimeout(() => Core.Utils.toast("STRUCTURE OPTIMISABLE"), 1000); }
            },
            Voice: {
                init: function() {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if(SR) {
                        Core.State.recognition = new SR(); Core.State.recognition.lang = 'fr-FR';
                        Core.State.recognition.onstart = () => { Core.State.isRecording = true; document.getElementById('ui-voice-btn').classList.add('text-red-500'); };
                        Core.State.recognition.onresult = (e) => { document.execCommand('insertText', false, e.results[0][0].transcript); Core.Storage.saveEditor(); };
                        Core.State.recognition.onend = () => { Core.State.isRecording = false; document.getElementById('ui-voice-btn').classList.remove('text-red-500'); };
                    }
                },
                toggle: function() { if(!Core.State.recognition) return; Core.State.isRecording ? Core.State.recognition.stop() : Core.State.recognition.start(); }
            },
            Macros: {
                handle: function(key) {
                    clearTimeout(Core.State.macroTimeout); Core.State.macroBuffer.push(key.toLowerCase()); const seq = Core.State.macroBuffer.join(',');
                    if(Core.State.macros[seq]) { document.execCommand('insertHTML', false, Core.State.macros[seq]); Core.State.macroBuffer = []; }
                    Core.State.macroTimeout = setTimeout(() => { Core.State.macroBuffer = []; }, 800);
                },
                renderHUD: function() {
                    const hudList = document.getElementById('ui-macro-list-hud'); if(!hudList) return; hudList.innerHTML = '';
                    Object.entries(Core.State.macros).forEach(([k, v]) => {
                        const row = document.createElement('div'); row.className = "hud-row";
                        row.innerHTML = `<span class="hud-key">${k.toUpperCase().replace(',', ' + ')}</span><span class="hud-val">${v.length <= 2 ? v : 'TEXT'}</span>`;
                        hudList.appendChild(row);
                    });
                },
                renderManager: async function() {
                    const list = document.getElementById('ui-macro-manager-list'); if (!list) return;
                    list.innerHTML = '';
                    const all = await Core.DB.macros.toArray();
                    all.forEach(m => {
                        const div = document.createElement('div'); div.className = "flex justify-between items-center p-3 bg-white/5 rounded-xl text-xs";
                        div.innerHTML = `<span class="text-blue-400 font-mono font-bold">${m.trigger}</span><span class="text-slate-400 truncate max-w-[150px] ml-4">${m.text}</span><button onclick="Core.Macros.delete('${m.trigger}')" class="text-red-500 font-bold ml-auto hover:bg-red-500/10 px-2 py-1 rounded">DEL</button>`;
                        list.appendChild(div);
                    });
                },
                add: async function() {
                    const tr = document.getElementById('ui-new-macro-trigger').value.trim(); 
                    const tx = document.getElementById('ui-new-macro-text').value.trim();
                    if(tr && tx) { 
                        await Core.DB.macros.put({trigger: tr, text: tx}); 
                        await Core.Storage.loadAll(); 
                        this.renderManager(); 
                        document.getElementById('ui-new-macro-trigger').value = '';
                        document.getElementById('ui-new-macro-text').value = '';
                        Core.Utils.toast("MACRO ENREGISTR√âE"); 
                    }
                },
                delete: async function(trigger) { 
                    await Core.DB.macros.delete(trigger); 
                    await Core.Storage.loadAll(); 
                    this.renderManager(); 
                    Core.Utils.toast("MACRO SUPPRIM√âE");
                }
            },
            UI: {
                openSearch: () => { document.getElementById('modal-search').style.display = 'flex'; document.getElementById('search-input').focus(); },
                openMacros: () => { 
                    document.getElementById('modal-macros').style.display = 'flex'; 
                    Core.Macros.renderManager(); 
                },
                openHelp: () => {
                    Core.UI.switchHelp('strat');
                    document.getElementById('modal-help').style.display = 'flex';
                },
                switchHelp: (tab) => {
                    document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
                    const content = document.getElementById('ui-help-content');
                    if(tab === 'strat') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'strat\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">PHILOSOPHIE DU SYST√àME</div>
                            <p>AgenData est con√ßu pour la forge cognitive. L'information n'a de valeur que si elle est transform√©e en synth√®se.</p>
                            <div class="help-step-box">
                                <h3 class="text-white font-bold mb-2">Capture vs Cristallisation</h3>
                                <p>Le Brouillon est un espace de d√©charge brute. L'Agenda est l'espace de cristallisation. Une journ√©e vide dans l'agenda est une journ√©e sans trace intellectuelle.</p>
                            </div>
                        `;
                    } else if(tab === 'comp') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'comp\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">LES OUTILS OP√âRATIONNELS</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="help-step-box"><h4 class="text-blue-400 font-black text-[10px] uppercase mb-2">BROUILLON</h4><p>Capture rapide et brute.</p></div>
                                <div class="help-step-box"><h4 class="text-blue-400 font-black text-[10px] uppercase mb-2">AGENDA</h4><p>Synth√®se temporelle archiv√©e.</p></div>
                            </div>
                        `;
                    } else if(tab === 'syntax') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'syntax\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">COMMANDES CL√âS</div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center border-b border-white/5 pb-2"><span>Alt + V</span><span class="text-xs italic">Mode Lecture/√âdition</span></div>
                                <div class="flex justify-between items-center border-b border-white/5 pb-2"><span>Ctrl + F</span><span class="text-xs italic">Interrogation archives</span></div>
                                <div class="flex justify-between items-center border-b border-white/5 pb-2"><span>Alt + S√©quence</span><span class="text-xs italic">Expansion macros</span></div>
                            </div>
                        `;
                    } else if(tab === 'workflow') {
                        document.querySelector('[onclick="Core.UI.switchHelp(\'workflow\')"]').classList.add('active');
                        content.innerHTML = `
                            <div class="help-section-title">FLUX OP√âRATIONNEL</div>
                            <div class="space-y-4"><p>1. Capturez dans le brouillon.<br>2. Qualifiez avec des macros.<br>3. Transf√©rez vers l'agenda via le menu contextuel ou le bouton d'import.</p></div>
                        `;
                    }
                },
                closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); },
                showToolbar: (rect) => {
                    const bar = document.getElementById('smart-toolbar'); const container = document.getElementById('ui-toolbar-days'); container.innerHTML = '';
                    ['L','M','M','J','V','S','D'].forEach((d, i) => {
                        const target = new Date(Core.State.currentMonday); target.setDate(target.getDate() + i); const k = Core.Utils.formatDate(target);
                        const btn = document.createElement('button'); btn.className = "px-2 py-1 text-[9px] hover:bg-blue-500 rounded text-slate-500 font-bold";
                        btn.textContent = d; btn.onmousedown = (e) => { e.preventDefault(); Core.Agenda.importFromDraft(k); }; container.appendChild(btn);
                    });
                    bar.style.top = `${rect.bottom + window.scrollY + 8}px`; bar.style.left = `${rect.left + window.scrollX}px`; bar.style.display = 'flex';
                }
            },
            Listeners: {
                setup: function() {
                    const editor = document.getElementById('main-editor');
                    editor.addEventListener('input', Core.Utils.debounce(() => Core.Storage.saveEditor(), 1000));
                    document.addEventListener('keydown', e => {
                        if(e.key === 'Alt') { const hud = document.getElementById('macro-hud'); if(hud) hud.classList.add('visible'); Core.Macros.renderHUD(); }
                        if(e.altKey && e.key.length === 1 && e.key !== 'v') Core.Macros.handle(e.key);
                        if(e.altKey && e.key === 'v') Core.Editor.toggleMode();
                        if((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); Core.UI.openSearch(); }
                        if(e.key === 'F1') { e.preventDefault(); Core.UI.openHelp(); }
                    });
                    document.addEventListener('keyup', e => { if(e.key === 'Alt') { const hud = document.getElementById('macro-hud'); if(hud) hud.classList.remove('visible'); } });
                    document.addEventListener('selectionchange', () => {
                        const sel = window.getSelection();
                        if(sel.rangeCount && !sel.isCollapsed && editor.contains(sel.anchorNode)) Core.UI.showToolbar(sel.getRangeAt(0).getBoundingClientRect());
                        else { const bar = document.getElementById('smart-toolbar'); if(bar) bar.style.display = 'none'; }
                    });
                    document.addEventListener('mousedown', (e) => {
                        if(!e.target.closest('.day-transfer-bar') && !e.target.closest('.action-icon')) {
                            const d = document.getElementById('day-transfer-bar'); if(d) d.style.display = 'none';
                        }
                    });
                }
            }
        };
        window.onload = () => Core.Init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & Metadata -->
    <title>Geo Challenge - Le Jeu de G√©ographie Ultime</title>
    <meta name="description" content="Testez vos connaissances en g√©ographie dans Geo Challenge ! Explorez le monde avec Street View et devinez votre position sur la carte. Jouez en solo, d√©fiez vos amis et montez dans le classement.">
    <meta name="keywords" content="jeu, g√©ographie, geoguessr, street view, quiz, carte du monde, voyage, challenge">
    <link rel="canonical" href="https://leonce-equity.com/geo/index.html">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://leonce-equity.com/geo/index.html">
    <meta property="og:title" content="Geo Challenge - Le Jeu de G√©ographie Ultime">
    <meta property="og:description" content="Testez vos connaissances en g√©ographie ! Explorez le monde et devinez o√π vous √™tes.">
    <meta property="og:image" content="https://leonce-equity.com/geo/geo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://leonce-equity.com/geo/index.html">
    <meta property="twitter:title" content="Geo Challenge - Le Jeu de G√©ographie Ultime">
    <meta property="twitter:description" content="Testez vos connaissances en g√©ographie ! Explorez le monde et devinez o√π vous √™tes.">
    <meta property="twitter:image" content="https://leonce-equity.com/geo/geo.png">

    <!-- Scripts and Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #street-view { height: 100vh; width: 100%; }
        #map { height: 12rem; }
        @media (min-width: 768px) { #map { height: 250px; width: 350px; } }
        #result-map, #summary-map { width: 100%; }
        #result-map { height: 16rem; }
        #summary-map { height: 24rem; }
        .leaflet-pane, .leaflet-top, .leaflet-bottom { z-index: 400 !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .slide-in-bottom { animation: slideInBottom 0.5s ease-in-out; }
        @keyframes slideInBottom { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-animation { animation: slideInAndOut 4s ease-in-out forwards; }
        @keyframes slideInAndOut { 0%, 100% { transform: translateY(150%); opacity: 0; } 15%, 85% { transform: translateY(0); opacity: 1; } }
        #compass-arrow { transition: transform 0.2s linear; }
        .score-pop { animation: scorePop 0.5s ease-out; }
        @keyframes scorePop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        @keyframes twinkle {
            0%, 100% { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 1; }
            50% { text-shadow: none; opacity: 0.7; }
        }
        #game-title span {
            animation: twinkle 2s infinite;
        }
        #game-title span:nth-of-type(4n+1) { color: #f87171; }
        #game-title span:nth-of-type(4n+2) { color: #4ade80; }
        #game-title span:nth-of-type(4n+3) { color: #60a5fa; }
        #game-title span:nth-of-type(4n+4) { color: #facc15; }
    </style>
</head>
<body class="bg-gray-800 text-white overflow-hidden">

    <!-- Language Selection Screen -->
    <div id="language-screen" class="w-full h-screen flex items-center justify-center p-4">
        <div class="text-center w-full max-w-md">
            <h2 id="game-title" class="text-5xl font-black text-white mb-2 tracking-wider">
                <span>G</span><span>E</span><span>O</span> <span>C</span><span>H</span><span>A</span><span>L</span><span>L</span><span>E</span><span>N</span><span>G</span><span>E</span>
            </h2>
            <p class="text-sm text-gray-500 mb-8">version 0.96 (c) EXJV</p>
            <h1 class="text-2xl md:text-3xl font-bold mb-2">Welcome / Bienvenue</h1>
            <p class="text-gray-400 mb-8">Please select your language / Veuillez s√©lectionner votre langue</p>
            <div class="grid grid-cols-2 gap-4">
                <button data-lang="fr" class="lang-btn bg-blue-600 hover:bg-blue-700 w-full font-bold py-4 rounded-lg transition">Fran√ßais üá´üá∑</button>
                <button data-lang="en" class="lang-btn bg-red-600 hover:bg-red-700 w-full font-bold py-4 rounded-lg transition">English üá¨üáß</button>
                <button data-lang="es" class="lang-btn bg-yellow-600 hover:bg-yellow-700 w-full font-bold py-4 rounded-lg transition">Espa√±ol üá™üá∏</button>
                <button data-lang="de" class="lang-btn bg-gray-600 hover:bg-gray-700 w-full font-bold py-4 rounded-lg transition">Deutsch üá©üá™</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="hidden absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-lg fade-in">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="apiKeyTitle"></h2>
            <p class="text-gray-400 mb-6" data-lang-key="apiKeyDesc"></p>
            <input type="text" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 mb-4" data-lang-key="apiKeyPlaceholder" placeholder="">
            <button id="save-api-key-btn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition" data-lang-key="apiKeyButton"></button>
            <p id="api-key-error" class="text-red-400 text-sm mt-4 hidden" data-lang-key="apiKeyError"></p>
        </div>
    </div>
    
    <!-- Game Setup Screen -->
    <div id="game-setup-screen" class="w-full h-screen flex items-center justify-center fade-in hidden p-4">
        <div class="bg-gray-900 p-8 rounded-lg shadow-2xl text-center w-full max-w-md">
            <h1 class="text-3xl md:text-4xl font-bold mb-4" data-lang-key="mainTitle"></h1>
            <p class="text-gray-400 mb-8" data-lang-key="mainSubtitle"></p>
            <div class="space-y-4">
                <button data-mode="classic" class="game-mode-btn bg-blue-600 hover:bg-blue-700 w-full font-bold py-3 px-4 rounded-lg transition"><span data-lang-key="modeClassic"></span><span class="text-sm font-normal block text-blue-200" data-lang-key="modeClassicSub"></span></button>
                <button data-mode="endless" class="game-mode-btn bg-purple-600 hover:bg-purple-700 w-full font-bold py-3 px-4 rounded-lg transition"><span data-lang-key="modeEndless"></span><span class="text-sm font-normal block text-purple-200" data-lang-key="modeEndlessSub"></span></button>
                <button data-mode="monuments" class="game-mode-btn bg-teal-600 hover:bg-teal-700 w-full font-bold py-3 px-4 rounded-lg transition"><span data-lang-key="modeMonuments"></span><span class="text-sm font-normal block text-teal-200" data-lang-key="modeMonumentsSub"></span></button>
                <button data-mode="museums" class="game-mode-btn bg-orange-600 hover:bg-orange-700 w-full font-bold py-3 px-4 rounded-lg transition"><span data-lang-key="modeMuseums"></span><span class="text-sm font-normal block text-orange-200" data-lang-key="modeMuseumsSub"></span></button>
            </div>
            <div class="mt-8 flex items-center justify-center">
                <input type="checkbox" id="timed-mode-checkbox" class="h-4 w-4 rounded text-blue-600 bg-gray-700 border-gray-600">
                <label for="timed-mode-checkbox" class="ml-2 block text-sm text-gray-300" data-lang-key="timedMode"></label>
            </div>
            <div class="mt-6 flex justify-center items-center space-x-6">
                <button id="achievements-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-trophy mr-2"></i><span data-lang-key="achievementsButton"></span></button>
                <button id="hall-of-fame-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-crown mr-2"></i><span data-lang-key="hallOfFameButton"></span></button>
            </div>
        </div>
    </div>
    
    <!-- User Profile -->
    <div id="user-profile" class="hidden absolute top-5 right-5 z-20 pointer-events-auto">
        <div class="flex items-center bg-gray-900 bg-opacity-80 p-2 rounded-lg shadow-lg">
            <img id="user-avatar" src="" class="w-8 h-8 rounded-full mr-3">
            <span id="user-name" class="font-bold text-sm"></span>
            <button id="logout-btn" class="ml-4 text-gray-400 hover:text-white transition" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="game-container" class="hidden relative">
        <div id="street-view"></div>
        <div id="ui-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 p-2 md:p-5">
            <!-- Score Panel - Top Left -->
            <div class="absolute top-0 left-0 w-auto p-2 md:p-0 pointer-events-auto">
                <div class="bg-gray-900 bg-opacity-80 p-3 rounded-lg shadow-lg">
                    <h2 class="text-base md:text-lg font-bold"><span data-lang-key="score"></span>: <span id="total-score">0</span></h2>
                    <p class="text-xs md:text-sm text-gray-300"><span data-lang-key="round"></span>: <span id="round-info">1 / 5</span></p>
                    <div id="timer-display" class="hidden text-center mt-2"><p class="text-xl md:text-2xl font-bold text-yellow-400"><span id="time-left">90</span>s</p></div>
                </div>
            </div>
            <!-- Hints Panel - Top Right -->
            <div class="absolute top-0 right-0 w-auto p-2 md:p-0 pointer-events-auto">
                <div class="bg-gray-900 bg-opacity-80 p-3 rounded-lg shadow-lg text-center">
                     <h3 class="font-bold text-sm mb-2" data-lang-key="hints"></h3>
                     <div class="flex gap-2 md:flex-col md:space-y-2">
                         <button id="hint-compass" class="hint-btn flex-1 bg-gray-700 hover:bg-gray-600 p-2 rounded-lg text-xs" data-cost="250"><i class="fas fa-compass block mx-auto mb-1"></i><span data-lang-key="hintCompass"></span><span class="hidden md:block text-gray-400">(-250 pts)</span></button>
                         <button id="hint-country" class="hint-btn flex-1 bg-gray-700 hover:bg-gray-600 p-2 rounded-lg text-xs" data-cost="750"><i class="fas fa-flag block mx-auto mb-1"></i><span data-lang-key="hintCountry"></span><span class="hidden md:block text-gray-400">(-750 pts)</span></button>
                     </div>
                     <div id="compass-container" class="hidden mx-auto mt-2 w-12 h-12 md:w-16 md:h-16 bg-gray-800 rounded-full flex items-center justify-center border-2 border-gray-500"><div id="compass-arrow" class="text-2xl text-red-500">‚Üë</div></div>
                     <p id="geocoded-info" class="text-sm text-yellow-300 font-bold mt-2"></p>
                </div>
            </div>
            <!-- Map & Guess Button - Bottom Left -->
            <div class="fixed bottom-0 left-0 w-full md:w-auto md:bottom-5 md:left-5 pointer-events-auto bg-gray-900/80 md:bg-transparent p-4 md:p-0 rounded-t-lg md:rounded-none flex flex-col items-center">
                <div id="map-wrapper" class="hidden h-48 md:h-[250px] w-full">
                    <div id="map" class="w-full h-full border-2 md:border-3 border-white rounded-lg"></div>
                </div>
                <button id="guess-btn" class="w-full mt-2 bg-blue-600 font-bold py-3 px-4 rounded-lg transition"></button>
                <button id="end-game-btn" class="hidden w-full mt-2 bg-red-600 font-bold py-3 px-4 rounded-lg transition" data-lang-key="endGameButton"></button>
            </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modals-container" class="absolute inset-0 z-20 pointer-events-none"></div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500 mx-auto"></div>
            <p class="text-white text-xl mt-4" data-lang-key="loading"></p>
        </div>
    </div>
    
    <!-- Achievement / Share Toast -->
    <div id="toast" class="hidden absolute bottom-[-100px] right-10 bg-green-600 text-white p-4 rounded-lg shadow-xl">
        <p><i id="toast-icon" class="fas fa-trophy"></i> <span id="toast-message"></span></p>
        <p id="toast-title" class="font-bold"></p>
    </div>
    <script>
        const themedLocations = {
            monuments: [
                { lat: 48.8584, lng: 2.2945, heading: 200 }, { lat: 40.6892, lng: -74.0445, heading: 270 }, { lat: -22.9519, lng: -43.2105, heading: 0 }, { lat: 41.8902, lng: 12.4922, heading: 100 }, { lat: 29.9792, lng: 31.1342, heading: 90 }, { lat: -33.8568, lng: 151.2153, heading: 180 }, { lat: 27.1751, lng: 78.0421, heading: 0 }, { lat: -13.1631, lng: -72.5450, heading: 45 }, { lat: 30.3285, lng: 35.4444, heading: 300 }, { lat: 40.4319, lng: 116.5704, heading: 0 }, { lat: 37.9715, lng: 23.7257, heading: 135 }, { lat: 13.4125, lng: 103.8667, heading: 180 }, { lat: 55.7522, lng: 37.6231, heading: 270 }, { lat: 20.6843, lng: -88.5678, heading: 90 }, { lat: 47.5576, lng: 10.7498, heading: 180 }, { lat: 41.0082, lng: 28.9784, heading: 200 }, { lat: 25.1972, lng: 55.2744, heading: 150 }, { lat: 43.8791, lng: -103.4591, heading: 90 }, { lat: 51.1789, lng: -1.8262, heading: 0 }, { lat: -27.1127, lng: -109.3497, heading: 225 }, { lat: 34.9922, lng: 135.7720, heading: 0 }, { lat: 36.1069, lng: -112.1129, heading: 180 }, { lat: -17.9243, lng: 25.8572, heading: 90 }, { lat: 20.855, lng: 107.078, heading: 0 }, { lat: 41.4036, lng: 2.1744, heading: 120 }, { lat: 52.5163, lng: 13.3777, heading: 270 }, { lat: 37.8199, lng: -122.4783, heading: 180 }, { lat: 43.7230, lng: 10.3966, heading: 90 }, { lat: 41.9022, lng: 12.4539, heading: 270 }, { lat: 35.3606, lng: 138.7278, heading: 0 }, { lat: 48.8606, lng: 2.3376, heading: 90 }, { lat: 43.0896, lng: -79.0849, heading: 0 }, { lat: 36.4167, lng: 25.4333, heading: 180 }, { lat: 51.5007, lng: -0.1246, heading: 200 }, { lat: 39.9163, lng: 116.3972, heading: 180 }, { lat: -0.9935, lng: -91.1702, heading: 0 }
            ],
            museums: [
                { lat: 48.8606, lng: 2.3376, heading: 0 }, { lat: 48.8606, lng: 2.3377, heading: 0 }, { lat: 48.8605, lng: 2.3361, heading: 0 },{ lat: 48.8605, lng: 2.3359, heading: 0 }, { lat: 51.5194, lng: -0.1270, heading: 0 }, { lat: 51.5193, lng: -0.1271, heading: 0 }, { lat: 51.5186, lng: -0.1265, heading: 0 }, { lat: 40.7794, lng: -73.9632, heading: 0 }, { lat: 40.7816, lng: -73.9635, heading: 0 }, { lat: 40.7820, lng: -73.9626, heading: 0 }, { lat: 52.3600, lng: 4.8852, heading: 0 }, { lat: 52.3598, lng: 4.8851, heading: 0 }, { lat: 48.8600, lng: 2.3266, heading: 0 }, { lat: 48.8596, lng: 2.3276, heading: 0 },
            ]
        };
        const achievementsConfig = {
            firstGame: { icon: "fa-shoe-prints" },
            globetrotter: { icon: "fa-globe-americas" },
            precision: { icon: "fa-crosshairs" },
            highScore: { icon: "fa-crown" },
            worldTour: { icon: "fa-plane" },
            monumentalist: { icon: "fa-landmark" },
            artConnoisseur: { icon: "fa-palette" }
        };

        const translations = {
            fr: {
                apiKeyTitle: "Cl√© API Google Maps requise", apiKeyDesc: "Veuillez entrer votre cl√© API pour jouer. Elle sera sauvegard√©e localement.", apiKeyPlaceholder: "Collez votre cl√© API ici...", apiKeyButton: "Sauvegarder et Jouer", apiKeyError: "Cl√© API invalide.", mainTitle: "Geo Challenge", mainSubtitle: "Choisissez votre mode de jeu.", modeClassic: "Mode Classique", modeClassicSub: "(5 manches)", modeEndless: "Mode Infini", modeEndlessSub: "(Battez votre record)", modeMonuments: "D√©fi: Monuments du Monde", modeMonumentsSub: "(5 manches)", modeMuseums: "D√©fi: Mus√©es du Monde", modeMuseumsSub: "(5 manches)", timedMode: "Partie chronom√©tr√©e (90s / manche)", achievementsButton: "Succ√®s", hallOfFameButton: "Classement", score: "Score", round: "Manche", hints: "Indices", hintCompass: "Boussole", hintCountry: "Pays", endGameButton: "Terminer la partie", loading: "Chargement...", achievementUnlocked: "Succ√®s d√©bloqu√© !", achievements: { firstGame: { title: "Premiers Pas", desc: "Terminer votre premi√®re partie." }, globetrotter: { title: "Globe-trotter", desc: "Jouer 25 parties." }, precision: { title: "Pr√©cision Chirurgicale", desc: "Faire une estimation √† moins de 10m." }, highScore: { title: "Ma√Ætre du Monde", desc: "Marquer plus de 24,000 points." }, worldTour: { title: "Tour du Monde", desc: "Jouer sur les 5 continents habit√©s." }, monumentalist: { title: "Le Monumentaliste", desc: "Terminer le d√©fi des monuments." }, artConnoisseur: { title: "L'Expert en Art", desc: "Terminer le d√©fi des mus√©es." } }, distance: "Distance", youScored: "Vous avez marqu√©", points: "points!", baseScore: "Score de base", timeBonus: "Bonus temps", perfectBonus: "Parfait !", hintPenalty: "Malus indices", nextRound: "Manche Suivante", finalScoreBtn: "Voir le Score Final", gameFinished: "Partie termin√©e !", yourFinalScore: "Votre score final est de", replay: "Rejouer", summary: "Voir le Bilan", summaryTitle: "Bilan de la Partie", back: "Retour", achievementsTitle: "Succ√®s", close: "Fermer", locationWas: "Le lieu √©tait", placeGuessButton: "Placer une estimation", confirmGuessButton: "Valider la position", shareButton: "Partager", shareMessage: "J'ai obtenu [SCORE] points sur Geo Challenge! Pouvez-vous faire mieux ?", linkCopied: "Lien copi√© !", hallOfFameTitle: "Temple de la Renomm√©e", submitToHallOfFame: "Inscrire mon score", submitScoreTitle: "Inscrire votre score", nickname: "Pseudo", countryLabel: "Pays", submitButton: "Valider", rank: "Rang", player: "Joueur", date: "Date", nicknameRequired: "Un pseudo est requis.", scoreSubmitted: "Score enregistr√© !", submitError: "Erreur d'envoi", detectingCountry: "D√©tection du pays...", countryDetected: "Pays d√©tect√© : ", loginToSave: "Pour sauvegarder votre score, veuillez vous identifier.", loginGoogle: "Se connecter avec Google", or: "ou", continueAsAnon: "Continuer en anonyme"
            },
            en: {
                apiKeyTitle: "Google Maps API Key Required", apiKeyDesc: "Please enter your API key to play. It will be saved locally.", apiKeyPlaceholder: "Paste your API key here...", apiKeyButton: "Save and Play", apiKeyError: "Invalid API key.", mainTitle: "Geo Challenge", mainSubtitle: "Choose your game mode.", modeClassic: "Classic Mode", modeClassicSub: "(5 rounds)", modeEndless: "Endless Mode", modeEndlessSub: "(Beat your high score)", modeMonuments: "Challenge: World Monuments", modeMonumentsSub: "(5 rounds)", modeMuseums: "Challenge: World Museums", modeMuseumsSub: "(5 rounds)", timedMode: "Timed game (90s / round)", achievementsButton: "Achievements", hallOfFameButton: "Hall of Fame", score: "Score", round: "Round", hints: "Hints", hintCompass: "Compass", hintCountry: "Country", endGameButton: "End Game", loading: "Loading...", achievementUnlocked: "Achievement Unlocked!", achievements: { firstGame: { title: "First Steps", desc: "Finish your first game." }, globetrotter: { title: "Globetrotter", desc: "Play 25 games." }, precision: { title: "Surgical Precision", desc: "Make a guess within 10m." }, highScore: { title: "Master of the World", desc: "Score over 24,000 points." }, worldTour: { title: "World Tour", desc: "Play on all 5 inhabited continents." }, monumentalist: { title: "The Monumentalist", desc: "Complete the Monuments challenge." }, artConnoisseur: { title: "The Art Connoisseur", desc: "Complete the Museums challenge." } }, distance: "Distance", youScored: "You scored", points: "points!", baseScore: "Base score", timeBonus: "Time bonus", perfectBonus: "Perfect!", hintPenalty: "Hint penalty", nextRound: "Next Round", finalScoreBtn: "View Final Score", gameFinished: "Game Over!", yourFinalScore: "Your final score is", replay: "Play Again", summary: "View Summary", summaryTitle: "Game Summary", back: "Back", achievementsTitle: "Achievements", close: "Close", locationWas: "The location was", placeGuessButton: "Place Guess", confirmGuessButton: "Confirm Guess", shareButton: "Share", shareMessage: "I scored [SCORE] on Geo Challenge! Can you beat me?", linkCopied: "Link copied!", hallOfFameTitle: "Hall of Fame", submitToHallOfFame: "Submit Score", submitScoreTitle: "Submit Your Score", nickname: "Nickname", countryLabel: "Country", submitButton: "Submit", rank: "Rank", player: "Player", date: "Date", nicknameRequired: "A nickname is required.", scoreSubmitted: "Score submitted!", submitError: "Submission Error", detectingCountry: "Detecting country...", countryDetected: "Country detected: ", loginToSave: "Please sign in to save your score.", loginGoogle: "Sign in with Google", or: "or", continueAsAnon: "Continue as Anonymous"
            },
            es: {
                apiKeyTitle: "Se requiere clave de API de Google Maps", apiKeyDesc: "Por favor, introduce tu clave de API para jugar. Se guardar√° localmente.", apiKeyPlaceholder: "Pega tu clave de API aqu√≠...", apiKeyButton: "Guardar y Jugar", apiKeyError: "Clave de API no v√°lida.", mainTitle: "Geo Challenge", mainSubtitle: "Elige tu modo de jeu.", modeClassic: "Modo Cl√°sico", modeClassicSub: "(5 rondas)", modeEndless: "Modo Infinito", modeEndlessSub: "(Bate tu r√©cord)", modeMonuments: "Reto: Monumentos del Mundo", modeMonumentsSub: "(5 rondas)", modeMuseums: "Reto: Museos del Mundo", modeMuseumsSub: "(5 rondas)", timedMode: "Partida cronometrada (90s / ronda)", achievementsButton: "Logros", hallOfFameButton: "Sal√≥n de la Fama", score: "Puntuaci√≥n", round: "Ronda", hints: "Pistas", hintCompass: "Br√∫jula", hintCountry: "Pa√≠s", endGameButton: "Terminar Partida", loading: "Cargando...", achievementUnlocked: "¬°Logro desbloqueado!", achievements: { firstGame: { title: "Primeros Pasos", desc: "Completa tu primera partida." }, globetrotter: { title: "Trotamundos", desc: "Juega 25 partidas." }, precision: { title: "Precisi√≥n Quir√∫rgica", desc: "Haz una estimaci√≥n a menos de 10m." }, highScore: { title: "Maestro del Mundo", desc: "Consigue m√°s de 24.000 puntos." }, worldTour: { title: "Vuelta al Mundo", desc: "Juega en los 5 continentes habitados." }, monumentalist: { title: "El Monumentalista", desc: "Completa el reto de Monumentos." }, artConnoisseur: { title: "El Experto en Arte", desc: "Completa el reto de Museos." } }, distance: "Distancia", youScored: "Conseguiste", points: "puntos!", baseScore: "Puntuaci√≥n base", timeBonus: "Bonus de tiempo", perfectBonus: "¬°Perfecto!", hintPenalty: "Penalizaci√≥n de pistas", nextRound: "Siguiente Ronda", finalScoreBtn: "Ver Puntuaci√≥n Final", gameFinished: "¬°Partida Terminada!", yourFinalScore: "Tu puntuaci√≥n final es", replay: "Jugar de Nuevo", summary: "Ver Resumen", summaryTitle: "Resumen de la Partida", back: "Volver", achievementsTitle: "Logros", close: "Cerrar", locationWas: "La ubicaci√≥n era", placeGuessButton: "Hacer suposici√≥n", confirmGuessButton: "Confirmar suposici√≥n", shareButton: "Compartir", shareMessage: "I scored [SCORE] on Geo Challenge! Can you beat me?", linkCopied: "¬°Enlace copiado!", hallOfFameTitle: "Sal√≥n de la Fama", submitToHallOfFame: "Enviar Puntuaci√≥n", submitScoreTitle: "Enviar Tu Puntuaci√≥n", nickname: "Apodo", countryLabel: "Pa√≠s", submitButton: "Enviar", rank: "Rango", player: "Jugador", date: "Fecha", nicknameRequired: "Se requiere un apodo.", scoreSubmitted: "¬°Puntuaci√≥n enviada!", submitError: "Error al enviar", detectingCountry: "Detectando pa√≠s...", countryDetected: "Pa√≠s detectado: ", loginToSave: "Inicia sesi√≥n para guardar tu puntuaci√≥n.", loginGoogle: "Iniciar sesi√≥n con Google", or: "o", continueAsAnon: "Continuar como An√≥nimo"
            },
            de: {
                apiKeyTitle: "Google Maps API-Schl√ºssel erforderlich", apiKeyDesc: "Bitte geben Sie Ihren API-Schl√ºssel ein, um zu spielen. Er wird lokal gespeichert.", apiKeyPlaceholder: "F√ºgen Sie Ihren API-Schl√ºssel hier ein...", apiKeyButton: "Speichern und Spielen", apiKeyError: "Ung√ºltiger API-Schl√ºssel.", mainTitle: "Geo Challenge", mainSubtitle: "W√§hle deinen Spielmodus.", modeClassic: "Klassischer Modus", modeClassicSub: "(5 Runden)", modeEndless: "Endlos-Modus", modeEndlessSub: "(Schlage deinen Highscore)", modeMonuments: "Herausforderung: Weltmonumente", modeMonumentsSub: "(5 rondas)", modeMuseums: "Herausforderung: Weltmuseen", modeMuseumsSub: "(5 Runden)", timedMode: "Zeitspiel (90s / Runde)", achievementsButton: "Erfolge", hallOfFameButton: "Ruhmeshalle", score: "Punktzahl", round: "Runde", hints: "Hinweise", hintCompass: "Kompass", hintCountry: "Land", endGameButton: "Spiel beenden", loading: "Laden...", achievementUnlocked: "Erfolg freigeschaltet!", achievements: { firstGame: { title: "Erste Schritte", desc: "Beende dein erstes Spiel." }, globetrotter: { title: "Weltenbummler", desc: "Spiele 25 Spiele." }, precision: { title: "Chirurgische Pr√§zision", desc: "Rate auf unter 10m genau." }, highScore: { title: "Meister der Welt", desc: "Erziele √ºber 24.000 Punkte." }, worldTour: { title: "Weltreise", desc: "Spiele auf allen 5 bewohnten Kontinenten." }, monumentalist: { title: "Der Monumentalist", desc: "Schlie√üe die Monumente-Herausforderung ab." }, artConnoisseur: { title: "Der Kunstkenner", desc: "Schlie√üe die Museen-Herausforderung ab." } }, distance: "Entfernung", youScored: "Du hast", points: "Punkte erzielt!", baseScore: "Basispunktzahl", timeBonus: "Zeitbonus", perfectBonus: "Perfekt!", hintPenalty: "Hinweis-Malus", nextRound: "N√§chste Runde", finalScoreBtn: "Endergebnis ansehen", gameFinished: "Spiel vorbei!", yourFinalScore: "Dein Endergebnis ist", replay: "Nochmal spielen", summary: "Zusammenfassung", summaryTitle: "Spielzusammenfassung", back: "Zur√ºck", achievementsTitle: "Erfolge", close: "Schlie√üen", locationWas: "Der Ort war", placeGuessButton: "Sch√§tzung abgeben", confirmGuessButton: "Best√§tigen", shareButton: "Teilen", shareMessage: "I scored [SCORE] on Geo Challenge! Can you beat me?", linkCopied: "Link kopiert!", hallOfFameTitle: "Ruhmeshalle", submitToHallOfFame: "Punktzahl einreichen", submitScoreTitle: "Deine Punktzahl einreichen", nickname: "Spitzname", countryLabel: "Land", submitButton: "Einreichen", rank: "Rang", player: "Spieler", date: "Datum", nicknameRequired: "Ein Spitzname ist erforderlich.", scoreSubmitted: "Punktzahl eingereicht!", submitError: "Fehler beim Senden", detectingCountry: "Land wird erkannt...", countryDetected: "Land erkannt: ", loginToSave: "Bitte melde dich an, um deine Punktzahl zu speichern.", loginGoogle: "Mit Google anmelden", or: "oder", continueAsAnon: "Anonym fortfahren"
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
              apiKey: "AIzaSyAUsQJlJ5VoUjXnl5mx1VLkx78mfRFyjLA",
              authDomain: "geo-challenge-87cae.firebaseapp.com",
              projectId: "geo-challenge-87cae",
              storageBucket: "geo-challenge-87cae.firebasestorage.app",
              messagingSenderId: "499842730324",
              appId: "1:499842730324:web:7161036d30818e1a4460c1"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const googleProvider = new firebase.auth.GoogleAuthProvider();

            const els = {
                languageScreen: document.getElementById('language-screen'),
                apiKeyModal: document.getElementById('api-key-modal'),
                apiKeyInput: document.getElementById('api-key-input'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                apiKeyError: document.getElementById('api-key-error'),
                gameSetupScreen: document.getElementById('game-setup-screen'),
                userProfile: document.getElementById('user-profile'),
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                logoutBtn: document.getElementById('logout-btn'),
                gameContainer: document.getElementById('game-container'),
                totalScore: document.getElementById('total-score'),
                roundInfo: document.getElementById('round-info'),
                timerDisplay: document.getElementById('timer-display'),
                timeLeft: document.getElementById('time-left'),
                hintCompass: document.getElementById('hint-compass'),
                hintCountry: document.getElementById('hint-country'),
                compassContainer: document.getElementById('compass-container'),
                compassArrow: document.getElementById('compass-arrow'),
                geocodedInfo: document.getElementById('geocoded-info'),
                guessBtn: document.getElementById('guess-btn'),
                endGameBtn: document.getElementById('end-game-btn'),
                modalsContainer: document.getElementById('modals-container'),
                loadingOverlay: document.getElementById('loading-overlay'),
                toast: document.getElementById('toast'),
                toastIcon: document.getElementById('toast-icon'),
                toastMessage: document.getElementById('toast-message'),
                toastTitle: document.getElementById('toast-title'),
                achievementsBtn: document.getElementById('achievements-btn'),
                hallOfFameBtn: document.getElementById('hall-of-fame-btn'),
                mapWrapper: document.getElementById('map-wrapper'),
            };

            let sv, map, guessMarker, currentUser;
            let currentLoc = {};
            let gameState = {};
            let timers = { round: null, toast: null };
            let currentLang = 'fr';
            let achievements = {};
            let gameStats = {};
            
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateUserProfileUI(user);
            });
            
            const updateUserProfileUI = (user) => {
                if (user && !user.isAnonymous) {
                    els.userAvatar.src = user.photoURL;
                    els.userName.textContent = user.displayName;
                    els.userProfile.classList.remove('hidden');
                } else {
                    els.userProfile.classList.add('hidden');
                }
            };

            const animateValue = (obj, start, end, duration) => {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            };

            const setLanguage = (lang) => {
                currentLang = lang;
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    const translation = translations[lang] ? translations[lang][key] : null;
                    if (translation) {
                        if (el.tagName === 'INPUT' && el.type === 'text') el.placeholder = translation;
                        else el.innerHTML = translation;
                    }
                });
                if (translations[currentLang] && translations[currentLang].achievements) {
                    Object.keys(achievementsConfig).forEach(key => {
                        achievements[key] = {
                            ...achievementsConfig[key],
                            ...translations[currentLang].achievements[key],
                            unlocked: achievements[key]?.unlocked || false
                        };
                    });
                }
            };

            const loadData = () => {
                try {
                    const stats = JSON.parse(localStorage.getItem('geoGameStats'));
                    gameStats = { gamesPlayed: 0, continentsVisited: new Set(), ...stats, continentsVisited: new Set(stats?.continentsVisited) };
                    const savedAchievements = JSON.parse(localStorage.getItem('geoGameAchievements')) || {};
                    Object.keys(achievementsConfig).forEach(key => {
                         achievements[key] = { ...achievementsConfig[key], unlocked: savedAchievements[key] || false };
                    });
                } catch (e) { console.error("Error loading data", e); }
            };

            const saveData = () => {
                try {
                    const stats = { ...gameStats, continentsVisited: Array.from(gameStats.continentsVisited) };
                    localStorage.setItem('geoGameStats', JSON.stringify(stats));
                    const unlockedAchievements = {};
                    Object.keys(achievements).forEach(key => { if (achievements[key].unlocked) unlockedAchievements[key] = true; });
                    localStorage.setItem('geoGameAchievements', JSON.stringify(unlockedAchievements));
                } catch (e) { console. error("Error saving data", e); }
            };

            const showToast = (key, isShare = false, customMessage = '') => {
                clearTimeout(timers.toast);
                if (isShare) {
                    els.toastIcon.className = 'fas fa-share-alt';
                    els.toastMessage.textContent = '';
                    els.toastTitle.textContent = customMessage || translations[currentLang].linkCopied;
                } else {
                    els.toastIcon.className = 'fas fa-trophy';
                    els.toastMessage.textContent = translations[currentLang].achievementUnlocked;
                    els.toastTitle.textContent = achievements[key].title;
                }
                els.toast.classList.remove('hidden', 'toast-animation');
                void els.toast.offsetWidth;
                els.toast.classList.add('toast-animation');
                timers.toast = setTimeout(() => els.toast.classList.add('hidden'), 3900);
            };

            const checkAchievements = (checkType, data = {}) => {
                let newAchievementUnlocked = false;
                const unlock = (key) => {
                    if (achievements[key] && !achievements[key].unlocked) {
                        achievements[key].unlocked = true;
                        newAchievementUnlocked = true;
                        showToast(key);
                    }
                };
                if (checkType === 'gameEnd') {
                    unlock('firstGame');
                    if (gameStats.gamesPlayed >= 25) unlock('globetrotter');
                    if (gameState.totalScore > 24000) unlock('highScore');
                    if (gameStats.continentsVisited.size >= 5) unlock('worldTour');
                    if (gameState.settings.mode === 'monuments') unlock('monumentalist');
                    if (gameState.settings.mode === 'museums') unlock('artConnoisseur');
                }
                if (checkType === 'roundEnd' && data.distance < 0.01) unlock('precision');
                if (newAchievementUnlocked) saveData();
            };
            const showModal = (content) => {
                els.modalsContainer.classList.remove('pointer-events-none');
                els.modalsContainer.classList.add('pointer-events-auto');
                const modal = document.createElement('div');
                modal.className = 'absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-30 p-4';
                modal.innerHTML = `<div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-2xl fade-in text-center w-full max-w-3xl">${content}</div>`;
                els.modalsContainer.appendChild(modal);
            };
            const closeModal = () => {
                els.modalsContainer.innerHTML = '';
                els.modalsContainer.classList.remove('pointer-events-auto');
                els.modalsContainer.classList.add('pointer-events-none');
            };
            const showSummaryModal = () => {
                const T = translations[currentLang];
                const modalContent = `
                    <h2 class="text-3xl font-bold mb-4">${T.summaryTitle}</h2>
                    <div id="summary-map" class="w-full h-96 rounded-lg border-2 border-gray-600"></div>
                    <button id="close-summary-btn" class="mt-6 bg-blue-600 font-bold py-3 px-6 rounded-lg transition">${T.back}</button>`;
                showModal(modalContent);
                document.getElementById('close-summary-btn').addEventListener('click', () => { closeModal(); showFinalScoreModal(); });
                
                const sumMap = L.map('summary-map').setView([20, 0], 1);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(sumMap);
                const colors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231'];
                const bounds = [];
                gameState.history.forEach((round, i) => {
                    if(round.guess) {
                        const actualLatLng = L.latLng(round.actual.lat, round.actual.lng);
                        const guessLatLng = L.latLng(round.guess.lat, round.guess.lng);
                        bounds.push(actualLatLng, guessLatLng);
                        L.marker(actualLatLng).addTo(sumMap); L.marker(guessLatLng).addTo(sumMap);
                        L.polyline([actualLatLng, guessLatLng], { color: colors[i % 5] }).addTo(sumMap);
                    }
                });
                if(bounds.length > 0) setTimeout(() => sumMap.fitBounds(bounds, {padding: [50, 50]}), 100);
            };
            const showFinalScoreModal = () => {
                const T = translations[currentLang];
                const shareButtonHTML = `<button id="share-btn" class="bg-green-600 font-bold py-3 px-6 rounded-lg transition">${T.shareButton}</button>`;
                const summaryButton = gameState.settings.mode !== 'endless' ? `<button id="summary-btn" class="bg-teal-600 font-bold py-3 px-6 rounded-lg transition">${T.summary}</button>` : '';
                const submitButtonHTML = `<button id="submit-score-btn" class="bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-6 rounded-lg transition">${T.submitToHallOfFame}</button>`;
                
                const modalContent = `
                    <h2 class="text-2xl md:text-3xl font-bold mb-2">${T.gameFinished}</h2>
                    <p class="text-lg md:text-xl text-gray-300 mb-4">${T.yourFinalScore}</p>
                    <p class="text-5xl md:text-6xl font-bold text-yellow-400 mb-8">${gameState.totalScore.toLocaleString()}</p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="play-again-btn" class="bg-blue-600 font-bold py-3 px-6 rounded-lg transition">${T.replay}</button>
                        ${summaryButton}
                        ${shareButtonHTML}
                        ${submitButtonHTML}
                    </div>`;
                showModal(modalContent);
                document.getElementById('play-again-btn').addEventListener('click', () => {
                    closeModal();
                    els.gameContainer.classList.add('hidden');
                    els.gameSetupScreen.classList.remove('hidden');
                    clearTimeout(timers.toast);
                    els.toast.classList.remove('toast-animation');
                    els.toast.classList.add('hidden');
                });
                if(summaryButton) document.getElementById('summary-btn').addEventListener('click', () => { closeModal(); showSummaryModal(); });
                document.getElementById('share-btn').addEventListener('click', shareScore);
                document.getElementById('submit-score-btn').addEventListener('click', () => {
                    closeModal();
                    showSubmitScoreModal(gameState.totalScore);
                });
            };
            
            const showSubmitScoreModal = (score) => {
                const T = translations[currentLang];

                const getSubmitContent = (user) => {
                    const isGoogleUser = user && !user.isAnonymous;
                    return `
                        <h2 class="text-2xl font-bold mb-4">${T.submitScoreTitle}</h2>
                        <p class="text-lg mb-4">${T.score}: <span class="font-bold">${score.toLocaleString()}</span></p>
                        <div id="auth-section" class="mb-4">
                            ${isGoogleUser ? 
                                `<p class="text-green-400">Connect√© en tant que ${user.displayName}</p>` :
                                `<button id="google-submit-btn" class="bg-white text-gray-800 font-bold py-2 px-4 rounded-lg w-full max-w-xs mx-auto flex items-center justify-center transition hover:bg-gray-200">
                                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                                    ${T.loginGoogle}
                                </button>
                                <p class="text-gray-400 text-sm my-2">${T.or}</p>`
                            }
                        </div>
                        <div class="space-y-4 text-left w-full max-w-sm mx-auto">
                            <input type="text" id="nickname-input" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg" placeholder="${T.nickname}">
                        </div>
                        <div id="country-display" class="text-gray-400 mt-4 h-5"></div>
                        <div id="submit-error" class="text-red-400 text-sm mt-2 h-5"></div>
                        <button id="confirm-submit-btn" class="mt-4 bg-green-600 font-bold py-3 px-8 rounded-lg">${T.submitButton}</button>
                    `;
                }

                showModal(getSubmitContent(currentUser));
                
                const nicknameInput = document.getElementById('nickname-input');
                if (currentUser && !currentUser.isAnonymous) {
                    nicknameInput.value = currentUser.displayName;
                }

                const googleSubmitBtn = document.getElementById('google-submit-btn');
                if (googleSubmitBtn) {
                    googleSubmitBtn.addEventListener('click', () => {
                        googleSubmitBtn.disabled = true;
                        googleSubmitBtn.innerHTML = `<div class="w-5 h-5 border-2 border-dashed rounded-full animate-spin mx-auto"></div>`;
                        
                        auth.signInWithPopup(googleProvider)
                            .then(result => {
                                // The onAuthStateChanged listener will handle the UI update globally.
                                // We just need to re-render the modal with the new state.
                                closeModal();
                                showSubmitScoreModal(score); 
                            })
                            .catch(error => {
                                closeModal();
                                showSubmitScoreModal(score);
                                setTimeout(() => {
                                    const errorEl = document.getElementById('submit-error');
                                    if(errorEl) errorEl.textContent = error.message;
                                }, 100);
                            });
                    });
                }
                
                const countryDisplay = document.getElementById('country-display');
                const confirmBtn = document.getElementById('confirm-submit-btn');
                let detectedCountry = '';

                confirmBtn.disabled = true;
                countryDisplay.textContent = T.detectingCountry;

                fetch('https://ip-api.com/json/')
                    .then(response => response.ok ? response.json() : Promise.reject('Network response failed'))
                    .then(data => {
                        if (data.status === 'success' && data.country) {
                            detectedCountry = data.country;
                            countryDisplay.textContent = T.countryDetected + detectedCountry;
                        } else {
                            countryDisplay.textContent = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching country:', error);
                        countryDisplay.textContent = '';
                    })
                    .finally(() => {
                        confirmBtn.disabled = false;
                    });

                confirmBtn.addEventListener('click', async () => {
                    const nickname = nicknameInput.value.trim();
                    const errorEl = document.getElementById('submit-error');

                    if (!nickname) {
                        errorEl.textContent = T.nicknameRequired;
                        return;
                    }
                    errorEl.textContent = '';
                    
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = `<div class="w-5 h-5 border-2 border-dashed rounded-full animate-spin mx-auto"></div>`;

                    try {
                        if (!auth.currentUser) {
                            await auth.signInAnonymously();
                        }
                        
                        await db.collection('hallOfFame').add({
                            pseudo: nickname,
                            country: detectedCountry,
                            score: score,
                            date: firebase.firestore.FieldValue.serverTimestamp(),
                            uid: auth.currentUser.uid
                        });

                        showToast(null, true, T.scoreSubmitted);
                        closeModal();
                        showHallOfFameModal(true);
                    } catch (err) {
                        console.error("Erreur lors de l'√©criture du document: ", err);
                        errorEl.textContent = `${T.submitError}: ${err.code || err.message}`;
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = T.submitButton;
                    }
                });
            };

            const showHallOfFameModal = async (fromSubmit = false) => {
                const T = translations[currentLang];
                showLoading(true);
                let listHTML = `<div class="text-center text-gray-400 p-8">${T.loading}</div>`;
                const modalContent = `
                    <h2 class="text-3xl font-bold mb-6 text-center">${T.hallOfFameTitle}</h2>
                    <div id="hall-of-fame-list" class="max-h-[70vh] overflow-y-auto pr-2">${listHTML}</div>
                    <div class="text-center mt-6"><button id="close-hof-btn" class="bg-blue-600 font-bold py-3 px-6 rounded-lg transition">${T.close}</button></div>`;
                showModal(modalContent);
                document.getElementById('close-hof-btn').addEventListener('click', () => {
                    closeModal();
                    if (fromSubmit) {
                        els.gameContainer.classList.add('hidden');
                        els.gameSetupScreen.classList.remove('hidden');
                    }
                });
                
                try {
                    const scoresRef = db.collection('hallOfFame');
                    const snapshot = await scoresRef.orderBy('score', 'desc').limit(20).get();
                    
                    if (snapshot.empty) {
                        listHTML = `<div class="text-center text-gray-400 p-8">No scores yet. Be the first!</div>`;
                    } else {
                        listHTML = `<table class="w-full text-left"><thead><tr class="text-gray-400 border-b border-gray-600">
                                <th class="p-2 w-12">${T.rank}</th><th class="p-2">${T.player}</th><th class="p-2">${T.countryLabel}</th><th class="p-2">${T.score}</th><th class="p-2 hidden md:table-cell">${T.date}</th>
                            </tr></thead><tbody>`;
                        snapshot.docs.forEach((doc, index) => {
                            const data = doc.data();
                            const date = data.date && data.date.toDate ? data.date.toDate().toLocaleDateString() : 'N/A';
                            listHTML += `<tr class="border-b border-gray-700">
                                <td class="p-2 font-bold">${index + 1}</td>
                                <td class="p-2">${data.pseudo}</td>
                                <td class="p-2">${data.country || '-'}</td>
                                <td class="p-2 text-yellow-400 font-semibold">${data.score.toLocaleString()}</td>
                                <td class="p-2 text-sm text-gray-400 hidden md:table-cell">${date}</td>
                            </tr>`;
                        });
                        listHTML += `</tbody></table>`;
                    }
                    document.getElementById('hall-of-fame-list').innerHTML = listHTML;
                } catch (error) {
                    console.error("Erreur lors de la r√©cup√©ration des scores: ", error);
                    document.getElementById('hall-of-fame-list').innerHTML = `<div class="text-center text-red-400 p-8">Erreur lors du chargement des scores.</div>`;
                } finally {
                    showLoading(false);
                }
            };
            const showAchievementsModal = () => {
                const T = translations[currentLang];
                let listHTML = '';
                Object.values(achievements).forEach(ach => {
                    listHTML += `<div class="p-4 rounded-lg flex items-center transition ${ach.unlocked ? 'bg-yellow-500 text-gray-900' : 'bg-gray-700 text-white'}">
                        <i class="fas ${ach.icon} text-3xl mr-4 ${ach.unlocked ? '' : 'opacity-30'}"></i>
                        <div><h4 class="font-bold">${ach.title}</h4><p class="text-sm ${ach.unlocked ? 'text-gray-800' : 'text-gray-400'}">${ach.desc}</p></div>
                    </div>`;
                });
                const modalContent = `
                    <h2 class="text-3xl font-bold mb-6 text-center">${T.achievementsTitle}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto pr-4">${listHTML}</div>
                    <div class="text-center mt-6"><button id="close-ach-btn" class="bg-blue-600 font-bold py-3 px-6 rounded-lg transition">${T.close}</button></div>`;
                showModal(modalContent);
                document.getElementById('close-ach-btn').addEventListener('click', closeModal);
            };
            const showResultModal = (distance, finalScore, baseScore, timeBonus, precisionBonus) => {
                const T = translations[currentLang];
                let breakdown = `${T.baseScore}: <span class="score-base">${baseScore}</span>`;
                if (timeBonus > 0) breakdown += ` | ${T.timeBonus}: ${timeBonus}`;
                if (precisionBonus > 0) breakdown += ` | <span class="text-green-400 font-bold">${T.perfectBonus} +${precisionBonus}</span>`;
                if (gameState.hintPenalty > 0) breakdown += ` | <span class="text-red-400">${T.hintPenalty}: -${gameState.hintPenalty}</span>`;
                
                const modalContent = `
                    <h2 class="text-2xl md:text-4xl font-bold">${T.distance}: ${Math.round(distance)} km</h2>
                    <p class="text-md text-gray-400 -mt-1 mb-3">${T.locationWas}: <span class="font-semibold text-white">${currentLoc.locationName}</span></p>
                    <p class="text-lg md:text-xl text-gray-300 mb-4">${T.youScored} <span id="round-score-anim" class="font-bold text-yellow-400 score-pop">${finalScore}</span> ${T.points}</p>
                    <div class="text-xs md:text-sm text-gray-400 mb-6">${breakdown}</div>
                    <div id="result-map" class="w-full h-64 rounded-lg border-2 border-gray-600"></div>
                    <button id="next-round-btn" class="bg-green-600 font-bold py-3 px-6 rounded-lg mt-4 transition">
                        ${(gameState.settings.mode === 'endless' || gameState.currentRound < gameState.settings.roundLimit) ? T.nextRound : T.finalScoreBtn}
                    </button>`;
                showModal(modalContent);
                document.getElementById('next-round-btn').addEventListener('click', nextRound);
                
                animateValue(document.getElementById('round-score-anim'), 0, finalScore, 1000);

                const resMap = L.map('result-map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(resMap);
                const actual = [currentLoc.lat, currentLoc.lng];
                const guess = guessMarker ? [guessMarker.getLatLng().lat, guessMarker.getLatLng().lng] : null;
                const bounds = [actual];
                L.marker(actual).addTo(resMap);
                if (guess) { 
                    bounds.push(guess); L.marker(guess).addTo(resMap);
                    const latlngs = [guess];
                    const animatedPolyline = L.polyline(latlngs, { color: 'red' }).addTo(resMap);
                    let i = 0;
                    const steps = 50;

                    const startLng = guess[1];
                    let endLng = actual[1];
                    let lngDiff = endLng - startLng;
                    if (Math.abs(lngDiff) > 180) {
                        if (lngDiff > 0) { endLng -= 360; } else { endLng += 360; }
                    }
                    const finalLngDiff = endLng - startLng;
                    
                    const animationInterval = setInterval(() => {
                        i++;
                        const lat = guess[0] + (actual[0] - guess[0]) * (i / steps);
                        const lng = startLng + finalLngDiff * (i / steps);
                        animatedPolyline.addLatLng([lat, lng]);
                        if (i >= steps) clearInterval(animationInterval);
                    }, 20);
                }
                setTimeout(() => resMap.fitBounds(bounds, { padding: [50, 50] }), 100);
            };
            const endGame = () => {
                gameStats.gamesPlayed++;
                checkAchievements('gameEnd');
                saveData();
                showFinalScoreModal();
            };
            const nextRound = () => {
                closeModal();
                gameState.currentRound++;
                if (gameState.settings.mode !== 'endless' && gameState.currentRound > gameState.settings.roundLimit) {
                    endGame();
                } else {
                    updateUI();
                    startRound();
                }
            };
            const handleGuess = () => {
                clearTimeout(timers.round);
                const guessPos = guessMarker ? guessMarker.getLatLng() : null;
                const distance = guessPos ? getDistance(currentLoc, guessPos) : 20000;
                let { score, precisionBonus } = calculateScore(distance);
                let timeBonus = 0;
                if(gameState.settings.isTimed) {
                    const timeUsed = gameState.settings.timePerRound - (parseInt(els.timeLeft.textContent) || 0);
                    timeBonus = Math.max(0, Math.round((gameState.settings.timePerRound - timeUsed * 1.5) * 20));
                    score += timeBonus;
                }
                const finalRoundScore = Math.max(0, Math.round(score + precisionBonus) - gameState.hintPenalty);
                gameState.totalScore += finalRoundScore;
                gameState.history.push({ actual: {lat: currentLoc.lat, lng: currentLoc.lng}, guess: guessPos ? {lat: guessPos.lat, lng: guessPos.lng} : null });
                showResultModal(distance, finalRoundScore, Math.round(score), timeBonus, precisionBonus);
                checkAchievements('roundEnd', { distance });
            };
            const startTimer = () => {
                if (!gameState.settings.isTimed) return els.timerDisplay.classList.add('hidden');
                els.timerDisplay.classList.remove('hidden');
                let timeLeft = gameState.settings.timePerRound;
                els.timeLeft.textContent = timeLeft;
                clearTimeout(timers.round);
                timers.round = setInterval(() => {
                    timeLeft--;
                    els.timeLeft.textContent = timeLeft;
                    if (timeLeft <= 0) { clearTimeout(timers.round); handleGuess(); }
                }, 1000);
            };
            const startRound = async () => {
                showLoading(true);
                resetRoundUI();
                currentLoc = await getRandomLocation();
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'location': { lat: currentLoc.lat, lng: currentLoc.lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const addr = results[0].address_components;
                        currentLoc.country = addr.find(c => c.types.includes('country'))?.long_name || 'Inconnu';
                        currentLoc.locationName = results[0].formatted_address;
                        const countryCode = addr.find(c => c.types.includes('country'))?.short_name;
                        currentLoc.continent = getContinent(countryCode);
                        if (currentLoc.continent) gameStats.continentsVisited.add(currentLoc.continent);
                    } else {
                        currentLoc.country = "Inconnu";
                        currentLoc.locationName = "Lieu Myst√©rieux";
                    }
                });

                const svService = new google.maps.StreetViewService();
                svService.getPanorama({
                    location: currentLoc,
                    radius: (gameState.settings.mode === 'museums') ? 50 : 50000,
                    source: (gameState.settings.mode === 'museums') ? 'default' : 'outdoor'
                }, (data, status) => {
                    setTimeout(() => {
                        showLoading(false);
                        if (status === 'OK') {
                            sv = new google.maps.StreetViewPanorama(document.getElementById('street-view'), {
                                position: data.location.latLng,
                                pov: { heading: currentLoc.heading || Math.random() * 360, pitch: 0 },
                                zoom: 1, showRoadLabels: false, motionTracking: false, motionTrackingControl: false,
                                addressControl: false, fullscreenControl: false, panControl: false, enableCloseButton: false
                            });
                            sv.addListener('pov_changed', () => {
                                const pov = sv.getPov();
                                if (pov) updateCompass(pov.heading);
                            });
                            startTimer();
                        } else { startRound(); }
                    }, 500);
                });
            };
            const startNewGame = (settings) => {
                gameState = { settings, totalScore: 0, currentRound: 1, history: [], hintPenalty: 0 };
                updateUI();
                startRound();
            };
            const updateUI = () => {
                els.totalScore.textContent = gameState.totalScore;
                els.roundInfo.textContent = gameState.settings.mode === 'endless' ? gameState.currentRound : `${gameState.currentRound} / ${gameState.settings.roundLimit}`;
                els.endGameBtn.classList.toggle('hidden', gameState.settings.mode !== 'endless' || gameState.currentRound === 1);
            };
            const resetRoundUI = () => {
                gameState.hintPenalty = 0;
                [els.hintCompass, els.hintCountry].forEach(b => b.disabled = false);
                els.geocodedInfo.textContent = '';
                els.compassContainer.classList.add('hidden');
                
                els.mapWrapper.classList.add('hidden');
                mapVisible = false;
                els.guessBtn.textContent = translations[currentLang].placeGuessButton;
                els.guessBtn.disabled = false;
                
                if (map && guessMarker) { map.removeLayer(guessMarker); guessMarker = null; }
                if(map) setTimeout(() => map.invalidateSize(), 100);
            };

            const showLoading = (isLoading) => {
                els.loadingOverlay.classList.toggle('hidden', !isLoading);
            };
            
            const getDistance = (from, to) => {
                const R = 6371;
                const dLat = (to.lat - from.lat) * Math.PI / 180;
                const dLon = (to.lng - from.lng) * Math.PI / 180;
                const a = Math.sin(dLat / 2)**2 + Math.cos(from.lat * Math.PI / 180) * Math.cos(to.lat * Math.PI / 180) * Math.sin(dLon / 2)**2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            };
            const calculateScore = (dist) => {
                if (dist < 0.05) return { score: 5000, precisionBonus: 1000 };
                return { score: Math.max(0, 5000 * Math.exp(-dist / 2000)), precisionBonus: 0 };
            };
            const getRandomLocation = () => {
                let locations;
                if (gameState.settings?.mode === 'monuments') locations = themedLocations.monuments;
                else if (gameState.settings?.mode === 'museums') locations = themedLocations.museums;
                
                if (locations) {
                    const loc = locations[Math.floor(Math.random() * locations.length)];
                    return Promise.resolve({ ...loc, lat: loc.lat + (Math.random() - 0.5) * 0.0001, lng: loc.lng + (Math.random() - 0.5) * 0.0001 });
                }
                
                return Promise.resolve({ lat: Math.random() * 170 - 85, lng: Math.random() * 360 - 180 });
            };
            const getContinent = (code) => ({'AF':'Asia','AX':'Europe','AL':'Europe','DZ':'Africa','AS':'Oceania','AD':'Europe','AO':'Africa','AI':'North America','AQ':'Antarctica','AG':'North America','AR':'South America','AM':'Asia','AW':'North America','AU':'Oceania','AT':'Europe','AZ':'Asia','BS':'North America','BH':'Asia','BD':'Asia','BB':'North America','BY':'Europe','BE':'Europe','BZ':'North America','BJ':'Africa','BM':'North America','BT':'Asia','BO':'South America','BA':'Europe','BW':'Africa','BR':'South America','BN':'Asia','BG':'Europe','BF':'Africa','BI':'Africa','KH':'Asia','CM':'Africa','CA':'North America','CV':'Africa','KY':'North America','CF':'Africa','TD':'Africa','CL':'South America','CN':'Asia','CO':'South America','KM':'Africa','CG':'Africa','CD':'Africa','CK':'Oceania','CR':'North America','CI':'Africa','HR':'Europe','CU':'North America','CY':'Asia','CZ':'Europe','DK':'Europe','DJ':'Africa','DM':'North America','DO':'North America','EC':'South America','EG':'Africa','SV':'North America','GQ':'Africa','ER':'Africa','EE':'Europe','ET':'Africa','FK':'South America','FO':'Europe','FJ':'Oceania','FI':'Europe','FR':'Europe','GF':'South America','PF':'Oceania','GA':'Africa','GM':'Africa','GE':'Asia','DE':'Europe','GH':'Africa','GI':'Europe','GR':'Europe','GL':'North America','GD':'North America','GP':'North America','GU':'Oceania','GT':'North America','GN':'Africa','GW':'Africa','GY':'South America','HT':'North America','VA':'Europe','HN':'North America','HK':'Asia','HU':'Europe','IS':'Europe','IN':'Asia','ID':'Asia','IR':'Asia','IQ':'Asia','IE':'Europe','IL':'Asia','IT':'Europe','JM':'North America','JP':'Asia','JO':'Asia','KZ':'Asia','KE':'Africa','KI':'Oceania','KP':'Asia','KR':'Asia','KW':'Asia','KG':'Asia','LA':'Asia','LV':'Europe','LB':'Asia','LS':'Africa','LR':'Africa','LY':'Africa','LI':'Europe','LT':'Europe','LU':'Europe','MO':'Asia','MK':'Europe','MG':'Africa','MW':'Africa','MY':'Asia','MV':'Asia','ML':'Africa','MT':'Europe','MH':'Oceania','MQ':'North America','MR':'Africa','MU':'Africa','YT':'Africa','MX':'North America','FM':'Oceania','MD':'Europe','MC':'Europe','MN':'Asia','ME':'Europe','MS':'North America','MA':'Africa','MZ':'Africa','MM':'Asia','NA':'Africa','NR':'Oceania','NP':'Asia','NL':'Europe','NC':'Oceania','NZ':'Oceania','NI':'North America','NE':'Africa','NG':'Africa','NU':'Oceania','MP':'Oceania','NO':'Europe','OM':'Asia','PK':'Asia','PW':'Oceania','PS':'Asia','PA':'North America','PG':'Oceania','PY':'South America','PE':'South America','PH':'Asia','PN':'Oceania','PL':'Europe','PT':'Europe','PR':'North America','QA':'Asia','RE':'Africa','RO':'Europe','RU':'Europe','RW':'Africa','KN':'North America','LC':'North America','PM':'North America','VC':'North America','WS':'Oceania','SM':'Europe','ST':'Africa','SA':'Asia','SN':'Africa','RS':'Europe','SC':'Africa','SL':'Africa','SG':'Asia','SK':'Europe','SI':'Europe','SB':'Oceania','SO':'Africa','ZA':'Africa','ES':'Europe','LK':'Asia','SD':'Africa','SR':'South America','SZ':'Africa','SE':'Europe','CH':'Europe','SY':'Asia','TW':'Asia','TJ':'Asia','TZ':'Africa','TH':'Asia','TG':'Africa','TK':'Oceania','TO':'Oceania','TT':'North America','TN':'Africa','TR':'Asia','TM':'Asia','TC':'North America','TV':'Oceania','UG':'Africa','UA':'Europe','AE':'Asia','GB':'Europe','US':'North America','UY':'South America','UZ':'Asia','VU':'Oceania','VE':'South America','VN':'Asia','VG':'North America','VI':'North America','WF':'Oceania','EH':'Africa','YE':'Asia','ZM':'Africa','ZW':'Africa'}[code] || null);
            const updateCompass = (heading) => { if (!els.compassContainer.classList.contains('hidden')) els.compassArrow.style.transform = `rotate(${-heading}deg)`; };
            const shareScore = async () => {
                const T = translations[currentLang];
                const shareText = T.shareMessage.replace('[SCORE]', gameState.totalScore.toLocaleString());
                const shareData = {
                    title: 'Geo Challenge',
                    text: shareText,
                    url: window.location.href,
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(`${shareText} ${window.location.href}`);
                        showToast(null, true);
                    }
                } catch (err) { console.error("Share failed:", err); }
            };
            
            const loadGoogleMapsScript = (apiKey) => {
                if (window.google && window.google.maps) { return initGame(); }
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGame&libraries=geocoding`;
                script.async = true; script.defer = true;
                window.handleApiError = () => {
                    localStorage.removeItem('googleMapsApiKey');
                    document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center text-center bg-red-900 text-white p-4"><div><h1 class="text-2xl font-bold">Erreur de Cl√© API</h1><p>La cl√© est invalide ou les APIs requises (Maps, Street View, Geocoding) ne sont pas activ√©es. La page va se recharger.</p></div></div>`;
                    setTimeout(() => window.location.reload(), 5000);
                };
                script.onerror = window.handleApiError;
                document.head.appendChild(script);
            };

            const startApiKeyFlow = () => {
                const netlifyApiKey = "YOUR_NETLIFY_API_KEY_HERE"; 
                const savedApiKey = localStorage.getItem('googleMapsApiKey');

                if (netlifyApiKey && netlifyApiKey !== "YOUR_NETLIFY_API_KEY_HERE") {
                    loadGoogleMapsScript(netlifyApiKey);
                } else if (savedApiKey) {
                    loadGoogleMapsScript(savedApiKey);
                } else {
                    els.apiKeyModal.classList.remove('hidden');
                }
            };
            
            const init = () => {
                loadData();
                const savedLang = localStorage.getItem('geoGameLang') || 'fr';
                setLanguage(savedLang);

                document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    setLanguage(lang);
                    localStorage.setItem('geoGameLang', lang);
                    els.languageScreen.classList.add('hidden');
                    startApiKeyFlow();
                }));
            };
            
            window.initGame = () => {
                els.gameSetupScreen.classList.remove('hidden');
                els.apiKeyModal.classList.add('hidden');
                setupGameUI();
            };

            const setupGameUI = () => {
                if (map) return;
                map = L.map('map').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                map.on('click', (e) => {
                    if (guessMarker) guessMarker.setLatLng(e.latlng);
                    else guessMarker = L.marker(e.latlng).addTo(map);
                    els.guessBtn.disabled = false;
                });
            }

            els.saveApiKeyBtn.addEventListener('click', () => {
                const apiKey = els.apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('googleMapsApiKey', apiKey);
                    els.apiKeyModal.classList.add('hidden');
                    loadGoogleMapsScript(apiKey);
                } else {
                    els.apiKeyError.classList.remove('hidden');
                }
            });

            document.querySelectorAll('.game-mode-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const settings = {
                    mode: e.currentTarget.dataset.mode,
                    isTimed: document.getElementById('timed-mode-checkbox').checked && e.currentTarget.dataset.mode !== 'endless',
                    roundLimit: e.currentTarget.dataset.mode === 'endless' ? Infinity : 5,
                    timePerRound: 90
                };
                els.gameSetupScreen.classList.add('hidden');
                els.gameContainer.classList.remove('hidden');
                startNewGame(settings);
            }));
            
            let mapVisible = false;
            els.guessBtn.addEventListener('click', () => {
                if (!mapVisible) {
                    els.mapWrapper.classList.remove('hidden');
                    setTimeout(() => map.invalidateSize(), 100);
                    els.guessBtn.innerHTML = translations[currentLang].confirmGuessButton;
                    els.guessBtn.disabled = true;
                    mapVisible = true;
                } else {
                    handleGuess();
                }
            });

            els.achievementsBtn.addEventListener('click', showAchievementsModal);
            els.hallOfFameBtn.addEventListener('click', () => showHallOfFameModal(false));
            els.endGameBtn.addEventListener('click', endGame);
            els.hintCompass.addEventListener('click', (e) => {
                els.compassContainer.classList.remove('hidden');
                gameState.hintPenalty += parseInt(e.currentTarget.dataset.cost);
                e.currentTarget.disabled = true;
            });
            els.hintCountry.addEventListener('click', (e) => {
                els.geocodedInfo.textContent = `${translations[currentLang].hintCountry}: ${currentLoc.country || '...'}`;
                gameState.hintPenalty += parseInt(e.currentTarget.dataset.cost);
                e.currentTarget.disabled = true;
            });
            
            els.logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.reload();
                });
            });

            document.querySelectorAll('#game-title span').forEach((span, index) => {
                span.style.animationDelay = `${index * 0.15}s`;
            });

            init();
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Financier Avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .dark body {
            background-color: #0f172a; /* slate-900 */
        }
        .tab-active {
            color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        .dark .tab-active {
            color: #818cf8; /* indigo-400 */
            border-color: #818cf8;
        }
        .result-card {
            background: linear-gradient(145deg, #4f46e5, #6366f1);
        }
        .dark .result-card {
             background: linear-gradient(145deg, #1e293b, #334155); /* slate-800 to slate-700 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .switch-label {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.2s ease-in-out;
        }
        .switch-radio:checked + .switch-label {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
        }
        .dark .switch-radio:checked + .switch-label {
            background-color: #818cf8;
        }
        /* Tooltip styles */
        .has-tooltip .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="w-full max-w-4xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden md:grid md:grid-cols-2">
        
        <!-- Colonne de gauche : Formulaires -->
        <div class="p-6 sm:p-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white mb-2">Calculateur Financier</h1>
                    <p class="text-slate-500 dark:text-slate-400">Outils pour vos décisions financières.</p>
                </div>
                <!-- Dark Mode Toggle -->
                <button id="theme-toggle" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.464 9.092a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM11 17a1 1 0 100-2H9a1 1 0 100 2h2zm-7-4a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            
            <div class="border-b border-slate-200 dark:border-slate-700 my-6">
                <nav class="-mb-px flex flex-wrap gap-x-4 sm:gap-x-6" aria-label="Tabs">
                    <button id="tab-loan" data-tab-id="loan" class="tab tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Prêt</button>
                    <button id="tab-fv" data-tab-id="fv" class="tab text-slate-500 dark:text-slate-400 hover:text-slate-700 hover:border-slate-300 dark:hover:text-slate-200 dark:hover:border-slate-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Épargne</button>
                    <button id="tab-ret" data-tab-id="ret" class="tab text-slate-500 dark:text-slate-400 hover:text-slate-700 hover:border-slate-300 dark:hover:text-slate-200 dark:hover:border-slate-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Retraite</button>
                    <button id="tab-inf" data-tab-id="inf" class="tab text-slate-500 dark:text-slate-400 hover:text-slate-700 hover:border-slate-300 dark:hover:text-slate-200 dark:hover:border-slate-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Inflation</button>
                    <button id="tab-dep" data-tab-id="dep" class="tab text-slate-500 dark:text-slate-400 hover:text-slate-700 hover:border-slate-300 dark:hover:text-slate-200 dark:hover:border-slate-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dépréciation</button>
                </nav>
            </div>

            <!-- Contenu des calculateurs -->
            <div>
                <!-- Contenu Calculateur de Prêt -->
                <div id="loan-calculator-content">
                    <div class="flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded-full p-1 mb-5 text-sm text-slate-600 dark:text-slate-300">
                        <input type="radio" id="loan-mode-normal" name="loan-mode" value="normal" class="sr-only" checked><label for="loan-mode-normal" class="switch-label">Calculer la mensualité</label>
                        <input type="radio" id="loan-mode-reverse" name="loan-mode" value="reverse" class="sr-only"><label for="loan-mode-reverse" class="switch-label">Calculer le capital</label>
                    </div>
                    <form id="loan-form" class="space-y-5">
                        <div id="loan-amount-field"><label for="amount" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Montant du prêt <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-48 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Le capital total que vous souhaitez emprunter.</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="amount" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="150000"></div></div>
                        <div id="loan-monthly-payment-field" class="hidden"><label for="monthly-payment-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Mensualité souhaitée</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="monthly-payment-input" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="850"></div></div>
                        <div><label for="interest" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Taux d'intérêt annuel <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-56 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Le taux d'intérêt nominal annuel, hors assurance et autres frais (TAEG).</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="interest" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="3.5"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><label for="years" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Durée du prêt (années)</label><input type="number" id="years" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="20"></div>
                        <div><button type="submit" id="loan-submit-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculer la mensualité</button></div>
                    </form>
                </div>
                <!-- Contenu Calculateur d'Épargne (Valeur Future) -->
                <div id="fv-calculator-content" class="hidden">
                    <div class="flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded-full p-1 mb-5 text-sm text-slate-600 dark:text-slate-300">
                        <input type="radio" id="fv-mode-normal" name="fv-mode" value="normal" class="sr-only" checked><label for="fv-mode-normal" class="switch-label">Calculer le capital</label>
                        <input type="radio" id="fv-mode-reverse" name="fv-mode" value="reverse" class="sr-only"><label for="fv-mode-reverse" class="switch-label">Calculer le versement</label>
                    </div>
                     <form id="fv-form" class="space-y-5">
                        <div><label for="initial-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Montant initial</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="initial-amount" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="10000"></div></div>
                        <div id="fv-monthly-contribution-field"><label for="monthly-contribution" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Versement mensuel</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="monthly-contribution" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="200"></div></div>
                        <div id="fv-target-amount-field" class="hidden"><label for="target-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Objectif de capital</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="target-amount" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="100000"></div></div>
                        <div><label for="fv-interest" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Taux de rendement annuel <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-56 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Le rendement annuel moyen attendu de votre placement (livret, assurance-vie, etc.).</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="fv-interest" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="5"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><label for="fv-years" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Durée (années)</label><input type="number" id="fv-years" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="10"></div>
                        <div><label for="fv-inflation" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Taux d'inflation estimé <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-56 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Optionnel. Permet de calculer le pouvoir d'achat réel de votre capital futur.</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="fv-inflation" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="2"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><button type="submit" id="fv-submit-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculer le capital</button></div>
                    </form>
                </div>
                <!-- Contenu Calculateur de Retraite -->
                <div id="ret-calculator-content" class="hidden">
                    <form id="ret-form" class="space-y-5">
                        <div><label for="ret-monthly-income" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Rente mensuelle souhaitée à la retraite</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="ret-monthly-income" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="1500"></div></div>
                        <div><label for="ret-initial-capital" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Capital de départ (épargne actuelle)</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="ret-initial-capital" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="20000"></div></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="ret-current-age" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Âge actuel</label><input type="number" id="ret-current-age" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="30"></div>
                            <div><label for="ret-retirement-age" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Âge de la retraite</label><input type="number" id="ret-retirement-age" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="65"></div>
                        </div>
                        <div><label for="ret-life-expectancy" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Espérance de vie</label><input type="number" id="ret-life-expectancy" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="85"></div>
                        <div><label for="ret-growth-rate-pre" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Rendement de l'épargne (avant retraite) <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-56 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Taux de rendement annuel moyen de vos placements pendant votre phase d'épargne.</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="ret-growth-rate-pre" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="5"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><label for="ret-growth-rate-post" class="flex items-center text-sm font-medium text-slate-700 dark:text-slate-300">Rendement du capital (pendant retraite) <span class="has-tooltip ml-1.5 relative"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="tooltip absolute bottom-full mb-2 w-56 bg-slate-700 text-white text-xs rounded py-1 px-2 left-1/2 -translate-x-1/2">Taux de rendement annuel de votre capital une fois à la retraite (souvent plus sécurisé).</span></span></label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="ret-growth-rate-post" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="3"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculer</button></div>
                    </form>
                </div>
                <!-- Contenu Calculateur d'Inflation -->
                <div id="inf-calculator-content" class="hidden">
                    <form id="inf-form" class="space-y-5">
                        <div><label for="inf-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Montant</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="inf-amount" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="1000"></div></div>
                        <div><label for="year-of-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Année du montant</label><input type="number" id="year-of-amount" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="1973 ou 2024"></div>
                        <div><label for="target-year" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Année de conversion</label><input type="number" id="target-year" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="2024 ou 1973"></div>
                        <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculer</button></div>
                    </form>
                </div>
                <!-- Contenu Calculateur de Dépréciation -->
                <div id="dep-calculator-content" class="hidden">
                    <form id="dep-form" class="space-y-5">
                        <div><label for="dep-initial-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Montant initial</label><div class="mt-1 relative rounded-md shadow-sm"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-slate-500 sm:text-sm">€</span></div><input type="number" id="dep-initial-amount" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="10000"></div></div>
                        <div><label for="dep-inflation-rate" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Taux d'inflation annuel moyen</label><div class="mt-1 relative rounded-md shadow-sm"><input type="number" step="0.01" id="dep-inflation-rate" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white pr-7 pl-4 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="2.5"><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-slate-500 sm:text-sm">%</span></div></div></div>
                        <div><label for="dep-years" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Durée (années)</label><input type="number" id="dep-years" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 px-4" placeholder="10"></div>
                        <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculer la dépréciation</button></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Colonne de droite : Résultats -->
        <div class="result-card text-white p-8 flex flex-col min-h-[400px] md:min-h-full">
             <div id="result-display" class="flex-grow flex flex-col justify-center text-center">
                <div id="initial-message">
                    <svg class="mx-auto h-12 w-12 text-indigo-300 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    <h3 class="mt-2 text-lg font-medium">Vos résultats s'afficheront ici</h3>
                    <p class="mt-1 text-sm text-indigo-200 dark:text-slate-400">Remplissez les champs pour commencer.</p>
                </div>
                <div id="dynamic-result-content" class="hidden">
                    <!-- Result Tabs -->
                    <div class="border-b border-white/20 mb-4">
                        <nav class="-mb-px flex justify-center space-x-6" aria-label="Tabs">
                            <button id="result-tab-summary" class="whitespace-nowrap py-3 px-1 border-b-2 border-white font-medium text-sm">Résumé</button>
                            <button id="result-tab-details" class="whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-indigo-200 hover:text-white hover:border-white/50 font-medium text-sm hidden">Détail</button>
                        </nav>
                    </div>
                    <!-- Summary Content -->
                    <div id="summary-content">
                        <h2 id="result-title" class="text-lg font-medium text-indigo-200 dark:text-slate-400"></h2>
                        <p id="result-value" class="mt-2 text-4xl md:text-5xl font-bold tracking-tight"></p>
                        <p id="result-subtitle" class="mt-2 text-sm text-indigo-200 dark:text-slate-400"></p>
                        <p id="result-subtitle2" class="mt-1 text-sm text-indigo-200 dark:text-slate-400"></p>
                        <div id="chart-container" class="relative h-48 w-full max-w-xs mx-auto mt-4">
                            <canvas id="result-chart"></canvas>
                        </div>
                    </div>
                    <!-- Details Content -->
                    <div id="details-content" class="hidden text-left overflow-y-auto max-h-[20rem]">
                        <!-- Table will be injected here -->
                    </div>
                    <div id="action-buttons-container" class="mt-4 flex flex-wrap justify-center gap-2"></div>
                </div>
             </div>
             <div id="error-message-container" class="mt-4 text-center text-yellow-300 font-medium hidden"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Données sur l'inflation (France, moyenne annuelle, source INSEE) ---
            const inflationData = {
                2024: 2.0, 2023: 4.9, 2022: 5.2, 2021: 1.6, 2020: 0.5, 2019: 1.1, 2018: 1.8, 2017: 1.0, 
                2016: 0.2, 2015: 0.0, 2014: 0.5, 2013: 0.9, 2012: 2.0, 2011: 2.1, 2010: 1.5, 
                2009: 0.1, 2008: 2.8, 2007: 1.5, 2006: 1.6, 2005: 1.8, 2004: 2.1, 2003: 1.9, 
                2002: 1.9, 2001: 1.7, 2000: 1.7, 1999: 0.5, 1998: 0.7, 1997: 1.2, 1996: 2.0, 
                1995: 1.8, 1994: 1.6, 1993: 2.1, 1992: 2.8, 1991: 3.2, 1990: 3.4, 1989: 3.6, 
                1988: 2.7, 1987: 3.1, 1986: 2.7, 1985: 5.8, 1984: 7.4, 1983: 9.6, 1982: 11.8, 
                1981: 13.4, 1980: 13.6, 1979: 10.8, 1978: 9.1, 1977: 9.4, 1976: 9.6, 1975: 11.8,
                1974: 13.7, 1973: 7.4
            };
            
            // --- Dark Mode ---
            const themeToggle = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const applyTheme = (isDark) => { if (isDark) { document.documentElement.classList.add('dark'); darkIcon.classList.remove('hidden'); lightIcon.classList.add('hidden'); } else { document.documentElement.classList.remove('dark'); darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden'); } };
            themeToggle.addEventListener('click', () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); applyTheme(isDark); });
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));

            // --- Gestion des onglets ---
            const tabs = [ { id: 'loan', btn: document.getElementById('tab-loan'), content: document.getElementById('loan-calculator-content') }, { id: 'fv', btn: document.getElementById('tab-fv'), content: document.getElementById('fv-calculator-content') }, { id: 'ret', btn: document.getElementById('tab-ret'), content: document.getElementById('ret-calculator-content') }, { id: 'inf', btn: document.getElementById('tab-inf'), content: document.getElementById('inf-calculator-content') }, { id: 'dep', btn: document.getElementById('tab-dep'), content: document.getElementById('dep-calculator-content') } ];
            let activeTabId = 'loan';
            tabs.forEach(tab => { tab.btn.addEventListener('click', () => { activeTabId = tab.id; tabs.forEach(otherTab => { otherTab.content.classList.add('hidden'); otherTab.btn.classList.remove('tab-active'); otherTab.btn.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-700', 'hover:border-slate-300', 'dark:hover:text-slate-200', 'dark:hover:border-slate-500'); }); tab.content.classList.remove('hidden'); tab.btn.classList.add('tab-active'); tab.btn.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-700', 'hover:border-slate-300', 'dark:hover:text-slate-200', 'dark:hover:border-slate-500'); clearDisplay(); }); });
            
            // --- Eléments d'affichage & Chart ---
            const initialMessage = document.getElementById('initial-message');
            const dynamicResultContent = document.getElementById('dynamic-result-content');
            const resultTitle = document.getElementById('result-title');
            const resultValue = document.getElementById('result-value');
            const resultSubtitle = document.getElementById('result-subtitle');
            const resultSubtitle2 = document.getElementById('result-subtitle2');
            const actionButtonsContainer = document.getElementById('action-buttons-container');
            const errorMessageContainer = document.getElementById('error-message-container');
            const chartContainer = document.getElementById('chart-container');
            const chartCanvas = document.getElementById('result-chart');
            const resultTabSummary = document.getElementById('result-tab-summary');
            const resultTabDetails = document.getElementById('result-tab-details');
            const summaryContent = document.getElementById('summary-content');
            const detailsContent = document.getElementById('details-content');
            let resultChart = null;
            let lastCalculationData = {};

            // --- Fonctions d'affichage ---
            const clearDisplay = () => { initialMessage.classList.remove('hidden'); dynamicResultContent.classList.add('hidden'); errorMessageContainer.classList.add('hidden'); actionButtonsContainer.innerHTML = ''; chartContainer.classList.add('hidden'); resultTabDetails.classList.add('hidden'); if (resultChart) { resultChart.destroy(); resultChart = null; } };
            const displayError = (message) => { clearDisplay(); errorMessageContainer.textContent = message; errorMessageContainer.classList.remove('hidden'); errorMessageContainer.classList.add('fade-in'); };
            const displayResult = (title, value, subtitle = '', subtitle2 = '') => { clearDisplay(); resultTitle.textContent = title; resultValue.textContent = value; resultSubtitle.textContent = subtitle; resultSubtitle2.textContent = subtitle2; dynamicResultContent.classList.remove('hidden'); dynamicResultContent.classList.add('fade-in'); createActionButtons(); };
            const formatCurrency = (value) => { if (typeof value !== 'number' || isNaN(value)) { return 'N/A'; } return value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }); };
            const formatCurrencyForPDF = (value) => { if (typeof value !== 'number') return String(value); return value.toFixed(2).replace('.', ',') + ' EUR'; };

            // --- Logique des Toggles ---
            document.querySelectorAll('input[name="loan-mode"]').forEach(radio => { radio.addEventListener('change', (e) => { const isNormalMode = e.target.value === 'normal'; document.getElementById('loan-amount-field').classList.toggle('hidden', !isNormalMode); document.getElementById('loan-monthly-payment-field').classList.toggle('hidden', isNormalMode); document.getElementById('loan-submit-button').textContent = isNormalMode ? 'Calculer la mensualité' : 'Calculer le capital'; }); });
            document.querySelectorAll('input[name="fv-mode"]').forEach(radio => { radio.addEventListener('change', (e) => { const isNormalMode = e.target.value === 'normal'; document.getElementById('fv-monthly-contribution-field').classList.toggle('hidden', !isNormalMode); document.getElementById('fv-target-amount-field').classList.toggle('hidden', isNormalMode); document.getElementById('fv-submit-button').textContent = isNormalMode ? 'Calculer le capital' : 'Calculer le versement'; }); });

            // --- Calculateur de Prêt ---
            document.getElementById('loan-form').addEventListener('submit', (e) => { e.preventDefault(); clearDisplay(); const mode = document.querySelector('input[name="loan-mode"]:checked').value; const annualInterestRate = parseFloat(document.getElementById('interest').value); const years = parseFloat(document.getElementById('years').value); if (isNaN(annualInterestRate) || isNaN(years) || annualInterestRate < 0 || years <= 0) { displayError("Veuillez entrer un taux et une durée valides."); return; } const monthlyInterestRate = (annualInterestRate / 100) / 12; const numberOfPayments = years * 12; if (mode === 'normal') { const principal = parseFloat(document.getElementById('amount').value); if (isNaN(principal) || principal <= 0) { displayError("Veuillez entrer un montant de prêt valide."); return; } const monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1); const totalRepaid = monthlyPayment * numberOfPayments; const totalInterest = totalRepaid - principal; lastCalculationData = { type: 'loan', principal, totalInterest, annualInterestRate, years, monthlyPayment, totalRepaid }; displayResult("Votre mensualité estimée", formatCurrency(monthlyPayment), `Coût total du crédit : ${formatCurrency(totalInterest)}`, `Montant total remboursé : ${formatCurrency(totalRepaid)}`); drawLoanChart(principal, totalInterest); } else { const monthlyPayment = parseFloat(document.getElementById('monthly-payment-input').value); if (isNaN(monthlyPayment) || monthlyPayment <= 0) { displayError("Veuillez entrer une mensualité valide."); return; } const principal = monthlyPayment * (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1) / (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)); const totalRepaid = monthlyPayment * numberOfPayments; const totalInterest = totalRepaid - principal; lastCalculationData = { type: 'loan_reverse', principal, totalInterest, annualInterestRate, years, monthlyPayment, totalRepaid }; displayResult("Capital empruntable", formatCurrency(principal), `Coût total du crédit : ${formatCurrency(totalInterest)}`, `Montant total remboursé : ${formatCurrency(totalRepaid)}`); drawLoanChart(principal, totalInterest); } saveState(); });

            // --- Calculateur d'Épargne ---
            document.getElementById('fv-form').addEventListener('submit', (e) => { e.preventDefault(); clearDisplay(); const mode = document.querySelector('input[name="fv-mode"]:checked').value; const initialAmount = parseFloat(document.getElementById('initial-amount').value) || 0; const annualRate = parseFloat(document.getElementById('fv-interest').value); const years = parseFloat(document.getElementById('fv-years').value); const inflation = parseFloat(document.getElementById('fv-inflation').value) || 0; if (isNaN(annualRate) || isNaN(years) || annualRate < 0 || years <= 0) { displayError("Veuillez entrer un taux et une durée valides."); return; } const monthlyRate = (annualRate / 100) / 12; const months = years * 12; if (mode === 'normal') { const monthlyContribution = parseFloat(document.getElementById('monthly-contribution').value) || 0; if (initialAmount <= 0 && monthlyContribution <= 0) { displayError("Veuillez entrer un montant initial ou un versement."); return; } const fvOfInitial = initialAmount * Math.pow(1 + monthlyRate, months); const fvOfContributions = monthlyContribution * (monthlyRate > 0 ? (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate)) : months * monthlyContribution); const totalFutureValue = fvOfInitial + fvOfContributions; const realValue = totalFutureValue / Math.pow(1 + (inflation / 100), years); lastCalculationData = { type: 'fv', initialAmount, monthlyContribution, annualRate, years, inflation, totalFutureValue, realValue }; displayResult("Capital final (valeur nominale)", formatCurrency(totalFutureValue), inflation > 0 ? `Pouvoir d'achat réel : ${formatCurrency(realValue)}` : '', `Après ${years} ans à ${annualRate}%.`); drawFvChart(initialAmount, monthlyContribution, years, annualRate); } else { const targetAmount = parseFloat(document.getElementById('target-amount').value); if (isNaN(targetAmount) || targetAmount <= 0) { displayError("Veuillez entrer un objectif de capital valide."); return; } const fvOfInitial = initialAmount * Math.pow(1 + monthlyRate, months); let monthlyContribution; if (monthlyRate > 0) { const denominator = (Math.pow(1 + monthlyRate, months) - 1) / monthlyRate; monthlyContribution = (targetAmount - fvOfInitial) / denominator; } else { monthlyContribution = (targetAmount - initialAmount) / months; } lastCalculationData = { type: 'fv_reverse', initialAmount, targetAmount, annualRate, years, monthlyContribution }; displayResult("Versement mensuel requis", formatCurrency(monthlyContribution), `Pour atteindre ${formatCurrency(targetAmount)} en ${years} ans.`); } saveState(); });

            // --- Calculateur de Retraite ---
            document.getElementById('ret-form').addEventListener('submit', (e) => { e.preventDefault(); clearDisplay(); const monthlyIncome = parseFloat(document.getElementById('ret-monthly-income').value); const initialCapital = parseFloat(document.getElementById('ret-initial-capital').value) || 0; const currentAge = parseInt(document.getElementById('ret-current-age').value); const retirementAge = parseInt(document.getElementById('ret-retirement-age').value); const lifeExpectancy = parseInt(document.getElementById('ret-life-expectancy').value); const preRetRate = parseFloat(document.getElementById('ret-growth-rate-pre').value); const postRetRate = parseFloat(document.getElementById('ret-growth-rate-post').value); if (isNaN(monthlyIncome) || isNaN(currentAge) || isNaN(retirementAge) || isNaN(lifeExpectancy) || isNaN(preRetRate) || isNaN(postRetRate) || monthlyIncome <= 0 || currentAge <= 0 || retirementAge <= currentAge || lifeExpectancy <= retirementAge) { displayError("Veuillez vérifier vos âges et montants."); return; } const savingYears = retirementAge - currentAge; const retirementYears = lifeExpectancy - retirementAge; const annualIncome = monthlyIncome * 12; const rPost = postRetRate / 100; const targetCapital = (annualIncome / rPost) * (1 - Math.pow(1 + rPost, -retirementYears)); const rPreMonthly = preRetRate / 100 / 12; const savingMonths = savingYears * 12; const fvOfInitialCapital = initialCapital * Math.pow(1 + rPreMonthly, savingMonths); const neededFromSavings = targetCapital - fvOfInitialCapital; let monthlySavings = 0; if (neededFromSavings > 0) { monthlySavings = (neededFromSavings * rPreMonthly) / (Math.pow(1 + rPreMonthly, savingMonths) - 1); } lastCalculationData = { type: 'ret', monthlyIncome, initialCapital, currentAge, retirementAge, lifeExpectancy, preRetRate, postRetRate, targetCapital, monthlySavings }; displayResult("Épargne mensuelle nécessaire", formatCurrency(monthlySavings), `Pour un capital cible de ${formatCurrency(targetCapital)} à ${retirementAge} ans.`); saveState(); });

            // --- Calculateur d'Inflation & Dépréciation ---
            document.getElementById('inf-form').addEventListener('submit', (e) => { e.preventDefault(); clearDisplay(); const amount = parseFloat(document.getElementById('inf-amount').value); const yearOfAmount = parseInt(document.getElementById('year-of-amount').value); const targetYear = parseInt(document.getElementById('target-year').value); const availableYears = Object.keys(inflationData).map(Number); const minYear = Math.min(...availableYears); const maxYear = Math.max(...availableYears); if (isNaN(amount) || isNaN(yearOfAmount) || isNaN(targetYear) || amount <= 0) { displayError("Veuillez entrer des valeurs numériques valides."); return; } if (yearOfAmount === targetYear) { displayError("Les deux années doivent être différentes."); return; } if (yearOfAmount < minYear || targetYear < minYear || yearOfAmount > maxYear || targetYear > maxYear) { displayError(`Données disponibles de ${minYear} à ${maxYear}.`); return; } let convertedValue = amount; let title, subtitle; if (targetYear > yearOfAmount) { for (let year = yearOfAmount; year < targetYear; year++) { convertedValue *= (1 + inflationData[year + 1] / 100); } title = `Valeur en ${targetYear}`; subtitle = `${formatCurrency(amount)} de ${yearOfAmount} équivaudraient à...`; } else { for (let year = yearOfAmount - 1; year >= targetYear; year--) { convertedValue /= (1 + inflationData[year + 1] / 100); } title = `Pouvoir d'achat en ${targetYear}`; subtitle = `...valait ${formatCurrency(amount)} en ${yearOfAmount}.`; } lastCalculationData = { type: 'inf', amount, yearOfAmount, targetYear, convertedValue }; displayResult(title, formatCurrency(convertedValue), subtitle); saveState(); });
            document.getElementById('dep-form').addEventListener('submit', (e) => { e.preventDefault(); clearDisplay(); const initialAmount = parseFloat(document.getElementById('dep-initial-amount').value); const inflationRate = parseFloat(document.getElementById('dep-inflation-rate').value); const years = parseFloat(document.getElementById('dep-years').value); if (isNaN(initialAmount) || isNaN(inflationRate) || isNaN(years) || initialAmount <= 0 || inflationRate < 0 || years <= 0) { displayError("Veuillez entrer des valeurs numériques positives valides."); return; } const finalPurchasingPower = initialAmount / Math.pow(1 + (inflationRate / 100), years); const loss = initialAmount - finalPurchasingPower; lastCalculationData = { type: 'dep', initialAmount, inflationRate, years, finalPurchasingPower, loss }; displayResult("Pouvoir d'achat futur", formatCurrency(finalPurchasingPower), `Perte de valeur : ${formatCurrency(loss)}`); saveState(); });
            
            // --- Fonctions de génération de tableau ---
            function generateAmortizationTableHTML(principal, annualInterestRate, years) { let content = `<table class="min-w-full text-white"><thead class="border-b border-white/20"><tr><th class="px-4 py-2 text-left text-xs font-medium uppercase">Mois</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Intérêts</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Capital</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Restant</th></tr></thead><tbody>`; const monthlyInterestRate = (annualInterestRate / 100) / 12; const numberOfPayments = years * 12; let remainingBalance = principal; const monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1); for (let i = 1; i <= numberOfPayments; i++) { const interestForMonth = remainingBalance * monthlyInterestRate; const principalForMonth = monthlyPayment - interestForMonth; remainingBalance -= principalForMonth; content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${i}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(interestForMonth)}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(principalForMonth)}</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(Math.abs(remainingBalance))}</td></tr>`; } content += `</tbody></table>`; return content; }
            function generateSavingsTableHTML(initial, monthly, years, rate) { let content = `<table class="min-w-full text-white"><thead class="border-b border-white/20"><tr><th class="px-4 py-2 text-left text-xs font-medium uppercase">Année</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Versements</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Intérêts Gagnés</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Capital Final</th></tr></thead><tbody>`; let capital = initial; const monthlyRate = rate / 100 / 12; for (let i = 1; i <= years; i++) { const startOfYearCapital = capital; for(let j=0; j<12; j++) { capital = (capital * (1 + monthlyRate)) + monthly; } const interestForYear = capital - startOfYearCapital - (monthly * 12); content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${i}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(monthly * 12)}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(interestForYear)}</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(capital)}</td></tr>`; } content += `</tbody></table>`; return content; }
            function generateInflationTableHTML(amount, yearOfAmount, targetYear) { let content = `<table class="min-w-full text-white"><thead class="border-b border-white/20"><tr><th class="px-4 py-2 text-left text-xs font-medium uppercase">Année</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Taux Inflation</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Valeur Équivalente</th></tr></thead><tbody>`; let currentValue = amount; const start = Math.min(yearOfAmount, targetYear); const end = Math.max(yearOfAmount, targetYear); if (targetYear > yearOfAmount) { for (let year = start; year <= end; year++) { const inflation = year > start ? inflationData[year] : '-'; if (year > start) currentValue *= (1 + inflationData[year] / 100); content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${year}</td><td class="px-4 py-2 text-sm text-right">${inflation}%</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(currentValue)}</td></tr>`; } } else { for (let year = start; year <= end; year++) { const inflation = year < end ? inflationData[year + 1] : '-'; const displayValue = year === end ? amount : amount / Array.from({length: end - year}, (_, i) => 1 + inflationData[end - i] / 100).reduce((a, b) => a * b, 1); content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${year}</td><td class="px-4 py-2 text-sm text-right">${inflation}%</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(displayValue)}</td></tr>`; } } content += `</tbody></table>`; return content; }
            function generateDepreciationTableHTML(initialAmount, inflationRate, years) { let content = `<table class="min-w-full text-white"><thead class="border-b border-white/20"><tr><th class="px-4 py-2 text-left text-xs font-medium uppercase">Année</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Valeur Début</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Perte Annuelle</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Pouvoir d'Achat Final</th></tr></thead><tbody>`; let currentPower = initialAmount; for (let i = 1; i <= years; i++) { const startValue = currentPower; const endValue = startValue / (1 + inflationRate / 100); const loss = startValue - endValue; currentPower = endValue; content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${i}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(startValue)}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(loss)}</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(currentPower)}</td></tr>`; } content += `</tbody></table>`; return content; }
            function generateRetirementTableHTML(data) { let content = `<table class="min-w-full text-white"><thead class="border-b border-white/20"><tr><th class="px-4 py-2 text-left text-xs font-medium uppercase">Âge</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Versements Annuels</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Intérêts Gagnés</th><th class="px-4 py-2 text-right text-xs font-medium uppercase">Capital Final</th></tr></thead><tbody>`; let capital = data.initialCapital; const monthlyRate = data.preRetRate / 100 / 12; for (let i = 1; i <= (data.retirementAge - data.currentAge); i++) { const startOfYearCapital = capital; for(let j=0; j<12; j++) { capital = (capital * (1 + monthlyRate)) + data.monthlySavings; } const interestForYear = capital - startOfYearCapital - (data.monthlySavings * 12); content += `<tr class="border-b border-white/10"><td class="px-4 py-2 text-sm">${data.currentAge + i}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(data.monthlySavings * 12)}</td><td class="px-4 py-2 text-sm text-right">${formatCurrency(interestForYear)}</td><td class="px-4 py-2 text-sm font-medium text-right">${formatCurrency(capital)}</td></tr>`; } content += `</tbody></table>`; return content; }

            // --- Logique des Graphiques ---
            function getChartColors() { const isDark = document.documentElement.classList.contains('dark'); return { textColor: isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(255, 255, 255, 0.7)', gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.2)', loanColors: ['#a78bfa', '#e0e7ff'], fvColors: { total: '#a78bfa', contributions: '#e0e7ff' } }; }
            function drawLoanChart(principal, interest) { chartContainer.classList.remove('hidden'); const colors = getChartColors(); resultChart = new Chart(chartCanvas, { type: 'doughnut', data: { labels: ['Capital Emprunté', 'Coût du Crédit'], datasets: [{ data: [principal, interest], backgroundColor: colors.loanColors, borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#6366f1', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            function drawFvChart(initial, monthly, years, rate) { chartContainer.classList.remove('hidden'); const colors = getChartColors(); const labels = Array.from({ length: years + 1 }, (_, i) => `An ${i}`); const dataTotal = []; const dataContributions = []; for (let i = 0; i <= years; i++) { const months = i * 12; const monthlyRate = (rate / 100) / 12; const fvInitial = initial * Math.pow(1 + monthlyRate, months); const fvContributions = monthly * (monthlyRate > 0 ? (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate)) : months * monthly); dataTotal.push(fvInitial + fvContributions); dataContributions.push(initial + (monthly * months)); } resultChart = new Chart(chartCanvas, { type: 'line', data: { labels: labels, datasets: [{ label: 'Capital Total', data: dataTotal, borderColor: colors.fvColors.total, tension: 0.1, fill: false }, { label: 'Versements Totaux', data: dataContributions, borderColor: colors.fvColors.contributions, tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { labels: { color: colors.textColor } } } } }); }
            
            // --- Sauvegarde (localStorage) & Export ---
            const saveState = () => { const state = {}; tabs.forEach(tab => { state[tab.id] = {}; const form = document.getElementById(`${tab.id}-form`); if (form) { form.querySelectorAll('input[type="number"]').forEach(input => { state[tab.id][input.id] = input.value; }); } }); localStorage.setItem('financialCalculatorState', JSON.stringify(state)); };
            const loadState = () => { const state = JSON.parse(localStorage.getItem('financialCalculatorState')); if (state) { tabs.forEach(tab => { if (state[tab.id]) { const form = document.getElementById(`${tab.id}-form`); if (form) { Object.keys(state[tab.id]).forEach(inputId => { const input = form.querySelector(`#${inputId}`); if (input) input.value = state[tab.id][inputId]; }); } } }); } };
            
            function createActionButtons() {
                actionButtonsContainer.innerHTML = '';
                const copyButton = document.createElement('button'); copyButton.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Copier`; copyButton.className = "py-2 px-3 border border-indigo-200 dark:border-slate-400 rounded-md text-xs font-medium text-white hover:bg-white hover:bg-opacity-20 dark:hover:bg-black dark:hover:bg-opacity-20 focus:outline-none flex items-center"; copyButton.onclick = copyResultsToClipboard; actionButtonsContainer.appendChild(copyButton);
                const pdfButton = document.createElement('button'); pdfButton.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> PDF`; pdfButton.className = "py-2 px-3 border border-indigo-200 dark:border-slate-400 rounded-md text-xs font-medium text-white hover:bg-white hover:bg-opacity-20 dark:hover:bg-black dark:hover:bg-opacity-20 focus:outline-none flex items-center"; pdfButton.onclick = exportResultsAsPDF; actionButtonsContainer.appendChild(pdfButton);
                
                resultTabDetails.classList.remove('hidden');
                resultTabSummary.click(); // Reset to summary view
                let tableHTML = '';
                if (lastCalculationData.type && lastCalculationData.type.startsWith('loan')) { tableHTML = generateAmortizationTableHTML(lastCalculationData.principal, lastCalculationData.annualInterestRate, lastCalculationData.years); }
                else if (lastCalculationData.type === 'fv') { tableHTML = generateSavingsTableHTML(lastCalculationData.initialAmount, lastCalculationData.monthlyContribution, lastCalculationData.years, lastCalculationData.annualRate); }
                else if (lastCalculationData.type === 'inf') { tableHTML = generateInflationTableHTML(lastCalculationData.amount, lastCalculationData.yearOfAmount, lastCalculationData.targetYear); }
                else if (lastCalculationData.type === 'dep') { tableHTML = generateDepreciationTableHTML(lastCalculationData.initialAmount, lastCalculationData.inflationRate, lastCalculationData.years); }
                else if (lastCalculationData.type === 'ret') { tableHTML = generateRetirementTableHTML(lastCalculationData); }
                else { resultTabDetails.classList.add('hidden'); }
                detailsContent.innerHTML = tableHTML;
            }

            function copyResultsToClipboard() { const text = `--- Simulation Financière ---\nTitre: ${resultTitle.textContent}\nRésultat: ${resultValue.textContent}\nDétail 1: ${resultSubtitle.textContent}\n` + (resultSubtitle2.textContent ? `Détail 2: ${resultSubtitle2.textContent}\n` : '') + `--------------------------`; const textarea = document.createElement('textarea'); textarea.value = text; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); alert('Résultats copiés dans le presse-papiers !'); }
            
            function getAmortizationDataForPDF(principal, annualInterestRate, years) { const body = []; const monthlyInterestRate = (annualInterestRate / 100) / 12; const numberOfPayments = years * 12; let remainingBalance = principal; const monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1); for (let i = 1; i <= numberOfPayments; i++) { const interestForMonth = remainingBalance * monthlyInterestRate; const principalForMonth = monthlyPayment - interestForMonth; remainingBalance -= principalForMonth; body.push([ i, formatCurrencyForPDF(interestForMonth), formatCurrencyForPDF(principalForMonth), formatCurrencyForPDF(Math.abs(remainingBalance)) ]); } return body; }
            function getSavingsDataForPDF(initial, monthly, years, rate) { const body = []; let capital = initial; const monthlyRate = rate / 100 / 12; for (let i = 1; i <= years; i++) { const startOfYearCapital = capital; for(let j=0; j<12; j++) { capital = (capital * (1 + monthlyRate)) + monthly; } const interestForYear = capital - startOfYearCapital - (monthly * 12); body.push([ i, formatCurrencyForPDF(monthly * 12), formatCurrencyForPDF(interestForYear), formatCurrencyForPDF(capital) ]); } return body; }
            function getInflationDataForPDF(amount, yearOfAmount, targetYear) { const body = []; let currentValue = amount; const start = Math.min(yearOfAmount, targetYear); const end = Math.max(yearOfAmount, targetYear); if (targetYear > yearOfAmount) { for (let year = start; year <= end; year++) { const inflation = year > start ? inflationData[year] : '-'; if (year > start) currentValue *= (1 + inflationData[year] / 100); body.push([year, `${inflation}%`, formatCurrencyForPDF(currentValue)]); } } else { for (let year = end; year >= start; year--) { const inflation = year < end ? inflationData[year + 1] : '-'; const displayValue = year === end ? amount : amount / Array.from({length: end - year}, (_, i) => 1 + inflationData[end - i] / 100).reduce((a, b) => a * b, 1); body.push([year, `${inflation}%`, formatCurrencyForPDF(displayValue)]); } body.reverse(); } return body; }
            function getDepreciationDataForPDF(initialAmount, inflationRate, years) { const body = []; let currentPower = initialAmount; for (let i = 1; i <= years; i++) { const startValue = currentPower; const endValue = startValue / (1 + inflationRate / 100); const loss = startValue - endValue; currentPower = endValue; body.push([i, formatCurrencyForPDF(startValue), formatCurrencyForPDF(loss), formatCurrencyForPDF(currentPower)]); } return body; }
            function getRetirementDataForPDF(data) { const body = []; let capital = data.initialCapital; const monthlyRate = data.preRetRate / 100 / 12; for (let i = 1; i <= (data.retirementAge - data.currentAge); i++) { const startOfYearCapital = capital; for(let j=0; j<12; j++) { capital = (capital * (1 + monthlyRate)) + data.monthlySavings; } const interestForYear = capital - startOfYearCapital - (data.monthlySavings * 12); body.push([ data.currentAge + i, formatCurrencyForPDF(data.monthlySavings * 12), formatCurrencyForPDF(interestForYear), formatCurrencyForPDF(capital) ]); } return body; }

            function exportResultsAsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.text('Simulation Financière', 105, 20, { align: 'center' });
                doc.setFont('helvetica', 'normal'); doc.setFontSize(12); doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 105, 30, { align: 'center' });
                doc.setLineWidth(0.5); doc.line(20, 35, 190, 35);
                doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text(resultTitle.textContent, 20, 50);
                doc.setFontSize(22); doc.text(resultValue.textContent.replace(/\s/g, '').replace('€', ' EUR'), 20, 65);
                doc.setFontSize(11); doc.setFont('helvetica', 'normal'); doc.text(resultSubtitle.textContent.replace(/\s/g, '').replace('€', ' EUR'), 20, 75);
                if (resultSubtitle2.textContent) { doc.text(resultSubtitle2.textContent.replace(/\s/g, '').replace('€', ' EUR'), 20, 82); }
                doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.text('Paramètres de la simulation :', 20, 100);
                doc.setFontSize(11); doc.setFont('helvetica', 'normal');
                let paramsText = ''; const data = lastCalculationData;
                switch(data.type) {
                    case 'loan': paramsText = `Montant du prêt: ${formatCurrencyForPDF(data.principal)}\nTaux annuel: ${data.annualInterestRate}%\nDurée: ${data.years} ans`; break;
                    case 'loan_reverse': paramsText = `Mensualité: ${formatCurrencyForPDF(data.monthlyPayment)}\nTaux annuel: ${data.annualInterestRate}%\nDurée: ${data.years} ans`; break;
                    case 'fv': paramsText = `Montant initial: ${formatCurrencyForPDF(data.initialAmount)}\nVersement mensuel: ${formatCurrencyForPDF(data.monthlyContribution)}\nTaux annuel: ${data.annualRate}%\nDurée: ${data.years} ans\nInflation estimée: ${data.inflation}%`; break;
                    case 'fv_reverse': paramsText = `Montant initial: ${formatCurrencyForPDF(data.initialAmount)}\nObjectif: ${formatCurrencyForPDF(data.targetAmount)}\nTaux annuel: ${data.annualRate}%\nDurée: ${data.years} ans`; break;
                    case 'ret': paramsText = `Capital de départ: ${formatCurrencyForPDF(data.initialCapital)}\nRente mensuelle: ${formatCurrencyForPDF(data.monthlyIncome)}\nÂge actuel: ${data.currentAge} ans\nÂge retraite: ${data.retirementAge} ans\nEspérance de vie: ${data.lifeExpectancy} ans\nRendement avant retraite: ${data.preRetRate}%\nRendement pendant retraite: ${data.postRetRate}%`; break;
                    case 'inf': paramsText = `Montant: ${formatCurrencyForPDF(data.amount)}\nAnnée du montant: ${data.yearOfAmount}\nAnnée de conversion: ${data.targetYear}`; break;
                    case 'dep': paramsText = `Montant initial: ${formatCurrencyForPDF(data.initialAmount)}\nTaux d'inflation: ${data.inflationRate}%\nDurée: ${data.years} ans`; break;
                }
                doc.text(paramsText, 20, 110);
                
                let finalY = 140; 
                const columnStyles = { 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' } };
                if (data.type && data.type.startsWith('loan')) { const body = getAmortizationDataForPDF(data.principal, data.annualInterestRate, data.years); doc.autoTable({ head: [['Mois', 'Intérêts', 'Capital', 'Capital Restant']], body: body, startY: finalY, columnStyles: columnStyles }); } 
                else if (data.type === 'fv') { const body = getSavingsDataForPDF(data.initialAmount, data.monthlyContribution, data.years, data.annualRate); doc.autoTable({ head: [['Année', 'Versements', 'Intérêts Gagnés', 'Capital Final']], body: body, startY: finalY, columnStyles: columnStyles }); } 
                else if (data.type === 'inf') { const body = getInflationDataForPDF(data.amount, data.yearOfAmount, data.targetYear); doc.autoTable({ head: [['Année', 'Taux Inflation', 'Valeur Équivalente']], body: body, startY: finalY, columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' } } }); }
                else if (data.type === 'dep') { const body = getDepreciationDataForPDF(data.initialAmount, data.inflationRate, data.years); doc.autoTable({ head: [['Année', 'Valeur Début', 'Perte Annuelle', 'Pouvoir d\'Achat Final']], body: body, startY: finalY, columnStyles: columnStyles }); }
                else if (data.type === 'ret') { const body = getRetirementDataForPDF(data); doc.autoTable({ head: [['Âge', 'Versements Annuels', 'Intérêts Gagnés', 'Capital Final']], body: body, startY: finalY, columnStyles: columnStyles }); }

                doc.save(`simulation-${activeTabId}-${Date.now()}.pdf`);
            }
            loadState();

            // Add event listeners for result tabs
            resultTabSummary.addEventListener('click', () => {
                summaryContent.classList.remove('hidden');
                detailsContent.classList.add('hidden');
                resultTabSummary.classList.add('border-white');
                resultTabSummary.classList.remove('border-transparent', 'text-indigo-200');
                resultTabDetails.classList.add('border-transparent', 'text-indigo-200');
                resultTabDetails.classList.remove('border-white');
            });
            resultTabDetails.addEventListener('click', () => {
                summaryContent.classList.add('hidden');
                detailsContent.classList.remove('hidden');
                resultTabDetails.classList.add('border-white');
                resultTabDetails.classList.remove('border-transparent', 'text-indigo-200');
                resultTabSummary.classList.add('border-transparent', 'text-indigo-200');
                resultTabSummary.classList.remove('border-white');
            });
        });
    </script>
</body>
</html>

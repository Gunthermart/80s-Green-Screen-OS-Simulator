<!doctype html>
<html lang="fr" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Calculatrice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg-color-light: #f1f3f4;
        --main-bg-color-light: #ffffff;
        --text-color-light: #202124;
        --pretext-color-light: #5f6368;
        --btn-light-bg-light: #f1f3f4;
        --btn-light-hover-bg-light: #e8eaed;
        --btn-fn-bg-light: #dadce0;
        --btn-fn-hover-bg-light: #d0d3d6;
        --btn-primary-bg-light: #4285f4;
        --btn-primary-hover-bg-light: #5a95f5;
        --btn-primary-text-light: #ffffff;
        --border-color-light: #dadce0;
        --shadow-color-1-light: rgba(0,0,0,0.1);
        --shadow-color-2-light: rgba(0,0,0,0.08);

        --bg-color-dark: #202124;
        --main-bg-color-dark: #292a2d;
        --text-color-dark: #e8eaed;
        --pretext-color-dark: #969ba1;
        --btn-light-bg-dark: #3c4043;
        --btn-light-hover-bg-dark: #4c5155;
        --btn-fn-bg-dark: #5f6368;
        --btn-fn-hover-bg-dark: #70757a;
        --btn-primary-bg-dark: #8ab4f8;
        --btn-primary-hover-bg-dark: #9ac0f9;
        --btn-primary-text-dark: #202124;
        --border-color-dark: #5f6368;
        --shadow-color-1-dark: rgba(0,0,0,0.4);
        --shadow-color-2-dark: rgba(0,0,0,0.3);

        --btn-shadow: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
        --btn-active-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.3);
      }
      
      html, body {
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
      }

      body {
        background-color: var(--bg-color-light);
        font-family: 'Roboto', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease;
      }
      body.dark-mode {
        background-color: var(--bg-color-dark);
      }
      
      .main {
        overflow: hidden;
        display: flex;
        flex-direction: column;
        row-gap: 1rem;
        padding: 1rem;
        width: 100%;
        height: 100%;
        background-color: var(--main-bg-color-light);
        transition: all 0.3s ease-in-out;
      }
      
      @media (min-width: 576px) {
        .main {
          max-width: 480px;
          height: auto;
          min-height: 700px;
          max-height: 90vh;
          border-radius: 24px;
          box-shadow: 0 8px 32px var(--shadow-color-1-light), 0 4px 8px 3px var(--shadow-color-2-light);
          border: 1px solid var(--border-color-light);
          padding: 1.5rem;
        }
        body.dark-mode .main {
          box-shadow: 0 8px 32px var(--shadow-color-1-dark), 0 4px 8px 3px var(--shadow-color-2-dark);
          border-color: var(--border-color-dark);
        }
      }

      body.dark-mode .main {
        background-color: var(--main-bg-color-dark);
      }

      .calc-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
      }

      .dynamic-display {
        position: relative;
        flex-grow: 2;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color-light);
        min-height: 100px;
      }
      body.dark-mode .dynamic-display {
        border-bottom-color: var(--border-color-dark);
      }

      #pretext {
        text-align: right;
        font-size: clamp(0.9rem, 4vw, 1.2rem);
        color: var(--pretext-color-light);
        height: auto;
        min-height: 24px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-family: 'Roboto Mono', monospace;
      }
      body.dark-mode #pretext { color: var(--pretext-color-dark); }
      
      input#text-input {
        text-align: right;
        font-size: clamp(2.5rem, 12vw, 3.5rem);
        font-weight: 500;
        border: none;
        padding: 0;
        background-color: transparent;
        color: var(--text-color-light);
        box-shadow: none !important;
        font-family: 'Roboto Mono', monospace;
        height: auto;
      }
      body.dark-mode input#text-input { color: var(--text-color-dark); }
      
      .meta-controls {
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        padding: 0.5rem 0;
      }
      .form-check-label{
          color: var(--pretext-color-light);
      }
      body.dark-mode .form-check-label { color: var(--pretext-color-dark); }
      
      .nav-pills .nav-link {
        padding: 0.25rem 0.75rem;
        color: var(--pretext-color-light);
        font-weight: 500;
        border-radius: 100px;
      }
      body.dark-mode .nav-pills .nav-link { color: var(--pretext-color-dark); }

      .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
        color: var(--btn-primary-text-light);
        background-color: var(--btn-primary-bg-light);
      }
      body.dark-mode .nav-pills .nav-link.active, body.dark-mode .nav-pills .show > .nav-link {
        color: var(--btn-primary-text-dark);
        background-color: var(--btn-primary-bg-dark);
      }

      .tab-content {
        flex-grow: 5;
        flex-shrink: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .tab-pane, .input-panel {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .keypad-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(5, 1fr);
        gap: clamp(0.5rem, 2vw, 0.75rem);
        height: 100%;
      }
      .keypad-grid .btn {
        font-size: clamp(1rem, 4vw, 1.2rem);
        font-weight: 500;
        border-radius: 8px;
        border: none;
        box-shadow: var(--btn-shadow);
        transition: box-shadow 0.1s ease, transform 0.1s ease, background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-family: 'Roboto Mono', monospace;
      }
       .keypad-grid .btn:active {
        box-shadow: var(--btn-active-shadow);
        transform: translateY(1px);
      }
      .btn-light {
        background-color: var(--btn-light-bg-light);
        color: var(--text-color-light);
      }
      .btn-light:hover { background-color: var(--btn-light-hover-bg-light); }
      body.dark-mode .btn-light { background-color: var(--btn-light-bg-dark); color: var(--text-color-dark); }
      body.dark-mode .btn-light:hover { background-color: var(--btn-light-hover-bg-dark); }

      .btn-fn {
        background-color: var(--btn-fn-bg-light);
        color: var(--text-color-light);
      }
      .btn-fn:hover { background-color: var(--btn-fn-hover-bg-light); }
      body.dark-mode .btn-fn { background-color: var(--btn-fn-bg-dark); color: var(--text-color-dark); }
      body.dark-mode .btn-fn:hover { background-color: var(--btn-fn-hover-bg-dark); }

      .btn-primary {
        background-color: var(--btn-primary-bg-light);
        border-color: var(--btn-primary-bg-light);
        color: var(--btn-primary-text-light);
      }
      .btn-primary:hover {
        background-color: var(--btn-primary-hover-bg-light);
        border-color: var(--btn-primary-hover-bg-light);
      }
      body.dark-mode .btn-primary { background-color: var(--btn-primary-bg-dark); border-color: var(--btn-primary-bg-dark); color: var(--btn-primary-text-dark); }
      body.dark-mode .btn-primary:hover { background-color: var(--btn-primary-hover-bg-dark); border-color: var(--btn-primary-hover-bg-dark); }

      .f-container {
          position: relative;
          width: 100%;
          height: 100%;
      }
      .f1, .f2 {
          width: 100%;
          height: 100%;
          position: absolute;
          top: 0;
          left: 0;
      }
      
      .notification {
        border-radius: 5px;
        padding: 0.15rem 0.5rem;
        background-color: #fdd835;
        color: #202124;
        position: absolute;
        right: 8px;
        top: -30px;
        white-space: nowrap;
        animation: slideInRight 0.3s forwards;
      }
      .history-panel {
        font-size: 1rem;
        color: var(--text-color-light);
        overflow-y: auto;
      }
      body.dark-mode .history-panel { color: var(--text-color-dark); }
      .no-history {
        color: var(--pretext-color-light);
        text-align: center;
        padding: 2rem;
      }
      body.dark-mode .no-history { color: var(--pretext-color-dark); }
      .hist-item {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
      }
      .hist-item .timestamp {
        color: var(--pretext-color-light);
      }
       .hist-item button {
        color: var(--text-color-light) !important;
        background-color: var(--btn-light-bg-light);
       }
      body.dark-mode .hist-item .timestamp { color: var(--pretext-color-dark); }
      body.dark-mode .hist-item button { color: var(--text-color-dark) !important; background-color: var(--btn-light-bg-dark); }
      
      #theme-toggle {
          cursor: pointer;
          width: 24px;
          height: 24px;
          color: var(--pretext-color-light);
      }
      body.dark-mode #theme-toggle { color: var(--pretext-color-dark); }
      #theme-toggle:hover { color: var(--text-color-light); }
      body.dark-mode #theme-toggle:hover { color: var(--text-color-dark); }
    </style>
  </head>
  <body>
    <div class="main">
      <div class="calc-body">
        <div class="dynamic-display">
          <span id="pretext"></span>
          <input id="text-input" class="form-control" placeholder="0" autofocus />
        </div>
        <div class="hstack gap-3 meta-controls">
          <div style="width: 80px;" class="text-start">
             <svg id="theme-toggle" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          </div>
          <nav class="nav nav-pills mx-auto">
            <a class="nav-link active" id="keypad-tab" data-bs-toggle="tab" data-bs-target="#keypad-content" type="button" role="tab" aria-controls="keypad-content" aria-selected="true">Clavier</a>
            <a class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-content" type="button" role="tab" aria-controls="history-content" aria-selected="false">Historique</a>
          </nav>
          <div style="width: 80px;" class="text-end">
               <span class="notification d-none"></span>
          </div>
        </div>
        <div class="tab-content">
          <div class="tab-pane active show" id="keypad-content" role="tabpanel" aria-labelledby="keypad-tab" tabindex="0">
            <div class="input-panel h-100">
               <div class="keypad-grid h-100">
                  <!-- Row 1 -->
                  <div class="f-container"><button class="btn btn-fn f1" data-value="sin(">sin</button><button class="btn btn-fn f2 d-none" data-value="asin(">sin<sup>-1</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="cos(">cos</button><button class="btn btn-fn f2 d-none" data-value="acos(">cos<sup>-1</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="tan(">tan</button><button class="btn btn-fn f2 d-none" data-value="atan(">tan<sup>-1</sup></button></div>
                  <button class="btn btn-fn" data-value="(">(</button>
                  <button class="btn btn-fn" data-value=")">)</button>
                  <button class="btn btn-fn" data-value="%">%</button>
                  <button class="btn btn-fn" data-value="AC">AC</button>
                  
                  <!-- Row 2 -->
                  <div class="f-container"><button class="btn btn-fn f1" data-value="log(">log</button><button class="btn btn-fn f2 d-none" data-value="10^">10<sup>x</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="ln(">ln</button><button class="btn btn-fn f2 d-none" data-value="e^">e<sup>x</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="^">x<sup>y</sup></button><button class="btn btn-fn f2 d-none" data-value="^(1/"><sup>y</sup>√x</button></div>
                  <button class="btn btn-light" data-value="7">7</button>
                  <button class="btn btn-light" data-value="8">8</button>
                  <button class="btn btn-light" data-value="9">9</button>
                  <button class="btn btn-fn" data-value="÷">÷</button>

                  <!-- Row 3 -->
                  <button class="btn btn-fn" data-value="π">π</button>
                  <button class="btn btn-fn" data-value="!">x!</button>
                  <button class="btn btn-fn" data-value="^2">x<sup>2</sup></button>
                  <button class="btn btn-light" data-value="4">4</button>
                  <button class="btn btn-light" data-value="5">5</button>
                  <button class="btn btn-light" data-value="6">6</button>
                  <button class="btn btn-fn" data-value="×">×</button>

                  <!-- Row 4 -->
                   <button class="btn btn-fn" data-value="e">e</button>
                   <button class="btn btn-fn" data-value=" mod ">mod</button>
                   <button class="btn btn-fn" data-value="sqrt(">√</button>
                   <button class="btn btn-light" data-value="1">1</button>
                   <button class="btn btn-light" data-value="2">2</button>
                   <button class="btn btn-light" data-value="3">3</button>
                   <button class="btn btn-fn" data-value="−">−</button>
                  
                  <!-- Row 5 -->
                   <button class="btn btn-fn" data-value="Ans">Ans</button>
                   <button class="btn btn-light fn rad" data-value="Rad">Rad</button>
                   <button class="btn btn-light fn deg" data-value="Deg" disabled>Deg</button>
                   <button class="btn btn-light" data-value="0">0</button>
                   <button class="btn btn-light" data-value=".">.</button>
                   <button class="btn btn-primary" data-value="=">=</button>
                   <button class="btn btn-fn" data-value="+">+</button>
               </div>
            </div>
          </div>
          <div class="tab-pane" id="history-content" role="tabpanel" aria-labelledby="history-tab" tabindex="0">
            <div class="vstack gap-2 history-panel text-end">
              <div class="no-history">Vos calculs et résultats apparaissent ici pour que vous puissiez les réutiliser.</div>
              <div class="history-item-template">
                <span class="timestamp" style="font-size: 12px; margin-right: 10px;">timestamp</span>
                <button class="btn btn-light border border-secondary-subtle">expression</button>
                <span>=</span>
                <button class="btn btn-light border border-secondary-subtle">result</button>
              </div>
            </div>
          </div>
          <div class="form-check form-switch d-flex align-items-center justify-content-center p-2">
              <input class="form-check-input" type="checkbox" role="switch" id="invSwitch" />
              <label class="form-check-label" for="invSwitch">Inv</label>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.1/math.min.js"></script>
    <script>
      // angles-config.js content
      let replacements = {};
      window.angle = "deg";
      math.config({ predictable: true });
      const fns1 = ["sin", "cos", "tan", "sec", "cot", "csc"];
      fns1.forEach(function (name) {
        const fn = math[name];
        const fnNumber = function (x) {
          switch (window.angle) {
            case "deg": return fn((x / 360) * 2 * Math.PI);
            case "grad": return fn((x / 400) * 2 * Math.PI);
            default: return fn(x);
          }
        };
        replacements[name] = math.typed(name, { number: fnNumber, "Array | Matrix": function (x) { return math.map(x, fnNumber); } });
      });
      const fns2 = ["asin", "acos", "atan", "atan2", "acot", "acsc", "asec"];
      fns2.forEach(function (name) {
        const fn = math[name];
        const fnNumber = function (x) {
          const result = fn(x);
          if (typeof result === "number") {
            switch (window.angle) {
              case "deg": return (result / 2 / Math.PI) * 360;
              case "grad": return (result / 2 / Math.PI) * 400;
              default: return result;
            }
          }
          return result;
        };
        replacements[name] = math.typed(name, { number: fnNumber, "Array | Matrix": function (x) { return math.map(x, fnNumber); } });
      });
      math.import(replacements, { override: true });

      // calc.js content
      let lastAns = "";
      let prevInput = "";
      let history = [];
      let evalScope = {};
      let operators = ["+", "−", "×", "÷", "%", "!"];

      function fmtInput(line) {
        return line
          .replaceAll("−", "-")
          .replaceAll("×", "*")
          .replaceAll("÷", "/")
          .replaceAll("π", "pi")
          .replaceAll("log(", "log10(")
          .replaceAll("ln(", "log(")
          .replaceAll("Ans", lastAns);
      }

      function addToHistory(time, expression, result) {
        let nohistory = document.querySelector(".no-history");
        if (nohistory && !nohistory.classList.contains("d-none")) { nohistory.classList.add("d-none"); }
        let template = document.querySelector(".history-item-template");
        let parent = template.parentElement;
        template = template.cloneNode(true);
        template.classList.remove("history-item-template");
        template.classList.add("hist-item");
        
        template.querySelector('.timestamp').textContent = time;
        const buttons = template.querySelectorAll('button');
        buttons[0].textContent = expression;
        buttons[1].textContent = result;

        template.querySelectorAll("button").forEach((b) =>
          b.addEventListener("click", (e) => {
            document.querySelector("input#text-input").value = e.target.innerText;
          })
        );
        parent.prepend(template);
      }

      function evaluateInput(line) {
        line = fmtInput(line);
        let res = "";
        try {
          res = math.format(math.evaluate(line, evalScope), { precision: 14 });
        } catch (e) {
          showNotification(e.message);
          return "";
        }
        return res;
      }

      function handleClick(text) {
        let isOperator = operators.includes(text);
        let input = document.querySelector("input#text-input");
        let pretext = document.querySelector("span#pretext");

        if (prevInput === "=" && !isOperator && text !== "=") {
          pretext.innerText = "Ans = " + lastAns;
          input.value = "";
        }

        switch (text) {
          case "=":
            if(input.value) {
                let ans = evaluateInput(input.value);
                if (ans !== "") {
                  const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                  addToHistory(time, input.value, ans);
                  history.push({ timestamp: Date.now(), expression: input.value, result: ans });
                  pretext.innerText = input.value + " =";
                  setInput(input, ans);
                  lastAns = ans;
                  input.classList.remove("border-danger");
                } else {
                  input.classList.add("border-danger");
                }
            }
            break;
          case "AC":
            input.value = "";
            pretext.innerText = "";
            lastAns = "";
            break;
          case "Rad":
            window.angle = "rad";
            document.querySelector(".btn.rad").disabled = true;
            document.querySelector(".btn.deg").disabled = false;
            showNotification("Angles réglés sur les radians");
            break;
          case "Deg":
            window.angle = "deg";
            document.querySelector(".btn.deg").disabled = true;
            document.querySelector(".btn.rad").disabled = false;
            showNotification("Angles réglés sur les degrés");
            break;
          default:
            insertValue(input, text);
        }
        prevInput = text;
      }

      function insertValue(input, text) {
        const caretPos = input.selectionStart;
        input.value =
          input.value.slice(0, caretPos) + text + input.value.slice(caretPos);
        input.focus({ focusVisible: true });
        input.setSelectionRange(caretPos + text.length, caretPos + text.length);
      }

      function setInput(input, text) {
        input.value = text;
        input.focus({ focusVisible: true });
        setTimeout(() => { input.selectionStart = input.selectionEnd = 10000; }, 0);
      }

      function showNotification(text, duration = 2500) {
        const notifEl = document.querySelector(".notification");
        notifEl.innerText = text;
        notifEl.classList.remove("d-none");
        setTimeout(() => {
          notifEl.classList.add("d-none");
        }, duration);
      }
      
      document.querySelectorAll(".keypad-grid button, .f-container button").forEach((button) => {
        button.addEventListener("click", (e) => {
           if(e.currentTarget.dataset.value) {
               handleClick(e.currentTarget.dataset.value);
           }
        });
      });

      document.querySelector("body").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          handleClick("=");
        }
      });

      document.querySelector("#invSwitch").addEventListener("change", (e) => {
        document.querySelectorAll(".btn.f2").forEach((b) => {
          e.target.checked ? b.classList.remove("d-none") : b.classList.add("d-none");
        });
        document.querySelectorAll(".btn.f1").forEach((b) => {
          e.target.checked ? b.classList.add("d-none") : b.classList.remove("d-none");
        });
      });
      
      const tabEl = document.querySelector('a[data-bs-target="#history-content"]');
      if (tabEl) {
        tabEl.addEventListener("show.bs.tab", (event) => {
            if (history.length === 0) return;
            document.querySelectorAll(".hist-item").forEach((i) => i.remove());
            let rtf = new Intl.RelativeTimeFormat(window.navigator.language || 'fr', { numeric: 'auto' });
            history.forEach((h) => {
                const timeDiff = Math.floor((h.timestamp - Date.now()) / 1000);
                let rtime = "";
                if (timeDiff < -3600) {
                  rtime = rtf.format(Math.floor(timeDiff / 3600), "hours");
                } else if (timeDiff < -60) {
                  rtime = rtf.format(Math.floor(timeDiff / 60), "minutes");
                } else {
                  rtime = rtf.format(timeDiff, "seconds");
                }
                addToHistory(rtime, h.expression, h.result);
            });
        });
      }

      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle');
      const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
      const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

      themeToggle.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          if (document.body.classList.contains('dark-mode')) {
              themeToggle.innerHTML = sunIcon;
          } else {
              themeToggle.innerHTML = moonIcon;
          }
      });
      
      // Set initial theme
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.body.classList.add('dark-mode');
          themeToggle.innerHTML = sunIcon;
      } else {
          themeToggle.innerHTML = moonIcon;
      }
    </script>
  </body>
</html>


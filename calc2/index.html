<!doctype html>
<html lang="fr" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Calculatrice Flottante</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg-color: #202124;
        --main-bg-color: #292a2d;
        --text-color: #e8eaed;
        --pretext-color: #969ba1;
        --btn-light-bg: #3c4043;
        --btn-light-hover-bg: #4c5155;
        --btn-fn-bg: #5f6368;
        --btn-fn-hover-bg: #70757a;
        --btn-primary-bg: #8ab4f8;
        --btn-primary-hover-bg: #9ac0f9;
        --border-color: #5f6368;
        --shadow-color-1: rgba(0,0,0,0.4);
        --shadow-color-2: rgba(0,0,0,0.3);
        --btn-shadow: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
        --btn-active-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.3);
      }

      html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background-color: transparent; /* Make body background transparent */
        font-family: 'Roboto', sans-serif;
      }
      
      .main {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.6);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        row-gap: 1rem;
        padding: 0;
        width: 100%;
        max-width: 680px; 
        height: auto;
        min-height: 600px;
        background-color: var(--main-bg-color);
        border-radius: 12px;
        box-shadow: 0 8px 32px var(--shadow-color-1), 0 4px 8px 3px var(--shadow-color-2);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease-in-out;
      }
      .title-bar {
        background-color: #3c4043;
        color: #e8eaed;
        padding: 8px 12px;
        cursor: move;
        display: flex;
        align-items: center;
        user-select: none;
        position: relative;
        justify-content: center;
      }
      .window-controls {
        display: flex;
        gap: 8px;
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
      }
      .dot {
        height: 12px;
        width: 12px;
        border-radius: 50%;
        cursor: pointer;
      }
      .dot.red { background-color: #ff5f57; }
      .dot.yellow { background-color: #febc2e; }
      .dot.green { background-color: #28c840; }
      .title {
        font-family: 'Roboto Mono', monospace;
        text-align: center;
        flex-grow: 1;
      }
      .calc-body {
        padding: 0 1.5rem 1.5rem 1.5rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        transition: opacity 0.2s ease-in-out;
      }
      .main.minimized {
          top: auto !important;
          left: 20px !important;
          bottom: 20px !important;
          right: auto !important;
          transform: scale(0.6) !important;
          height: 48px;
          min-height: 48px;
          width: 250px;
          max-width: 250px;
      }

      .main.minimized .calc-body {
          display: none;
      }

      .dynamic-display {
        position: relative;
        flex-grow: 1;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        min-height: 80px;
      }
      #pretext {
        text-align: right;
        font-size: 1rem;
        color: var(--pretext-color);
        height: 24px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-family: 'Roboto Mono', monospace;
      }
      input#text-input {
        text-align: right;
        font-size: 3rem;
        font-weight: 500;
        border: none;
        padding: 0;
        background-color: transparent;
        color: var(--text-color);
        box-shadow: none !important;
        font-family: 'Roboto Mono', monospace;
      }
      .meta-controls {
        align-items: center;
        justify-content: space-between;
      }
       .form-check-label{
          color: var(--pretext-color);
      }
      .nav-pills .nav-link {
        padding: 0.25rem 0.75rem;
        color: var(--pretext-color);
        font-weight: 500;
        border-radius: 100px;
      }
      .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
        color: #202124;
        background-color: #8ab4f8;
      }
      .tab-content {
        flex-grow: 3;
        flex-shrink: 1;
        overflow: hidden;
      }
      .tab-pane, .input-panel {
        height: 100%;
      }
      .keypad-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(5, 1fr);
        gap: 0.75rem;
        height: 100%;
      }
      .keypad-grid .btn {
        font-size: 1.1rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        box-shadow: var(--btn-shadow);
        transition: box-shadow 0.1s ease, transform 0.1s ease, background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-family: 'Roboto Mono', monospace;
      }
       .keypad-grid .btn:active {
        box-shadow: var(--btn-active-shadow);
        transform: translateY(1px);
      }
      .btn-light {
        background-color: var(--btn-light-bg);
        color: var(--text-color);
      }
      .btn-light:hover {
        background-color: var(--btn-light-hover-bg);
      }
      .btn-fn {
        background-color: var(--btn-fn-bg);
        color: var(--text-color);
      }
       .btn-fn:hover {
        background-color: var(--btn-fn-hover-bg);
      }
      .btn-primary {
        background-color: var(--btn-primary-bg);
        border-color: var(--btn-primary-bg);
        color: #202124;
      }
      .btn-primary:hover {
        background-color: var(--btn-primary-hover-bg);
        border-color: var(--btn-primary-hover-bg);
      }
      .f-container {
          position: relative;
          width: 100%;
          height: 100%;
      }
      .f1, .f2 {
          width: 100%;
          height: 100%;
          position: absolute;
          top: 0;
          left: 0;
      }
      
      .notification {
        border-radius: 5px;
        padding: 0.15rem 0.5rem;
        background-color: #fdd835;
        color: #202124;
        position: absolute;
        right: 8px;
        top: -30px;
        white-space: nowrap;
        animation: slideInRight 0.3s forwards;
      }
      .history-panel {
        font-size: 1rem;
        color: var(--text-color);
      }
      .no-history {
        color: var(--pretext-color);
        text-align: center;
        padding: 2rem;
      }
      .hist-item {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
      }
      .hist-item .timestamp {
        color: var(--pretext-color);
      }
       .hist-item button {
        color: var(--text-color) !important;
        background-color: var(--btn-light-bg);
       }
    </style>
  </head>
  <body class="dark-mode">
    <div class="main">
      <div class="title-bar">
         <div class="window-controls">
            <div class="dot red"></div>
            <div class="dot yellow" id="minimize-btn"></div>
            <div class="dot green"></div>
        </div>
        <div class="title">Calculatrice</div>
      </div>
      <div class="calc-body">
        <div class="dynamic-display">
          <span id="pretext"></span>
          <input id="text-input" class="form-control" placeholder="0" autofocus />
        </div>
        <div class="hstack gap-3 meta-controls">
          
          <nav class="nav nav-pills mx-auto">
            <a class="nav-link active" id="keypad-tab" data-bs-toggle="tab" data-bs-target="#keypad-content" type="button" role="tab" aria-controls="keypad-content" aria-selected="true">Clavier</a>
            <a class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-content" type="button" role="tab" aria-controls="history-content" aria-selected="false">Historique</a>
          </nav>
          <div style="width: 80px;" class="text-end">
               <span class="notification d-none"></span>
          </div>
        </div>
        <div class="tab-content">
          <div class="tab-pane active show" id="keypad-content" role="tabpanel" aria-labelledby="keypad-tab" tabindex="0">
            <div class="input-panel h-100">
               <div class="keypad-grid h-100">
                  <!-- Row 1 -->
                  <div class="f-container"><button class="btn btn-fn f1" data-value="sin(">sin</button><button class="btn btn-fn f2 d-none" data-value="asin(">sin<sup>-1</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="cos(">cos</button><button class="btn btn-fn f2 d-none" data-value="acos(">cos<sup>-1</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="tan(">tan</button><button class="btn btn-fn f2 d-none" data-value="atan(">tan<sup>-1</sup></button></div>
                  <button class="btn btn-fn" data-value="(">(</button>
                  <button class="btn btn-fn" data-value=")">)</button>
                  <button class="btn btn-fn" data-value="%">%</button>
                  <button class="btn btn-fn" data-value="AC">AC</button>
                  
                  <!-- Row 2 -->
                  <div class="f-container"><button class="btn btn-fn f1" data-value="log(">log</button><button class="btn btn-fn f2 d-none" data-value="10^">10<sup>x</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="ln(">ln</button><button class="btn btn-fn f2 d-none" data-value="e^">e<sup>x</sup></button></div>
                  <div class="f-container"><button class="btn btn-fn f1" data-value="^">x<sup>y</sup></button><button class="btn btn-fn f2 d-none" data-value="^(1/"><sup>y</sup>√x</button></div>
                  <button class="btn btn-light" data-value="7">7</button>
                  <button class="btn btn-light" data-value="8">8</button>
                  <button class="btn btn-light" data-value="9">9</button>
                  <button class="btn btn-fn" data-value="÷">÷</button>

                  <!-- Row 3 -->
                  <button class="btn btn-fn" data-value="π">π</button>
                  <button class="btn btn-fn" data-value="!">x!</button>
                  <button class="btn btn-fn" data-value="^2">x<sup>2</sup></button>
                  <button class="btn btn-light" data-value="4">4</button>
                  <button class="btn btn-light" data-value="5">5</button>
                  <button class="btn btn-light" data-value="6">6</button>
                  <button class="btn btn-fn" data-value="×">×</button>

                  <!-- Row 4 -->
                   <button class="btn btn-fn" data-value="e">e</button>
                   <button class="btn btn-fn" data-value=" mod ">mod</button>
                   <button class="btn btn-fn" data-value="sqrt(">√</button>
                   <button class="btn btn-light" data-value="1">1</button>
                   <button class="btn btn-light" data-value="2">2</button>
                   <button class="btn btn-light" data-value="3">3</button>
                   <button class="btn btn-fn" data-value="−">−</button>
                  
                  <!-- Row 5 -->
                   <button class="btn btn-fn" data-value="Ans">Ans</button>
                   <button class="btn btn-light fn rad" data-value="Rad">Rad</button>
                   <button class="btn btn-light fn deg" data-value="Deg" disabled>Deg</button>
                   <button class="btn btn-light" data-value="0">0</button>
                   <button class="btn btn-light" data-value=".">.</button>
                   <button class="btn btn-primary" data-value="=">=</button>
                   <button class="btn btn-fn" data-value="+">+</button>
               </div>
            </div>
          </div>
          <div class="tab-pane" id="history-content" role="tabpanel" aria-labelledby="history-tab" tabindex="0">
            <div class="vstack gap-2 history-panel text-end">
              <div class="no-history">Vos calculs et résultats apparaissent ici pour que vous puissiez les réutiliser.</div>
              <div class="history-item-template">
                <span class="timestamp" style="font-size: 12px; margin-right: 10px;">timestamp</span>
                <button class="btn btn-light border border-secondary-subtle">expression</button>
                <span>=</span>
                <button class="btn btn-light border border-secondary-subtle">result</button>
              </div>
            </div>
          </div>
          <div class="form-check form-switch d-flex align-items-center justify-content-center p-2">
              <input class="form-check-input" type="checkbox" role="switch" id="invSwitch" />
              <label class="form-check-label" for="invSwitch">Inv</label>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.1/math.min.js"></script>
    <script>
      // angles-config.js content
      let replacements = {};
      window.angle = "deg";
      math.config({ predictable: true });
      const fns1 = ["sin", "cos", "tan", "sec", "cot", "csc"];
      fns1.forEach(function (name) {
        const fn = math[name];
        const fnNumber = function (x) {
          switch (window.angle) {
            case "deg": return fn((x / 360) * 2 * Math.PI);
            case "grad": return fn((x / 400) * 2 * Math.PI);
            default: return fn(x);
          }
        };
        replacements[name] = math.typed(name, { number: fnNumber, "Array | Matrix": function (x) { return math.map(x, fnNumber); } });
      });
      const fns2 = ["asin", "acos", "atan", "atan2", "acot", "acsc", "asec"];
      fns2.forEach(function (name) {
        const fn = math[name];
        const fnNumber = function (x) {
          const result = fn(x);
          if (typeof result === "number") {
            switch (window.angle) {
              case "deg": return (result / 2 / Math.PI) * 360;
              case "grad": return (result / 2 / Math.PI) * 400;
              default: return result;
            }
          }
          return result;
        };
        replacements[name] = math.typed(name, { number: fnNumber, "Array | Matrix": function (x) { return math.map(x, fnNumber); } });
      });
      math.import(replacements, { override: true });

      // calc.js content
      let lastAns = "";
      let prevInput = "";
      let history = [];
      let evalScope = {};
      let operators = ["+", "−", "×", "÷", "%", "!"];

      function fmtInput(line) {
        return line
          .replaceAll("−", "-")
          .replaceAll("×", "*")
          .replaceAll("÷", "/")
          .replaceAll("π", "pi")
          .replaceAll("log(", "log10(")
          .replaceAll("ln(", "log(")
          .replaceAll("Ans", lastAns);
      }

      function addToHistory(time, expression, result) {
        let nohistory = document.querySelector(".no-history");
        if (nohistory && !nohistory.classList.contains("d-none")) { nohistory.classList.add("d-none"); }
        let template = document.querySelector(".history-item-template");
        let parent = template.parentElement;
        template = template.cloneNode(true);
        template.classList.remove("history-item-template");
        template.classList.add("hist-item");
        
        template.querySelector('.timestamp').textContent = time;
        const buttons = template.querySelectorAll('button');
        buttons[0].textContent = expression;
        buttons[1].textContent = result;

        template.querySelectorAll("button").forEach((b) =>
          b.addEventListener("click", (e) => {
            document.querySelector("input#text-input").value = e.target.innerText;
          })
        );
        parent.prepend(template);
      }

      function evaluateInput(line) {
        line = fmtInput(line);
        let res = "";
        try {
          res = math.format(math.evaluate(line, evalScope), { precision: 14 });
        } catch (e) {
          showNotification(e.message);
          return "";
        }
        return res;
      }

      function handleClick(text) {
        let isOperator = operators.includes(text);
        let input = document.querySelector("input#text-input");
        let pretext = document.querySelector("span#pretext");

        if (prevInput === "=" && !isOperator && text !== "=") {
          pretext.innerText = "Ans = " + lastAns;
          input.value = "";
        }

        switch (text) {
          case "=":
            if(input.value) {
                let ans = evaluateInput(input.value);
                if (ans !== "") {
                  const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                  addToHistory(time, input.value, ans);
                  history.push({ timestamp: Date.now(), expression: input.value, result: ans });
                  pretext.innerText = input.value + " =";
                  setInput(input, ans);
                  lastAns = ans;
                  input.classList.remove("border-danger");
                } else {
                  input.classList.add("border-danger");
                }
            }
            break;
          case "AC":
            input.value = "";
            pretext.innerText = "";
            lastAns = "";
            break;
          case "Rad":
            window.angle = "rad";
            document.querySelector(".btn.rad").disabled = true;
            document.querySelector(".btn.deg").disabled = false;
            showNotification("Angles réglés sur les radians");
            break;
          case "Deg":
            window.angle = "deg";
            document.querySelector(".btn.deg").disabled = true;
            document.querySelector(".btn.rad").disabled = false;
            showNotification("Angles réglés sur les degrés");
            break;
          default:
            insertValue(input, text);
        }
        prevInput = text;
      }

      function insertValue(input, text) {
        const caretPos = input.selectionStart;
        input.value =
          input.value.slice(0, caretPos) + text + input.value.slice(caretPos);
        input.focus({ focusVisible: true });
        input.setSelectionRange(caretPos + text.length, caretPos + text.length);
      }

      function setInput(input, text) {
        input.value = text;
        input.focus({ focusVisible: true });
        setTimeout(() => { input.selectionStart = input.selectionEnd = 10000; }, 0);
      }

      function showNotification(text, duration = 2500) {
        const notifEl = document.querySelector(".notification");
        notifEl.innerText = text;
        notifEl.classList.remove("d-none");
        setTimeout(() => {
          notifEl.classList.add("d-none");
        }, duration);
      }
      
      document.querySelectorAll(".keypad-grid button, .f-container button").forEach((button) => {
        button.addEventListener("click", (e) => {
           if(e.currentTarget.dataset.value) {
               handleClick(e.currentTarget.dataset.value);
           }
        });
      });

      document.querySelector("body").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          handleClick("=");
        }
      });

      document.querySelector("#invSwitch").addEventListener("change", (e) => {
        document.querySelectorAll(".btn.f2").forEach((b) => {
          e.target.checked ? b.classList.remove("d-none") : b.classList.add("d-none");
        });
        document.querySelectorAll(".btn.f1").forEach((b) => {
          e.target.checked ? b.classList.add("d-none") : b.classList.remove("d-none");
        });
      });
      
      const tabEl = document.querySelector('a[data-bs-target="#history-content"]');
      if (tabEl) {
        tabEl.addEventListener("show.bs.tab", (event) => {
            if (history.length === 0) return;
            document.querySelectorAll(".hist-item").forEach((i) => i.remove());
            let rtf = new Intl.RelativeTimeFormat(window.navigator.language || 'fr', { numeric: 'auto' });
            history.forEach((h) => {
                const timeDiff = Math.floor((h.timestamp - Date.now()) / 1000);
                let rtime = "";
                if (timeDiff < -3600) {
                  rtime = rtf.format(Math.floor(timeDiff / 3600), "hours");
                } else if (timeDiff < -60) {
                  rtime = rtf.format(Math.floor(timeDiff / 60), "minutes");
                } else {
                  rtime = rtf.format(timeDiff, "seconds");
                }
                addToHistory(rtime, h.expression, h.result);
            });
        });
      }

      // Dragging logic
      const dragElement = document.querySelector('.main');
      const header = document.querySelector('.title-bar');
      const minimizeBtn = document.getElementById('minimize-btn');

      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      let isFirstDrag = true;

      function dragStart(e) {
        if (dragElement.classList.contains('minimized')) {
            toggleMinimize();
            return;
        }

        e.preventDefault();
        
        if (isFirstDrag) {
            const rect = dragElement.getBoundingClientRect();
            dragElement.style.left = `${rect.left}px`;
            dragElement.style.top = `${rect.top}px`;
            dragElement.style.transform = 'scale(0.6)';
            isFirstDrag = false;
        }

        const touch = e.type === 'touchstart';
        pos3 = touch ? e.touches[0].clientX : e.clientX;
        pos4 = touch ? e.touches[0].clientY : e.clientY;

        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);

        document.addEventListener('mousemove', elementDrag);
        document.addEventListener('touchmove', elementDrag, { passive: false });
        
        header.style.cursor = 'grabbing';
      }

      function elementDrag(e) {
        e.preventDefault();
        
        const touch = e.type === 'touchmove';
        const clientX = touch ? e.touches[0].clientX : e.clientX;
        const clientY = touch ? e.touches[0].clientY : e.clientY;

        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;

        requestAnimationFrame(() => {
          dragElement.style.top = (dragElement.offsetTop - pos2) + "px";
          dragElement.style.left = (dragElement.offsetLeft - pos1) + "px";
        });
      }

      function dragEnd() {
        document.removeEventListener('mouseup', dragEnd);
        document.removeEventListener('touchend', dragEnd);
        document.removeEventListener('mousemove', elementDrag);
        document.removeEventListener('touchmove', elementDrag);
        
        header.style.cursor = 'move';
      }

      function toggleMinimize() {
        if (!dragElement.classList.contains('minimized') && isFirstDrag) {
            const rect = dragElement.getBoundingClientRect();
            dragElement.style.left = `${rect.left}px`;
            dragElement.style.top = `${rect.top}px`;
            dragElement.style.transform = 'scale(0.6)';
            isFirstDrag = false;
        }
        dragElement.classList.toggle('minimized');
      }

      if (header) {
        header.addEventListener('mousedown', dragStart);
        header.addEventListener('touchstart', dragStart, { passive: false });
      }

      if (minimizeBtn) {
        minimizeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // prevent dragStart from firing
            toggleMinimize();
        });
      }

    </script>
  </body>
</html>


import React, { useState, useEffect, useRef } from 'react';
import { Terminal, Shield, X, Activity, BarChart3, LayoutGrid, Maximize2, AlertTriangle, Octagon, Trash2, Database, Zap, Send, MessageSquare, Radar, Cpu, Grid, Lock, Target, Scan, Globe, Crosshair } from 'lucide-react';

/* --- UTILS --- */
const getCurrentTime = () => {
  const now = new Date();
  return now.toLocaleTimeString('fr-FR', { hour12: false });
};

/* --- COMPONENTS --- */

// 1. SNIPER HUD
const SniperHUD = () => {
  const [pos, setPos] = useState({ x: 0, y: 0 });
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const handleMove = (e) => {
      setPos({ x: e.clientX, y: e.clientY });
      if (!visible) setVisible(true);
    };
    window.addEventListener('mousemove', handleMove);
    return () => window.removeEventListener('mousemove', handleMove);
  }, [visible]);

  if (!visible) return null;

  return (
    <div className="pointer-events-none fixed inset-0 z-[60] overflow-hidden mix-blend-difference">
      <div className="absolute top-0 w-[1px] h-full bg-emerald-500/40" style={{ left: pos.x }} />
      <div className="absolute left-0 h-[1px] w-full bg-emerald-500/40" style={{ top: pos.y }} />
      <div className="absolute text-[9px] font-mono text-emerald-400 bg-black/80 px-1 border border-emerald-500/50" style={{ left: pos.x + 10, top: pos.y + 10 }}>X:{pos.x} Y:{pos.y}</div>
      <div className="absolute w-4 h-4 border border-emerald-500/80" style={{ left: pos.x - 8, top: pos.y - 8 }} />
    </div>
  );
};

// 2. LIQUIDITY TERRAIN (Background)
const LiquidityTerrain = ({ speed = 1 }) => {
  const canvasRef = useRef(null);
  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let width, height;
    const resize = () => { if (canvas.parentElement) { width = canvas.parentElement.clientWidth; height = canvas.parentElement.clientHeight; canvas.width = width; canvas.height = height; } };
    resize();
    window.addEventListener('resize', resize);

    let offsetZ = 0;
    const gridSize = 40;
    const fov = 300;
    const getNoise = (x, z) => Math.sin(x * 0.1) * Math.cos(z * 0.1) * 20 + Math.sin(z * 0.3) * 10;

    const draw = () => {
        ctx.fillStyle = 'rgba(0, 5, 2, 0.2)'; ctx.fillRect(0, 0, width, height);
        ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)'; ctx.lineWidth = 1; ctx.beginPath();
        const cx = width / 2; const cy = height / 2; const horizon = cy * 0.5;
        offsetZ -= speed; if (offsetZ <= -gridSize) offsetZ = 0;

        for(let x = -width; x < width; x += gridSize) {
            if (Math.abs(x) > width) continue; 
            for(let z = 0; z < 800; z += gridSize) {
                const zDepth = z + offsetZ; if (zDepth < 1) continue;
                const scale = fov / (fov + zDepth); const scaleNext = fov / (fov + zDepth + gridSize);
                const gridX = (x - cx) / gridSize; const gridZ = zDepth / gridSize;
                const px = (x * scale) + cx; const py = (getNoise(gridX, gridZ) * scale) + cy + horizon;
                const pxNext = (x * scaleNext) + cx; const pyNext = (getNoise(gridX, (zDepth + gridSize) / gridSize) * scaleNext) + cy + horizon;
                ctx.moveTo(px, py); ctx.lineTo(pxNext, pyNext);
            }
        }
        for(let z = 0; z < 800; z += gridSize) {
             const zDepth = z + offsetZ; if (zDepth < 1) continue;
             const scale = fov / (fov + zDepth); const yBase = cy + horizon; 
             ctx.moveTo(0, yBase + 50 * scale); ctx.lineTo(width, yBase + 50 * scale);
        }
        ctx.stroke();
        const grad = ctx.createLinearGradient(0, 0, 0, height/2); grad.addColorStop(0, 'black'); grad.addColorStop(1, 'transparent');
        ctx.fillStyle = grad; ctx.fillRect(0, 0, width, height/2);
        requestAnimationFrame(draw);
    };
    const animationId = requestAnimationFrame(draw);
    return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animationId); };
  }, [speed]);
  return <canvas ref={canvasRef} className="absolute inset-0 w-full h-full pointer-events-none z-0 opacity-60" />;
};

// 3. THE GLOBE (Reintegrated & SPECTACULAR)
const Globe3D = () => {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let width, height;

    const resize = () => {
      if (canvas.parentElement) {
        width = canvas.parentElement.clientWidth;
        height = canvas.parentElement.clientHeight;
        canvas.width = width;
        canvas.height = height;
      }
    };
    resize();
    window.addEventListener('resize', resize);

    const GLOBE_RADIUS = Math.min(width, height) * 0.35;
    const PERSPECTIVE = 800;

    // --- DATA GENERATION ---
    const hubs = [
        { lat: 40, lon: -74, label: "NYC" },
        { lat: 51, lon: 0, label: "LDN" },
        { lat: 35, lon: 139, label: "TKY" },
        { lat: 1, lon: 103, label: "SGP" },
        { lat: 25, lon: 55, label: "DXB" },
        { lat: -33, lon: 151, label: "SYD" }
    ];

    const getXYZ = (lat, lon, r) => {
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        return {
            x: -(r * Math.sin(phi) * Math.cos(theta)),
            y: (r * Math.cos(phi)),
            z: (r * Math.sin(phi) * Math.sin(theta))
        };
    };

    // Sphere Dots
    const dots = [];
    for(let i=0; i<700; i++) {
        const theta = Math.random() * 2 * Math.PI;
        const phi = Math.acos((Math.random() * 2) - 1);
        dots.push({
            x: GLOBE_RADIUS * Math.sin(phi) * Math.cos(theta),
            y: GLOBE_RADIUS * Math.sin(phi) * Math.sin(theta),
            z: GLOBE_RADIUS * Math.cos(phi),
            size: Math.random() * 1.5,
            alphaBase: Math.random() * 0.5 + 0.1
        });
    }

    const hubPoints = hubs.map(h => ({ ...getXYZ(h.lat, h.lon, GLOBE_RADIUS), ...h }));

    // Generate Arcs (Connections)
    const arcs = [];
    hubPoints.forEach((h1, i) => {
        hubPoints.forEach((h2, j) => {
            if (i < j) {
                // Determine arc height (control point)
                const dist = Math.sqrt(Math.pow(h1.x - h2.x, 2) + Math.pow(h1.y - h2.y, 2) + Math.pow(h1.z - h2.z, 2));
                const maxDist = GLOBE_RADIUS * 2;
                const arcHeight = GLOBE_RADIUS + (dist / maxDist) * (GLOBE_RADIUS * 0.6); // Arc goes higher if points are far

                // Midpoint for Control Point
                const mx = (h1.x + h2.x) / 2;
                const my = (h1.y + h2.y) / 2;
                const mz = (h1.z + h2.z) / 2;
                
                // Normalize midpoint to project it out to arcHeight
                const mLen = Math.sqrt(mx*mx + my*my + mz*mz);
                const cx = (mx / mLen) * arcHeight;
                const cy = (my / mLen) * arcHeight;
                const cz = (mz / mLen) * arcHeight;

                arcs.push({
                    p1: h1, p2: h2, cp: {x: cx, y: cy, z: cz},
                    particles: [{t: Math.random(), speed: 0.005 + Math.random() * 0.005}]
                });
            }
        });
    });

    let rotation = 0;
    let animationFrameId;

    const draw = () => {
        ctx.clearRect(0, 0, width, height);
        const cx = width / 2;
        const cy = height / 2;
        rotation += 0.003;

        // 1. Atmosphere (Glow)
        const gradient = ctx.createRadialGradient(cx, cy, GLOBE_RADIUS * 0.5, cx, cy, GLOBE_RADIUS * 1.5);
        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.15)'); 
        gradient.addColorStop(0.6, 'rgba(16, 185, 129, 0.05)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);

        const rotate = (p) => ({
            x: p.x * Math.cos(rotation) - p.z * Math.sin(rotation),
            y: p.y,
            z: p.z * Math.cos(rotation) + p.x * Math.sin(rotation)
        });

        const project = (p) => {
            const scale = PERSPECTIVE / (PERSPECTIVE + p.z);
            return {
                x: (p.x * scale) + cx,
                y: (p.y * scale) + cy,
                scale: scale,
                visible: scale > 0
            };
        };

        // Draw Dots (Sphere)
        dots.forEach(dot => {
            const rDot = rotate(dot);
            const pDot = project(rDot);
            
            if (pDot.visible) {
                const alpha = Math.max(0, (pDot.scale - 0.5) * 1.5 * dot.alphaBase);
                if (alpha > 0) {
                    ctx.fillStyle = `rgba(16, 185, 129, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(pDot.x, pDot.y, dot.size * pDot.scale, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        });

        // Draw Arcs & Particles
        arcs.forEach(arc => {
            const rP1 = rotate(arc.p1);
            const rP2 = rotate(arc.p2);
            const rCP = rotate(arc.cp);
            
            // Draw Curve (Sampled)
            const segments = 20;
            ctx.beginPath();
            let started = false;
            
            for(let i=0; i<=segments; i++) {
                const t = i / segments;
                const x = (1-t)*(1-t)*rP1.x + 2*(1-t)*t*rCP.x + t*t*rP2.x;
                const y = (1-t)*(1-t)*rP1.y + 2*(1-t)*t*rCP.y + t*t*rP2.y;
                const z = (1-t)*(1-t)*rP1.z + 2*(1-t)*t*rCP.z + t*t*rP2.z;
                
                const p = project({x,y,z});
                if(p.visible) {
                    if(!started) { ctx.moveTo(p.x, p.y); started=true; }
                    else ctx.lineTo(p.x, p.y);
                }
            }
            
            const avgZ = (rP1.z + rP2.z + rCP.z) / 3;
            const alpha = Math.max(0.05, (PERSPECTIVE / (PERSPECTIVE + avgZ) - 0.5));
            
            ctx.strokeStyle = `rgba(16, 185, 129, ${alpha * 0.4})`;
            ctx.lineWidth = 1;
            ctx.stroke();

            // Particles on the Arc
            arc.particles.forEach(part => {
                part.t += part.speed;
                if(part.t > 1) part.t = 0;
                
                const t = part.t;
                const x = (1-t)*(1-t)*rP1.x + 2*(1-t)*t*rCP.x + t*t*rP2.x;
                const y = (1-t)*(1-t)*rP1.y + 2*(1-t)*t*rCP.y + t*t*rP2.y;
                const z = (1-t)*(1-t)*rP1.z + 2*(1-t)*t*rCP.z + t*t*rP2.z;

                const p = project({x,y,z});
                if(p.visible && z < 200) {
                     ctx.fillStyle = '#fff';
                     ctx.beginPath();
                     ctx.arc(p.x, p.y, 1.5 * p.scale, 0, Math.PI*2);
                     ctx.fill();
                }
            });
        });

        // Draw Hubs & Labels
        hubPoints.forEach(hub => {
            const rHub = rotate(hub);
            const pHub = project(rHub);
            
            if (pHub.visible && rHub.z < 100) { 
                const alpha = Math.max(0, (pHub.scale - 0.4));
                
                // Hub Dot
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(pHub.x, pHub.y, 2 * pHub.scale, 0, Math.PI * 2);
                ctx.fill();
                
                // Pulse Ring
                const pulse = (Math.sin(Date.now() / 200) + 1) / 2; 
                ctx.strokeStyle = `rgba(16, 185, 129, ${alpha * (1 - pulse)})`;
                ctx.beginPath();
                ctx.arc(pHub.x, pHub.y, (3 + pulse * 12) * pHub.scale, 0, Math.PI * 2);
                ctx.stroke();

                // Label
                if (alpha > 0.5) {
                    ctx.font = '10px monospace';
                    ctx.fillStyle = `rgba(16, 185, 129, ${alpha})`;
                    ctx.fillText(hub.label, pHub.x + 8, pHub.y - 4);
                }
            }
        });

        animationFrameId = requestAnimationFrame(draw);
    };

    draw();
    return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animationFrameId); };
  }, []);

  return (
    <div className="w-full h-full min-h-[200px] relative bg-black/60 rounded border border-emerald-500/30 overflow-hidden flex flex-col group">
         <div className="absolute top-2 left-2 text-[10px] text-emerald-400 font-bold z-10 flex items-center gap-2 group-hover:animate-pulse transition-all"><Globe size={12}/> MACRO_NEXUS_LINK</div>
         <canvas ref={canvasRef} className="w-full h-full" />
         <div className="absolute bottom-2 right-2 text-[9px] text-emerald-600 font-mono">LIVE_FLOW: ACTIVE</div>
    </div>
  );
};

// CRT Overlay
const CrtOverlay = ({ stressLevel, isGlitching }) => {
  return (
    <div className="pointer-events-none fixed inset-0 z-50 overflow-hidden h-full w-full">
      <div className="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(0,255,0,0.06),rgba(0,0,0,0.02),rgba(0,255,0,0.06))] bg-[length:100%_4px,3px_100%] pointer-events-none" />
      <div className="absolute inset-0 bg-white opacity-[0.02] animate-flicker pointer-events-none mix-blend-overlay" />
      <div className="absolute inset-0 bg-[radial-gradient(circle,rgba(0,0,0,0)_60%,rgba(0,0,0,0.8)_100%)] pointer-events-none" />
      {stressLevel !== 'NORMAL' && isGlitching && (
        <>
          <div className={`absolute inset-0 bg-transparent mix-blend-screen opacity-50 ${stressLevel === 'CRITICAL' ? 'animate-glitch-red-heavy' : 'animate-glitch-red-micro'}`} style={{ left: '-2px', textShadow: '2px 0 red' }}></div>
          <div className={`absolute inset-0 bg-transparent mix-blend-screen opacity-50 ${stressLevel === 'CRITICAL' ? 'animate-glitch-blue-heavy' : 'animate-glitch-blue-micro'}`} style={{ left: '2px', textShadow: '-2px 0 blue' }}></div>
        </>
      )}
      {stressLevel === 'CRITICAL' && isGlitching && <div className="absolute inset-0 bg-red-500/10 animate-pulse pointer-events-none mix-blend-overlay" />}
      <style>{`
        @keyframes flicker { 0% { opacity: 0.02; } 50% { opacity: 0.05; } 100% { opacity: 0.02; } }
        .animate-flicker { animation: flicker 0.3s infinite; }
        @keyframes glitch-red-micro { 0% { transform: translate(0); } 20% { transform: translate(-1px, 0); } 100% { transform: translate(0); } }
        @keyframes glitch-blue-micro { 0% { transform: translate(0); } 20% { transform: translate(1px, 0); } 100% { transform: translate(0); } }
        .animate-glitch-red-micro { animation: glitch-red-micro 2s infinite steps(2); }
        .animate-glitch-blue-micro { animation: glitch-blue-micro 2s infinite steps(2) reverse; }
        @keyframes glitch-heavy { 0% { transform: translate(0); } 20% { transform: translate(-3px, 3px); filter: hue-rotate(90deg); } 100% { transform: translate(0); } }
        .animate-glitch-red-heavy { animation: glitch-heavy 0.2s infinite; opacity: 0.3; }
        .animate-glitch-blue-heavy { animation: glitch-heavy 0.25s infinite reverse; opacity: 0.3; }
      `}</style>
    </div>
  );
};

// ALGORITHMIC VISION CHART
const FinancialChart = ({ dataSource }) => {
  const canvasRef = useRef(null);
  const [patterns, setPatterns] = useState([]);

  useEffect(() => {
    const interval = setInterval(() => {
        if(Math.random() > 0.7) {
            setPatterns(prev => [...prev.slice(-2), {
                x: Math.random() * 80 + 10 + '%', y: Math.random() * 60 + 20 + '%',
                type: Math.random() > 0.5 ? 'DOUBLE_TOP' : 'LIQ_HUNT', id: Date.now()
            }]);
        }
    }, 2000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    const dataPoints = [];
    const maxPoints = 80;
    let currentPrice = 1000;
    for (let i = 0; i < maxPoints; i++) { currentPrice += (Math.random() - 0.5) * 5; dataPoints.push(currentPrice); }

    const resize = () => { if(canvas.parentElement) { canvas.width = canvas.parentElement.clientWidth; canvas.height = 200; } };
    resize();
    window.addEventListener('resize', resize);

    const draw = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const width = canvas.width; const height = canvas.height;
      const change = (Math.random() - 0.5) * 5; currentPrice += change; dataPoints.push(currentPrice); if (dataPoints.length > maxPoints) dataPoints.shift();
      const min = Math.min(...dataPoints) - 20; const max = Math.max(...dataPoints) + 20; const range = max - min || 1; const xStep = (width * 0.7) / (maxPoints - 1);

      ctx.beginPath(); ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2;
      dataPoints.forEach((point, i) => { const x = i * xStep; const y = height - ((point - min) / range) * height; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); });
      ctx.stroke();

      const lastX = (dataPoints.length - 1) * xStep; const lastY = height - ((dataPoints[dataPoints.length - 1] - min) / range) * height;
      ctx.beginPath(); ctx.strokeStyle = 'rgba(16, 185, 129, 0.5)'; ctx.setLineDash([4, 4]); ctx.lineWidth = 2; ctx.moveTo(lastX, lastY);
      let predY = lastY; let predX = lastX;
      for(let i=0; i<20; i++) { predX += xStep; predY -= ((dataPoints[dataPoints.length-1] - dataPoints[dataPoints.length-10]) * 0.1) + (Math.random() - 0.5) * 5; ctx.lineTo(predX, predY); }
      ctx.stroke(); ctx.setLineDash([]);
      
      ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(width, predY - 30); ctx.lineTo(width, predY + 30); ctx.closePath(); ctx.fillStyle = 'rgba(16, 185, 129, 0.1)'; ctx.fill();
      animationFrameId = requestAnimationFrame(draw);
    };
    draw();
    return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animationFrameId); };
  }, [dataSource]);
  
  return (
    <div className="relative border border-emerald-500/30 bg-black/50 rounded mb-2 overflow-hidden w-full h-[200px]">
        <canvas ref={canvasRef} className="w-full h-full" />
        {patterns.map(p => (
            <div key={p.id} className="absolute border border-emerald-400/80 pointer-events-none animate-ping-once" style={{ left: p.x, top: p.y, width: '40px', height: '40px', transform: 'translate(-50%, -50%)' }}>
                 <div className="absolute -top-4 left-0 text-[8px] bg-emerald-500 text-black px-1 font-bold whitespace-nowrap">{p.type}</div>
                 <div className="absolute top-0 left-0 w-1 h-1 bg-emerald-400"></div><div className="absolute bottom-0 right-0 w-1 h-1 bg-emerald-400"></div>
            </div>
        ))}
        <div className="absolute top-2 left-2 flex items-center gap-2"><div className="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div><span className="text-xs font-bold tracking-widest text-emerald-400">AI_VISION_LAYER_V2</span></div>
        <style>{`@keyframes ping-once { 0% { opacity: 0; transform: scale(1.5) translate(-50%, -50%); } 20% { opacity: 1; transform: scale(1) translate(-50%, -50%); } 80% { opacity: 1; } 100% { opacity: 0; } } .animate-ping-once { animation: ping-once 2s forwards; }`}</style>
    </div>
  );
};

// Quantum Core
const QuantumCore = () => {
    const canvasRef = useRef(null);
    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        let width, height;
        const resize = () => { if(canvas.parentElement) { width = canvas.parentElement.clientWidth; height = canvas.parentElement.clientHeight; canvas.width = width; canvas.height = height; }};
        resize();
        window.addEventListener('resize', resize);
        const particles = Array.from({ length: 40 }, () => ({ x: Math.random() * width, y: Math.random() * height, vx: (Math.random() - 0.5) * 1.5, vy: (Math.random() - 0.5) * 1.5, size: Math.random() * 2 + 1 }));
        const draw = () => {
            ctx.fillStyle = 'rgba(0, 10, 5, 0.2)'; ctx.fillRect(0, 0, width, height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; if(p.x < 0 || p.x > width) p.vx *= -1; if(p.y < 0 || p.y > height) p.vy *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fillStyle = '#10b981'; ctx.fill();
                for(let j = i + 1; j < particles.length; j++) {
                    const p2 = particles[j]; const dx = p.x - p2.x; const dy = p.y - p2.y; const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 80) { ctx.beginPath(); ctx.strokeStyle = `rgba(16, 185, 129, ${1 - dist/80})`; ctx.lineWidth = 0.5; ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                }
            });
            requestAnimationFrame(draw);
        };
        draw();
    }, []);
    return (
        <div className="w-full h-full min-h-[200px] relative bg-black/60 rounded border border-emerald-500/30 overflow-hidden">
             <div className="absolute top-2 left-2 text-[10px] text-emerald-400 font-bold z-10 flex items-center gap-2 animate-pulse"><Cpu size={12}/> NEURAL_NET_V9</div>
             <canvas ref={canvasRef} className="w-full h-full" />
        </div>
    );
};

// Heatmap
const LiquidityHeatmap = () => {
    const [grid, setGrid] = useState(Array(64).fill(0));
    useEffect(() => { const interval = setInterval(() => { setGrid(prev => prev.map(() => Math.random() > 0.7 ? Math.random() : Math.random() * 0.2)); }, 800); return () => clearInterval(interval); }, []);
    const getColor = (val) => { if(val > 0.9) return 'bg-white shadow-[0_0_10px_white]'; if(val > 0.6) return 'bg-emerald-300'; if(val > 0.3) return 'bg-emerald-600'; return 'bg-emerald-900/40'; };
    return (
        <div className="w-full h-full min-h-[200px] flex flex-col bg-black/60 rounded border border-emerald-500/30 p-2">
            <div className="flex justify-between items-center mb-2 text-[10px] text-emerald-400 font-bold uppercase tracking-widest"><span className="flex items-center gap-2"><Grid size={12}/> DEPTH_MAP</span><span className="text-emerald-600">L3</span></div>
            <div className="flex-1 grid grid-cols-8 gap-1">{grid.map((val, i) => <div key={i} className={`rounded-sm transition-colors duration-500 ${getColor(val)}`} />)}</div>
        </div>
    );
};

// Radar
const AlphaRadar = () => {
    const canvasRef = useRef(null);
    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        let angle = 0; let animationFrameId;
        const targets = [{ r: 0.3, theta: 1.2, label: 'NVDA', decay: 1 }, { r: 0.6, theta: 3.5, label: 'BTC', decay: 0.5 }];
        const draw = () => {
            if (!canvas.parentElement) { animationFrameId = requestAnimationFrame(draw); return; }
            const w = canvas.parentElement.clientWidth; const h = canvas.parentElement.clientHeight;
            canvas.width = w; canvas.height = h; const cx = w/2; const cy = h/2; const radius = Math.max(0, Math.min(w, h)/2 - 20);
            ctx.clearRect(0, 0, w, h);
            if (radius > 0) {
                ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)'; [0.33, 0.66, 1].forEach(s => { ctx.beginPath(); ctx.arc(cx, cy, radius * s, 0, Math.PI*2); ctx.stroke(); });
                angle += 0.03; ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle); ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,radius,0,0.4); ctx.fillStyle='rgba(16,185,129,0.2)'; ctx.fill(); ctx.restore();
                targets.forEach(t => { const x = cx + Math.cos(t.theta)*t.r*radius; const y = cy + Math.sin(t.theta)*t.r*radius; if(t.decay > 0.01) { ctx.fillStyle=`rgba(16,185,129,${t.decay})`; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); ctx.fillText(t.label, x+5, y); }});
            }
            animationFrameId = requestAnimationFrame(draw);
        };
        draw(); return () => cancelAnimationFrame(animationFrameId);
    }, []);
    return (<div className="w-full h-full min-h-[200px] relative bg-black/40 rounded border border-emerald-900/50 flex flex-col"><div className="absolute top-2 left-2 text-[10px] text-emerald-500 font-bold z-10 flex items-center gap-2"><Radar size={12}/> ALPHA_SCANNER</div><canvas ref={canvasRef} className="w-full h-full" /></div>);
}

// Uplink
const SecureUplink = () => {
  const [status, setStatus] = useState('IDLE'); const [msg, setMsg] = useState('');
  const handleSend = () => { if(!msg.trim()) return; setStatus('ENCRYPTING'); setTimeout(() => { setStatus('SENT'); setMsg(''); setTimeout(() => setStatus('IDLE'), 3000); }, 2000); };
  return (
    <div className="flex flex-col h-full">
       <div className="bg-emerald-900/10 p-2 rounded mb-4 border border-emerald-500/20 text-xs font-mono space-y-1"><div className="flex justify-between"><span className="text-emerald-500">TARGET:</span><span className="text-emerald-300">ANALYST_DESK_01</span></div><div className="flex justify-between"><span className="text-emerald-500">ENCRYPTION:</span><span className="text-emerald-300">AES-256-GCM (ACTIVE)</span></div></div>
       {status === 'IDLE' && (<><textarea className="flex-1 bg-black/50 border border-emerald-900/50 rounded p-2 text-emerald-300 text-xs font-mono outline-none resize-none" placeholder="ENTER SECURE PAYLOAD..." value={msg} onChange={(e) => setMsg(e.target.value)} /><button onClick={handleSend} className="mt-2 bg-emerald-600 hover:bg-emerald-500 text-black font-bold py-2 rounded text-xs tracking-widest flex items-center justify-center gap-2 transition-all"><Send size={12} /> TRANSMIT</button></>)}
       {status === 'ENCRYPTING' && (<div className="flex-1 flex flex-col items-center justify-center space-y-2"><Lock className="animate-pulse text-emerald-500" size={32} /><div className="text-xs text-emerald-400 font-mono">ENCRYPTING...</div><div className="w-full bg-emerald-900/30 h-1 rounded overflow-hidden"><div className="bg-emerald-500 h-full animate-[width_2s_ease-in-out_forwards]" style={{width: '0%'}}></div></div></div>)}
       {status === 'SENT' && (<div className="flex-1 flex flex-col items-center justify-center space-y-2"><Zap size={24} className="text-emerald-400" /><div className="text-xs text-emerald-300 font-mono text-center">DELIVERED</div></div>)}
    </div>
  );
};

// Window
const Window = ({ id, title, children, onClose, isOpen, initialPos, type = "default", isTiled }) => {
  if (!isOpen) return null;
  const borderColor = type === 'alert' ? 'border-red-500/50' : 'border-emerald-500/50';
  const headerBg = type === 'alert' ? 'bg-red-900/20' : 'bg-emerald-900/20';
  const textColor = type === 'alert' ? 'text-red-400' : 'text-emerald-400';
  const containerStyle = isTiled ? "relative w-full h-full flex flex-col min-h-[300px] z-10" : "absolute w-full max-w-md md:max-w-xl flex flex-col z-20";
  const positionStyle = isTiled ? {} : { top: initialPos?.y || '10%', left: initialPos?.x || '10%', zIndex: id === 'terminal' ? 30 : 20 };
  
  return (
    <div className={`${containerStyle} bg-gray-950/90 border ${borderColor} shadow-[0_0_30px_rgba(0,20,0,0.4)] overflow-hidden backdrop-blur-md transition-all duration-300`} style={positionStyle}>
      <div className={`${headerBg} border-b ${borderColor} p-2 flex justify-between items-center select-none ${!isTiled ? 'cursor-move' : ''}`}>
        <div className={`flex items-center gap-2 ${textColor} font-mono text-xs font-bold uppercase tracking-widest`}>
          {type === 'alert' ? <AlertTriangle size={14} /> : (title.includes('VIS') ? <Scan size={14} /> : (title.includes('SCAN') ? <Crosshair size={14}/> : <Activity size={14} />))} {title}
        </div>
        <button onClick={() => onClose(id)} className="p-1 hover:bg-red-500/20 text-red-400 rounded transition-colors"><X size={14} /></button>
      </div>
      <div className={`p-4 font-mono ${textColor} text-sm overflow-auto flex-1`}>{children}</div>
    </div>
  );
};

/* --- MAIN APP --- */
export default function App() {
  const [booted, setBooted] = useState(false);
  const [isTiled, setIsTiled] = useState(true); 
  const [bootLog, setBootLog] = useState([]);
  const [riskMode, setRiskMode] = useState('NORMAL');
  const [showRiskMenu, setShowRiskMenu] = useState(false);
  const [dataSource, setDataSource] = useState('LIT_MARKET');
  const [isGlitching, setIsGlitching] = useState(false);

  const [windows, setWindows] = useState({
    terminal: true,
    market: true,
    radar: false,
    contact: false,
    core: false,
    map: false,
    network: false // New Globe Window
  });
  
  const [input, setInput] = useState('');
  const [history, setHistory] = useState([
    "LEONCE EQUITY OS [Version 5.1.0]",
    "CLEARANCE: LVL_5 [PARTNER]",
    "TERRAIN_ENGINE: ACTIVE",
    "MACRO_NEXUS: STANDBY",
    "",
    "Tapez 'help' pour les commandes."
  ]);
  const bottomRef = useRef(null);
  const inputRef = useRef(null);

  useEffect(() => {
    const logs = ["LOADING KERNEL...", "CONNECTING TO QUANTUM CORE...", "GENERATING LIQUIDITY TERRAIN...", "CALIBRATING SNIPER HUD...", "ACCESS GRANTED."];
    let delay = 0;
    logs.forEach((log, index) => {
      delay += Math.random() * 300 + 100;
      setTimeout(() => {
        setBootLog(prev => [...prev, log]);
        if (index === logs.length - 1) setTimeout(() => setBooted(true), 500);
      }, delay);
    });
  }, []);

  useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [history]);
  useEffect(() => { if (booted) inputRef.current?.focus(); }, [booted, windows.terminal]);

  useEffect(() => {
    if (isGlitching) {
      const timer = setTimeout(() => { setIsGlitching(false); if (riskMode === 'MAX') setRiskMode('NORMAL'); }, 5000);
      return () => clearTimeout(timer);
    }
  }, [isGlitching, riskMode]);

  const handleRiskAction = (action) => {
      setShowRiskMenu(false); setIsGlitching(true);
      if (action === 'HALT') { setRiskMode('MAX'); setHistory(prev => [...prev, ">> CRITICAL: TRADING HALTED."]); }
      else if (action === 'FLUSH') { setHistory(prev => [...prev, ">> FLUSHING POSITIONS..."]); setTimeout(() => setHistory(prev => [...prev, ">> COMPLETE."]), 1000); }
  };

  const cycleDataSource = () => {
      const sources = ['LIT_MARKET', 'DARK_POOL', 'SATELLITE_LINK'];
      const nextIndex = (sources.indexOf(dataSource) + 1) % sources.length;
      setDataSource(sources[nextIndex]);
      if (sources[nextIndex] === 'DARK_POOL') setIsGlitching(true);
  };

  const systemStress = riskMode === 'MAX' ? 'CRITICAL' : (dataSource === 'DARK_POOL' ? 'HIGH' : 'NORMAL');

  const handleCommand = (e) => {
    if (e.key === 'Enter') {
      const trimmedInput = input.trim();
      const args = trimmedInput.split(' ');
      const cmd = args[0].toLowerCase();
      const newHistory = [...history, `partner@leonce-equity:~$ ${trimmedInput}`];

      switch (cmd) {
        case 'help':
          newHistory.push(
            "NOUVELLES FONCTIONNALITÉS V5.1:",
            "  * MACRO NEXUS (Globe Stratégique)",
            "",
            "COMMANDES:",
            "  market, radar, contact, core, map",
            "  network (Globe), layout, clear",
            "  darkpool, stress"
          );
          break;
        case 'clear': setHistory([]); setInput(''); return;
        case 'market': setWindows(prev => ({ ...prev, market: true })); break;
        case 'radar': setWindows(prev => ({ ...prev, radar: true })); break;
        case 'contact': setWindows(prev => ({ ...prev, contact: true })); break;
        case 'core': setWindows(prev => ({ ...prev, core: true })); newHistory.push(">> CONNECTING TO NEURAL NET..."); break;
        case 'map': setWindows(prev => ({ ...prev, map: true })); newHistory.push(">> LOADING LIQUIDITY MAP L3..."); break;
        case 'network': setWindows(prev => ({ ...prev, network: true })); newHistory.push(">> CONNECTING TO MACRO NEXUS..."); break;
        case 'layout': setIsTiled(!isTiled); break;
        case 'darkpool': setIsGlitching(true); newHistory.push(">> DARK POOL ACTIVE."); break;
        case 'stress': setRiskMode('MAX'); setIsGlitching(true); newHistory.push(">> STRESS TEST INITIATED."); break;
        case 'exit': window.location.reload(); break;
        default: newHistory.push(`Erreur: Commande '${cmd}' inconnue.`);
      }
      setHistory(newHistory);
      setInput('');
    }
  };

  const closeWindow = (key) => setWindows(prev => ({ ...prev, [key]: false }));
  const toggleWindow = (key) => setWindows(prev => ({ ...prev, [key]: !prev[key] }));

  const activeWindowCount = Object.values(windows).filter(Boolean).length;
  const getGridClass = () => {
    if (!isTiled) return 'relative h-full';
    if (activeWindowCount === 1) return 'grid grid-cols-1 gap-4 p-4 h-full pb-20 z-10'; 
    if (activeWindowCount === 2) return 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 h-full pb-20 z-10';
    return 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 h-full pb-20 z-10';
  };

  if (!booted) return (
      <div className="min-h-screen bg-black text-emerald-500 font-mono p-10 flex flex-col justify-end pb-20">
        <CrtOverlay stressLevel={systemStress} isGlitching={isGlitching} />
        <div className="text-center mb-10 opacity-50"><Shield size={64} className="mx-auto mb-4 animate-pulse" /><h1 className="text-2xl tracking-[0.5em] font-bold">LEONCE EQUITY</h1></div>
        {bootLog.map((log, i) => <div key={i} className="mb-2 tracking-wider text-sm">{`> ${log}`}</div>)}
        <div className="mt-4 animate-pulse">_</div>
      </div>
  );

  return (
    <div className={`min-h-screen bg-black font-mono text-emerald-500 overflow-hidden relative selection:bg-emerald-500 selection:text-black flex flex-col ${(systemStress !== 'NORMAL' && isGlitching) ? 'animate-jitter' : ''}`}>
      
      {/* 1. SNIPER HUD */}
      <SniperHUD />
      
      <CrtOverlay stressLevel={systemStress} isGlitching={isGlitching} />

      {/* STRATEGIC TASKBAR */}
      <div className="w-full h-12 bg-gray-950 border-b border-emerald-900/50 flex justify-between items-center px-4 z-40 backdrop-blur shrink-0 relative z-[70]">
        <div className="flex items-center gap-6">
          <span className="font-bold text-lg tracking-widest text-emerald-400 flex items-center gap-2"><Shield size={18} /> LEONCE_OS</span>
          <div className="h-6 w-[1px] bg-emerald-900 mx-2 hidden md:block"></div>
          <div className="flex gap-2 items-center">
            <button onClick={() => toggleWindow('terminal')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.terminal ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Terminal"><Terminal size={18} /></button>
            <button onClick={() => toggleWindow('market')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.market ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Markets"><BarChart3 size={18} /></button>
            <button onClick={() => toggleWindow('radar')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.radar ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Alpha Radar"><Radar size={18} /></button>
            <button onClick={() => toggleWindow('map')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.map ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Heatmap"><Grid size={18} /></button>
            <button onClick={() => toggleWindow('core')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.core ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="AI Core"><Cpu size={18} /></button>
            <button onClick={() => toggleWindow('network')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.network ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Global Network"><Globe size={18} /></button>
            <button onClick={() => toggleWindow('contact')} className={`p-1.5 rounded hover:bg-emerald-900/30 transition-all ${windows.contact ? 'text-emerald-300 bg-emerald-900/20' : 'text-emerald-700'}`} title="Secure Uplink"><MessageSquare size={18} /></button>
          </div>
        </div>
        <div className="flex items-center gap-4 md:gap-6">
           <div className="relative">
              <button onClick={() => setShowRiskMenu(!showRiskMenu)} className={`flex items-center gap-2 px-2 py-1 border rounded font-bold text-xs transition-all uppercase tracking-wider ${riskMode === 'MAX' ? 'border-red-500 bg-red-900/20 text-red-500 animate-pulse' : 'border-emerald-900/50 text-emerald-600 hover:text-emerald-400 hover:border-emerald-500/50'}`}>
                <AlertTriangle size={14} /><span className="hidden md:inline">{riskMode === 'MAX' ? 'CRITICAL' : 'RISK_OPS'}</span>
              </button>
              {showRiskMenu && (
                <div className="absolute top-full right-0 mt-2 w-48 bg-gray-950 border border-red-500/50 p-2 shadow-[0_0_20px_rgba(255,0,0,0.2)] z-50 backdrop-blur-md rounded">
                   <div className="text-red-500 text-[10px] font-bold mb-2 border-b border-red-900 pb-1 tracking-widest">EMERGENCY PROTOCOLS</div>
                   <button onClick={() => handleRiskAction('HALT')} className="w-full text-left text-xs text-red-400 hover:bg-red-900/30 p-2 mb-1 flex items-center gap-2 rounded transition-colors border border-transparent hover:border-red-500/30"><Octagon size={12}/> HALT_TRADING</button>
                   <button onClick={() => handleRiskAction('FLUSH')} className="w-full text-left text-xs text-red-400 hover:bg-red-900/30 p-2 flex items-center gap-2 rounded transition-colors border border-transparent hover:border-red-500/30"><Trash2 size={12}/> FLUSH_POSITIONS</button>
                </div>
              )}
           </div>
           <button onClick={cycleDataSource} className="flex items-center gap-2 text-xs font-bold transition-colors uppercase border border-transparent hover:border-emerald-500/30 px-2 py-1 rounded" title="Click to cycle data source">
              <Database size={14} className={dataSource === 'DARK_POOL' ? 'text-purple-500' : (dataSource === 'SATELLITE_LINK' ? 'text-blue-500' : 'text-emerald-500')} />
              <div className="flex flex-col items-start leading-none"><span className="text-[9px] text-gray-500">FEED_SOURCE</span><span className={dataSource === 'DARK_POOL' ? 'text-purple-400' : (dataSource === 'SATELLITE_LINK' ? 'text-blue-400' : 'text-emerald-400')}>{dataSource === 'LIT_MARKET' ? 'LIT_MKT' : (dataSource === 'DARK_POOL' ? 'DARK_PL' : 'SAT_LNK')}</span></div>
           </button>
           <div className="h-6 w-[1px] bg-emerald-900 hidden md:block"></div>
           <div className="hidden md:flex items-center gap-2 text-xs font-bold border border-emerald-500/30 px-3 py-1.5 rounded bg-emerald-900/10 text-emerald-400 shadow-[0_0_10px_rgba(16,185,129,0.1)]"><Lock size={12} /><span className="tracking-widest">LVL_5:PARTNER</span></div>
           <button onClick={() => setIsTiled(!isTiled)} className="md:hidden text-emerald-600 hover:text-emerald-300">{isTiled ? <LayoutGrid size={16} /> : <Maximize2 size={16} />}</button>
        </div>
      </div>

      <div className="flex-1 relative overflow-hidden w-full">
        {/* 2. LIQUIDITY TERRAIN */}
        <LiquidityTerrain speed={riskMode === 'MAX' ? 5 : 1} />
        
        <div className="fixed bottom-0 left-0 w-full h-8 bg-emerald-950/80 border-t border-emerald-900/50 flex items-center overflow-hidden z-50 backdrop-blur-md">
           <div className="bg-emerald-900 text-emerald-100 px-3 h-full flex items-center text-xs font-bold shrink-0 tracking-widest z-10">INTELLIGENCE_FEED</div>
           <div className="animate-ticker flex whitespace-nowrap">
             {["DETECTED: Rotation sectorielle massive vers l'Énergie Nucléaire (+15% flow)", "///", "LEONCE ALPHA: +4.2% VS SPX500 (24H)", "///", "WHALE TRACKER: Wallet '0x4...9a' accumulating [L_EQTY]", "///", "SYSTEM STATUS: OPTIMAL", "///"].map((item, i) => <span key={i} className="mx-4 text-xs font-mono text-emerald-400/80 uppercase tracking-wide">{item}</span>)}
           </div>
           <style>{`@keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } } .animate-ticker { animation: ticker 30s linear infinite; }`}</style>
        </div>

        <div className={getGridClass()}>
          
          <Window id="terminal" title="partner@leonce-equity:~" isOpen={windows.terminal} onClose={closeWindow} initialPos={{x: '5%', y: '15%'}} isTiled={isTiled}>
            <div className="space-y-1 h-full flex flex-col" onClick={() => inputRef.current?.focus()}>
              <div className="flex-1 overflow-auto">
                {history.map((line, i) => <div key={i} className={`break-words whitespace-pre-wrap leading-relaxed ${line.includes('CRITICAL') || line.includes('WARNING') ? 'text-red-400 font-bold' : ''}`}>{line}</div>)}
                <div ref={bottomRef} />
              </div>
              <div className="flex items-center mt-2 group shrink-0">
                <span className="mr-2 text-emerald-300 font-bold">partner@leonce-equity:~$</span>
                <input ref={inputRef} type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleCommand} className="bg-transparent border-none outline-none flex-1 text-emerald-400 font-bold caret-emerald-500 w-full" autoFocus spellCheck="false" />
              </div>
            </div>
          </Window>

          <Window id="market" title="MARKET_PREDICTION_V2" isOpen={windows.market} onClose={closeWindow} initialPos={{x: '50%', y: '10%'}} isTiled={isTiled}>
             <FinancialChart dataSource={dataSource} />
          </Window>

          <Window id="core" title="LEONCE_NEURAL_CORE" isOpen={windows.core} onClose={closeWindow} initialPos={{x: '10%', y: '60%'}} isTiled={isTiled}>
             <QuantumCore />
          </Window>

          <Window id="map" title="LIQUIDITY_HEATMAP_L3" isOpen={windows.map} onClose={closeWindow} initialPos={{x: '60%', y: '60%'}} isTiled={isTiled}>
             <LiquidityHeatmap />
          </Window>

          <Window id="radar" title="ALPHA_TARGET_SCAN" isOpen={windows.radar} onClose={closeWindow} initialPos={{x: '15%', y: '50%'}} isTiled={isTiled}>
             <AlphaRadar />
          </Window>

          <Window id="network" title="MACRO_NEXUS" isOpen={windows.network} onClose={closeWindow} initialPos={{x: '40%', y: '40%'}} isTiled={isTiled}>
             <Globe3D />
          </Window>
          
          <Window id="contact" title="SECURE_UPLINK_V2" isOpen={windows.contact} onClose={closeWindow} initialPos={{x: '20%', y: '20%'}} isTiled={isTiled}>
             <SecureUplink />
          </Window>
        </div>
      </div>
      <style>{`
        @keyframes jitter { 0% { transform: translate(0,0); } 25% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, 0); } 75% { transform: translate(0, -1px); } 100% { transform: translate(0,0); } }
        .animate-jitter { animation: jitter 0.1s infinite; }
        ::selection { background: rgba(16, 185, 129, 0.3); color: white; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #064e3b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
        /* Hide default cursor when Sniper HUD is active */
        body { cursor: none; }
      `}</style>
    </div>
  );
}

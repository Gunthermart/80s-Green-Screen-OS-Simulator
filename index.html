<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEWS TERMINAL (Final Version)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --main-color: #00ff41;
            --glow-color: rgba(0, 255, 65, 0.5);
            --dim-color: #008f11;
            --bg-color: #051005;
            --border-color: #004d00;
            --impact-up: #00d8ff;
            --impact-down: #ff4141;
            --impact-neutral: #ff9900;
            --terminal-padding: 1rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: var(--main-color);
            font-size: 18px;
            line-height: 1.2;
            text-shadow: 0 0 3px var(--glow-color);
        }
        
        .terminal-window { 
            position: relative; 
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            border: 2px solid var(--border-color); 
            box-shadow: 0 0 25px var(--glow-color), inset 0 0 40px rgba(0, 20, 0, 0.5); 
            padding: var(--terminal-padding); 
            background: var(--bg-color); 
            overflow: hidden; 
        }

        .terminal-window::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            z-index: 2;
            background-size: 100% 4px;
            pointer-events: none;
            animation: scanline 10s linear infinite;
        }

        @keyframes scanline {
            from { background-position: 0 0; }
            to { background-position: 0 -100vh; }
        }

        .terminal-header { position: relative; display: flex; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--border-color); margin: 0 calc(-1 * var(--terminal-padding)) 1rem; padding: 0.5rem var(--terminal-padding); min-height: 3rem; z-index: 3; gap: 1rem; }
        .terminal-title { font-size: 1.5rem; text-transform: uppercase; margin: 0; display: flex; align-items: center; }
        .terminal-title::before { content: '>$ '; margin-right: 0.5rem; color: var(--dim-color); }
        .blinking-caret { animation: blink-animation 1s steps(2, start) infinite; margin-left: 0.25rem; }
        @keyframes blink-animation { to { visibility: hidden; } }

        .effects-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-left: auto; align-items: center; }
        .switch-control { font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .switch-control input { display: none; }
        .slider { position: relative; display: inline-block; width: 34px; height: 14px; background-color: var(--border-color); border-radius: 14px; transition: background-color 0.3s; }
        .slider::before { content: ''; position: absolute; height: 20px; width: 20px; left: -3px; bottom: -3px; background-color: var(--dim-color); border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .switch-control input:checked + .slider { background-color: var(--main-color); }
        .switch-control input:checked + .slider::before { transform: translateX(20px); background-color: var(--main-color); }

        .terminal-content { display: flex; flex-direction: column; gap: 1rem; position: relative; z-index: 3; flex: 1; min-height: 0; }
        .config-panel { border: 1px solid var(--border-color); margin-bottom: 1rem; background-color: rgba(0, 0, 0, 0.3); }
        .config-panel-header { padding: 0.5rem; background-color: var(--border-color); cursor: pointer; outline: none; display: flex; align-items: center; font-size: 1rem; text-transform: uppercase; }
        .config-panel-header::before { content: ':: '; color: var(--main-color); margin-right: 0.25rem; }
        .config-panel-header::after { content: ' ::'; color: var(--main-color); margin-left: 0.25rem; }
        .config-panel-content { padding: 1rem; display: none; }
        .config-panel[open] .config-panel-content { display: block; }

        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .config-section h3 { text-transform: uppercase; margin-bottom: 0.75rem; font-size: 1.2rem; border-bottom: 1px dotted var(--border-color); padding-bottom: 0.25rem; }
        .config-input-group { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .config-items { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 0.5rem; background-color: rgba(0, 0, 0, 0.2); }
        .config-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; padding: 0.25rem; border-bottom: 1px dotted var(--border-color); }
        .config-item:last-child { margin-bottom: 0; border-bottom: none; }
        .config-item-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .status-icon { display: inline-block; width: 1rem; text-align: center; font-weight: bold; }

        .config-items::-webkit-scrollbar { width: 8px; }
        .config-items::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 4px; }
        .config-items::-webkit-scrollbar-thumb { background-color: var(--main-color); border-radius: 4px; border: 2px solid var(--bg-color); }
        .config-items::-webkit-scrollbar-thumb:hover { background-color: var(--glow-color); }

        .impact-switch-container { display: flex; align-items: center; gap: 0.5rem; }
        .impact-label { font-size: 0.9rem; transition: color 0.3s, text-shadow 0.3s; }
        .impact-label.inactive { color: var(--dim-color); text-shadow: none !important; }

        .filters-bar { border: 1px solid var(--border-color); padding: 0.75rem; display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: center; background-color: rgba(0, 0, 0, 0.3); gap: 1rem; }
        .date-filters, .keyword-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .article-count { font-size: 0.9rem; padding: 0.25rem 0.5rem; border: 1px dotted var(--border-color); background-color: rgba(0, 0, 0, 0.2); margin-left: auto; }

        .terminal-screen { flex-grow: 1; overflow: hidden; border: 1px solid var(--border-color); padding: 0; position: relative; background-color: rgba(0, 0, 0, 0.3); touch-action: none; }
        .terminal-screen::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: var(--main-color); opacity: 0.2; box-shadow: 0 0 5px var(--glow-color); pointer-events: none; z-index: 10; }
        .news-ticker { position: absolute; left: 0; top: 0; width: 100%; padding: 1rem; }
        
        .news-item { margin-bottom: 0.5rem; overflow: hidden; padding: 0.25rem; border-left: 2px solid var(--dim-color); transition: border-color 0.2s, font-size 0.3s; }
        .news-item:hover { border-left-color: var(--main-color); background-color: rgba(0, 80, 20, 0.2); }
        .news-item a { color: var(--main-color); text-decoration: none; display: block; }
        .news-item a:hover { text-decoration: underline; }
        .news-item.is-read a { color: var(--dim-color); text-shadow: none; }
        
        .news-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .news-meta-bar { border: 1px solid var(--border-color); border-top: none; padding: 0.25rem 0.75rem; font-size: 0.9em; color: var(--dim-color); text-align: center; height: 2rem; line-height: 1.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-color: rgba(0, 0, 0, 0.3); }
        
        .zoom-x2 .news-item {
            font-size: 200%;
            line-height: 1.2;
            margin-bottom: 0.8rem;
        }
        .zoom-x2 .news-title {
            white-space: normal;
            text-overflow: clip;
        }
        .zoom-x4 .news-item {
            font-size: 400%;
            line-height: 1.2;
            margin-bottom: 1.2rem;
        }
        .zoom-x4 .news-title {
            white-space: normal;
            text-overflow: clip;
        }

        .impact-up { color: var(--impact-up); text-shadow: none; }
        .impact-down { color: var(--impact-down); text-shadow: none; }
        .impact-neutral { color: var(--impact-neutral); text-shadow: none; }

        input, button, select { font-family: inherit; background-color: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); color: var(--main-color); padding: 0.5rem; font-size: 16px; }
        input, select { flex-grow: 1; min-width: 100px; }
        select { -moz-appearance: none; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300ff41%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        input:focus, select:focus { outline: 1px solid var(--main-color); box-shadow: 0 0 5px var(--glow-color); }
        button { cursor: pointer; min-width: 80px; text-transform: uppercase; transition: background-color 0.2s, color 0.2s; }
        button:hover { background-color: var(--border-color); }
        button.active { background-color: var(--main-color); color: var(--bg-color); text-shadow: 0 0 5px #000; }
        .delete-btn { 
            color: var(--impact-down); 
            border: none; 
            padding: 0 0.5rem; 
            background: transparent; 
            min-width: auto;
            margin-left: auto;
            text-shadow: none;
        }
        .delete-btn:hover { background: rgba(255, 65, 65, 0.2); }

        .terminal-footer { border-top: 1px solid var(--border-color); margin: 1rem calc(-1 * var(--terminal-padding)) 0; padding: 0.5rem var(--terminal-padding); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; font-size: 0.9rem; gap: 1rem; }
        .refresh-controls { display: flex; gap: 0.5rem; align-items: center; }
        .countdown-display { font-size: 0.8rem; color: var(--dim-color); min-width: 150px; text-align: right; }

        .scroll-controls { display: flex; align-items: center; gap: 1rem; }
        .speed-control-container { display: flex; align-items: center; gap: 0.5rem; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100px; height: 5px; background: var(--border-color); outline: none; border-radius: 5px; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 15px; height: 15px; background: var(--main-color); border-radius: 50%; border: 2px solid var(--bg-color); box-shadow: 0 0 8px var(--glow-color); }
        input[type="range"]::-moz-range-thumb { width: 15px; height: 15px; background: var(--main-color); border-radius: 50%; border: 2px solid var(--bg-color); box-shadow: 0 0 8px var(--glow-color); }
        .direction-switch { position: relative; width: 20px; height: 40px; background: var(--border-color); border-radius: 20px; cursor: pointer; }
        .direction-switch input { opacity: 0; width: 0; height: 0; }
        .direction-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 20px; }
        .direction-slider:before { position: absolute; content: "▲"; font-size: 12px; line-height: 16px; text-align: center; color: var(--bg-color); height: 16px; width: 16px; left: 2px; top: 2px; background-color: var(--main-color); border-radius: 50%; transition: .4s; }
        .direction-switch input:checked + .direction-slider:before { transform: translateY(20px); content: "▼"; }
        .scroll-logo { width: 24px; height: 24px; fill: var(--dim-color); }
        
        .autocomplete-container {
            position: relative;
            display: flex;
            flex-grow: 1;
        }
        #new-keyword-input, #new-keyword-suggestion {
            font-family: inherit;
            padding: 0.5rem;
            font-size: 16px;
            border: 1px solid var(--border-color);
            width: 100%;
        }
        #new-keyword-input {
            position: relative;
            z-index: 2;
            background-color: transparent;
            color: var(--main-color);
        }
        #new-keyword-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--dim-color);
            border-color: var(--border-color);
        }
        
        #zoom-btn {
            background: none;
            border: 1px solid var(--dim-color);
            color: var(--dim-color);
            cursor: pointer;
            padding: 0.1rem 0.5rem;
            text-transform: uppercase;
            min-width: auto;
        }
        #zoom-btn:hover {
            color: var(--main-color);
            border-color: var(--main-color);
        }
        
        #help-button {
            background: none;
            border: 1px solid var(--dim-color);
            color: var(--dim-color);
            cursor: pointer;
            padding: 0.1rem 0.5rem;
            text-transform: uppercase;
        }
        #help-button:hover {
            color: var(--main-color);
            border-color: var(--main-color);
        }
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none; /* Caché par défaut */
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .help-modal.is-visible {
            display: flex;
        }
        .help-content {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 15px var(--glow-color);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            position: relative;
            border-radius: 1rem;
        }
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .help-content h2 {
            text-transform: uppercase;
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .help-content p {
            margin-bottom: 1rem;
            color: var(--main-color);
        }
        .help-content strong {
            color: var(--impact-up);
            text-shadow: none;
        }
        .help-close-btn {
            position: static;
            background: var(--bg-color);
            border: 1px solid var(--dim-color);
            color: var(--dim-color);
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 26px;
            text-align: center;
            border-radius: 0;
            box-shadow: 2px 2px 0 var(--border-color);
        }
        .help-close-btn:hover {
            background: var(--border-color);
            color: var(--main-color);
        }
        .help-close-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        @media (max-width: 768px) {
            body { font-size: 16px; } 
            .terminal-window { --terminal-padding: 0.75rem; } 
            .terminal-title { font-size: 1.2rem; } 
            .filters-bar { flex-direction: column; align-items: stretch; gap: 0.75rem; } 
            .article-count { margin-left: 0; text-align: center; } 
            .terminal-footer { flex-direction: column; align-items: center; } 
            .countdown-display { text-align: center; order: -1; }
            .scroll-controls { flex-wrap: wrap; justify-content: center; }
        }
        @media (max-width: 480px) {
            .terminal-window { --terminal-padding: 0.5rem; }
            .terminal-header { gap: 0.5rem; } .terminal-title { font-size: 1rem; } 
            .effects-controls { gap: 0.5rem; justify-content: flex-end; }
            .switch-control { font-size: 0.7rem; gap: 0.25rem; } 
            .config-panel-header { font-size: 0.9rem; } 
            .news-item a { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="terminal-window">
        <header class="terminal-header">
            <h1 class="terminal-title">NEWS TERMINAL V1.16<span class="blinking-caret">█</span></h1>
            <div class="effects-controls">
                <button id="help-button" title="Help">[?]</button>
                <button id="zoom-btn" title="Change zoom level">ZOOM [1X]</button>
                <label class="switch-control" title="Enable/Disable sounds"> SOUND <input type="checkbox" data-effect="sound"> <span class="slider"></span> </label>
            </div>
        </header>

        <div class="terminal-content">
            <details class="config-panel">
                <summary class="config-panel-header">CONFIGURATION</summary>
                <div class="config-panel-content">
                    <div class="config-grid">
                        <div class="config-section">
                            <h3>RSS Feeds</h3>
                            <div class="config-input-group"> <input type="url" id="new-feed-input" placeholder="Feed URL..."> <button id="add-feed-btn">ADD</button> </div>
                            <div id="feeds-list" class="config-items"></div>
                        </div>
                        <div class="config-section">
                            <h3>Keywords</h3>
                            <div class="config-input-group">
                                <div class="autocomplete-container">
                                    <input type="text" id="new-keyword-suggestion" disabled>
                                    <input type="text" id="new-keyword-input" placeholder="Keyword..." autocomplete="off">
                                </div>
                                <button id="new-keyword-impact-btn" title="Cycle impact">IMPACT [▲]</button>
                                <label class="switch-control" title="Enable sound for this keyword">
                                    <span>♪</span>
                                    <input type="checkbox" id="new-keyword-sound-switch">
                                    <span class="slider"></span>
                                </label>
                                <button id="add-keyword-btn">ADD</button>
                            </div>
                            <div id="keywords-list" class="config-items"></div>
                        </div>
                    </div>
                    <div class="config-section" style="margin-top: 1rem;">
                        <div class="config-input-group"> <label for="refresh-interval">AUTO-REFRESH:</label> <select id="refresh-interval"> <option value="0">MANUAL</option> <option value="5">5 MIN</option> <option value="10">10 MIN</option> <option value="15">15 MIN</option> <option value="30">30 MIN</option> </select> <button id="refresh-btn">RELOAD_DATA()</button> </div>
                    </div>
                    <div class="config-section" style="margin-top: 1rem;">
                        <h3>Backup & Restore</h3>
                        <div class="config-input-group">
                            <button id="export-config-btn">EXPORT</button>
                            <button id="import-config-btn">IMPORT</button>
                            <button id="reset-config-btn">RESET</button>
                        </div>
                    </div>
                </div>
            </details>
            <input type="file" id="import-config-file" style="display: none;" accept=".json,.txt"/>

            <div class="filters-bar">
                <div id="date-filters" class="date-filters"> <button class="filter-btn" data-filter="all">ALL_TIME</button> <button class="filter-btn" data-filter="today">TODAY</button> <button class="filter-btn" data-filter="3days">LAST_3_DAYS</button> </div>
                <div id="keyword-filters" class="keyword-filters"> <button class="filter-btn" data-filter="keywords">KEYWORDS_ONLY</button> <button class="filter-btn" data-filter="all-news">ALL_NEWS</button> </div>
                <div id="article-count" class="article-count">RECORDS: 0/0</div>
            </div>

            <main id="results-container" class="terminal-screen"></main>
            <div id="news-meta-display" class="news-meta-bar"></div>

            <footer class="terminal-footer">
                <div class="scroll-controls">
                    <div class="speed-control-container">
                        <span>SLOW</span>
                        <input type="range" id="speed-control" min="10" max="200" title="Scroll speed">
                        <span>FAST</span>
                    </div>
                    <svg class="scroll-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4L12 20M12 4L8 8M12 4L16 8M12 20L8 16M12 20L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <label class="direction-switch" title="Scroll direction">
                        <input type="checkbox" id="direction-control">
                        <span class="direction-slider"></span>
                    </label>
                </div>
                <div id="countdown-display" class="countdown-display"></div>
                <div class="system-info">SYSTEM: READY</div>
            </footer>
        </div>
    </div>
    
    <div id="help-modal" class="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>SYSTEM HELP</h2>
                <button id="help-close-btn">X</button>
            </div>
            <p><strong>OBJECTIVE:</strong> Real-time monitoring of financial news from RSS feeds. Detection and highlighting of relevant information based on predefined keywords to quickly identify news with potential market impact (Bullish/Bearish).</p>
            <p><strong>CONFIGURATION:</strong><br>
            - <strong>RSS Feeds:</strong> Add or remove information sources.<br>
            - <strong>Keywords:</strong> Customize the list of words to detect. Assign an impact (Bullish/Bearish) and a sound alert (♪) to each word directly in the list.</p>
            <p><strong>CONTROLS:</strong><br>
            - <strong>Filters:</strong> Display all news or only those containing your keywords, and filter by time period.<br>
            - <strong>Scroll Controls:</strong> Adjust the speed and direction of the scroll with your mouse wheel/swipe or the dedicated controls.<br>
            - <strong>ZOOM:</strong> Increases the text size for better readability.<br>
            - <strong>SOUND:</strong> Toggles all sound alerts on or off.</p>
            <p><strong>INTERACTION:</strong><br>
            - Hover over a news item to see its date and source in the info bar below.<br>
            - Click on a news item to open it in a new tab.</p>
        </div>
    </div>

    <div id="reset-modal" class="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>RESET CONFIGURATION</h2>
            </div>
            <p>Are you sure you want to reset all RSS feeds and keywords to their default values? This action cannot be undone.</p>
            <div class="modal-buttons" style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button id="reset-cancel-btn">CANCEL</button>
                <button id="reset-confirm-btn">CONFIRM RESET</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let rssFeeds = [], keywords = [], readArticles = new Set(), allFetchedArticles = [], relevantArticles = [], cache = {};
        let activeDateFilter = 'all', activeKeywordFilter = 'keywords';
        let autoRefreshIntervalId = null, countdownIntervalId = null, glitchIntervalId = null;
        const CACHE_DURATION = 10 * 60 * 1000;
        
        let effectsSettings = { zoomLevel: 1, sound: false };
        let scrollSettings = { speed: 50, direction: 'up' };
        let touchStartY = 0;
        let newKeywordImpact = 'up'; // 'up', 'down', 'neutral'
        let synth; // Pour Tone.js
        let previousArticleLinks = new Set();
        let audioContextStarted = false;
        let currentSuggestion = '';
        let animationFrameId;

        // --- ÉLÉMENTS DU DOM ---
        const dom = {
            body: document.body,
            terminalWindow: document.querySelector('.terminal-window'),
            effectsControls: document.querySelector('.effects-controls'),
            results: document.getElementById('results-container'),
            feeds: document.getElementById('feeds-list'),
            keywords: document.getElementById('keywords-list'),
            newFeed: document.getElementById('new-feed-input'),
            newKeyword: document.getElementById('new-keyword-input'),
            newKeywordSuggestion: document.getElementById('new-keyword-suggestion'),
            newKeywordImpactBtn: document.getElementById('new-keyword-impact-btn'),
            newKeywordSoundSwitch: document.getElementById('new-keyword-sound-switch'),
            labelUp: document.getElementById('label-up'),
            labelDown: document.getElementById('label-down'),
            addFeedBtn: document.getElementById('add-feed-btn'),
            addKeywordBtn: document.getElementById('add-keyword-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            dateFilters: document.getElementById('date-filters'),
            keywordFilters: document.getElementById('keyword-filters'),
            count: document.getElementById('article-count'),
            refreshIntervalSelect: document.getElementById('refresh-interval'),
            countdownDisplay: document.getElementById('countdown-display'),
            systemInfo: document.querySelector('.system-info'),
            speedControl: document.getElementById('speed-control'),
            directionControl: document.getElementById('direction-control'),
            newsMetaDisplay: document.getElementById('news-meta-display'),
            helpButton: document.getElementById('help-button'),
            helpModal: document.getElementById('help-modal'),
            helpCloseBtn: document.getElementById('help-close-btn'),
            zoomBtn: document.getElementById('zoom-btn'),
            exportConfigBtn: document.getElementById('export-config-btn'),
            importConfigBtn: document.getElementById('import-config-btn'),
            importConfigFile: document.getElementById('import-config-file'),
            resetConfigBtn: document.getElementById('reset-config-btn'),
            resetModal: document.getElementById('reset-modal'),
            resetConfirmBtn: document.getElementById('reset-confirm-btn'),
            resetCancelBtn: document.getElementById('reset-cancel-btn')
        };
        
        // --- FONCTIONS UTILITAIRES ET CONFIGURATION ---
        function sanitizeForId(text) { return text.replace(/[^a-zA-Z0-9]/g, '-'); }

        function loadConfig() {
            const defaultFeeds = ['https://abcbourse.com/rss/chroniquesrss', 'https://abcbourse.com/rss/lastanalysisrss', 'https://abcbourse.com/rss/displaynewsrss', 'https://www.tradingsat.com/rssbourse.xml'];
            const defaultKeywords = [
                // Haussier
                { text: "OPA", impact: 'up', sound: true }, { text: "fusion", impact: 'up', sound: false }, { text: "acquisition", impact: 'up', sound: false },
                { text: "acquisition stratégique", impact: 'up', sound: false }, { text: "résultats supérieurs aux attentes", impact: 'up', sound: false },
                { text: "hausse du chiffre d'affaires", impact: 'up', sound: false }, { text: "amélioration de la marge", impact: 'up', sound: false },
                { text: "rachat d'actions", impact: 'up', sound: false }, { text: "hausse du dividende", impact: 'up', sound: false },
                { text: "contrat majeur remporté", impact: 'up', sound: false }, { text: "relèvement de recommandation", impact: 'up', sound: false },
                { text: "bonne publication", impact: 'up', sound: false }, { text: "innovation", impact: 'up', sound: false },
                { text: "approbation réglementaire", impact: 'up', sound: false }, { text: "IPO réussie", impact: 'up', sound: false },
                { text: "introduction en bourse", impact: 'up', sound: false }, { text: "croissance à l'international", impact: 'up', sound: false },
                { text: "hausse", impact: 'up', sound: false }, { text: "bénéfice", impact: 'up', sound: false }, { text: "profit", impact: 'up', sound: false }, 
                { text: "résultats", impact: 'up', sound: false }, { text: "croissance", impact: 'up', sound: false }, { text: "gain", impact: 'up', sound: false }, 
                { text: "rachat", impact: 'up', sound: false }, { text: "dividende", impact: 'up', sound: false }, { text: "contrat", impact: 'up', sound: false }, 
                { text: "recommandation", impact: 'up', sound: false }, { text: "approbation", impact: 'up', sound: false }, { text: "introduction", impact: 'up', sound: false }, 
                { text: "expansion", impact: 'up', sound: false }, { text: "amélioration", impact: 'up', sound: false }, { text: "relèvement", impact: 'up', sound: false }, 
                { text: "partenariat", impact: 'up', sound: false }, { text: "succès", impact: 'up', sound: false },
                // Baissier
                { text: "profit warning", impact: 'down', sound: true }, { text: "avertissement sur résultats", impact: 'down', sound: false },
                { text: "recul du chiffre d'affaires", impact: 'down', sound: false }, { text: "résultat net en baisse", impact: 'down', sound: false },
                { text: "recul de la marge opérationnelle", impact: 'down', sound: false }, { text: "dégradation de notation", impact: 'down', sound: false },
                { text: "suspension de dividende", impact: 'down', sound: false }, { text: "procès", impact: 'down', sound: false },
                { text: "enquête judiciaire", impact: 'down', sound: false }, { text: "amende", impact: 'down', sound: false },
                { text: "retard de production", impact: 'down', sound: false }, { text: "retard de livraison", impact: 'down', sound: false },
                { text: "tensions sociales", impact: 'down', sound: false }, { text: "grève", impact: 'down', sound: false },
                { text: "rupture de contrat", impact: 'down', sound: false }, { text: "endettement préoccupant", impact: 'down', sound: false },
                { text: "gel de projet", impact: 'down', sound: false }, { text: "retrait de la cote", impact: 'down', sound: false },
                { text: "perspectives revues à la baisse", impact: 'down', sound: false }, { text: "risque de nationalisation", impact: 'down', sound: false },
                { text: "départ du PDG", impact: 'down', sound: false }, { text: "départ du DG", impact: 'down', sound: false },
                { text: "pertes de change", impact: 'down', sound: false }, { text: "effet devises", impact: 'down', sound: false },
                { text: "conflit social", impact: 'down', sound: false }, { text: "blocage", impact: 'down', sound: false },
                { text: "révision des objectifs", impact: 'down', sound: false }, { text: "défaillance partenaire", impact: 'down', sound: false },
                { text: "baisse", impact: 'down', sound: false }, { text: "perte", impact: 'down', sound: false }, { text: "recul", impact: 'down', sound: false },
                { text: "avertissement", impact: 'down', sound: false }, { text: "dégradation", impact: 'down', sound: false }, { text: "suspension", impact: 'down', sound: false },
                { text: "enquête", impact: 'down', sound: false }, { text: "retard", impact: 'down', sound: false }, { text: "rupture", impact: 'down', sound: false },
                { text: "endettement", impact: 'down', sound: false }, { text: "conflit", impact: 'down', sound: false }, { text: "risque", impact: 'down', sound: false },
                { text: "départ", impact: 'down', sound: false }, { text: "défaillance", impact: 'down', sound: false }, { text: "inflation", impact: 'down', sound: false },
                { text: "licenciement", impact: 'down', sound: false }
            ];

            rssFeeds = JSON.parse(localStorage.getItem('rssFeeds')) || defaultFeeds;
            keywords = JSON.parse(localStorage.getItem('keywordsWithImpact')) || defaultKeywords;
            
            keywords.sort((a, b) => a.text.localeCompare(b.text)); // Tri au chargement
            readArticles = new Set(JSON.parse(localStorage.getItem('readArticles')) || []);
            cache = JSON.parse(localStorage.getItem('rssCache')) || {};
            dom.refreshIntervalSelect.value = localStorage.getItem('refreshInterval') || '5';
            
            const savedEffects = JSON.parse(localStorage.getItem('effectsSettings'));
            if (savedEffects) {
                effectsSettings = {...effectsSettings, ...savedEffects};
                // Migration from old setting
                if (savedEffects.zoom === true && savedEffects.zoomLevel === undefined) {
                    effectsSettings.zoomLevel = 2;
                }
                delete effectsSettings.zoom; // remove old property
            }

            const savedScroll = JSON.parse(localStorage.getItem('scrollSettings'));
            if (savedScroll) scrollSettings = savedScroll;

            const savedFilters = JSON.parse(localStorage.getItem('activeFilters'));
            if(savedFilters) {
                activeDateFilter = savedFilters.date;
                activeKeywordFilter = savedFilters.keyword;
            }
            
            updateSystemInfo("CONFIG LOADED");
        }

        function saveConfig() {
            localStorage.setItem('rssFeeds', JSON.stringify(rssFeeds));
            localStorage.setItem('keywordsWithImpact', JSON.stringify(keywords));
            localStorage.setItem('refreshInterval', dom.refreshIntervalSelect.value);
            localStorage.setItem('effectsSettings', JSON.stringify(effectsSettings));
            localStorage.setItem('scrollSettings', JSON.stringify(scrollSettings));
            localStorage.setItem('activeFilters', JSON.stringify({date: activeDateFilter, keyword: activeKeywordFilter}));
            updateSystemInfo("CONFIG SAVED");
        }

        function saveReadArticles() { localStorage.setItem('readArticles', JSON.stringify(Array.from(readArticles))); updateSystemInfo("READ STATUS UPDATED"); }
        function saveCache() { localStorage.setItem('rssCache', JSON.stringify(cache)); updateSystemInfo("CACHE SAVED"); }
        function updateSystemInfo(message) {
            if (dom.systemInfo) {
                dom.systemInfo.textContent = `SYSTEM: ${message}`;
                setTimeout(() => { if (dom.systemInfo) dom.systemInfo.textContent = "SYSTEM: READY"; }, 2000);
            }
        }

        function renderConfigUI() {
            if (rssFeeds.length === 0) {
                dom.feeds.innerHTML = `<div class="config-item" style="justify-content: center; color: var(--dim-color);">LOAD A CONFIG FILE</div>`;
            } else {
                dom.feeds.innerHTML = rssFeeds.map(feed => `<div class="config-item"><span class="status-icon" id="status-${sanitizeForId(feed)}">•</span><span class="config-item-text" title="${feed}">${feed}</span><button class="delete-btn" data-type="feed" data-value="${feed}">X</button></div>`).join('');
            }

            if (keywords.length === 0) {
                 dom.keywords.innerHTML = `<div class="config-item" style="justify-content: center; color: var(--dim-color);">LOAD A CONFIG FILE</div>`;
            } else {
                dom.keywords.innerHTML = keywords.map(kw => {
                    const impactSymbol = kw.impact === 'up' ? '▲' : (kw.impact === 'down' ? '▼' : '=');
                    const impactClass = `impact-${kw.impact}`;
                    return `
                    <div class="config-item" data-keyword="${kw.text}">
                        <span class="config-item-text">${kw.text}</span>
                         <button class="impact-toggle-btn" title="Cycle impact"><span class="${impactClass}">${impactSymbol}</span></button>
                        <label class="switch-control" title="Enable sound">
                            <span>♪</span>
                            <input type="checkbox" class="sound-toggle" ${kw.sound ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                        <button class="delete-btn" data-type="keyword" data-value="${kw.text}">X</button>
                    </div>`;
                }).join('');
            }
            updateSystemInfo("UI UPDATED");
        }
        
        function applyEffects() {
            dom.results.classList.remove('zoom-x2', 'zoom-x4');
            if (effectsSettings.zoomLevel === 2) {
                dom.results.classList.add('zoom-x2');
            } else if (effectsSettings.zoomLevel === 4) {
                dom.results.classList.add('zoom-x4');
            }
        }
        
        async function startAudioContext() {
            if (Tone && Tone.context.state !== 'running' && !audioContextStarted) {
                await Tone.start();
                console.log('Audio context started on user interaction.');
                audioContextStarted = true;
            }
        }

        function playSound() {
            if (!effectsSettings.sound || !Tone || Tone.context.state !== 'running') return;
            if (!synth) {
                synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
                }).toDestination();
            }
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "8n", now);
            synth.triggerAttackRelease("G5", "8n", now + 0.15);
        }

        function playValidationSound() {
            if (!effectsSettings.sound || !Tone || Tone.context.state !== 'running') return;
            if (!synth) {
                synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
                }).toDestination();
            }
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "8n", now);
            synth.triggerAttackRelease("G5", "8n", now + 0.15);
            synth.triggerAttackRelease("C5", "8n", now + 0.4);
            synth.triggerAttackRelease("G5", "8n", now + 0.55);
        }

        function setupEffectControls() {
            // Sound control (existing checkbox)
            const soundInput = dom.effectsControls.querySelector('input[data-effect="sound"]');
            if (soundInput) {
                soundInput.checked = effectsSettings.sound;
                soundInput.addEventListener('change', async () => { 
                    effectsSettings.sound = soundInput.checked; 
                    if (effectsSettings.sound) {
                       await startAudioContext();
                       playValidationSound();
                    }
                    saveConfig(); 
                });
            }

            // Zoom control (new button)
            const updateZoomBtn = () => {
                if (dom.zoomBtn) dom.zoomBtn.textContent = `ZOOM [${effectsSettings.zoomLevel}X]`;
            };
            updateZoomBtn();

            if (dom.zoomBtn) {
                dom.zoomBtn.addEventListener('click', () => {
                    if (effectsSettings.zoomLevel === 1) {
                        effectsSettings.zoomLevel = 2;
                    } else if (effectsSettings.zoomLevel === 2) {
                        effectsSettings.zoomLevel = 4;
                    } else {
                        effectsSettings.zoomLevel = 1;
                    }
                    updateZoomBtn();
                    applyEffects();
                    saveConfig();
                    displayResults(); // Recalculate ticker animation
                });
            }
        }

        function setupScrollControls() {
            dom.speedControl.value = scrollSettings.speed;
            dom.directionControl.checked = scrollSettings.direction === 'down';

            dom.speedControl.addEventListener('input', () => {
                scrollSettings.speed = dom.speedControl.value;
                displayResults();
            });
            dom.speedControl.addEventListener('change', saveConfig);

            dom.directionControl.addEventListener('change', () => {
                scrollSettings.direction = dom.directionControl.checked ? 'down' : 'up';
                displayResults();
                saveConfig();
            });
        }

        function setupFilters() {
            dom.dateFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            dom.keywordFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            dom.dateFilters.querySelector(`[data-filter="${activeDateFilter}"]`).classList.add('active');
            dom.keywordFilters.querySelector(`[data-filter="${activeKeywordFilter}"]`).classList.add('active');
        }

        // --- FONCTIONS IMPORT/EXPORT ---
        function exportConfig() {
            try {
                const configData = {
                    rssFeeds: rssFeeds,
                    keywords: keywords
                };
                const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateString = new Date().toISOString().split('T')[0];
                a.download = `news_terminal_config_${dateString}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                updateSystemInfo("CONFIG EXPORTED");
            } catch (error) {
                console.error("Export failed:", error);
                updateSystemInfo("ERROR: EXPORT FAILED");
            }
        }

        function importConfig() {
            const file = dom.importConfigFile.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && Array.isArray(importedData.rssFeeds) && Array.isArray(importedData.keywords)) {
                        rssFeeds = importedData.rssFeeds;
                        keywords = importedData.keywords.map(k => ({...k, impact: k.impact || 'neutral'})); // Ensure impact exists
                        keywords.sort((a, b) => a.text.localeCompare(b.text));
                        
                        saveConfig();
                        renderConfigUI();
                        fetchAllFeeds();
                        updateSystemInfo("CONFIG IMPORTED");
                    } else {
                        updateSystemInfo("ERROR: BAD CONFIG FORMAT");
                    }
                } catch (error) {
                    console.error("Import failed:", error);
                    updateSystemInfo("ERROR: NOT A VALID JSON FILE");
                }
                dom.importConfigFile.value = '';
            };
            reader.readAsText(file);
        }

        // --- LOGIQUE PRINCIPALE ---
        async function fetchAllFeeds() {
            if (dom.refreshBtn.disabled) return;
            dom.refreshBtn.disabled = true; dom.refreshBtn.textContent = 'LOADING...'; updateSystemInfo("FETCHING DATA");
            const fetchPromises = rssFeeds.map(async (feedUrl) => {
                const feedId = sanitizeForId(feedUrl), statusEl = document.getElementById(`status-${feedId}`), now = Date.now(), cachedItem = cache[feedUrl];
                if (cachedItem && (now - cachedItem.timestamp < CACHE_DURATION)) { if (statusEl) statusEl.innerHTML = `~`; try { return cachedItem.articles.map(a => ({ ...a, source: new URL(feedUrl).hostname })); } catch(e) { return []; } }
                if (statusEl) statusEl.innerHTML = `?`;
                try {
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(feedUrl)}`);
                    if (!response.ok) throw new Error(`ERR ${response.status}`);
                    const xmlString = await response.text(), articles = parseRSS(xmlString);
                    cache[feedUrl] = { timestamp: Date.now(), articles }; saveCache();
                    if (statusEl) statusEl.innerHTML = `+`; return articles.map(a => ({ ...a, source: new URL(feedUrl).hostname }));
                } catch (error) { console.error(`Flux ${feedUrl}:`, error); if (statusEl) statusEl.innerHTML = `!`; try { return cachedItem ? cachedItem.articles.map(a => ({ ...a, source: new URL(feedUrl).hostname })) : []; } catch(e) { return []; } }
            });
            const articleArrays = await Promise.all(fetchPromises);
            allFetchedArticles = articleArrays.flat().sort((a, b) => new Date(b.date) - new Date(a.date));
            relevantArticles = findRelevantArticles(allFetchedArticles);

            const newArticles = relevantArticles.filter(a => !previousArticleLinks.has(a.link));
            if(newArticles.some(a => a.keywords.some(k => keywords.find(kw => kw.text === k && kw.sound)))) {
                playSound();
            }
            previousArticleLinks = new Set(relevantArticles.map(a => a.link));

            displayResults();
            dom.refreshBtn.disabled = false; dom.refreshBtn.textContent = 'RELOAD_DATA()'; updateSystemInfo("DATA FETCHED");
        }

        function parseRSS(xmlString) {
            const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            if (xmlDoc.querySelector("parsererror")) { console.error("Erreur XML"); return []; }
            return Array.from(xmlDoc.querySelectorAll("item, entry")).map(item => ({ title: item.querySelector("title")?.textContent || '', link: item.querySelector("link")?.getAttribute('href') || item.querySelector("link")?.textContent || '', description: item.querySelector("description, summary")?.textContent || '', date: new Date(item.querySelector("pubDate, published, updated")?.textContent || Date.now()) }));
        }

        function findRelevantArticles(articles) {
            return articles.map(article => {
                const contentToScan = `${article.title} ${article.description}`.toLowerCase(); 
                let impactScore = 0; 
                const foundKeywords = new Set();
                let hasMatch = false;

                keywords.forEach(kw => { 
                    if (contentToScan.includes(kw.text.toLowerCase())) { 
                        hasMatch = true;
                        foundKeywords.add(kw.text);
                        if(kw.impact === 'up') {
                            impactScore += 1;
                        } else if (kw.impact === 'down') {
                            impactScore -= 1;
                        }
                    } 
                });
                return hasMatch ? { ...article, keywords: Array.from(foundKeywords), impactScore } : null;
            }).filter(Boolean);
        }

        function displayResults() {
            cancelAnimationFrame(animationFrameId);
            dom.results.innerHTML = '';
            const sourceArticles = activeKeywordFilter === 'keywords' ? relevantArticles : allFetchedArticles;
            const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate()), threeDaysAgo = new Date(today); threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
            const filteredArticles = sourceArticles.filter(article => { const articleDate = new Date(article.date); if (activeDateFilter === 'today') return articleDate >= today; if (activeDateFilter === '3days') return articleDate >= threeDaysAgo; return true; });
            dom.count.textContent = `RECORDS: ${filteredArticles.length}/${sourceArticles.length}`;
            if (filteredArticles.length === 0) { dom.results.innerHTML = `<div class="no-data" style="padding: 2rem; text-align: center;">NO RELEVANT DATA FOUND.</div>`; return; }
            const ticker = document.createElement('div'); ticker.className = 'news-ticker';
            
            const keywordsWithSound = new Set(keywords.filter(k => k.sound).map(k => k.text));

            ticker.innerHTML = filteredArticles.map(article => {
                const impactScore = article.impactScore;
                const hasKeywords = article.keywords && article.keywords.length > 0;
                let impactClass = '', impactSymbol = '•';

                if (hasKeywords) {
                     if (impactScore > 0) {
                        impactClass = 'impact-up';
                        impactSymbol = '▲';
                    } else if (impactScore < 0) {
                        impactClass = 'impact-down';
                        impactSymbol = '▼';
                    } else {
                        impactClass = 'impact-neutral';
                        impactSymbol = '=';
                    }
                }
               
                const impactHtml = hasKeywords ? `<span class="${impactClass}">[${impactSymbol}]</span>` : `<span>[${impactSymbol}]</span>`;
                const titleHtml = `${impactHtml} > ${highlightKeywords(article.title, article.keywords || [], impactClass)}`;
                const dateStr = formatDate(new Date(article.date));
                const sourceStr = article.source || 'N/A';
                const hasSound = article.keywords && article.keywords.some(k => keywordsWithSound.has(k));
                return `<div class="news-item ${readArticles.has(article.link) ? 'is-read' : ''}" ${hasSound ? 'data-sound-trigger="true"' : ''}><a href="${article.link}" data-link="${article.link}" data-date="${dateStr}" data-source="${sourceStr}" target="_blank" rel="noopener noreferrer"><div class="news-title">${titleHtml}</div></a></div>`;
            }).join('');
            dom.results.appendChild(ticker);

            setTimeout(() => {
                if (ticker.scrollHeight > dom.results.clientHeight) {
                    ticker.innerHTML += ticker.innerHTML;
                    startTickerAnimation(ticker);
                }
            }, 100);
        }

        function startTickerAnimation(ticker) {
            let position = 0;
            let lastTime = null;
            const container = dom.results;
            const containerHeight = container.clientHeight;
            const contentHeight = ticker.scrollHeight / 2;
            const soundItems = ticker.querySelectorAll('[data-sound-trigger="true"]');
            const scanLineY = containerHeight / 2;

            function animate(timestamp) {
                if (!lastTime) lastTime = timestamp;
                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;

                const speedFactor = (parseInt(scrollSettings.speed, 10) / 100) * 100 + 20; // Vitesse de base + ajustement
                const directionFactor = scrollSettings.direction === 'up' ? -1 : 1;
                
                position += (deltaTime / 1000) * speedFactor * directionFactor;

                if (directionFactor === -1 && Math.abs(position) >= contentHeight) {
                    position = 0;
                    soundItems.forEach(item => item.dataset.soundPlayed = 'false');
                } else if (directionFactor === 1 && position >= 0) {
                    position = -contentHeight;
                    soundItems.forEach(item => item.dataset.soundPlayed = 'false');
                }
                
                ticker.style.transform = `translateY(${position}px)`;

                // Détection du son
                soundItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    const itemTop = rect.top - containerRect.top;
                    const itemBottom = rect.bottom - containerRect.top;

                    if (itemTop < scanLineY && itemBottom > scanLineY) {
                        if (item.dataset.soundPlayed !== 'true') {
                            playSound();
                            item.dataset.soundPlayed = 'true';
                        }
                    }
                });

                animationFrameId = requestAnimationFrame(animate);
            }
            animationFrameId = requestAnimationFrame(animate);
        }

        function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return '??/??'; return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`; }
        function highlightKeywords(text, keywordsToHighlight, colorClass) { if (!text || !keywordsToHighlight || keywordsToHighlight.length === 0) return text; const regex = new RegExp(keywordsToHighlight.map(k => k.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|'), 'gi'); return text.replace(regex, (match) => `<span class="${colorClass}">${match}</span>`); }

        function setAutoRefresh(minutes) {
            clearInterval(autoRefreshIntervalId); clearInterval(countdownIntervalId); dom.countdownDisplay.textContent = '';
            if (minutes > 0) {
                const intervalMs = minutes * 60 * 1000; autoRefreshIntervalId = setInterval(fetchAllFeeds, intervalMs); let nextRefresh = Date.now() + intervalMs;
                const updateCountdown = () => { const remaining = Math.round((nextRefresh - Date.now()) / 1000); if (remaining <= 0) { dom.countdownDisplay.textContent = 'REFRESHING...'; return; } dom.countdownDisplay.textContent = `NEXT REFRESH: ${Math.floor(remaining / 60)}:${(remaining % 60) < 10 ? '0' : ''}${remaining % 60}`; };
                updateCountdown(); countdownIntervalId = setInterval(updateCountdown, 1000); updateSystemInfo(`AUTO-REFRESH SET: ${minutes}MIN`);
            } else { updateSystemInfo("AUTO-REFRESH DISABLED"); }
        }

        // --- GESTIONNAIRES D'ÉVÉNEMENTS ---
        function handleWheelScroll(e) { e.preventDefault(); if (e.deltaY < 0) { scrollSettings.direction = 'down'; } else { scrollSettings.direction = 'up'; } dom.directionControl.checked = scrollSettings.direction === 'down'; displayResults(); saveConfig(); }
        function handleTouchStart(e) { touchStartY = e.touches[0].clientY; }
        function handleTouchEnd(e) {
            const touchEndY = e.changedTouches[0].clientY; const deltaY = touchEndY - touchStartY;
            if (Math.abs(deltaY) > 50) { if (deltaY > 0) { scrollSettings.direction = 'up'; } else { scrollSettings.direction = 'down'; } dom.directionControl.checked = scrollSettings.direction === 'down'; displayResults(); saveConfig(); }
        }
        
        function handleKeywordInput() {
            const value = dom.newKeyword.value.toLowerCase().trim();
            dom.newKeywordSuggestion.value = '';
            currentSuggestion = '';

            if (!value) return;
            const matchedKeyword = keywords.find(kw => kw.text.toLowerCase().startsWith(value));
            if (matchedKeyword) {
                dom.newKeywordSuggestion.value = matchedKeyword.text;
                currentSuggestion = matchedKeyword.text;

                const element = dom.keywords.querySelector(`[data-keyword="${matchedKeyword.text}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig(); 
            renderConfigUI(); 
            setupEffectControls(); 
            setupScrollControls(); 
            setupFilters(); 
            applyEffects(); 
            fetchAllFeeds(); 
            setAutoRefresh(parseInt(dom.refreshIntervalSelect.value, 10));
            
            // if (rssFeeds.length === 0 && keywords.length === 0) {
            //     document.querySelector('.config-panel').open = true;
            // }

            document.body.addEventListener('click', startAudioContext, { once: true });
            document.body.addEventListener('touchstart', startAudioContext, { once: true });
            
            dom.results.addEventListener('wheel', handleWheelScroll, { passive: false });
            dom.results.addEventListener('touchstart', handleTouchStart, { passive: false });
            dom.results.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            function updateNewKeywordImpactBtn() {
                const symbols = { up: '▲', down: '▼', neutral: '=' };
                const classes = { up: 'impact-up', down: 'impact-down', neutral: 'impact-neutral' };
                dom.newKeywordImpactBtn.innerHTML = `IMPACT [<span class="${classes[newKeywordImpact]}">${symbols[newKeywordImpact]}</span>]`;
            }
            updateNewKeywordImpactBtn();

            dom.newKeywordImpactBtn.addEventListener('click', () => {
                const cycle = { 'up': 'neutral', 'neutral': 'down', 'down': 'up' };
                newKeywordImpact = cycle[newKeywordImpact];
                updateNewKeywordImpactBtn();
            });
            
            dom.newsMetaDisplay.textContent = '// HOVER A NEWS ITEM FOR DETAILS';
            dom.results.addEventListener('mouseover', (e) => {
                const linkElement = e.target.closest('a');
                if (linkElement && linkElement.dataset.date) {
                    dom.newsMetaDisplay.textContent = `DATE: ${linkElement.dataset.date} // SOURCE: ${linkElement.dataset.source}`;
                }
            });
            dom.results.addEventListener('mouseout', () => {
                dom.newsMetaDisplay.textContent = '// HOVER A NEWS ITEM FOR DETAILS';
            });

            // GESTION DES MODIFICATIONS DANS LA LISTE DE MOTS-CLÉS
            dom.keywords.addEventListener('click', (e) => {
                const target = e.target;
                const configItem = target.closest('.config-item');
                if (!configItem) return;

                const keywordText = configItem.dataset.keyword;
                const keyword = keywords.find(k => k.text === keywordText);
                if (!keyword) return;

                if (target.closest('.sound-toggle')) {
                     keyword.sound = target.closest('.sound-toggle').checked;
                }
                
                if (target.closest('.impact-toggle-btn')) {
                    const cycle = { 'up': 'neutral', 'neutral': 'down', 'down': 'up' };
                    keyword.impact = cycle[keyword.impact];
                }
                saveConfig();
                renderConfigUI(); // Redessine pour mettre à jour les styles
            });
            
            dom.newKeyword.addEventListener('input', handleKeywordInput);
            dom.newKeyword.addEventListener('keydown', (e) => {
                if ((e.key === 'Tab' || e.key === 'Enter') && currentSuggestion) {
                    e.preventDefault();
                    dom.newKeyword.value = currentSuggestion;
                    dom.newKeywordSuggestion.value = '';
                    currentSuggestion = '';
                }
            });

            dom.helpButton.addEventListener('click', () => dom.helpModal.classList.add('is-visible'));
            dom.helpCloseBtn.addEventListener('click', () => dom.helpModal.classList.remove('is-visible'));
            dom.helpModal.addEventListener('click', (e) => {
                if (e.target === dom.helpModal) {
                    dom.helpModal.classList.remove('is-visible');
                }
            });

            // Listeners for import/export
            dom.exportConfigBtn.addEventListener('click', exportConfig);
            dom.importConfigBtn.addEventListener('click', () => dom.importConfigFile.click());
            dom.importConfigFile.addEventListener('change', importConfig);

            // Listeners for reset
            dom.resetConfigBtn.addEventListener('click', () => dom.resetModal.classList.add('is-visible'));
            dom.resetCancelBtn.addEventListener('click', () => dom.resetModal.classList.remove('is-visible'));
            dom.resetModal.addEventListener('click', (e) => {
                if (e.target === dom.resetModal) {
                    dom.resetModal.classList.remove('is-visible');
                }
            });
            dom.resetConfirmBtn.addEventListener('click', () => {
                localStorage.removeItem('rssFeeds');
                localStorage.removeItem('keywordsWithImpact');
                localStorage.removeItem('effectsSettings');
                localStorage.removeItem('scrollSettings');
                localStorage.removeItem('activeFilters');
                localStorage.removeItem('readArticles');
                localStorage.removeItem('rssCache');
                location.reload();
            });
        });
        dom.addFeedBtn.addEventListener('click', () => { const newFeed = dom.newFeed.value.trim(); if (newFeed && !rssFeeds.includes(newFeed)) { rssFeeds.push(newFeed); saveConfig(); renderConfigUI(); dom.newFeed.value = ''; updateSystemInfo("RSS FEED ADDED"); fetchAllFeeds(); } });
        dom.addKeywordBtn.addEventListener('click', () => { const text = dom.newKeyword.value.trim(); if (text && !keywords.some(kw => kw.text === text)) { const sound = dom.newKeywordSoundSwitch.checked; keywords.push({ text, impact: newKeywordImpact, sound }); keywords.sort((a, b) => a.text.localeCompare(b.text)); saveConfig(); renderConfigUI(); dom.newKeyword.value = ''; updateSystemInfo("KEYWORD ADDED"); fetchAllFeeds();} });
        dom.dateFilters.addEventListener('click', (e) => { if (e.target.matches('.filter-btn')) { dom.dateFilters.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); activeDateFilter = e.target.dataset.filter; displayResults(); saveConfig(); updateSystemInfo(`FILTER: ${activeDateFilter.toUpperCase()}`); } });
        dom.keywordFilters.addEventListener('click', (e) => { if (e.target.matches('.filter-btn')) { dom.keywordFilters.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); activeKeywordFilter = e.target.dataset.filter; displayResults(); saveConfig(); updateSystemInfo(`VIEW: ${activeKeywordFilter.toUpperCase()}`); } });
        dom.results.addEventListener('click', (e) => { const linkElement = e.target.closest('a'); if (linkElement) { const link = linkElement.dataset.link; if(link) { readArticles.add(link); saveReadArticles(); linkElement.parentElement.classList.add('is-read'); } } });
        document.body.addEventListener('click', (e) => { if (e.target.classList.contains('delete-btn')) { const type = e.target.dataset.type, value = e.target.dataset.value; if (type === 'feed') { rssFeeds = rssFeeds.filter(item => item !== value); } else if (type === 'keyword') { keywords = keywords.filter(item => item.text !== value); } saveConfig(); renderConfigUI(); relevantArticles = findRelevantArticles(allFetchedArticles); displayResults(); } });
        dom.refreshBtn.addEventListener('click', () => { fetchAllFeeds(); setAutoRefresh(parseInt(dom.refreshIntervalSelect.value, 10)); });
        dom.refreshIntervalSelect.addEventListener('change', (e) => { const minutes = parseInt(e.target.value, 10); saveConfig(); setAutoRefresh(minutes); });
    </script>
</body>
</html>


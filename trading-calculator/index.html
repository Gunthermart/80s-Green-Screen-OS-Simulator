<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Elegant Light Mode Palette */
            --color-background: #FDF6E3;
            --color-card-background: #FFFFFF;
            --color-secondary-background: #E6D8AD;
            --color-text-main: #333333;
            --color-text-secondary: #777777;
            --color-border: #D1C4A8;
            --color-input-background: #FFFFFF;
            --color-accent-primary: #B0C4DE; /* Sky Blue */
            --color-accent-primary-text: #FFFFFF;
            --color-accent-success: #6B8E23; /* Olive Drab */
            --color-accent-danger: #8B0000; /* Deep Red */
            --color-accent-danger-bg: #FADADD;
        }
        html.dark {
            /* Elegant Dark Mode Palette */
            --color-background: #121212;
            --color-card-background: #1E1E1E;
            --color-secondary-background: #2a2a2a;
            --color-text-main: rgba(255, 255, 255, 0.87);
            --color-text-secondary: rgba(255, 255, 255, 0.60);
            --color-border: #646464;
            --color-input-background: #2a2a2a;
            --color-accent-primary: #3777d3; /* Soft Blue */
            --color-accent-primary-text: #FFFFFF;
            --color-accent-success: #4CAF50; /* Desaturated Green */
            --color-accent-danger: #ff3232; /* Light Red */
            --color-accent-danger-bg: rgba(255, 50, 50, 0.15);
        }
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--color-background);
            color: var(--color-text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        /* Simple transition for modals */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-leave { opacity: 1; transform: scale(1); }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="font-sans">

    <main class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-[var(--color-card-background)] p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md relative transition-colors duration-300">
            
            <!-- Header Icons -->
            <div class="absolute top-4 right-4 flex items-center space-x-2">
                <!-- Language Selector -->
                <div class="relative">
                    <button id="lang-toggle" class="p-2 rounded-full text-[var(--color-text-secondary)] hover:bg-black/10 dark:hover:bg-white/10 transition-colors duration-200" aria-label="Select Language">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V10a1 1 0 00-1-1H7a1 1 0 00-1 1v10a1 1 0 001 1h2a1 1 0 001-1zm-1-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4z" /></svg>
                    </button>
                    <div id="lang-menu" class="hidden absolute right-0 mt-2 w-36 bg-[var(--color-card-background)] rounded-md shadow-lg z-20 border border-[var(--color-border)]">
                        <ul class="py-1">
                            <li><button data-lang="en" class="lang-option w-full text-left px-4 py-2 text-sm text-[var(--color-text-main)] hover:bg-[var(--color-secondary-background)]/50">English</button></li>
                            <li><button data-lang="fr" class="lang-option w-full text-left px-4 py-2 text-sm text-[var(--color-text-main)] hover:bg-[var(--color-secondary-background)]/50">Français</button></li>
                            <li><button data-lang="es" class="lang-option w-full text-left px-4 py-2 text-sm text-[var(--color-text-main)] hover:bg-[var(--color-secondary-background)]/50">Español</button></li>
                            <li><button data-lang="de" class="lang-option w-full text-left px-4 py-2 text-sm text-[var(--color-text-main)] hover:bg-[var(--color-secondary-background)]/50">Deutsch</button></li>
                            <li><button data-lang="zh" class="lang-option w-full text-left px-4 py-2 text-sm text-[var(--color-text-main)] hover:bg-[var(--color-secondary-background)]/50">中文</button></li>
                        </ul>
                    </div>
                </div>
                <!-- Help Button -->
                <button id="help-button" class="p-2 rounded-full text-[var(--color-text-secondary)] hover:bg-black/10 dark:hover:bg-white/10 transition-colors duration-200" aria-label="Help">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="p-2 rounded-full text-[var(--color-text-secondary)] hover:bg-black/10 dark:hover:bg-white/10 transition-colors duration-200" aria-label="Toggle Dark Mode">
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>

            <h1 data-i18n="title" class="text-2xl sm:text-3xl font-bold mb-2 text-center pt-10">Trading Calculator</h1>
            <p data-i18n="subtitle" class="text-center text-[var(--color-text-secondary)] mb-6 text-sm sm:text-base">Calculate your position size and risk/reward ratio.</p>

            <!-- Trade Type Toggle -->
            <div class="flex justify-center mb-6">
                <div class="flex rounded-lg p-1 bg-[var(--color-secondary-background)]/50">
                    <button id="long-button" data-i18n="long" class="px-4 sm:px-6 py-2 text-sm font-bold rounded-md transition-all duration-300">LONG</button>
                    <button id="short-button" data-i18n="short" class="px-4 sm:px-6 py-2 text-sm font-bold rounded-md transition-all duration-300">SHORT</button>
                </div>
            </div>

            <!-- Input Fields -->
            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="capital" data-i18n="capitalLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Capital ($)</label>
                        <input type="number" id="capital" data-i18n-placeholder="capitalPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="10000" />
                    </div>
                    <div>
                        <label for="risk" data-i18n="riskLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Risk (%)</label>
                        <input type="number" id="risk" data-i18n-placeholder="riskPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="1" />
                    </div>
                </div>
                <div>
                    <label for="entry" data-i18n="entryLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Entry Price ($)</label>
                    <input type="number" id="entry" data-i18n-placeholder="entryPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="50.25" />
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="stoploss" data-i18n="stopLossLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Stop-Loss ($)</label>
                        <input type="number" id="stoploss" data-i18n-placeholder="stopLossPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="49.50" />
                    </div>
                    <div>
                        <label for="takeprofit" data-i18n="takeProfitLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Take-Profit ($)</label>
                        <input type="number" id="takeprofit" data-i18n-placeholder="takeProfitPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="52.00" />
                    </div>
                </div>
                 <div>
                    <label for="rr-input" data-i18n="rrInputLabel" class="block text-sm font-medium text-[var(--color-text-secondary)]">Risk/Reward Ratio (1:X)</label>
                    <input type="number" id="rr-input" data-i18n-placeholder="rrInputPlaceholder" class="input-field mt-1 block w-full px-3 py-2 bg-[var(--color-input-background)] border border-[var(--color-border)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)]" placeholder="2" />
                </div>
            </div>

            <!-- Error & Results -->
            <div id="error-container" class="hidden mt-6 p-3 bg-[var(--color-accent-danger-bg)] text-[var(--color-accent-danger)] rounded-lg">
                <p id="error-message" class="text-center font-medium text-sm"></p>
            </div>
            <div id="results-container" class="hidden mt-6 p-4 sm:p-6 bg-[var(--color-accent-primary)]/20 rounded-lg border border-[var(--color-accent-primary)]/50">
                <h2 data-i18n="resultsTitle" class="text-xl sm:text-2xl font-semibold mb-4 text-center">Results</h2>
                <div class="space-y-3 text-sm sm:text-base">
                    <div class="flex justify-between items-center">
                        <span data-i18n="monetaryRisk" class="font-medium text-[var(--color-text-secondary)]">Monetary Risk:</span>
                        <span id="risk-amount" class="font-bold text-lg sm:text-xl text-[var(--color-text-main)]"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span data-i18n="positionSize" class="font-medium text-[var(--color-text-secondary)]">Position Size:</span>
                        <span id="position-size" class="font-bold text-lg sm:text-xl text-[var(--color-text-main)]"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span data-i18n="riskRewardRatio" class="font-medium text-[var(--color-text-secondary)]">Risk/Reward Ratio:</span>
                        <span id="rr-ratio" class="font-bold text-lg sm:text-xl text-[var(--color-text-main)]"></span>
                    </div>
                </div>
            </div>
            
            <!-- Reset Button -->
            <div class="mt-6">
                <button id="reset-button" data-i18n="reset" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-[var(--color-text-secondary)] bg-black/10 hover:bg-black/20 dark:bg-white/10 dark:hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">Reset</button>
            </div>
        </div>
    </main>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--color-card-background)] rounded-lg shadow-xl w-full max-w-lg p-6 sm:p-8 relative">
            <button id="close-help-modal" class="absolute top-4 right-4 text-[var(--color-text-secondary)] hover:text-[var(--color-text-main)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 data-i18n="helpTitle" class="text-xl sm:text-2xl font-bold mb-4 text-[var(--color-text-main)]">How the Calculator Works</h2>
            <div class="space-y-4 text-[var(--color-text-secondary)] text-sm sm:text-base">
                <div>
                    <h3 data-i18n="helpObjectiveTitle" class="font-semibold text-[var(--color-text-main)] mb-1">Objective</h3>
                    <p data-i18n="helpObjectiveText">This tool helps you manage your risk...</p>
                </div>
                <div>
                    <h3 data-i18n="helpHowToTitle" class="font-semibold text-[var(--color-text-main)] mb-1">How to Use</h3>
                    <ul class="space-y-2 list-inside">
                        <li data-i18n="helpHowToText1">1. **Select Trade Type:** ...</li>
                        <li data-i18n="helpHowToText2">2. **Enter your Capital:** ...</li>
                        <li data-i18n="helpHowToText3">3. **Define your Risk:** ...</li>
                        <li data-i18n="helpHowToText4">4. **Set your Prices:** ...</li>
                        <li data-i18n="helpHowToText5" class="pt-2 text-[var(--color-text-main)]">The results will automatically show...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DICTIONNAIRE DE TRADUCTIONS (i18n) ---
        const translations = {
            en: { title: "Trading Calculator", subtitle: "Calculate your position size and risk/reward ratio.", long: "LONG", short: "SHORT", capitalLabel: "Capital ($)", capitalPlaceholder: "10000", riskLabel: "Risk (%)", riskPlaceholder: "1", entryLabel: "Entry Price ($)", entryPlaceholder: "50.25", stopLossLabel: "Stop-Loss ($)", stopLossPlaceholder: "49.50", takeProfitLabel: "Take-Profit ($)", takeProfitPlaceholder: "52.00", rrInputLabel: "Risk/Reward Ratio (1:X)", rrInputPlaceholder: "2", resultsTitle: "Results", monetaryRisk: "Monetary Risk:", positionSize: "Position Size:", riskRewardRatio: "Risk/Reward Ratio:", units: "Units", reset: "Reset", errorFillAllFields: "Please fill in all fields to perform the calculation.", errorInvalidNumbers: "Please enter valid numbers for all fields.", errorPositiveValues: "Capital and risk percentage must be greater than zero.", errorPositiveRR: "Risk/Reward ratio must be a positive number.", errorEntryStopSame: "Entry price cannot be the same as the stop-loss price.", errorLongStopLoss: "For a Long trade, stop-loss must be below the entry price.", errorLongTakeProfit: "For a Long trade, take-profit must be above the entry price.", errorShortStopLoss: "For a Short trade, stop-loss must be above the entry price.", errorShortTakeProfit: "For a Short trade, take-profit must be below the entry price.", errorCalculation: "An error occurred during calculation.", helpTitle: "How the Calculator Works", helpObjectiveTitle: "Objective", helpObjectiveText: "This tool helps you manage your risk in trading by calculating the optimal position size based on your capital, risk percentage, and trade setup (entry, stop-loss, and take-profit prices).", helpHowToTitle: "How to Use", helpHowToText1: "1. **Select Trade Type:** Choose 'LONG' if you are buying or 'SHORT' if you are selling.", helpHowToText2: "2. **Enter your Capital:** The total amount of money in your trading account.", helpHowToText3: "3. **Define your Risk:** The percentage of your capital you are willing to risk on this single trade (e.g., 1% or 2%).", helpHowToText4: "4. **Set your Prices:** Enter your entry price, your stop-loss price (where you will exit if the trade goes against you), and your take-profit price.", helpHowToText5: "The results will automatically show you the amount of money at risk, the exact position size to take, and the risk/reward ratio of your trade.", },
            fr: { title: "Calculateur de Trading", subtitle: "Calculez votre taille de position et votre ratio risque/récompense.", long: "LONG", short: "SHORT", capitalLabel: "Capital ($)", capitalPlaceholder: "10000", riskLabel: "Risque (%)", riskPlaceholder: "1", entryLabel: "Prix d'Entrée ($)", entryPlaceholder: "50.25", stopLossLabel: "Stop-Loss ($)", stopLossPlaceholder: "49.50", takeProfitLabel: "Take-Profit ($)", takeProfitPlaceholder: "52.00", rrInputLabel: "Ratio Risque/Récompense (1:X)", rrInputPlaceholder: "2", resultsTitle: "Résultats", monetaryRisk: "Risque Monétaire:", positionSize: "Taille de la Position:", riskRewardRatio: "Ratio Risque/Récompense:", units: "Unités", reset: "Réinitialiser", errorFillAllFields: "Veuillez remplir tous les champs pour effectuer le calcul.", errorInvalidNumbers: "Veuillez entrer des nombres valides pour tous les champs.", errorPositiveValues: "Le capital et le pourcentage de risque doivent être supérieurs à zéro.", errorPositiveRR: "Le ratio Risque/Récompense doit être un nombre positif.", errorEntryStopSame: "Le prix d'entrée ne peut pas être le même que le prix du stop-loss.", errorLongStopLoss: "Pour un achat (Long), le stop-loss doit être inférieur au prix d'entrée.", errorLongTakeProfit: "Pour un achat (Long), le take-profit doit être supérieur au prix d'entrée.", errorShortStopLoss: "Pour une vente (Short), le stop-loss doit être supérieur au prix d'entrée.", errorShortTakeProfit: "Pour une vente (Short), le take-profit doit être inférieur au prix d'entrée.", errorCalculation: "Une erreur est survenue lors du calcul.", helpTitle: "Fonctionnement du Calculateur", helpObjectiveTitle: "Objectif", helpObjectiveText: "Cet outil vous aide à gérer votre risque en trading en calculant la taille de position optimale en fonction de votre capital, de votre pourcentage de risque et de votre configuration de trade (prix d'entrée, de stop-loss et de take-profit).", helpHowToTitle: "Comment l'utiliser", helpHowToText1: "1. **Sélectionnez le type de trade :** Choisissez 'LONG' si vous achetez ou 'SHORT' si vous vendez.", helpHowToText2: "2. **Entrez votre Capital :** Le montant total de votre compte de trading.", helpHowToText3: "3. **Définissez votre Risque :** Le pourcentage de votre capital que vous êtes prêt à risquer sur ce trade (ex: 1% ou 2%).", helpHowToText4: "4. **Fixez vos Prix :** Entrez votre prix d'entrée, votre prix de stop-loss (où vous sortirez si le trade va contre vous) et votre prix de take-profit.", helpHowToText5: "Les résultats afficheront automatiquement le montant risqué, la taille de position exacte à prendre et le ratio risque/récompense de votre trade.", },
            es: { title: "Calculadora de Trading", subtitle: "Calcule el tamaño de su posición y la relación riesgo/recompensa.", long: "COMPRA", short: "VENTA", capitalLabel: "Capital ($)", capitalPlaceholder: "10000", riskLabel: "Riesgo (%)", riskPlaceholder: "1", entryLabel: "Precio de Entrada ($)", entryPlaceholder: "50.25", stopLossLabel: "Stop-Loss ($)", stopLossPlaceholder: "49.50", takeProfitLabel: "Take-Profit ($)", takeProfitPlaceholder: "52.00", rrInputLabel: "Relación Riesgo/Recompensa (1:X)", rrInputPlaceholder: "2", resultsTitle: "Resultados", monetaryRisk: "Riesgo Monetario:", positionSize: "Tamaño de Posición:", riskRewardRatio: "Relación Riesgo/Recompensa:", units: "Unidades", reset: "Reiniciar", errorFillAllFields: "Por favor, rellene todos los campos para realizar el cálculo.", errorInvalidNumbers: "Por favor, introduzca números válidos en todos los campos.", errorPositiveValues: "El capital y el porcentaje de riesgo deben ser mayores que cero.", errorPositiveRR: "La relación Riesgo/Recompensa debe ser un número positivo.", errorEntryStopSame: "El precio de entrada no puede ser el mismo que el stop-loss.", errorLongStopLoss: "Para una compra (Long), el stop-loss debe ser inferior al precio de entrada.", errorLongTakeProfit: "Para una compra (Long), el take-profit debe ser superior al precio de entrada.", errorShortStopLoss: "Para una venta (Short), el stop-loss debe ser superior al precio de entrada.", errorShortTakeProfit: "Para una venta (Short), el take-profit debe ser inferior al precio de entrada.", errorCalculation: "Se ha producido un error durante el cálculo.", helpTitle: "Cómo Funciona la Calculadora", helpObjectiveTitle: "Objetivo", helpObjectiveText: "Esta herramienta le ayuda a gestionar su riesgo en el trading calculando el tamaño de posición óptimo en función de su capital, porcentaje de riesgo y configuración de la operación (precios de entrada, stop-loss y take-profit).", helpHowToTitle: "Cómo Usar", helpHowToText1: "1. **Seleccione el tipo de operación:** Elija 'COMPRA' si va a comprar o 'VENTA' si va a vender.", helpHowToText2: "2. **Introduzca su Capital:** La cantidad total de dinero en su cuenta de trading.", helpHowToText3: "3. **Defina su Riesgo:** El porcentaje de su capital que está dispuesto a arriesgar en esta operación (ej: 1% o 2%).", helpHowToText4: "4. **Establezca sus Precios:** Introduzca su precio de entrada, su precio de stop-loss (donde saldrá si la operación va en su contra) y su precio de take-profit.", helpHowToText5: "Los resultados mostrarán automáticamente la cantidad de dinero en riesgo, el tamaño exacto de la posición a tomar y la relación riesgo/recompensa de su operación.", },
            de: { title: "Trading-Rechner", subtitle: "Berechnen Sie Ihre Positionsgröße und Ihr Chance-Risiko-Verhältnis.", long: "KAUFEN", short: "VERKAUFEN", capitalLabel: "Kapital ($)", capitalPlaceholder: "10000", riskLabel: "Risiko (%)", riskPlaceholder: "1", entryLabel: "Einstiegspreis ($)", entryPlaceholder: "50.25", stopLossLabel: "Stop-Loss ($)", stopLossPlaceholder: "49.50", takeProfitLabel: "Take-Profit ($)", takeProfitPlaceholder: "52.00", rrInputLabel: "Chance-Risiko-Verhältnis (1:X)", rrInputPlaceholder: "2", resultsTitle: "Ergebnisse", monetaryRisk: "Monetäres Risiko:", positionSize: "Positionsgröße:", riskRewardRatio: "Chance-Risiko-Verhältnis:", units: "Einheiten", reset: "Zurücksetzen", errorFillAllFields: "Bitte füllen Sie alle Felder aus, um die Berechnung durchzuführen.", errorInvalidNumbers: "Bitte geben Sie für alle Felder gültige Zahlen ein.", errorPositiveValues: "Kapital und Risikoprozentsatz müssen größer als Null sein.", errorPositiveRR: "Das Chance-Risiko-Verhältnis muss eine positive Zahl sein.", errorEntryStopSame: "Der Einstiegspreis darf nicht mit dem Stop-Loss-Preis identisch sein.", errorLongStopLoss: "Bei einem Kauf (Long) muss der Stop-Loss unter dem Einstiegspreis liegen.", errorLongTakeProfit: "Bei einem Kauf (Long) muss der Take-Profit über dem Einstiegspreis liegen.", errorShortStopLoss: "Bei einem Verkauf (Short) muss der Stop-Loss über dem Einstiegspreis liegen.", errorShortTakeProfit: "Bei einem Verkauf (Short) muss der Take-Profit unter dem Einstiegspreis liegen.", errorCalculation: "Bei der Berechnung ist ein Fehler aufgetreten.", helpTitle: "So Funktioniert der Rechner", helpObjectiveTitle: "Ziel", helpObjectiveText: "Dieses Tool hilft Ihnen, Ihr Risiko beim Trading zu managen, indem es die optimale Positionsgröße basierend auf Ihrem Kapital, Ihrem Risikoprozentsatz und Ihrem Trade-Setup (Einstiegs-, Stop-Loss- und Take-Profit-Preise) berechnet.", helpHowToTitle: "Anwendung", helpHowToText1: "1. **Trade-Typ auswählen:** Wählen Sie 'KAUFEN', wenn Sie kaufen, oder 'VERKAUFEN', wenn Sie verkaufen.", helpHowToText2: "2. **Ihr Kapital eingeben:** Der Gesamtbetrag auf Ihrem Handelskonto.", helpHowToText3: "3. **Ihr Risiko definieren:** Der Prozentsatz Ihres Kapitals, den Sie bereit sind, bei diesem einen Trade zu riskieren (z.B. 1% oder 2%).", helpHowToText4: "4. **Ihre Preise festlegen:** Geben Sie Ihren Einstiegspreis, Ihren Stop-Loss-Preis (wo Sie aussteigen, wenn der Trade gegen Sie läuft) und Ihren Take-Profit-Preis ein.", helpHowToText5: "Die Ergebnisse zeigen Ihnen automatisch den riskierten Geldbetrag, die exakte Positionsgröße und das Chance-Risiko-Verhältnis Ihres Trades an.", },
            zh: { title: "交易计算器", subtitle: "计算您的头寸规模和风险/回报率。", long: "做多", short: "做空", capitalLabel: "资金 ($)", capitalPlaceholder: "10000", riskLabel: "风险 (%)", riskPlaceholder: "1", entryLabel: "入场价 ($)", entryPlaceholder: "50.25", stopLossLabel: "止损价 ($)", stopLossPlaceholder: "49.50", takeProfitLabel: "止盈价 ($)", takeProfitPlaceholder: "52.00", rrInputLabel: "风险/回报率 (1:X)", rrInputPlaceholder: "2", resultsTitle: "结果", monetaryRisk: "风险金额:", positionSize: "头寸规模:", riskRewardRatio: "风险/回报率:", units: "单位", reset: "重置", errorFillAllFields: "请填写所有字段以执行计算。", errorInvalidNumbers: "请输入所有字段的有效数字。", errorPositiveValues: "资金和风险百分比必须大于零。", errorPositiveRR: "风险/回报率必须是正数。", errorEntryStopSame: "入场价不能与止损价相同。", errorLongStopLoss: "做多交易，止损价必须低于入场价。", errorLongTakeProfit: "做多交易，盈价必须高于入场价。", errorShortStopLoss: "做空交易，止损价必须高于入场价。", errorShortTakeProfit: "做空交易，止盈价必须低于入场价。", errorCalculation: "计算过程中发生错误。", helpTitle: "计算器如何工作", helpObjectiveTitle: "目标", helpObjectiveText: "该工具通过根据您的资金、风险百分比和交易设置（入场价、止损价和止盈价）计算最佳头寸规模，帮助您管理交易风险。", helpHowToTitle: "如何使用", helpHowToText1: "1. **选择交易类型：** 如果您是买入，请选择“做多”；如果您是卖出，请选择“做空”。", helpHowToText2: "2. **输入您的资金：** 您交易账户中的总金额。", helpHowToText3: "3. **定义您的风险：** 您愿意在此次交易中承担的资金百分比（例如1%或2%）。", helpHowToText4: "4. **设置您的价格：** 输入您的入场价、止损价（如果交易对您不利，您将在此退出）和止盈价。", helpHowToText5: "结果将自动显示您的风险金额、应持有的确切头寸规模以及交易的风险/回报率。", },
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let isDarkMode = false;
            let language = 'fr';
            let tradeType = 'long';
            let lastEdited = 'tp'; // 'tp' or 'rr'

            // --- DOM ELEMENTS ---
            const docHtml = document.documentElement;
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const longButton = document.getElementById('long-button');
            const shortButton = document.getElementById('short-button');
            const resetButton = document.getElementById('reset-button');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const closeHelpModal = document.getElementById('close-help-modal');
            const langToggle = document.getElementById('lang-toggle');
            const langMenu = document.getElementById('lang-menu');
            const langOptions = document.querySelectorAll('.lang-option');
            const inputs = {
                capital: document.getElementById('capital'),
                risk: document.getElementById('risk'),
                entry: document.getElementById('entry'),
                stoploss: document.getElementById('stoploss'),
                takeprofit: document.getElementById('takeprofit'),
                rr_input: document.getElementById('rr-input'),
            };
            const containers = {
                error: document.getElementById('error-container'),
                results: document.getElementById('results-container'),
            };
            const displays = {
                errorMessage: document.getElementById('error-message'),
                riskAmount: document.getElementById('risk-amount'),
                positionSize: document.getElementById('position-size'),
                rrRatio: document.getElementById('rr-ratio'),
            };
            
            // --- FUNCTIONS ---

            const saveParameters = () => {
                try {
                    const params = {
                        capital: inputs.capital.value,
                        risk: inputs.risk.value,
                        entry: inputs.entry.value,
                        stoploss: inputs.stoploss.value,
                        takeprofit: inputs.takeprofit.value,
                        rr_input: inputs.rr_input.value,
                        tradeType,
                        language,
                        isDarkMode,
                        lastEdited
                    };
                    localStorage.setItem('tradingCalcParams', JSON.stringify(params));
                } catch (error) {
                    console.error("Could not save parameters to localStorage:", error);
                }
            };

            const loadParameters = () => {
                try {
                    const savedParams = localStorage.getItem('tradingCalcParams');
                    if (savedParams) {
                        const params = JSON.parse(savedParams);
                        inputs.capital.value = params.capital || '';
                        inputs.risk.value = params.risk || '';
                        inputs.entry.value = params.entry || '';
                        inputs.stoploss.value = params.stoploss || '';
                        inputs.takeprofit.value = params.takeprofit || '';
                        inputs.rr_input.value = params.rr_input || '';
                        lastEdited = params.lastEdited || 'tp';
                        
                        toggleDarkMode(params.isDarkMode || false);
                        setTradeType(params.tradeType || 'long', true); // Do not recalculate yet
                        updateLanguage(params.language || 'fr'); // This will trigger the final calculation
                    } else {
                        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                        toggleDarkMode(prefersDark);
                        setTradeType('long');
                        updateLanguage('fr');
                    }
                } catch (error) {
                    console.error("Could not load parameters from localStorage:", error);
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    toggleDarkMode(prefersDark);
                    setTradeType('long');
                    updateLanguage('fr');
                }
            };

            const updateLanguage = (lang) => {
                language = lang;
                const t = translations[lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.innerText = t[key];
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                     if (t[key]) el.placeholder = t[key];
                });
                calculatePosition();
                saveParameters();
            };

            const toggleDarkMode = (isDark) => {
                isDarkMode = isDark;
                docHtml.classList.toggle('dark', isDarkMode);
                sunIcon.style.display = isDarkMode ? 'block' : 'none';
                moonIcon.style.display = isDarkMode ? 'none' : 'block';
                saveParameters();
            };

            const setTradeType = (type, skipCalculation = false) => {
                tradeType = type;
                if (type === 'long') {
                    longButton.style.backgroundColor = 'var(--color-accent-success)';
                    longButton.style.color = 'var(--color-accent-primary-text)';
                    longButton.classList.add('shadow-md');
                    shortButton.style.backgroundColor = 'transparent';
                    shortButton.style.color = 'var(--color-text-main)';
                    shortButton.classList.remove('shadow-md');
                } else {
                    shortButton.style.backgroundColor = 'var(--color-accent-danger)';
                    shortButton.style.color = 'var(--color-accent-primary-text)';
                    shortButton.classList.add('shadow-md');
                    longButton.style.backgroundColor = 'transparent';
                    longButton.style.color = 'var(--color-text-main)';
                    longButton.classList.remove('shadow-md');
                }
                if (!skipCalculation) {
                    calculatePosition();
                }
                saveParameters();
            };
            
            const setError = (key) => {
                containers.results.classList.add('hidden');
                if (key) {
                    containers.error.classList.remove('hidden');
                    displays.errorMessage.innerText = translations[language][key];
                } else {
                    containers.error.classList.add('hidden');
                }
            };

            const setResults = (results) => {
                setError(null);
                containers.results.classList.remove('hidden');
                const t = translations[language];
                displays.riskAmount.innerText = `$${results.riskAmount}`;
                displays.positionSize.innerText = `${results.positionSize} ${t.units}`;
                displays.rrRatio.innerText = `1 : ${results.riskRewardRatio}`;
            };
            
            const clearResults = () => {
                containers.results.classList.add('hidden');
                setError(null);
            };

            const calculatePosition = () => {
                const baseFieldsFilled = inputs.capital.value && inputs.risk.value && inputs.entry.value && inputs.stoploss.value;
                const drivingFieldFilled = (lastEdited === 'tp' && inputs.takeprofit.value) || (lastEdited === 'rr' && inputs.rr_input.value);

                if (!baseFieldsFilled || !drivingFieldFilled) {
                    clearResults();
                    if (baseFieldsFilled) {
                        if (lastEdited === 'tp' && !inputs.takeprofit.value) inputs.rr_input.value = '';
                        if (lastEdited === 'rr' && !inputs.rr_input.value) inputs.takeprofit.value = '';
                    }
                    return;
                }

                const numCapital = Number(inputs.capital.value);
                const numRisk = Number(inputs.risk.value);
                const numEntry = Number(inputs.entry.value);
                const numStoploss = Number(inputs.stoploss.value);
                let numTakeprofit = Number(inputs.takeprofit.value);
                let numRR = Number(inputs.rr_input.value);

                if ([numCapital, numRisk, numEntry, numStoploss].some(isNaN)) { setError('errorInvalidNumbers'); return; }
                if (numCapital <= 0 || numRisk <= 0) { setError('errorPositiveValues'); return; }
                if (numEntry === numStoploss) { setError('errorEntryStopSame'); return; }

                try {
                    const stopLossDiff = tradeType === 'long' ? numEntry - numStoploss : numStoploss - numEntry;
                    if (stopLossDiff <= 0) {
                        setError(tradeType === 'long' ? 'errorLongStopLoss' : 'errorShortStopLoss');
                        return;
                    }

                    if (lastEdited === 'rr') {
                        if (isNaN(numRR)) { clearResults(); return; }
                        if (numRR <= 0) { setError('errorPositiveRR'); inputs.takeprofit.value = ''; return; }
                        const takeProfitDiff = stopLossDiff * numRR;
                        numTakeprofit = tradeType === 'long' ? (numEntry + takeProfitDiff) : (numEntry - takeProfitDiff);
                        inputs.takeprofit.value = numTakeprofit.toFixed(4);
                    } else { // lastEdited === 'tp'
                        if (isNaN(numTakeprofit)) { clearResults(); return; }
                        const takeProfitDiff = tradeType === 'long' ? numTakeprofit - numEntry : numEntry - numTakeprofit;
                        if (takeProfitDiff <= 0) {
                            setError(tradeType === 'long' ? 'errorLongTakeProfit' : 'errorShortTakeProfit');
                            inputs.rr_input.value = '';
                            return;
                        }
                        numRR = takeProfitDiff / stopLossDiff;
                        inputs.rr_input.value = numRR.toFixed(2);
                    }

                    if (isNaN(numRR) || !isFinite(numRR)) { clearResults(); return; }
                    
                    const riskAmount = numCapital * (numRisk / 100);
                    const positionSize = riskAmount / stopLossDiff;
                    
                    setResults({
                        riskAmount: riskAmount.toFixed(2),
                        positionSize: positionSize.toFixed(4),
                        riskRewardRatio: numRR.toFixed(2)
                    });
                } catch {
                    setError('errorCalculation');
                }
            };
            
            const resetAll = () => {
                Object.values(inputs).forEach(input => input.value = '');
                clearResults();
                localStorage.removeItem('tradingCalcParams');
                setTradeType('long'); 
            };
            
            const handleInputChange = () => {
                calculatePosition();
                saveParameters();
            };

            // --- EVENT LISTENERS ---
            darkModeToggle.addEventListener('click', () => toggleDarkMode(!isDarkMode));
            longButton.addEventListener('click', () => setTradeType('long'));
            shortButton.addEventListener('click', () => setTradeType('short'));
            resetButton.addEventListener('click', resetAll);
            
            ['capital', 'risk', 'entry', 'stoploss'].forEach(key => {
                inputs[key].addEventListener('input', handleInputChange);
            });

            inputs.takeprofit.addEventListener('input', () => {
                lastEdited = 'tp';
                handleInputChange();
            });
            inputs.rr_input.addEventListener('input', () => {
                lastEdited = 'rr';
                handleInputChange();
            });


            // Help Modal
            helpButton.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpModal.addEventListener('click', () => helpModal.classList.add('hidden'));
            helpModal.addEventListener('click', (e) => {
                if(e.target === helpModal) helpModal.classList.add('hidden');
            });

            // Language Dropdown
            langToggle.addEventListener('click', () => langMenu.classList.toggle('hidden'));
            langOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    updateLanguage(e.target.dataset.lang);
                    langMenu.classList.add('hidden');
                });
            });
            document.addEventListener('click', (e) => {
                if (!langToggle.contains(e.target) && !langMenu.contains(e.target)) {
                    langMenu.classList.add('hidden');
                }
            });

            // --- INITIALIZATION ---
            loadParameters();
        });
    </script>
</body>
</html>

